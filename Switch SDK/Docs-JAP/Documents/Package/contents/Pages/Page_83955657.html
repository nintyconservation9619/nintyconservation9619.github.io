<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<script type="text/javascript" src="../template/js/jquery/jquery.js"></script>
<script type="text/javascript" src="../template/js/common/manualLib.js"></script>
<script type="text/javascript" src="../tocData.js"></script>
<link rel="stylesheet" type="text/css" href="../template/css/template.css" />
<title>Semaphore クラス</title>
</head>
<body data-reassemble="autoindex=no,forceNoLabel=yes">
<div id="autoindex_content">
<div class="body_content">
<noscript>
<div style="border: 4px double black; margin: 4px; padding: 2px; font-weight: bold; background-color: #FFFFCC;">
<p>お使いのブラウザは JavaScript が使用できないため、本ドキュメントの一部機能が無効になっています。</p><p>JavaScript が無効の環境では目次を使用することができません。<br />JavaScriptの実行が許可された状態で閲覧してください。<br /><br /></p>
</div>
</noscript>
<div class="page_navigation_top">
<table class="page_navi_root">
<tr>
<td class="page_navi_left"></td>
<td class="page_navi_right"></td>
</tr>
</table>
</div>
<div class="breadcrumb"></div>

<!-- Semaphore クラス -->
<div class="pagetitle" id="PageId_83955657">Semaphore クラス</div>
<div class="text_separate">
<p>
  <ul class="macro_toc">
    <li>
      <a href="#Anchor_83955657_h1_1">Semaphore クラス</a>
    </li>
    <ul>
      <li>
        <a href="#Anchor_83955657_h2_1">機能概要</a>
      </li>
      <li>
        <a href="#Anchor_83955657_h2_2">Semaphore クラスの使用例</a>
      </li>
    </ul>
  </ul>
</p>
<h1 id="Anchor_83955657_h1_1">Semaphore クラス</h1>
<h2 id="Anchor_83955657_h2_1">機能概要</h2>
<p>
  <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_semaphore.html">Semaphore</a> クラスは、計数カウンタを利用して有限な共有リソースを複数の<a href="../Pages/Page_83955697.html">スレッド</a>間で排他的に利用できるように制御するための同期機能です。</p>
<p>
  <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_semaphore.html">Semaphore</a> クラスは、<a href="../../../Api/HtmlNX/structnn_1_1os_1_1_semaphore_type.html">nn::os::SemaphoreType</a> オブジェクトを利用した <a href="../Pages/Page_83955700.html">セマフォ機能</a> をラッピングしたもので以下のメンバ関数を持ちます。API リファレンスはリンク先を参照して下さい。</p>
<table class="table">
  <tbody>
    <tr>
      <th>名前</th>
      <th>説明</th>
      <th>備考</th>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_semaphore.html#a0d96480b41894361ef6bc8427a49d09b">Semaphore</a>
      </td>
      <td>コンストラクタ</td>
      <td>
        <a href="../../../Api/HtmlNX/namespacenn_1_1os.html#af76bc96a9333f18ed5d7bead209eb4f3">InitializeSemaphore()</a> 同等の初期化を実行</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_semaphore.html#acc8163318392dce33ac0e867627ba63c">~Semaphore</a>
      </td>
      <td>デストラクタ</td>
      <td>
        <a href="../../../Api/HtmlNX/namespacenn_1_1os.html#a201a00464d5606e40bef1798cba2ace8">FinalizeSemaphore()</a> 同等の破棄を実行</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_semaphore.html#ae52d131a300cced5796eae9436d86fce">Acquire</a>
      </td>
      <td>セマフォ獲得まで待機</td>
      <td>
        <a href="../../../Api/HtmlNX/namespacenn_1_1os.html#ac9e1d42bdb0279e887dc1caef45fcff1">AcquireSemaphore()</a> 同等のセマフォ獲得待機を実行</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_semaphore.html#a0899675580ec5fd530954ef16e92c224">TryAcquire</a>
      </td>
      <td>セマフォ獲得を試行</td>
      <td>
        <a href="../../../Api/HtmlNX/namespacenn_1_1os.html#af5fa41594b3b3072d78735f366bdb7ce">TryAcquireSemaphore()</a> 同等のセマフォ獲得を試行</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_semaphore.html#a4966976ed17e3c92adccd39858eddd3d">TimedAcquire</a>
      </td>
      <td>セマフォ獲得まで時限付き待機</td>
      <td>
        <a href="../../../Api/HtmlNX/namespacenn_1_1os.html#a54c8209e58cabbf5ab5173867dcad732">TimedAcquireSemaphore()</a> 同等の時限付きセマフォ獲得待機を実行</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_semaphore.html#ac148682b814e9d6a6a92ed78453601ac">Release</a>
      </td>
      <td>セマフォ返却</td>
      <td>
        <p>
          <a href="../../../Api/HtmlNX/namespacenn_1_1os.html#acf2cbceb4266858d27387ff2cb29a5ae">ReleaseSemaphore()</a> 同等のセマフォ返却を実行</p>
        <p>1 カウント返却と複数カウント返却で以下の２つを用意</p>
        <p>
          <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_semaphore.html#ac148682b814e9d6a6a92ed78453601ac">Release()</a>
        </p>
        <p>
          <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_semaphore.html#ad28ab773481ff8465cb7c68bc160b1a7">Release( int count )</a>
        </p>
      </td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_semaphore.html#ac1d4de245f1c2e6a589c0caddb01b2ac">GetCurrentCount</a>
      </td>
      <td>セマフォカウンタの取得</td>
      <td>
        <a href="../../../Api/HtmlNX/namespacenn_1_1os.html#aa6a315a7f4822cee3e62e9912737edfa">GetCurrentSemaphoreCount()</a> 同等のセマフォカウンタ取得を実行</td>
    </tr>
  </tbody>
</table>
<p>&nbsp;</p>
<h2 id="Anchor_83955657_h2_2">Semaphore クラスの使用例</h2>
<p>ここでは例として、<a href="../../../Api/HtmlNX/classnn_1_1os_1_1_semaphore.html">Semaphore</a> クラスを使った SemaphoreSample クラスを実装します。</p>
<table class="codeblock">
  <tbody>
    <tr>
      <td class="code">
        <div class="codeblock"><pre><span class="cp">#include &lt;nn/os.h&gt;
</span>
<span class="k">class</span> <span class="nc">SemaphoreSample</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">explicit</span> <span class="n">SemaphoreSample</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">)</span> <span class="o">:</span> <span class="n">m_stockCount</span><span class="p">(</span>    <span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="p">),</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="n">m_emptyCount</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>  <span class="p">{}</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">void</span> <span class="n">Consume</span><span class="p">()</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">m_stockCount</span><span class="p">().</span><span class="n">Acquire</span><span class="p">();</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">DequeueAndConsume</span><span class="p">();</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">m_emptyCount</span><span class="p">().</span><span class="n">Release</span><span class="p">();</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">void</span> <span class="n">Produce</span><span class="p">()</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">m_emptyCount</span><span class="p">().</span><span class="n">Acquire</span><span class="p">();</span>
 &nbsp; &nbsp; &nbsp; &nbsp;<span class="n">ProduceAndEnqueue</span><span class="p">();</span>
 &nbsp; &nbsp; &nbsp; &nbsp;<span class="n">m_stockCount</span><span class="p">().</span><span class="n">Release</span><span class="p">();</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="nn">nn::os::</span><span class="n">Semaphore</span>   <span class="n">m_stockCount</span><span class="p">;</span>   <span class="c1">// 在庫数
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="nn">nn::os::</span><span class="n">Semaphore</span>   <span class="n">m_emptyCount</span><span class="p">;</span>   <span class="c1">// 空き数
</span><span class="p">};</span></pre></div>
      </td>
    </tr>
  </tbody>
</table>
<p>&nbsp;</p>
<p>この SemaphoreSample クラスは、いわゆる 生産者／消費者問題 をセマフォを使って実装したものです。</p>
<p>コンストラクタの引数には有限なバッファの個数&nbsp;<code>count</code> を指定します。これにより、&nbsp;<code>m_stockCount</code> と&nbsp;<code>m_emptyCount</code> の２つのセマフォが初期化されます。&nbsp;<code>m_stockCount</code> はバッファの中の在庫数をセマフォカウンタで示しており初期値は 0 で最大値は&nbsp;<code>count</code> 個です。一方、&nbsp;<code>m_emptyCount</code> はバッファの中の空き容量をセマフォカウンタで示しており初期値も最大値も&nbsp;<code>count</code> 個です。</p>
<p>消費者側の処理が&nbsp;<code>Consume()</code> メンバ関数です。最初の&nbsp;<code>m_stockCount().Acquire()</code> で在庫が 1 つ以上になるまで待機し、待ちが解除されれば&nbsp;<code>DequeueAndConsume()</code> でバッファからデータを取得し、最後に&nbsp;<code>m_emptyCount().Release()</code> にてバッファを 1 つ空けます。</p>
<p>生産者側の処理が&nbsp;<code>Produce()</code> メンバ関数です。最初の&nbsp;<code>m_emptyCount().Acquire()</code> で空きが 1 つ以上になるまで待機し、待ちが解除されれば <code>ProduceAndEnqueue()</code> でバッファにデータを蓄積し、最後に&nbsp;<code>m_stockCount().Release()</code> にて在庫数を 1 つ増やします。</p>
<p>
  <code>Consume()</code> と&nbsp;<code>Produce()</code> は複数のスレッドからどのようなタイミングで呼ばれても正しく動作します。つまり、最少 0 個から最大&nbsp;<code>count</code> 個までのデータ数を正しくカウントし、必要に応じて消費者もしくは生産者を待機させるように動作します。</p>
<p>なお、実際にデータを蓄積する&nbsp;<code>ProduceAndEnqueue()</code> やデータを取得する <code>DequeueAndConsume()</code> の実装には、別途キューの管理と排他制御が必要になります。</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
</div>
<div class="breadcrumb_bottom"></div>
<div class="page_navigation">
<table class="page_navi_root">
<tr>
<td class="page_navi_left"></td>
<td class="page_navi_right"></td>
</tr>
<tr><td colspan="2" class="page_navi_bottom"></td></tr>
</table>
</div>
</div>
</div>
</body>
</html>
