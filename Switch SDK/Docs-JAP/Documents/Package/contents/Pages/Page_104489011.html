<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<script type="text/javascript" src="../template/js/jquery/jquery.js"></script>
<script type="text/javascript" src="../template/js/common/manualLib.js"></script>
<script type="text/javascript" src="../tocData.js"></script>
<link rel="stylesheet" type="text/css" href="../template/css/template.css" />
<title>振動バイナリファイル (bnvib ファイル)</title>
</head>
<body data-reassemble="autoindex=no,forceNoLabel=yes">
<div id="autoindex_content">
<div class="body_content">
<noscript>
<div style="border: 4px double black; margin: 4px; padding: 2px; font-weight: bold; background-color: #FFFFCC;">
<p>お使いのブラウザは JavaScript が使用できないため、本ドキュメントの一部機能が無効になっています。</p><p>JavaScript が無効の環境では目次を使用することができません。<br />JavaScriptの実行が許可された状態で閲覧してください。<br /><br /></p>
</div>
</noscript>
<div class="page_navigation_top">
<table class="page_navi_root">
<tr>
<td class="page_navi_left"></td>
<td class="page_navi_right"></td>
</tr>
</table>
</div>
<div class="breadcrumb"></div>

<!-- 振動バイナリファイル (bnvib ファイル) -->
<div class="pagetitle" id="PageId_104489011">振動バイナリファイル (bnvib ファイル)</div>
<div class="text_separate">
<h1 id="Anchor_104489011_h1_1">振動バイナリファイル</h1>
<h2 id="Anchor_104489011_h2_1">概要</h2>
<p>振動バイナリファイルは、<a href="../Pages/Page_104489003.html">振動値</a>の列が記録されたバイナリファイルです。拡張子は bnvib です。</p>
<p>事前に PC ツールで生成した振動バイナリファイルを、プログラム実行時にロードして再生することができます。</p>
<p>&nbsp;</p>
<p>振動バイナリファイルから振動値を取り出すために、 <a href="../../../Api/HtmlNX/namespacenn_1_1hid.html#a7d0be2e26c8283bf479ec142133c81e2">ParseVibrationFile()</a> 関数や <a href="../../../Api/HtmlNX/namespacenn_1_1hid.html#a43c97eccdcb915afba12627b52c2e692">RetrieveVibrationValue()</a> 関数を利用できます。</p>
<p>
  <a href="../../../Api/HtmlNX/classnn_1_1hid_1_1_vibration_player.html">VibrationPlayer </a>クラスを利用すると、振動バイナリファイルに記録されている振動を任意の区間でループさせたり、実行時に振動に変化を加えるなど、より高度な機能を使うことができます。</p>
<h2 id="Anchor_104489011_h2_2">振動バイナリファイルの再生方法</h2>
<p>振動バイナリファイルを再生するには、 振動バイナリファイルパース&nbsp;API を使う方法と <a href="../../../Api/HtmlNX/classnn_1_1hid_1_1_vibration_player.html">VibrationPlayer </a>を使う方法があります。</p>
<h3 id="Anchor_104489011_h3_1">振動バイナリファイルパース API&nbsp;を使う方法</h3>
<p>振動バイナリファイルパース API&nbsp;は、メモリ上に展開された振動バイナリファイルのデータから、振動値を直接取り出す機能を提供します。</p>
<p>振動ファイルをパースする際のコンテクストは <a href="../../../Api/HtmlNX/structnn_1_1hid_1_1_vibration_file_parser_context.html">VibrationFileParserContext </a>構造体に保持されます。</p>
<p>&nbsp;</p>
<p>振動バイナリファイルパース API&nbsp;を利用するためには、まず <a href="../../../Api/HtmlNX/namespacenn_1_1fs.html#a81801a404563984f8c6cc1483cc6d730">nn::fs::ReadFile()</a> 関数などの API を利用して、メモリ上に振動バイナリファイルのデータを読み出す必要があります。</p>
<p>その後、 <a href="../../../Api/HtmlNX/namespacenn_1_1hid.html#a7d0be2e26c8283bf479ec142133c81e2">ParseVibrationFile()</a> 関数を利用して&nbsp;<a href="../../../Api/HtmlNX/structnn_1_1hid_1_1_vibration_file_parser_context.html">VibrationFileParserContext </a>構造体を初期化します。</p>
<p>実際に振動値を取り出すためには <a href="../../../Api/HtmlNX/namespacenn_1_1hid.html#a43c97eccdcb915afba12627b52c2e692">RetrieveVibrationValue()</a> 関数を利用します。</p>
<p>&nbsp;</p>
<p>振動バイナリファイルには、振動値が 200Hz のサンプリングレートで記録されています。</p>
<p>そのため、取り出した振動値を再生するためには、別途 5ms 間隔で動作するタイマーを用意した上で、取り出した振動値を定期的に <a href="../Pages/Page_104488991.html">VibrationDevice</a> に送信する必要があります。</p>
<h3 id="Anchor_104489011_h3_2">VibrationPlayer を使う方法</h3>
<p>
  <a href="../../../Api/HtmlNX/classnn_1_1hid_1_1_vibration_player.html">VibrationPlayer </a>クラスは、<a href="../Pages/Page_104489019.html">振動ノード</a>の一種であり、振動バイナリファイルパース API の機能をラップしたユーティリティクラスです。</p>
<p>
  <a href="../../../Api/HtmlNX/classnn_1_1hid_1_1_vibration_player.html">VibrationPlayer&nbsp;</a>クラスの利用方法は<a href="../Pages/Page_104489019.html">振動ノード</a>の説明や API リファレンスを参照してください。</p>
<h2 id="Anchor_104489011_h2_3">振動バイナリファイルの生成方法</h2>
<p>振動バイナリファイルは、<a href="../Pages/Page_104490352.html">振動コンバータ</a>を使って WAV ファイルまたは AIFF ファイルを元にして生成することができます。</p>
<p>また、以下のフォーマットを参考にして任意のバイナリエディタを利用することにより、 PC で振動バイナリファイルの中身を直接編集することもできます。</p>
<h2 id="Anchor_104489011_h2_4">振動バイナリファイルフォーマット</h2>
<h3 id="Anchor_104489011_h3_3">概要</h3>
<p>振動バイナリファイルは、メタデータ領域とデータ領域によって構成されています。</p>
<p>複数バイトを利用する数値型は、リトルエンディアンで記録されます。</p>
<p>
  <span style="color: rgb(51,51,51);">振動の制御の最小単位が 5 msec のため、振動バイナリファイルの長さは 5 msec の倍数になります。</span>
</p>
<table class="table">
  <tbody>
    <tr>
      <th>&nbsp;</th>
      <th colspan="2">&nbsp;&nbsp;</th>
      <th>オフセット (byte)</th>
      <th>データ型</th>
      <th>説明</th>
    </tr>
    <tr>
      <th rowspan="6">メタデータ領域</th>
      <th colspan="2">MetaDataSize&nbsp;</th>
      <td>0</td>
      <td>uint32_t</td>
      <td>
        <p>メタデータのサイズ。（ただし MetaDataSize 自身の 4 byte は含みません）</p>
        <p>単位は byte。取りうる値は以下のいずれか。</p>
        <ul>
          <li>0x00000004 (ループ関連の情報を持たないファイルの場合)</li>
          <li>0x0000000C (LoopRange の情報を持ち LoopInterval の情報を持たないファイルの場合)</li>
          <li>0x00000010 (LoopRange と LoopInterval の情報を持つファイルの場合)</li>
        </ul>
      </td>
    </tr>
    <tr>
      <th colspan="2">FormatId&nbsp;</th>
      <td>4</td>
      <td>uint16_t</td>
      <td>フォーマットを表す数。0x0003 で固定。</td>
    </tr>
    <tr>
      <th colspan="2">SamplingRate&nbsp;</th>
      <td>6</td>
      <td>uint16_t</td>
      <td>サンプリングレート。単位は Hz。0x00C8 で固定。</td>
    </tr>
    <tr>
      <th rowspan="2">
        <p>LoopRange</p>
        <p>(オプション)&nbsp;</p>
      </th>
      <th>LoopStart&nbsp;</th>
      <td>8&nbsp;</td>
      <td>uint32_t&nbsp;</td>
      <td>ループ開始位置のサンプル番号。&nbsp;</td>
    </tr>
    <tr>
      <th>LoopEnd&nbsp;</th>
      <td>12&nbsp;</td>
      <td>uint32_t&nbsp;</td>
      <td>ループ終了位置のサンプル番号。&nbsp;</td>
    </tr>
    <tr>
      <th colspan="2">LoopInterval (オプション)&nbsp;&nbsp;</th>
      <td>16&nbsp;</td>
      <td>uint32_t&nbsp;</td>
      <td>ループ終了からループ開始までのインターバル（単位はサンプル個数）&nbsp;</td>
    </tr>
    <tr>
      <th rowspan="2">データ領域&nbsp;</th>
      <th colspan="2">DataSize&nbsp;&nbsp;</th>
      <td>4 + MetaDataSize&nbsp;</td>
      <td>uint32_t</td>
      <td>データのサイズ。（ただし DataSize 自身の 4 byte は含みません）</td>
    </tr>
    <tr>
      <th colspan="2">Data&nbsp;</th>
      <td>4 + MetadataSize + 4</td>
      <td>uint32_t[]&nbsp;</td>
      <td>
        <p>振動値データ本体。</p>
        <p>4 byte で 1 サンプル分のデータが、サンプルの個数分だけ並びます。</p>
      </td>
    </tr>
  </tbody>
</table>
<h4 id="Anchor_104489011_h4_1">ループ設定に関する補足説明</h4>
<p>LoopEnd 値は「ループの最後の次のサンプル」を意味しています。</p>
<p>一般に、長さ N のループでは、次の等式が成り立ちます。</p>
<p>N = LoopEnd - LoopStart</p>
<p>&nbsp;</p>
<p>BNVIB ファイルの LoopStart, LoopEnd は、<a href="../../../Api/HtmlNX/classnn_1_1hid_1_1_vibration_player.html">VibrationPlayer&nbsp;</a>の <a href="../../../Api/HtmlNX/structnn_1_1hid_1_1_vibration_file_info.html#a1fb773e0f20b178d1f6809b252742fcd">loopStartPosition</a>, <a href="../../../Api/HtmlNX/structnn_1_1hid_1_1_vibration_file_info.html#a84011094bb0ada635ec2cef0f7f4a052">loopEndPosition</a> にそれぞれ相当します。</p>
<p>したがって、BNVIB ファイルが正しく再生されるためには、次の等式が成り立っている必要があります。</p>
<p>0 &lt;= LoopStart &lt; LoopEnd &lt;= DataSize / 4</p>
<p>ここで、「DataSize」は、BNVIB ファイル内の振動データ本体のデータサイズを表します。(単位は byte)</p>
<p>ひとつのサンプルは 4 バイトで表現されるので、DataSize / 4 はサンプル長を意味しています。</p>
<p>&nbsp;</p>
<h3 id="Anchor_104489011_h3_4">データ部分のフォーマット</h3>
<p>4 バイトで 1 つの振動値を表します。</p>
<table class="table">
  <tbody>
    <tr>
      <th>&nbsp;</th>
      <th>&nbsp;</th>
      <th>オフセット (byte)</th>
      <th>データ型</th>
      <th>説明</th>
    </tr>
    <tr>
      <th rowspan="4">Data&nbsp;&nbsp;&nbsp;&nbsp;</th>
      <th>AmplitudeLow</th>
      <td>0&nbsp;</td>
      <td>uint8_t</td>
      <td>低帯域の振幅値。</td>
    </tr>
    <tr>
      <th>FrequencyLow</th>
      <td>1</td>
      <td>uint8_t</td>
      <td>低帯域の周波数値。</td>
    </tr>
    <tr>
      <th>AmplitudeHigh</th>
      <td>2</td>
      <td>uint8_t</td>
      <td>高帯域の振幅値。</td>
    </tr>
    <tr>
      <th>FrequencyHigh</th>
      <td>3</td>
      <td>uint8_t</td>
      <td>高帯域の周波数値。</td>
    </tr>
  </tbody>
</table>
<h4 id="Anchor_104489011_h4_2">振幅値の変換式&nbsp;</h4>
<p>uint8_t 型で記録されている振幅値 (b) は、以下の変換式にしたがって float 型の振幅値 (amplitude) に変換されます。</p>
<p>amplitude = b / 255</p>
<h4 id="Anchor_104489011_h4_3">周波数値の変換式</h4>
<p>uint8_t 型で記録されている周波数値 (b) は、以下の変換式にしたがって float 型の周波数値 (frequency) に変換されます。</p>
<p>frequency = 10 * 2<sup>b/32</sup></p>
<p>&nbsp;</p>
</div>
<div class="breadcrumb_bottom"></div>
<div class="page_navigation">
<table class="page_navi_root">
<tr>
<td class="page_navi_left"></td>
<td class="page_navi_right"></td>
</tr>
<tr><td colspan="2" class="page_navi_bottom"></td></tr>
</table>
</div>
</div>
</div>
</body>
</html>
