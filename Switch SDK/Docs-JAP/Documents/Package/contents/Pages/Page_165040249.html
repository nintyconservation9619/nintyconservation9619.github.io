<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<script type="text/javascript" src="../template/js/jquery/jquery.js"></script>
<script type="text/javascript" src="../template/js/common/manualLib.js"></script>
<script type="text/javascript" src="../tocData.js"></script>
<link rel="stylesheet" type="text/css" href="../template/css/template.css" />
<title>NumberLineAllocator</title>
</head>
<body data-reassemble="autoindex=no,forceNoLabel=yes">
<div id="autoindex_content">
<div class="body_content">
<noscript>
<div style="border: 4px double black; margin: 4px; padding: 2px; font-weight: bold; background-color: #FFFFCC;">
<p>お使いのブラウザは JavaScript が使用できないため、本ドキュメントの一部機能が無効になっています。</p><p>JavaScript が無効の環境では目次を使用することができません。<br />JavaScriptの実行が許可された状態で閲覧してください。<br /><br /></p>
</div>
</noscript>
<div class="page_navigation_top">
<table class="page_navi_root">
<tr>
<td class="page_navi_left"></td>
<td class="page_navi_right"></td>
</tr>
</table>
</div>
<div class="breadcrumb"></div>

<!-- NumberLineAllocator -->
<div class="pagetitle" id="PageId_165040249">NumberLineAllocator</div>
<div class="text_separate">
<h1 id="Anchor_165040249_h1_1">NumberLineAllocator クラス</h1>
<h2 id="Anchor_165040249_h2_1">機能概要</h2>
<p>
  <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html">NumberLineAllocator</a>&nbsp;クラスは、ある部分数直線から任意の領域を確保・解放することができる整数アロケータのクラスです。&nbsp;</p>
<p>0 から最大&nbsp;16777215&nbsp;(0xFFFFFF) までのインデックスで表される整数領域から、任意の長さの領域の割り当てることができます。</p>
<p>
  <a class="el" href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html">NumberLineAllocator</a>&nbsp;の管理領域は専用のコールバックを用いて管理し、&nbsp;<a class="el" href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html">NumberLineAllocator</a>&nbsp;で扱う領域と分離できます。</p>
<p>
  <br />
</p>
<p>
  <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html">NumberLineAllocator</a>&nbsp;クラスは以下のメンバ関数を持ちます。API リファレンスはリンク先を参照して下さい。</p>
<table style="margin-left: 1.5em;" class="table">
  <tbody>
    <tr>
      <th>名前</th>
      <th>説明</th>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#a1e3efc1b684befdaa9d3ea4c08fc8c23">NumberLineAllocator</a>
      </td>
      <td>コンストラクタです。</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html#a36ddcbfe848f26965181f49aa0f2a3a2">Initialize</a>
      </td>
      <td>アロケータを初期化します。</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html#a5d5c69b7eb4126bdf7ebba29a20cd921">Finalize</a>
      </td>
      <td>アロケータを破棄します。</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html#a5c133ee0d979b0d88864c1e7c2c9e460">AddRange</a>
      </td>
      <td>指定した部分数直線領域を確保可能にします。</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html#aa0717e2b3f8764211ac29853333bc083">RemoveRange</a>
      </td>
      <td>指定した部分数直線領域を確保不可能にします。</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html#a5a5f02b93d9e0d9f36a2da6d7f099eda">Allocate</a>
      </td>
      <td>
        <span style="color: rgb(85,85,85);">確保可能な区間を割り当てます。</span>
      </td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html#a49daf84a409ab88e831502895d5f5aa2">Free</a>
      </td>
      <td>
        <span style="color: rgb(85,85,85);">割り当て済みの区間を解放します。</span>
      </td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html#a4f6d775fb9c341c8daccf7d314e534c8">FindUserData</a>
      </td>
      <td>
        <span style="color: rgb(85,85,85);">確保済みの区間に関連付けられたユーザ定義のパラメータを取得します。&nbsp;</span>
      </td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html#a843376830577934d707528bf2148ec74">GetSizeOf</a>
      </td>
      <td>
        <span style="color: rgb(85,85,85);">指定した確保済み区間のサイズを取得します。</span>
      </td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html#a168ed216f723fdff9c0ca3679f0663f3">GetTotalFreeSize</a>
      </td>
      <td>
        <span style="color: rgb(85,85,85);">アロケータに存在する空き領域の合計を取得します。</span>
      </td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html#ad616039e70388b58d6115ea1be537a56">GetAllocatableSize</a>
      </td>
      <td>
        <span style="color: rgb(85,85,85);">アロケータから確保可能な最大サイズを取得します。</span>
      </td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html#ae5d998734ed79c7a8fc1401e9ecc740f">Dump</a>
      </td>
      <td>
        <span style="color: rgb(85,85,85);">アロケータ内部の情報を表示します。</span>
      </td>
    </tr>
  </tbody>
</table>
<h2 id="Anchor_165040249_h2_2">NumberLineAllocator の使用方法</h2>
<p>まず、&nbsp;<a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html">NumberLineAllocator</a>&nbsp;を初期化します。</p>
<p>初期化時には <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html">NumberLineAllocator</a>&nbsp;の管理領域用の確保・解放関数が必要になるので、そのコールバック関数も定義します。</p>
<p>その後、&nbsp;<a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html#a5c133ee0d979b0d88864c1e7c2c9e460">AddRange()</a>&nbsp;を呼び出し確保可能な部分数直線領域を設定します。</p>
<table class="codeblock">
  <tbody>
    <tr>
      <td class="code">
        <div class="codeblock"><pre><span class="cp">#include &lt;nn/mem/mem_NumberLineAllocator.h&gt;
</span>
<span class="c1">// 管理領域確保用コールバック
</span><span class="kt">void</span><span class="o">*</span> <span class="nf">ManagAlloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">pParam</span><span class="p">)</span>
<span class="p">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">NN_UNUSED</span><span class="p">(</span><span class="n">pParam</span><span class="p">);</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="nn">std::</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 管理領域解放用コールバック
</span><span class="kt">void</span> <span class="nf">ManagFree</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">pParam</span><span class="p">)</span>
<span class="p">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">NN_UNUSED</span><span class="p">(</span><span class="n">pParam</span><span class="p">);</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="nn">std::</span><span class="n">free</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">void</span> <span class="n">nnMain</span><span class="p">()</span>
<span class="p">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="nn">nn::mem::</span><span class="n">NumberLineAllocator</span> <span class="n">allocator</span><span class="p">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// 初期化
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">allocator</span><span class="p">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">ManagAlloc</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="n">ManagFree</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// 確保可能領域の指定
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">allocator</span><span class="p">.</span><span class="n">AddRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x01000000u</span><span class="p">);</span>
 
&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// 以下任意の処理
</span><span class="p">}</span></pre></div>
      </td>
    </tr>
  </tbody>
</table>
<p>&nbsp;</p>
<p>初期化後、メモリの確保・解放などが行えます。</p>
<table class="codeblock">
  <tbody>
    <tr>
      <td class="code">
        <div class="codeblock"><pre><span class="c1">// 例として、長さ 3 の部分数直線を確保
</span><span class="kt">int</span> <span class="n">numberLine</span><span class="p">;</span>
<span class="kt">bool</span> <span class="n">result</span> <span class="o">=</span> <span class="n">allocator</span><span class="p">.</span><span class="n">Allocate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">numberLine</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// 部分数直線の確保に失敗
</span><span class="p">}</span>
 
<span class="c1">// 例として、長さ 16 の部分数直線を 4 アライメントで確保
</span><span class="kt">int</span> <span class="n">alignedNumberLine</span><span class="p">;</span>
<span class="kt">bool</span> <span class="n">result</span> <span class="o">=</span> <span class="n">allocator</span><span class="p">.</span><span class="n">Allocate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">alignedNumberLine</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// 部分数直線の確保に失敗
</span><span class="p">}</span>
 
<span class="c1">// メモリを解放
</span><span class="n">allocator</span><span class="p">.</span><span class="n">Free</span><span class="p">(</span><span class="n">numberLine</span><span class="p">);</span>
<span class="n">allocator</span><span class="p">.</span><span class="n">Free</span><span class="p">(</span><span class="n">alignedNumberLine</span><span class="p">);</span></pre></div>
      </td>
    </tr>
  </tbody>
</table>
<p>&nbsp;</p>
<p>
  <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html">NumberLineAllocator</a>&nbsp;の利用を終了する場合は <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html#a5d5c69b7eb4126bdf7ebba29a20cd921">Finalize()</a> を呼び出してアロケータを破棄してください。</p>
<table class="codeblock">
  <tbody>
    <tr>
      <td class="code">
        <div class="codeblock"><pre><span class="n">allocator</span><span class="p">.</span><span class="n">Finalize</span><span class="p">();</span></pre></div>
      </td>
    </tr>
  </tbody>
</table>
<p>&nbsp;</p>
<p>その他の機能については関数リファレンスを参照して下さい。</p>
<h2 id="Anchor_165040249_h2_3">Dump フォーマット</h2>
<p>
  <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html#ae5d998734ed79c7a8fc1401e9ecc740f">Dump()</a> を呼び出した時の<span style="color: rgb(85,85,85);">アロケータ内部の情報は以下の XML フォーマットで表示されます。</span></p>
<table class="codeblock">
  <tbody>
    <tr>
      <td class="code">
        <div class="codeblock"><pre><span class="nt">&lt;heapinfo&gt;</span>
&nbsp;&nbsp;<span class="nt">&lt;offset&gt;</span>0<span class="nt">&lt;/offset&gt;</span>
&nbsp;&nbsp;<span class="nt">&lt;factor&gt;</span>1<span class="nt">&lt;/factor&gt;</span>
&nbsp;&nbsp;<span class="nt">&lt;max_allocatable_size&gt;</span>16777214<span class="nt">&lt;/max_allocatable_size&gt;</span>
&nbsp;&nbsp;<span class="nt">&lt;free_memory&gt;</span>16777214<span class="nt">&lt;/free_memory&gt;</span>
&nbsp;&nbsp;<span class="nt">&lt;allocated_memory&gt;</span>2<span class="nt">&lt;/allocated_memory&gt;</span>
&nbsp;&nbsp;<span class="nt">&lt;freelists&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="nt">&lt;free</span> <span class="na">index=</span><span class="s">'255'</span> <span class="na">first=</span><span class="s">'0000000000000002'</span> <span class="na">last=</span><span class="s">'0000000001000000'</span> <span class="na">size=</span><span class="s">'16777214'</span><span class="nt">/&gt;</span>
&nbsp;&nbsp;<span class="nt">&lt;/freelists&gt;</span>
&nbsp;&nbsp;<span class="nt">&lt;allocs&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="nt">&lt;alloc</span> <span class="na">level0=</span><span class="s">'0'</span> <span class="na">level1=</span><span class="s">'0'</span> <span class="na">level2=</span><span class="s">'0'</span> <span class="na">first=</span><span class="s">'0000000000000000'</span> <span class="na">last=</span><span class="s">'0000000000000002'</span> <span class="na">size=</span><span class="s">'2'</span><span class="nt">/&gt;</span>
&nbsp;&nbsp;<span class="nt">&lt;/allocs&gt;</span>
<span class="nt">&lt;/heapinfo&gt;</span></pre></div>
      </td>
    </tr>
  </tbody>
</table>
<p>以下に各要素の説明を示します。</p>
<table class="table">
  <tbody>
    <tr>
      <th>タグ</th>
      <th>説明</th>
    </tr>
    <tr>
      <td>heapinfo</td>
      <td>
        <p>
          <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html#ae5d998734ed79c7a8fc1401e9ecc740f">Dump()</a> で出力された XML の一番大枠のタグです。</p>
      </td>
    </tr>
    <tr>
      <td>offset</td>
      <td>表示されるインデックスをずらすオフセットです。ユーザが Dump() 呼び出し時に引数として指定します。</td>
    </tr>
    <tr>
      <td>factor</td>
      <td>
        <p>部分数直線の長さ 1 を定数倍して表示したい時に指定する整数です。</p>
        <p>例えばここで factor を 256 とすると、部分数直線の長さ 1 が 256 であるものとして以降の値を表示します。</p>
      </td>
    </tr>
    <tr>
      <td>max_allocatable_size</td>
      <td>確保可能な最大サイズです。</td>
    </tr>
    <tr>
      <td>free_memory</td>
      <td>
        <span style="color: rgb(85,85,85);">空き領域の合計サイズです。</span>
      </td>
    </tr>
    <tr>
      <td>freelists</td>
      <td>空き領域である部分数直線の集合を表すタグです。</td>
    </tr>
    <tr>
      <td>free</td>
      <td>
        <p>アロケータに存在する空き領域である部分数直線です。</p>
        <p>index は長さを元に 256 つにクラス分けされたそのクラスのどれに空き領域が所属するかを表します。 index が 0 から 254 までは部分数直線の長さ -1 と一致し、 255 は長さ 256 以上の部分数直線であることを表します。</p>
        <p>first は空き領域の開始インデックスです。</p>
        <p>last は空き領域の末尾インデックスに 1 足した値です。</p>
        <p>size は空き領域の長さです。</p>
      </td>
    </tr>
    <tr>
      <td>allocs</td>
      <td>確保済み領域である部分数直線の集合を表すタグです。</td>
    </tr>
    <tr>
      <td>alloc</td>
      <td>
        <p>確保済み領域である部分数直線です。</p>
        <p>level0, level1, level2 はアロケータ内部で確保済み領域を管理しているデータ構造のどの位置にいるかを表すインデックスです。通常のユーザは意識する必要はありません。</p>
        <p>first は確保済み領域の開始インデックスです。</p>
        <p>last は確保済み領域の末尾インデックスに 1 足した値です。</p>
        <p>size は確保済み領域の長さです。</p>
      </td>
    </tr>
  </tbody>
</table>
<p>offset や factor は NumberLineAllocator を内部実装として利用したメモリアロケータを作成した場合に有用です。</p>
<p>offset に自作メモリアロケータの開始アドレス、 factor に長さ 1 に割り当てた自作メモリアロケータの最小確保サイズを渡すことで、 <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html#ae5d998734ed79c7a8fc1401e9ecc740f">Dump()</a>&nbsp;時に自作メモリアロケータで利用している値を出力させることができます。</p>
<h2 id="Anchor_165040249_h2_4">NumberLineAllocator&nbsp;使用上の注意事項</h2>
<h3 id="Anchor_165040249_h3_1">最大確保数について</h3>
<p>
  <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html">NumberLineAllocator</a>&nbsp;で扱える部分数直線は有限で、その最大長は 16777215 (0xFFFFFF) です。</p>
<p>よって長さ 1 の領域は&nbsp;16777215 回しか確保できず、長さ 3 の領域は&nbsp;5592405 回、長さ 16777215 の領域は 1 回しか確保できません。</p>
<h3 id="Anchor_165040249_h3_2">管理領域のサイズについて</h3>
<p>
  <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html">NumberLineAllocator</a>&nbsp;は、確保済みの部分数直線それぞれの長さと確保した数に応じて管理領域が動的に変化します。</p>
<p>以下の表はある長さの部分数直線を連続して確保し、解放を行わなかった場合の管理領域のサイズ例です。</p>
<table class="table">
  <tbody>
    <tr>
      <th>連続して確保した部分数直線の長さ</th>
      <th>確保済みの部分数直線の数</th>
      <th>管理領域のサイズ(32bit)&nbsp;[Bytes]</th>
      <th>管理領域のサイズ(64bit)&nbsp;[Bytes]</th>
    </tr>
    <tr>
      <td>1</td>
      <td>0 (初期化直後)</td>
      <td>8544</td>
      <td>
        <span style="color: rgb(68,68,68);">14768</span>
      </td>
    </tr>
    <tr>
      <td>1</td>
      <td>4096</td>
      <td>
        <span style="color: rgb(68,68,68);">140640</span>
      </td>
      <td>
        <span style="color: rgb(68,68,68);">246192</span>
      </td>
    </tr>
    <tr>
      <td>1</td>
      <td>
        <span style="color: rgb(68,68,68);">262144</span>
      </td>
      <td>
        <span style="color: rgb(68,68,68);">8401248</span>
      </td>
      <td>
        <p>
          <span style="color: rgb(68,68,68);">14703024</span>
        </p>
      </td>
    </tr>
    <tr>
      <td>1</td>
      <td>
        <span style="color: rgb(68,68,68);">16777215 (0xFFFFFF)</span>
      </td>
      <td>
        <span style="color: rgb(68,68,68);">537141572</span>
      </td>
      <td>
        <span style="color: rgb(68,68,68);">940063104</span>
      </td>
    </tr>
    <tr>
      <td>16</td>
      <td>0</td>
      <td>
        <span style="color: rgb(68,68,68);">8544</span>
      </td>
      <td>
        <span style="color: rgb(68,68,68);">14768</span>
      </td>
    </tr>
    <tr>
      <td>16</td>
      <td>4096</td>
      <td>
        <span style="color: rgb(68,68,68);">386400</span>
      </td>
      <td>
        <span style="color: rgb(68,68,68);">737712</span>
      </td>
    </tr>
    <tr>
      <td>16</td>
      <td>
        <span style="color: rgb(68,68,68);">262144</span>
      </td>
      <td>
        <span style="color: rgb(68,68,68);">24191328</span>
      </td>
      <td>
        <span style="color: rgb(68,68,68);">46283184</span>
      </td>
    </tr>
    <tr>
      <td>16</td>
      <td>
        <span style="color: rgb(68,68,68);">1048575</span>
      </td>
      <td>
        <span style="color: rgb(68,68,68);">96739652</span>
      </td>
      <td>
        <span style="color: rgb(68,68,68);">185088384</span>
      </td>
    </tr>
  </tbody>
</table>
<p>上記の表は目安で、実際の管理領域のサイズは確保、解放のパターンによって異なります。</p>
<h3 id="Anchor_165040249_h3_3">管理領域の確保におけるキャッシュについて</h3>
<p>管理領域は、 <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html#a49daf84a409ab88e831502895d5f5aa2">Free()</a>&nbsp;のタイミングでは解放されず、再利用のため一定期間キャッシュされます。そのため、見かけ上 Allocate 数に対して管理領域が多く取られているように見える場合があります。</p>
<p>管理領域はアロケータが破棄されるまで一定量保持されます。全ての管理領域を解放するためには <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html#a5d5c69b7eb4126bdf7ebba29a20cd921">Finalize()</a>&nbsp;を呼び出してください。</p>
</div>
<div class="breadcrumb_bottom"></div>
<div class="page_navigation">
<table class="page_navi_root">
<tr>
<td class="page_navi_left"></td>
<td class="page_navi_right"></td>
</tr>
<tr><td colspan="2" class="page_navi_bottom"></td></tr>
</table>
</div>
</div>
</div>
</body>
</html>
