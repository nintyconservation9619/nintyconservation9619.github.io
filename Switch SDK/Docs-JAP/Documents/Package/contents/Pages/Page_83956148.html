<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<script type="text/javascript" src="../template/js/jquery/jquery.js"></script>
<script type="text/javascript" src="../template/js/common/manualLib.js"></script>
<script type="text/javascript" src="../tocData.js"></script>
<link rel="stylesheet" type="text/css" href="../template/css/template.css" />
<title>ThreadLocalStorage クラス</title>
</head>
<body data-reassemble="autoindex=no,forceNoLabel=yes">
<div id="autoindex_content">
<div class="body_content">
<noscript>
<div style="border: 4px double black; margin: 4px; padding: 2px; font-weight: bold; background-color: #FFFFCC;">
<p>お使いのブラウザは JavaScript が使用できないため、本ドキュメントの一部機能が無効になっています。</p><p>JavaScript が無効の環境では目次を使用することができません。<br />JavaScriptの実行が許可された状態で閲覧してください。<br /><br /></p>
</div>
</noscript>
<div class="page_navigation_top">
<table class="page_navi_root">
<tr>
<td class="page_navi_left"></td>
<td class="page_navi_right"></td>
</tr>
</table>
</div>
<div class="breadcrumb"></div>

<!-- ThreadLocalStorage クラス -->
<div class="pagetitle" id="PageId_83956148">ThreadLocalStorage クラス</div>
<div class="text_separate">
<p>
  <ul class="macro_toc">
    <li>
      <a href="#Anchor_83956148_h1_1">ThreadLocalStorage クラス</a>
    </li>
    <ul>
      <li>
        <a href="#Anchor_83956148_h2_1">機能概要</a>
      </li>
      <li>
        <a href="#Anchor_83956148_h2_2">ThreadLocalStorage クラスの利用シーン</a>
      </li>
      <li>
        <a href="#Anchor_83956148_h2_3">ThreadLocalStorage クラスの使用例</a>
      </li>
      <ul>
        <li>
          <a href="#Anchor_83956148_h3_1">単純な値の設定と取得</a>
        </li>
      </ul>
      <li>
        <a href="#Anchor_83956148_h2_4">ThreadLocalStorage クラス使用上の注意事項</a>
      </li>
      <ul>
        <li>
          <a href="#Anchor_83956148_h3_2">TLS リソースの上限</a>
        </li>
        <li>
          <a href="#Anchor_83956148_h3_3">ThreadLocalStorage クラスのコンストラクタ起動タイミング</a>
        </li>
      </ul>
    </ul>
  </ul>
</p>
<h1 id="Anchor_83956148_h1_1">ThreadLocalStorage クラス</h1>
<h2 id="Anchor_83956148_h2_1">機能概要</h2>
<p>
  <a href="../Pages/Page_83955692.html">スレッドローカルストレージ</a>（以後 TLS）は、単一の TLS スロット を介してスレッド毎に異なるデータを扱うための機能です。</p>
<p>
  <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_thread_local_storage.html">ThreadLocalStorage</a> クラスは、<a href="../../../Api/HtmlNX/structnn_1_1os_1_1_tls_slot.html">nn::os::TlsSlot</a> オブジェクトを使用する <a href="../Pages/Page_83955692.html">TLS 関連機能</a> の呼び出しをラッピングしたもので以下のメンバ関数を持ちます。API リファレンスはリンク先を参照して下さい。</p>
<table class="table">
  <tbody>
    <tr>
      <th>名前</th>
      <th>説明</th>
      <th>備考</th>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_thread_local_storage.html#a373a63e0f3a07f44d3261aa24034b8bb">ThreadLocalStorage</a>
      </td>
      <td>コンストラクタ</td>
      <td>
        <p>
          <a href="../../../Api/HtmlNX/namespacenn_1_1os.html#a2a67ebeb78e5d624b45ec27d66bdf0b2">AllocateTlsSlot()</a> 同等の TLS スロット確保を実行<br />デストラクタ関数登録のある／なしで、以下の２つのコンストラクタを用意</p>
        <p>
          <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_thread_local_storage.html#a373a63e0f3a07f44d3261aa24034b8bb">ThreadLocalStorage()</a>
        </p>
        <p>
          <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_thread_local_storage.html#af0bcbc7f926ee7149b47f1c7830f9338">ThreadLocalStorage( TlsDestructor )</a>
        </p>
      </td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_thread_local_storage.html#ac28465d30f5635c4d72e7b51bcb4bf3b">~ThreadLocalStorage</a>
      </td>
      <td>デストラクタ</td>
      <td>
        <a href="../../../Api/HtmlNX/namespacenn_1_1os.html#afded66e76230ba96acc86ba3d48d76c4">FreeTlsSlot()</a> 同等の TLS スロット返却を実行</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_thread_local_storage.html#a6c7417cb688d7ca220ba44efcb79f142">SetValue</a>
      </td>
      <td>TLS 値を設定</td>
      <td>
        <a href="../../../Api/HtmlNX/namespacenn_1_1os.html#a8f54d6581f3380bc9b6b7d92c9855acd">SetTlsValue()</a> 同等の TLS 値の設定</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_thread_local_storage.html#aa9d098d190edf02f04578834a5ca09bd">GetValue</a>
      </td>
      <td>TLS 値を取得</td>
      <td>
        <a href="../../../Api/HtmlNX/namespacenn_1_1os.html#a452445507fba4dc49cb9cfb77b4c88c1">GetTlsValue()</a> 同等の TLS 値の取得</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_thread_local_storage.html#ad65db1ac77dfa70a6286b07de2fa287c">GetTlsSlot</a>
      </td>
      <td>自インスタンスの取得</td>
      <td>自インスタンスで持つ <a href="../../../Api/HtmlNX/structnn_1_1os_1_1_tls_slot.html">TlsSlot</a> オブジェクトを返す</td>
    </tr>
  </tbody>
</table>
<p>&nbsp;</p>
<h2 id="Anchor_83956148_h2_2">ThreadLocalStorage クラスの利用シーン</h2>
<p>そもそも TLS は、１つの TLS スロット獲得によって、全スレッドでその TLS スロットに対する値の設定／獲得を行なうことができます。そのため、<a href="../../../Api/HtmlNX/classnn_1_1os_1_1_thread_local_storage.html">ThreadLocalStorage</a> クラスのインスタンスはグローバルに１つだけ存在すればよいことになります。</p>
<p>通常は、上記のような背景から、各用途ごとにグローバルに１つだけ存在する静的オブジェクトとして <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_thread_local_storage.html">ThreadLocalStorage</a> クラスを利用することを想定しています。</p>
<p>&nbsp;</p>
<h2 id="Anchor_83956148_h2_3">ThreadLocalStorage&nbsp;クラスの使用例</h2>
<p>ユーザが独自に作成するクラスのメンバ変数として&nbsp;<a href="../../../Api/HtmlNX/classnn_1_1os_1_1_thread_local_storage.html">ThreadLocalStorage</a> クラスを使用する例を示します。</p>
<h3 id="Anchor_83956148_h3_1">単純な値の設定と取得</h3>
<p>ここでは例として、スレッド固有のカウンタ機能のクラスを実装します。</p>
<table class="codeblock">
  <tbody>
    <tr>
      <td class="code">
        <div class="codeblock"><pre><span class="cp">#include &lt;nn/os.h&gt;
</span>
<span class="k">class</span> <span class="nc">ThreadSpecificCounter</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">uintptr_t</span> <span class="n">Get</span><span class="p">()</span> <span class="k">const</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="k">return</span> <span class="n">m_Tls</span><span class="p">.</span><span class="n">GetValue</span><span class="p">();</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">void</span> <span class="n">Increment</span><span class="p">()</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">m_Tls</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span> <span class="n">Get</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">);</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="nn">nn::os::</span><span class="n">ThreadLocalStorage</span>  <span class="n">m_Tls</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">ThreadSpecificCounter</span>   <span class="n">g_ThreadSpecificCounter</span><span class="p">;</span></pre></div>
      </td>
    </tr>
  </tbody>
</table>
<p>&nbsp;</p>
<p>この ThreadSpecificCounter クラスは、前述のようにグローバルに１つだけインスタンスを構築して使用することを想定しています。</p>
<p>Increment() メソッドでカウンタをインクリメントし、Get() メソッドで現在のカウンタ値を取得することができます。このカウンタは、呼出すスレッドによって固有のカウンタ値を TLS で保持しているため、スレッド間でカウンタ値同士が干渉することはありません。つまり、カウンタ値は各スレッド毎に異なる値が保持されます。</p>
<p>このように、スレッド毎に異なるワーク領域を同一の手続きで干渉させずにアクセスしたい場合に TLS は有用です。</p>
<p>&nbsp;</p>
<h2 id="Anchor_83956148_h2_4">ThreadLocalStorage クラス使用上の注意事項</h2>
<h3 id="Anchor_83956148_h3_2">TLS リソースの上限</h3>
<p>作成できるスレッドローカルストレージの数には上限があります。</p>
<p>
  <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_thread_local_storage.html">ThreadLocalStorage</a> クラスは内部で <a href="../../../Api/HtmlNX/namespacenn_1_1os.html#a2a67ebeb78e5d624b45ec27d66bdf0b2">nn::os::AllocateTlsSlot()</a> を使って TLS スロットを確保するため、<a href="../../../Api/HtmlNX/classnn_1_1os_1_1_thread_local_storage.html">ThreadLocalStorage</a> クラスで確保できる TLS スロット数の上限値は <a href="../../../Api/HtmlNX/namespacenn_1_1os.html#a2a67ebeb78e5d624b45ec27d66bdf0b2">nn::os::AllocateTlsSlot()</a> のスロット数上限値と同じく <a class="external-link" href="../../../Api/HtmlNX/namespacenn_1_1os.html#a59fab4470b957077f8605c71502c9f2f" rel="nofollow">nn::os::TlsSlotCountMax</a> で示されます。</p>
<p>この上限を超えて <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_thread_local_storage.html">ThreadLocalStorage</a> クラスをインスタンス化すると、コンストラクタの中で Abort で停止します。このような状況に陥らないようにするためにも、前述のように <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_thread_local_storage.html">ThreadLocalStorage</a> クラスは静的なオブジェクトとして使用し、動的にインスタンス化するような使い方は推奨されません。</p>
<h3 id="Anchor_83956148_h3_3">ThreadLocalStorage クラスのコンストラクタ起動タイミング</h3>
<p>
  <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_thread_local_storage.html">ThreadLocalStorage</a> クラスを静的なオブジェクトとして配置した場合、そのコンストラクタは nnMain() 関数が呼ばれる前に起動され、その時点で TLS スロットが確保されます。</p>
<p>一方、この <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_thread_local_storage.html">ThreadLocalStorage</a> クラスと同様に、何らかの静的オブジェクトのコンストラクタでスレッド生成を行なった場合、このスレッド生成と先程の TLS スロット確保はどちらが先に行なわれるかは不定です。これは、静的オブジェクトのコンストラクタの呼出し順が不定だからです。</p>
<p>このような状況の中で、スレッドの中で <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_thread_local_storage.html">ThreadLocalStorage</a> クラスの <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_thread_local_storage.html#aa9d098d190edf02f04578834a5ca09bd">GetValue()</a> や <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_thread_local_storage.html#a6c7417cb688d7ca220ba44efcb79f142">SetValue()</a> 関数にアクセスすると、TLS スロットが確保されていない状況で TLS にアクセスしてしまい、結果的に OS ライブラリ内部のアサートに失敗することとなります。</p>
<p>そのため、静的オブジェクトのコンストラクタでスレッド生成を行なう場合は TLS にアクセスしないようにしたり、もしくは、nnMain() 到達後にスレッド生成を行なうなどして、上記のような状況が起きないように留意して下さい。</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
</div>
<div class="breadcrumb_bottom"></div>
<div class="page_navigation">
<table class="page_navi_root">
<tr>
<td class="page_navi_left"></td>
<td class="page_navi_right"></td>
</tr>
<tr><td colspan="2" class="page_navi_bottom"></td></tr>
</table>
</div>
</div>
</div>
</body>
</html>
