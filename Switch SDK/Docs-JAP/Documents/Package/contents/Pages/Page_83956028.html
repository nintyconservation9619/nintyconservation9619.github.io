<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<script type="text/javascript" src="../template/js/jquery/jquery.js"></script>
<script type="text/javascript" src="../template/js/common/manualLib.js"></script>
<script type="text/javascript" src="../tocData.js"></script>
<link rel="stylesheet" type="text/css" href="../template/css/template.css" />
<title>Mutex クラス</title>
</head>
<body data-reassemble="autoindex=no,forceNoLabel=yes">
<div id="autoindex_content">
<div class="body_content">
<noscript>
<div style="border: 4px double black; margin: 4px; padding: 2px; font-weight: bold; background-color: #FFFFCC;">
<p>お使いのブラウザは JavaScript が使用できないため、本ドキュメントの一部機能が無効になっています。</p><p>JavaScript が無効の環境では目次を使用することができません。<br />JavaScriptの実行が許可された状態で閲覧してください。<br /><br /></p>
</div>
</noscript>
<div class="page_navigation_top">
<table class="page_navi_root">
<tr>
<td class="page_navi_left"></td>
<td class="page_navi_right"></td>
</tr>
</table>
</div>
<div class="breadcrumb"></div>

<!-- Mutex クラス -->
<div class="pagetitle" id="PageId_83956028">Mutex クラス</div>
<div class="text_separate">
<p>
  <ul class="macro_toc">
    <li>
      <a href="#Anchor_83956028_h1_1">Mutex クラス</a>
    </li>
    <ul>
      <li>
        <a href="#Anchor_83956028_h2_1">機能概要</a>
      </li>
      <li>
        <a href="#Anchor_83956028_h2_2">Mutex クラスの使用例</a>
      </li>
      <li>
        <a href="#Anchor_83956028_h2_3">std::lock_guard での利用</a>
      </li>
      <li>
        <a href="#Anchor_83956028_h2_4">Mutex クラス使用上の注意事項</a>
      </li>
      <ul>
        <li>
          <a href="#Anchor_83956028_h3_1">ロックレベル機能について</a>
        </li>
      </ul>
    </ul>
  </ul>
</p>
<h1 id="Anchor_83956028_h1_1">Mutex クラス</h1>
<h2 id="Anchor_83956028_h2_1">機能概要</h2>
<p>
  <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_mutex.html">Mutex</a> クラスは、複数<a href="../Pages/Page_83955697.html">スレッド</a>間で使用する共有リソースを排他制御するための同期機能です。<br />プログラムの特定の箇所において、複数のスレッドからの同時実行を抑制し、リソースが同時に複数のスレッドからアクセスされないようにします。</p>
<p>
  <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_mutex.html">Mutex</a> クラスは、<a href="../../../Api/HtmlNX/structnn_1_1os_1_1_mutex_type.html">nn::os::MutexType</a> オブジェクトを利用した <a href="../Pages/Page_83955800.html">ミューテックス機能</a> をラッピングしたもので以下のメンバ関数を持ちます。API リファレンスはリンク先を参照して下さい。</p>
<table class="table">
  <tbody>
    <tr>
      <th>名前</th>
      <th>説明</th>
      <th>備考</th>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_mutex.html#a74d0a167cb838c2d6c7929f7f4da2bac">Mutex</a>
      </td>
      <td>コンストラクタ</td>
      <td>
        <a href="../../../Api/HtmlNX/namespacenn_1_1os.html#a8d0a550df15490a884932a062dc26533">InitializeMutex()</a> 同等の初期化を実行</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_mutex.html#a6adb6927fa6324214ed568bccd270ada">~Mutex</a>
      </td>
      <td>デストラクタ</td>
      <td>
        <a href="../../../Api/HtmlNX/namespacenn_1_1os.html#a8ce43d38754bf3049ab8d60b9d9e0046">FinalizeMutex()</a> 同等の破棄を実行</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_mutex.html#a8a3082a5a4f31f639ba51fb3f2b044eb">Lock</a>
      </td>
      <td>ロックを取得する</td>
      <td>
        <a href="../../../Api/HtmlNX/namespacenn_1_1os.html#a8d4678856d87c3faea21f47ced342bb6">LockMutex()</a> 同等のロックを実行</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_mutex.html#aa41a772a84f70c3c684031564368c169">TryLock</a>
      </td>
      <td>ロックの取得を試みる</td>
      <td>
        <a href="../../../Api/HtmlNX/namespacenn_1_1os.html#af32963cc501eefcb10a0ebb993080b9f">TryLockMutex()</a> 同等のロックを試行</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_mutex.html#a8f421c40740a957ae8011dc2713f9e4e">Unlock</a>
      </td>
      <td>ロックを手放す</td>
      <td>
        <a href="../../../Api/HtmlNX/namespacenn_1_1os.html#aa661a7036a18c378a694ad67941cd75e">UnlockMutex()</a> 同等のアンロックを実行</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_mutex.html#a6701cd89b8ea896e18f2613d982dd110">lock</a>
      </td>
      <td>ロックを取得する</td>
      <td>Lock と等価</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_mutex.html#a5f7ade45057b283416f7d401eaa38ff1">try_lock</a>
      </td>
      <td>ロックの取得を試みる</td>
      <td>TryLock と等価</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_mutex.html#a398a0109fc604211f06d48c2b4018812">unlock</a>
      </td>
      <td>ロックを手放す</td>
      <td>Unlock と等価</td>
    </tr>
  </tbody>
</table>
<p>&nbsp;</p>
<p>コンストラクタでは、再帰ロックの可否 と ロックレベル値 を指定することが出来ます。それぞれの機能詳細は<a href="../Pages/Page_83955800.html">ミューテックス機能</a>を参照して下さい。</p>
<p>また、<a href="../../../Api/HtmlNX/classnn_1_1os_1_1_mutex.html">Mutex</a> クラスは C++ 標準の BasicLockable 要件と Lockable 要件を満たしているため、std::lock_guard や std::unique_lock などのクラステンプレートの型引数とすることができます。これらについても使用方法を後述します。</p>
<p>&nbsp;</p>
<h2 id="Anchor_83956028_h2_2">Mutex クラスの使用例</h2>
<p>多くのケースでは、以下のように何かしらのクラスのメンバ変数として <a href="../../../Api/HtmlNX/classnn_1_1os_1_1_mutex.html">Mutex</a> クラスを利用します。下記の Counter クラスでは、スレッドセーフにインクリメント／デクリメントできるカウンター機能を提供します。</p>
<table class="codeblock">
  <tbody>
    <tr>
      <td class="code">
        <div class="codeblock"><pre><span class="cp">#include &lt;nn/os.h&gt;
</span>
<span class="k">class</span> <span class="nc">Counter</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// コンストラクタで Mutex クラスを再帰ロック不可で初期化する
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Counter</span><span class="p">()</span> <span class="o">:</span> <span class="n">m_Counter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">m_Mutex</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="p">{}</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">void</span> <span class="n">Increment</span><span class="p">()</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">m_Mutex</span><span class="p">.</span><span class="n">Lock</span><span class="p">();</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="o">++</span><span class="n">m_Counter</span><span class="p">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">m_Mutex</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">void</span> <span class="n">Decrement</span><span class="p">()</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">m_Mutex</span><span class="p">.</span><span class="n">Lock</span><span class="p">();</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="o">--</span><span class="n">m_Counter</span><span class="p">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">m_Mutex</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>
&nbsp;&nbsp;&nbsp; <span class="p">}</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">int</span> <span class="n">Get</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_Counter</span><span class="p">;</span> <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">int</span>             <span class="n">m_Counter</span><span class="p">;</span>
 &nbsp; &nbsp;<span class="nn">nn::os::</span><span class="n">Mutex</span>   <span class="n">m_Mutex</span><span class="p">;</span>
<span class="p">};</span></pre></div>
      </td>
    </tr>
  </tbody>
</table>
<p>&nbsp;</p>
<p>まず、Counter クラスのコンストラクタで m_Mutex( false ) として、<a href="../../../Api/HtmlNX/classnn_1_1os_1_1_mutex.html">Mutex</a> クラスのインスタンスを再帰ロック不可で初期化しています。</p>
<p>Increment() および Decrement() メンバ関数では、m_Mutex のロックを獲得した上で m_Counter 変数をインクリメントもしくはデクリメントしています。そのため、これらのメンバ関数が複数のスレッドから同時に呼ばれたとしても m_Counter 変数が同時にアクセスされることはありません。</p>
<p>&nbsp;</p>
<h2 id="Anchor_83956028_h2_3">std::lock_guard での利用</h2>
<p>C++ 標準ライブラリの std::lock_guard などを利用することで、上記の Increment() や Decrement() 内部のロック区間をより安全に記述することが出来ます。以下に例を示します。</p>
<table class="codeblock">
  <tbody>
    <tr>
      <td class="code">
        <div class="codeblock"><pre><span class="cp">#include &lt;mutex&gt;
#include &lt;nn/os.h&gt;
</span>
<span class="k">class</span> <span class="nc">Counter</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// コンストラクタで Mutex クラスを再帰ロック不可で初期化する
</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="n">Counter</span><span class="p">()</span> <span class="o">:</span> <span class="n">m_Counter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">m_Mutex</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="p">{}</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">void</span> <span class="n">Increment</span><span class="p">()</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="nn">std::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="nn">nn::os::</span><span class="n">Mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span> <span class="n">m_Mutex</span> <span class="p">);</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="o">++</span><span class="n">m_Counter</span><span class="p">;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">}</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">void</span> <span class="n">Decrement</span><span class="p">()</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="p">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="nn">std::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="nn">nn::os::</span><span class="n">Mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span> <span class="n">m_Mutex</span> <span class="p">);</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="o">--</span><span class="n">m_Counter</span><span class="p">;</span>
&nbsp;&nbsp;&nbsp; <span class="p">}</span>

&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">int</span> <span class="n">Get</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_Counter</span><span class="p">;</span> <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kt">int</span>             <span class="n">m_Counter</span><span class="p">;</span>
 &nbsp; &nbsp;<span class="nn">nn::os::</span><span class="n">Mutex</span>   <span class="n">m_Mutex</span><span class="p">;</span>
<span class="p">};</span></pre></div>
      </td>
    </tr>
  </tbody>
</table>
<p>このような手法は Scoped Locking Pattern として知られるものです。上記の場合、std::lock_guard&lt;&gt; が記載されたブロックスコープの先頭で m_Mutex.Lock() <code>&nbsp;</code>を呼び出し、同ブロックスコープを抜ける際に m_Mutex.Unlock() が確実に呼び出されます。</p>
<p>&nbsp;</p>
<h2 id="Anchor_83956028_h2_4">Mutex クラス使用上の注意事項</h2>
<h3 id="Anchor_83956028_h3_1">ロックレベル機能について</h3>
<p>ロックレベル機能は、Release ビルド版では無効になるため、どのようなパラメータを指定しても、ロックレベル値のチェックは行なわれません。<br />ロックレベル機能を使用したい場合は、Debug もしくは Develop ビルド版を使用して下さい。</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
</div>
<div class="breadcrumb_bottom"></div>
<div class="page_navigation">
<table class="page_navi_root">
<tr>
<td class="page_navi_left"></td>
<td class="page_navi_right"></td>
</tr>
<tr><td colspan="2" class="page_navi_bottom"></td></tr>
</table>
</div>
</div>
</div>
</body>
</html>
