<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<script type="text/javascript" src="../template/js/jquery/jquery.js"></script>
<script type="text/javascript" src="../template/js/common/manualLib.js"></script>
<script type="text/javascript" src="../tocData.js"></script>
<link rel="stylesheet" type="text/css" href="../template/css/template.css" />
<title>StandardAllocator</title>
</head>
<body data-reassemble="autoindex=no,forceNoLabel=yes">
<div id="autoindex_content">
<div class="body_content">
<noscript>
<div style="border: 4px double black; margin: 4px; padding: 2px; font-weight: bold; background-color: #FFFFCC;">
<p>お使いのブラウザは JavaScript が使用できないため、本ドキュメントの一部機能が無効になっています。</p><p>JavaScript が無効の環境では目次を使用することができません。<br />JavaScriptの実行が許可された状態で閲覧してください。<br /><br /></p>
</div>
</noscript>
<div class="page_navigation_top">
<table class="page_navi_root">
<tr>
<td class="page_navi_left"></td>
<td class="page_navi_right"></td>
</tr>
</table>
</div>
<div class="breadcrumb"></div>

<!-- StandardAllocator -->
<div class="pagetitle" id="PageId_89102552">StandardAllocator</div>
<div class="text_separate">
<h1 id="Anchor_89102552_h1_1">StandardAllocator クラス</h1>
<h2 id="Anchor_89102552_h2_1">機能概要</h2>
<p>
  <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html">StandardAllocator</a>&nbsp;クラスは、メモリ領域の確保・解放などを行うためのクラスです。<br />従来のヒープに比べて高速に確保・解放を行うことが可能です。&nbsp;</p>
<p>
  <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html">StandardAllocator</a>&nbsp;クラスは以下のメンバ関数を持ちます。API リファレンスはリンク先を参照して下さい。</p>
<table class="wrapped" style="margin-left: 1.5em;">
  <colgroup>
    <col />
    <col />
  </colgroup>
  <tbody>
    <tr>
      <th>名前</th>
      <th>説明</th>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#a1e3efc1b684befdaa9d3ea4c08fc8c23">StandardAllocator</a>
      </td>
      <td>コンストラクタです。</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#a254da7aa9f98eb4947ce540c28727644">~StandardAllocator</a>
      </td>
      <td>デストラクタです。</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#acdb0dd01602811a4f469c87c348d3ed1">Initialize</a>
      </td>
      <td>指定されたメモリ領域を StandardAllocator で管理するために初期化します。</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#a6027bb6b016064edb1b007651d4af419">Finalize</a>
      </td>
      <td>アロケータを破棄します。</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#a53438b7a6199e4f100c59312d2f123cf">Allocate</a>
      </td>
      <td>メモリ領域を確保します。</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#ad81377b59c5e1532869b003cd9b5f318">Free</a>
      </td>
      <td>メモリ領域を解放します。</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#a83b6984b5dac190453d450e819041633">Reallocate</a>
      </td>
      <td>メモリ領域を指定したサイズで再確保します。</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#a2b942ec23f715b66f82c02150727fa08">ClearThreadCache</a>
      </td>
      <td>特定スレッド用にキャッシュしている空き領域を全てのスレッドが利用可能になるよう解放します。</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#a4e443e003b9edca4c62b6b0d3d8f7789">GetSizeOf</a>
      </td>
      <td>指定した確保済みメモリ領域のサイズを取得します。</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#a4f5539e8107b96f97d03624e3242ba6d">GetTotalFreeSize</a>
      </td>
      <td>
        <span style="color: rgb(85,85,85);">アロケータに存在する空き領域の合計を取得します。</span>
      </td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#a6ca06504f3ad359031dcfa2366196667">GetAllocatableSize</a>
      </td>
      <td>
        <span style="color: rgb(85,85,85);">アロケータから確保可能な最大サイズを取得します。</span>
      </td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#abd4e60ea1cc7efdaee8f52f0adb219cc">WalkAllocatedBlocks</a>
      </td>
      <td>確保されたメモリ領域に対して順にコールバック関数を呼び出します。</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#a39125dc68305a2d071ee64e1cf8f1879">Dump</a>
      </td>
      <td>アロケータ内部の情報を表示します。</td>
    </tr>
    <tr>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#abb0b274025674ce0d91668b0d5d2e1b5">Hash</a>
      </td>
      <td>アロケータの内部の情報を基にハッシュを生成します。</td>
    </tr>
  </tbody>
</table>
<h2 id="Anchor_89102552_h2_2">StandardAllocator の使用方法</h2>
<p>まず始めに&nbsp;<a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html">StandardAllocator</a>&nbsp;を初期化します。<br />静的配列を与えて初期化した場合、与えたメモリ領域を StandardAllocator で管理します。</p>
<p>静的配列を与えず、nullptr を与えて初期化した場合、StandardAllocator 内部で仮想アドレスメモリ機能を使い、必要な物理メモリを動的に割り当て、解除して利用します。仮想アドレスメモリを利用する際には .nmeta の設定が必要です。詳細は <a href="../Pages/Page_83956147.html">メモリ管理</a> を参照してください。</p>
<p>以下の例では静的配列をメモリ領域として与えています。<br />StandardAllocator に静的配列を与える場合、 <span class="ApiLink_NN_ALIGNAS">NN_ALIGNAS</span> マクロを利用し 4 KiB アライメントしておくと StandardAllocator 内で領域を無駄なく利用することができます。</p>
<table class="codeblock">
  <tbody>
    <tr>
      <td class="code">
        <div class="codeblock"><pre><span class="cp">#include &lt;nn/mem.h&gt;
</span>
<span class="c1">// 例として、 32MiB の領域を　StandardAllocator に与える
</span><span class="k">const</span> <span class="kt">size_t</span> <span class="n">MemoryHeapSize</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
<span class="c1">// 4 KiB アライメントしておくと StandardAllocator 内で領域を無駄なく利用することができる
</span><span class="n">NN_ALIGNAS</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span> <span class="k">static</span> <span class="kt">char</span> <span class="n">heap</span><span class="p">[</span><span class="n">MemoryHeapSize</span><span class="p">];</span>
 
<span class="nn">nn::mem::</span><span class="n">StandardAllocator</span> <span class="n">allocator</span><span class="p">;</span>
<span class="n">allocator</span><span class="p">.</span><span class="n">Initialize</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">heap</span><span class="p">),</span> <span class="n">MemoryHeapSize</span><span class="p">);</span></pre></div>
      </td>
    </tr>
  </tbody>
</table>
<p>
  <br />
</p>
<p>以下の例では仮想アドレスメモリ機能を利用します。</p>
<table class="codeblock">
  <tbody>
    <tr>
      <td class="code">
        <div class="codeblock"><pre><span class="cp">#include &lt;nn/mem.h&gt;
</span>
<span class="c1">// 例として、4GiB の仮想アドレス空間を利用する
</span><span class="k">const</span> <span class="kt">size_t</span> <span class="n">HeapRegisonSize</span> <span class="o">=</span> <span class="mi">4ull</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
 
<span class="nn">nn::mem::</span><span class="n">StandardAllocator</span> <span class="n">allocator</span><span class="p">;</span>
<span class="n">allocator</span><span class="p">.</span><span class="n">Initialize</span><span class="p">(</span><span class="k">nullptr</span><span class="p">,</span> <span class="n">HeapRegisonSize</span><span class="p">);</span></pre></div>
      </td>
    </tr>
  </tbody>
</table>
<p>
  <br />
</p>
<p>初期化後、メモリの確保・解放などが行えます。</p>
<table class="codeblock">
  <tbody>
    <tr>
      <td class="code">
        <div class="codeblock"><pre><span class="c1">// 例として、64 Bytes の領域を確保
</span><span class="kt">void</span><span class="o">*</span> <span class="n">address</span> <span class="o">=</span> <span class="n">allocator</span><span class="p">.</span><span class="n">Allocate</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
<span class="p">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// メモリの確保に失敗
</span><span class="p">}</span>
 
<span class="c1">// 例として、64 Bytes の領域を 4KiB アライメントで確保
</span><span class="kt">void</span><span class="o">*</span> <span class="n">alignedAddress</span> <span class="o">=</span> <span class="n">allocator</span><span class="p">.</span><span class="n">Allocate</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
<span class="p">{</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="c1">// メモリの確保に失敗
</span><span class="p">}</span>
 
<span class="c1">// メモリを解放
</span><span class="n">allocator</span><span class="p">.</span><span class="n">Free</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
<span class="n">allocator</span><span class="p">.</span><span class="n">Free</span><span class="p">(</span><span class="n">alignedAddress</span><span class="p">);</span></pre></div>
      </td>
    </tr>
  </tbody>
</table>
<p>
  <br />
</p>
<p>StandardAllocator の利用を終了する場合は <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#a6027bb6b016064edb1b007651d4af419">Finalize()</a> を呼び出してアロケータを破棄してください。</p>
<table class="codeblock">
  <tbody>
    <tr>
      <td class="code">
        <div class="codeblock"><pre><span class="n">allocator</span><span class="p">.</span><span class="n">Finalize</span><span class="p">();</span></pre></div>
      </td>
    </tr>
  </tbody>
</table>
<p>
  <br />
</p>
<p>その他の機能については関数リファレンスを参照して下さい。</p>
<h2 id="Anchor_89102552_h2_3">Dump フォーマット</h2>
<p>
  <span style="color: rgb(51,51,51);">
    <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#a39125dc68305a2d071ee64e1cf8f1879">Dump()</a>&nbsp;を呼び出した時の</span>
  <span style="color: rgb(85,85,85);">アロケータ内部の情報は以下の XML フォーマットで表示されます。</span>
</p>
<table class="codeblock">
  <tbody>
    <tr>
      <td class="code">
        <div class="codeblock"><pre><span class="nt">&lt;heapinfo&gt;</span>
&nbsp;<span class="nt">&lt;total_pages&gt;</span>65536<span class="nt">&lt;/total_pages&gt;</span>
&nbsp;<span class="nt">&lt;pagesize&gt;</span>4096<span class="nt">&lt;/pagesize&gt;</span>
&nbsp;<span class="nt">&lt;max_allocatable_size&gt;</span>266780672<span class="nt">&lt;/max_allocatable_size&gt;</span>
&nbsp;<span class="nt">&lt;free_memory&gt;</span>266784760<span class="nt">&lt;/free_memory&gt;</span>
&nbsp;<span class="nt">&lt;system_memory&gt;</span>602112<span class="nt">&lt;/system_memory&gt;</span>
&nbsp;<span class="nt">&lt;allocated_memory&gt;</span>1048584<span class="nt">&lt;/allocated_memory&gt;</span>
&nbsp;<span class="nt">&lt;page_summary&gt;</span>+______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________@<span class="nt">&lt;/page_summary&gt;</span>
&nbsp;<span class="nt">&lt;spans&gt;</span>
&nbsp;&nbsp;<span class="nt">&lt;span</span> <span class="na">start=</span><span class="s">'252c2800000'</span> <span class="na">numPages=</span><span class="s">'145'</span> <span class="na">cls=</span><span class="s">'0'</span> <span class="na">status=</span><span class="s">'in_use_sys'</span><span class="nt">/&gt;</span>
&nbsp;&nbsp;<span class="nt">&lt;span</span> <span class="na">start=</span><span class="s">'252c2891000'</span> <span class="na">numPages=</span><span class="s">'1'</span> <span class="na">cls=</span><span class="s">'0'</span> <span class="na">status=</span><span class="s">'in_use_sys'</span><span class="nt">/&gt;</span>
&nbsp;&nbsp;<span class="nt">&lt;span</span> <span class="na">start=</span><span class="s">'252c2892000'</span> <span class="na">numPages=</span><span class="s">'1'</span> <span class="na">cls=</span><span class="s">'0'</span> <span class="na">status=</span><span class="s">'in_use_sys'</span><span class="nt">/&gt;</span>
&nbsp;&nbsp;<span class="nt">&lt;span</span> <span class="na">start=</span><span class="s">'252c2893000'</span> <span class="na">numPages=</span><span class="s">'1'</span> <span class="na">cls=</span><span class="s">'1'</span> <span class="na">status=</span><span class="s">'in_use'</span> <span class="na">objects_count=</span><span class="s">'1'</span><span class="nt">/&gt;</span>
&nbsp;&nbsp;<span class="nt">&lt;span</span> <span class="na">start=</span><span class="s">'252c2894000'</span> <span class="na">numPages=</span><span class="s">'65132'</span> <span class="na">cls=</span><span class="s">'0'</span> <span class="na">status=</span><span class="s">'on_freelist'</span><span class="nt">/&gt;</span>
&nbsp;&nbsp;<span class="nt">&lt;span</span> <span class="na">start=</span><span class="s">'252d2700000'</span> <span class="na">numPages=</span><span class="s">'256'</span> <span class="na">cls=</span><span class="s">'0'</span> <span class="na">status=</span><span class="s">'in_use'</span> <span class="na">color=</span><span class="s">'#000000'</span> <span class="na">name=</span><span class="s">''</span><span class="nt">/&gt;</span>
&nbsp;<span class="nt">&lt;/spans&gt;</span>
&nbsp;<span class="nt">&lt;allocs&gt;</span>
&nbsp;&nbsp;<span class="nt">&lt;alloc</span> <span class="na">ptr=</span><span class="s">'252c2893000'</span> <span class="na">size=</span><span class="s">'8'</span><span class="nt">/&gt;</span>
&nbsp;&nbsp;<span class="nt">&lt;alloc</span> <span class="na">ptr=</span><span class="s">'252d2700000'</span> <span class="na">size=</span><span class="s">'1048576'</span><span class="nt">/&gt;</span>
&nbsp;<span class="nt">&lt;/allocs&gt;</span>
<span class="nt">&lt;/heapinfo&gt;</span></pre></div>
      </td>
    </tr>
  </tbody>
</table>
<p>
  <span style="color: rgb(85,85,85);">
    <span style="color: rgb(51,51,51);">スレッド毎のキャッシュ機能を利用している場合はキャッシュ用として実際の確保回数よりも多くのメモリが確保されるため、 Dump 時に alloc タグで表される確保済み領域が多くなることがあります。</span>
  </span>
</p>
<p>
  <span style="color: rgb(85,85,85);">
    <span style="color: rgb(51,51,51);">以下に各要素の説明を示します。</span>
  </span>
</p>
<table class="wrapped">
  <colgroup>
    <col />
    <col />
  </colgroup>
  <tbody>
    <tr>
      <th>タグ</th>
      <th>説明</th>
    </tr>
    <tr>
      <td>heapinfo</td>
      <td>
        <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_number_line_allocator.html#ae5d998734ed79c7a8fc1401e9ecc740f">Dump()</a>&nbsp;で出力された XML の一番大枠のタグです。</td>
    </tr>
    <tr>
      <td>pagesize</td>
      <td>StandardAllocator 内部でのメモリの管理をする単位です。</td>
    </tr>
    <tr>
      <td>max_allocatable_size</td>
      <td>確保可能な最大サイズです。 <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#a6ca06504f3ad359031dcfa2366196667">GetAllocatableSize()</a>&nbsp; で取得できる値と同じです。</td>
    </tr>
    <tr>
      <td>free_memory</td>
      <td>
        <span style="color: rgb(85,85,85);">空き領域の合計サイズです。<a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#a4f5539e8107b96f97d03624e3242ba6d">GetTotalFreeSize()</a> で取得できる値と同じです。&nbsp;</span>
      </td>
    </tr>
    <tr>
      <td>system_memory</td>
      <td>アロケータの管理領域のサイズです。</td>
    </tr>
    <tr>
      <td>allocated_memory</td>
      <td>確保済み領域の合計サイズです。</td>
    </tr>
    <tr>
      <td>page_summary</td>
      <td>
        <p>アロケータで扱っているメモリ領域の状態を文字列で簡易的に確認できるよう表現したものです。</p>
        <p>1 文字が 1 MiB を表しており、その文字の種類で 1 MiB の何割を確保済みとして利用しているかを表しています。</p>
      </td>
    </tr>
    <tr>
      <td>spans</td>
      <td>アロケータ内の各メモリブロックの集合を表すタグです。</td>
    </tr>
    <tr>
      <td>span</td>
      <td>
        <p>アロケータの状態を pagesize 単位で表します。StandardAllocator ではこの pagesize 単位で区切られた領域を span と呼んでいます。</p>
        <p>start は span の開始アドレスです。</p>
        <p>numPages は span のサイズを pagesize で割った値です。</p>
        <p>in_use は既にアロケータによって使用中であるかどうかを表します。以下の状態の span は 'yes' になります。空き領域の場合は 'no' になります。</p>
        <ul>
          <li>管理領域となっている</li>
          <li>確保済みである</li>
          <li>確保用領域として StandardAllocator が予約している</li>
        </ul>
        <p>cls は span の大きさごとに分けられたクラス番号です。<span style="color: rgb(51,51,51);">通常のユーザが意識する必要はありません。</span></p>
        <p>
          <span style="color: rgb(51,51,51);">objects_count は span の中で実際にユーザに確保されているメモリブロックの数です。</span>
        </p>
        <p>
          <span style="color: rgb(51,51,51);">sys は管理領域か否かを表します。 'yes' ならばその span は管理領域です。</span>
        </p>
        <p>
          <span style="color: rgb(51,51,51);">status は span が以下のどの状態かを表します。</span>
        </p>
        <ul>
          <li>
            <span style="color: rgb(51,51,51);">in_use &hellip; 使用済みである</span>
          </li>
          <li>
            <span style="color: rgb(51,51,51);">on_freelist &hellip; 確保可能である</span>
          </li>
          <li>
            <span style="color: rgb(51,51,51);">not_used &hellip; 確保可能である</span>
          </li>
          <li>
            <span style="color: rgb(51,51,51);">in_use_sys &hellip; 管理領域として使用済みである</span>
          </li>
        </ul>
        <p>
          <span style="color: rgb(51,51,51);">on_freelist と not_used では StandardAllocator 内部での管理状態が異なりますが、ユーザが意識する必要はありません。</span>
        </p>
        <p>
          <span style="color: rgb(51,51,51);">color と name は利用することのない情報です。<span style="color: rgb(51,51,51);">ユーザが意識する必要はありません。</span></span>
        </p>
      </td>
    </tr>
    <tr>
      <td>allocs</td>
      <td>確保済みメモリブロックの集合を表すタグです。スレッド毎のキャッシュ機能を有効にしている場合、キャッシュ済みのメモリブロックもこのタグ内に表されます。</td>
    </tr>
    <tr>
      <td>alloc</td>
      <td>
        <p>確保済みメモリブロックです。</p>
        <p>ptr は確保領域の先頭アドレスです。</p>
        <p>size は確保されたサイズです。</p>
      </td>
    </tr>
  </tbody>
</table>
<p>page_summary タグの各記号は以下の状態を表します。</p>
<table class="wrapped">
  <tbody>
    <tr>
      <th>記号</th>
      <th>意味</th>
    </tr>
    <tr>
      <td>
        <p>_</p>
      </td>
      <td>確保済み領域はない</td>
    </tr>
    <tr>
      <td>.</td>
      <td>0% を超え 12.5% 以下の領域が確保済み</td>
    </tr>
    <tr>
      <td>:</td>
      <td>12.5% を超え 25% 以下の領域が確保済み</td>
    </tr>
    <tr>
      <td>-</td>
      <td>25% を超え 37.5% 以下の領域が確保済み</td>
    </tr>
    <tr>
      <td>=</td>
      <td>37.5% を超え 50% 以下の領域が確保済み</td>
    </tr>
    <tr>
      <td>+</td>
      <td>50% を超え 62.5% 以下の領域が確保済み</td>
    </tr>
    <tr>
      <td>*</td>
      <td>62.5% を超え 75% 以下の領域が確保済み</td>
    </tr>
    <tr>
      <td>#</td>
      <td>75% を超え 87.5% 以下の領域が確保済み</td>
    </tr>
    <tr>
      <td>%</td>
      <td>87.5% を超え 100% 未満の領域が確保済み</td>
    </tr>
    <tr>
      <td>@</td>
      <td>全ての領域が確保済み</td>
    </tr>
  </tbody>
</table>
<h2 id="Anchor_89102552_h2_4">スレッド毎のキャッシュ機能について</h2>
<p>
  <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html">StandardAllocator</a> は <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#acdb0dd01602811a4f469c87c348d3ed1">Initialize()</a> 時もしくはコンストラクタ呼び出し時に isCacheEnable 引数を true にすることでスレッド毎のキャッシュ機能を利用できます。</p>
<p>これはマルチスレッドで StandardAllocator を利用している場合に、スレッド毎に固有のキャッシュを持ちメモリブロックの確保・解放をロックフリーで行うことで速度を向上する機能です。</p>
<p>スレッド毎のキャッシュを管理するため、 TLS スロットを 1 つ消費します。</p>
<p>スレッド毎のキャッシュ機能を有効にした場合、マルチスレッド時の確保・解放速度が 2 倍から 10 倍程度速くなります。どの程度高速になるかは確保・解放パターンに依存します。</p>
<h3 id="Anchor_89102552_h3_1">より詳細な仕様</h3>
<p>以下で示される具体的な数字や挙動は今後の更新により変更される可能性があります。ご注意ください。</p>
<p>あるスレッドで&nbsp;<a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#a53438b7a6199e4f100c59312d2f123cf">Allocate()</a>&nbsp;が呼ばれた時、それが <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html">StandardAllocator</a>&nbsp;が定める基準を超えない小さいサイズの確保要求であった場合、同じサイズのメモリブロックを一定数キャッシュします。</p>
<p>
  <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#ad81377b59c5e1532869b003cd9b5f318">Free()</a> が呼ばれた時は、解放するメモリブロックのサイズが&nbsp;1752Bytes 以下である場合、解放されたメモリブロックは一定期間キャッシュされ、そのスレッドからしか確保ができなくなります。プラットフォームやアドレス空間のサイズによってはこのサイズより大きな領域が解放された場合でもその空間がキャッシュされることもありますが、後述するキャッシュ上限を超えることはありません。</p>
<p>
  <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#a53438b7a6199e4f100c59312d2f123cf">Allocate()</a>&nbsp;時には、キャッシュ済みのメモリブロックから優先的にメモリ確保が行われます。</p>
<p>このキャッシュ済みのメモリは&nbsp;<a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#a39125dc68305a2d071ee64e1cf8f1879">Dump()</a><span style="color: rgb(51,51,51);">&nbsp;時には allocs タグの中に現れます。そのためキャッシュ機能を有効にした<span style="color: rgb(51,51,51);">場合、&nbsp;<a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#a39125dc68305a2d071ee64e1cf8f1879">Dump()</a><span style="color: rgb(51,51,51);">&nbsp;時</span>に実際の&nbsp;<a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#a53438b7a6199e4f100c59312d2f123cf">Allocate()</a>&nbsp;呼び出し回数より多くのメモリブロックが確保済みに見える場合があります。</span></span></p>
<p>各スレッドがキャッシュするメモリブロックの合計サイズには上限があります。この上限は動作時のスレッド数と<span style="color: rgb(51,51,51);">&nbsp;StandardAllocator に与えられたメモリ領域のサイズにより動的に変化しますが、2MiB を超えることはありません。</span></p>
<p>
  <span style="color: rgb(51,51,51);">また、 1 つのスレッドに対するキャッシュの合計サイズが StandardAllocator に与えられたメモリ領域のサイズの 12.5% を上回ることもありません。</span>
</p>
<p>
  <span style="color: rgb(51,51,51);">
    <span style="color: rgb(51,51,51);">キャッシュされたメモリブロックの合計サイズが上限を超えた場合、キャッシュしているメモリブロックのうち、一番占有率が高いサイズのメモリブロックを全てのスレッドが確保できるよう解放します。</span>
  </span>
</p>
<p>
  <span style="color: rgb(51,51,51);">
    <span style="color: rgb(51,51,51);">
      <span style="color: rgb(51,51,51);">例えば 16 Bytes のメモリブロックを 10 個、 64 Bytes のメモリブロックを 3 個、 128Bytes のメモリブロックを 1 個キャッシュしている状態で、キャッシュの上限を越えた場合には、</span>
    </span>
  </span>
  <span style="color: rgb(51,51,51);">16 * 10 = 160, 64 * 3 = 192, 128 * 1 = 128 なので、 64 Bytes のメモリブロック 3 個を<span style="color: rgb(51,51,51);">全てのスレッドが確保できるよう解放します。</span></span>
</p>
<p>
  <span style="color: rgb(51,51,51);">
    <span style="color: rgb(51,51,51);">また別の方法として&nbsp;<a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html#a2b942ec23f715b66f82c02150727fa08">ClearThreadCache()</a> を呼ぶことでキャッシュしている全てのメモリブロックを全てのスレッドが利用可能になるように解放することができます。</span>
  </span>
</p>
<p>
  <span style="color: rgb(51,51,51);">
    <span style="color: rgb(51,51,51);">スレッドが終了した時、そのスレッド用にキャッシュしているメモリブロックは<span style="color: rgb(51,51,51);">全てのスレッドが利用可能になるように</span>解放されます。</span>
  </span>
</p>
<h2 id="Anchor_89102552_h2_5">StandardAllocator&nbsp;使用上の注意事項</h2>
<h3 id="Anchor_89102552_h3_2">ExpHeap の利用</h3>
<p>基本的には確保、解放速度の観点から、&nbsp;<a href="../Pages/Page_89098776.html">ExpHeap</a>&nbsp;より StandardAllocator の利用を推奨しますが、以下のケースに限り&nbsp;<a href="../Pages/Page_89098776.html">ExpHeap</a>&nbsp;の利用を推奨します。</p>
<ul>
  <li>確保した領域を数 KiB の余裕なく使い切る</li>
  <li>ヒープ作成後の確保、解放回数が極端に少ない（数回程度）</li>
</ul>
<h3 id="Anchor_89102552_h3_3">管理領域のサイズについて</h3>
<p>
  <a href="../../../Api/HtmlNX/classnn_1_1mem_1_1_standard_allocator.html">StandardAllocator</a>&nbsp;は、アロケータ全体を管理するための管理領域として最低 16KiB の領域を必要とします。<br />管理するメモリ領域のサイズが大きくなると管理領域も大きくなりますが、以下の表の通り、サイズが大きいほど管理領域の占める割合は少なくなります。</p>
<table class="wrapped">
  <tbody>
    <tr>
      <th>メモリ領域のサイズ</th>
      <th>管理領域のサイズ(64bit)</th>
      <th>管理領域の占める割合</th>
    </tr>
    <tr>
      <td>64KiB</td>
      <td>16KiB</td>
      <td>25%</td>
    </tr>
    <tr>
      <td>2MiB</td>
      <td>20KiB</td>
      <td>0.97%</td>
    </tr>
    <tr>
      <td>1GiB</td>
      <td>2MiB</td>
      <td>
        <p>0.22%</p>
      </td>
    </tr>
  </tbody>
</table>
<p>目安として、 Windows での StandardAllocator 初期化時の管理領域のおおよそサイズの計算式を示します。</p>
<ul>
  <li>32bit 環境の場合：<ul><li>A = 1456 + 5 * (管理するメモリ領域のサイズ / 4096)</li><li>管理領域のサイズ（初期状態） = A を 4096 に切り上げた数 + 8192</li></ul></li>
  <li style="list-style-type: none;">64bit 環境の場合：<ul><li>B =&nbsp;2840 + 9 * (管理するメモリ領域のサイズ / 4096)</li><li>管理領域のサイズ（初期状態） = B を 4096 に切り上げた数 + 8192</li></ul></li>
</ul>
<p>上記のサイズは目安です。メモリの確保状況や<span style="color: rgb(51,51,51);">スレッド毎のキャッシュ機能の有効・無効、</span>プラットフォームによって、管理領域は増減します。</p>
</div>
<div class="breadcrumb_bottom"></div>
<div class="page_navigation">
<table class="page_navi_root">
<tr>
<td class="page_navi_left"></td>
<td class="page_navi_right"></td>
</tr>
<tr><td colspan="2" class="page_navi_bottom"></td></tr>
</table>
</div>
</div>
</div>
<!--AddLink-->
<script>
var NintendoSdkApiRefernce = {
    idMap: {},
    linkRewrite: function ()
    {
        var idMap = NintendoSdkApiRefernce.idMap;
        function rewrite(el)
        {
            var e = idMap[el.className];
            if (e === undefined)
            {
                return;
            }
            var html = '';
            html += '<a href=';
            html += e.url;
            html += ' target="_blank">';
            html += el.innerHTML;
            html += '</a>';
            el.innerHTML = html;
        }
        var apiLinkElems = document.querySelectorAll('span[class*="ApiLink_"]');
        for (var i = 0, n = apiLinkElems.length; i< n; ++i) {
            rewrite(apiLinkElems[i]);
        }
    }
};
function SetUrl( id, url )
{
    NintendoSdkApiRefernce.idMap[id] = { url: url };
}
SetUrl( 'ApiLink_NN_ALIGNAS', '../../../Api/HtmlNX/nn___macro_8h.html#a6ce9d4b07ab8bec971ac8875873615b5' )

NintendoSdkApiRefernce.linkRewrite();
</script>
<!--AddLink-->
</body>
</html>
