<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<script type="text/javascript" src="../template/js/jquery/jquery.js"></script>
<script type="text/javascript" src="../template/js/common/manualLib.js"></script>
<script type="text/javascript" src="../tocData.js"></script>
<link rel="stylesheet" type="text/css" href="../template/css/template.css" />
<title>キャッシュストレージ</title>
</head>
<body data-reassemble="autoindex=no,forceNoLabel=yes">
<div id="autoindex_content">
<div class="body_content">
<noscript>
<div style="border: 4px double black; margin: 4px; padding: 2px; font-weight: bold; background-color: #FFFFCC;">
<p>お使いのブラウザは JavaScript が使用できないため、本ドキュメントの一部機能が無効になっています。</p><p>JavaScript が無効の環境では目次を使用することができません。<br />JavaScriptの実行が許可された状態で閲覧してください。<br /><br /></p>
</div>
</noscript>
<div class="page_navigation_top">
<table class="page_navi_root">
<tr>
<td class="page_navi_left"></td>
<td class="page_navi_right"></td>
</tr>
</table>
</div>
<div class="breadcrumb"></div>

<!-- キャッシュストレージ -->
<div class="pagetitle" id="PageId_224957652">キャッシュストレージ</div>
<div class="text_separate">
<div class="info_new">
  <div class="info_new_left">参考：</div>
  <div class="info_new_right">
    <p>キャッシュストレージ機能を利用するには事前の申請が必要です。任天堂の窓口までご相談ください。</p>
    <p>ご相談の際には次の情報をお知らせください。</p>
    <ul>
      <li>
        <span style="color: rgb(33,33,33);">キャッシュストレージのデータ保存領域サイズとジャーナリング領域サイズ</span>
      </li>
      <li>
        <span style="color: rgb(33,33,33);">データ保存領域サイズ</span>の内訳（各要素の内容、サイズ、要素数）</li>
      <li>一時ストレージに配置することができるデータが含まれていないか</li>
      <li>巻き戻りや先送りされた状態になると支障があるデータが含まれていないか</li>
      <li>ゲーム性を損なわない範囲で圧縮やデータ形式変更などによるサイズの最適化を行ったか</li>
    </ul>
  </div>
</div>
<div class="info_new">
  <div class="info_new_left">参考：</div>
  <div class="info_new_right">
    <p>キャッシュストレージ機能<span style="color: rgb(51,51,51);">は&nbsp;NX Addon 3.1.0 以降で利用できます。</span></p>
  </div>
</div>
<div class="platform_nx">
  <p>1 つのアプリケーションで複数のキャッシュストレージを使用したい場合は、<a href="../Pages/Page_276903214.html">インデックス付きキャッシュストレージ</a> も参照してください。</p>
</div>
<h1 id="Anchor_224957652_h1_1">機能概要</h1>
<p>キャッシュストレージ機能は、アプリケーションが<strong>再生成・再取得可能なデータ</strong>を保存するための領域を提供します。<br /><strong>キャッシュストレージに書き込まれた内容は永続化されますが、アプリケーションの整理・削除時にあわせて削除されます。</strong></p>
<div class="warn_new">
  <div class="warn_new_left">警告：</div>
  <div class="warn_new_right">
    <p>
      <strong>キャッシュストレージは、ユーザにとって重要であるセーブデータを保存するための領域ではありません。削除してもユーザに不利益が無いデータの保存にのみ利用してください。<br />ユーザにとって重要であるセーブデータは <a href="../Pages/Page_107782148.html">ユーザーアカウントセーブデータ</a> に保存してください。&nbsp;</strong>
    </p>
  </div>
</div>
<p>アプリケーションごとに最大 1 つ存在し、ユーザーアカウントには紐づきません。</p>
<p>例えば以下のような目的で使用することを意図した領域です。</p>
<ul style="list-style-type: square;">
  <li>ROM や追加コンテンツより頻繁に更新し独自サーバーなどで配信するゲームリソースデータの保存</li>
  <li>他ユーザが作成しサーバー上にアップロードした、再取得可能な UGC（user-generated-content）の保存</li>
  <li>再生成・再取得可能なデータで、次回のアプリケーション起動時にも残っていると大きなメリットがあるようなデータの保存</li>
</ul>
<p>以下の点が <a href="../Pages/Page_224955140.html">一時ストレージ</a>&nbsp;機能と異なります。</p>
<ul style="list-style-type: square;">
  <li>アプリケーション終了後も永続化される</li>
  <li>
    <strong>アプリケーション整理・削除に伴い削除される</strong>
  </li>
  <li>ジャーナリング機能によるデータ保護、およびそれに伴ってコミット間の書き込み量制限がある</li>
</ul>
<div class="warn_new">
  <div class="warn_new_left">警告：</div>
  <div class="warn_new_right">
    <p>
      <strong>キャッシュストレージの存在と内容が保証されるのは</strong>
      <strong>アプリケーション稼働中のみ</strong>です。<br /><span style="color: rgb(51,51,51);">ユーザーの操作（データの整理、ソフトの消去、セーブデータの消去、micro SDカードの交換）によって任意のタイミングで<strong>削除されたり差し替わったりする可能性があります</strong>。</span></p>
    <p>削除された場合、キャッシュストレージの再作成はアプリケーション起動時にシステムが保証しますが、内容は空になります。<br />キャッシュストレージの内容が残り続けることを前提としたアプリケーションにしないでください。<br />特に、セーブデータとは独立して削除されるため、<strong>キャッシュストレージの内容を前提としたデータをセーブデータに書き込まないようにご注意ください。</strong></p>
    <p>
      <span style="color: rgb(51,51,51);">セーブデータを消去した場合やmicro SDカードを交換した場合は、キャッシュストレージがゲームの進行より先行していたり巻き戻っていたりする可能性があります。<br />キャッシュストレージの内容が巻き戻っていても先行していてもゲームが進行不能にならないようにしてください。</span>
      <strong>
        <br />
      </strong>
    </p>
    <p>
      <strong>必ず、以下のそれぞれの場合において、正しくアプリケーションが動くことをデバッグしてください。</strong>
    </p>
    <ul>
      <li>
        <strong>キャッシュストレージを単独で削除した場合</strong>
        <strong>
          <br />
        </strong>
      </li>
      <li>
        <strong>キャッシュストレージの内容が巻き戻っている場合</strong>
      </li>
      <li>
        <strong>キャッシュストレージの内容が先行している場合<br /></strong>
      </li>
    </ul>
  </div>
</div>
<div class="info_new">
  <div class="info_new_left">参考：</div>
  <div class="info_new_right">
    <p>アプリケーション終了後に残る必要が無いデータの一時保存の目的には、<a href="../Pages/Page_224955140.html">一時ストレージ</a>機能をご利用ください。</p>
  </div>
</div>
<h1 id="Anchor_224957652_h1_2">作成</h1>
<p>nmeta ファイルに以下の要素を記述した状態でアプリケーションを起動すると、システムが自動で作成します。</p>
<p>アプリケーション起動時点で、作成済みであることが保証されます。</p>
<table class="wrapped" style="margin-left: 1.5em;">
  <colgroup>
    <col />
    <col />
    <col />
  </colgroup>
  <tbody>
    <tr>
      <th>項目名</th>
      <th>概要</th>
      <th>補足</th>
    </tr>
    <tr>
      <td>NintendoSdkMeta/Application/CacheStorageSize</td>
      <td>キャッシュストレージのデータ保存領域サイズ</td>
      <td>16KB 単位、48 KB 以上である必要があります。</td>
    </tr>
    <tr>
      <td>NintendoSdkMeta/Application/CacheStorageJournalSize</td>
      <td>キャッシュストレージのジャーナリング領域サイズ</td>
      <td>16KB 単位、48 KB 以上である必要があります。</td>
    </tr>
  </tbody>
</table>
<div class="info_new">
  <div class="info_new_left">参考：</div>
  <div class="info_new_right">
    <p>キャッシュストレージのデータ保存領域サイズとジャーナリング領域サイズの合計が 4000MB 以下である必要があります。</p>
  </div>
</div>
<h2 id="Anchor_224957652_h2_1">設定例</h2>
<table class="codeblock">
  <tbody>
    <tr>
      <td class="code">
        <div class="codeblock"><pre>&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span>?&gt;
&lt;NintendoSdkMeta&gt;
&nbsp;&nbsp;&lt;Core&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;Name&gt;Application&lt;/Name&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;ApplicationId&gt;0x0005000C10000000&lt;/ApplicationId&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;Is64BitInstruction&gt;True&lt;/Is64BitInstruction&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;ProcessAddressSpace&gt;AddressSpace64Bit&lt;/ProcessAddressSpace&gt;
&nbsp;&nbsp;&lt;/Core&gt;
&nbsp;&nbsp;&lt;Application&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;CacheStorageSize&gt;0x0000000003F00000&lt;/CacheStorageSize&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;CacheStorageJournalSize&gt;0x0000000000100000&lt;/CacheStorageJournalSize&gt;
&nbsp;&nbsp;&lt;/Application&gt;
&lt;/NintendoSdkMeta&gt;</pre></div>
      </td>
    </tr>
  </tbody>
</table>
<h1 id="Anchor_224957652_h1_3">マウント・ファイル操作</h1>
<p>
  <span class="ApiLink_nn__fs__MountCacheStorage">nn::fs::MountCacheStorage</span>() でマウントできます。</p>
<p>ファイル操作方法は&nbsp;<a href="../Pages/Page_107782148.html">セーブデータ (NX Addon)</a>&nbsp;と同様です。キャッシュストレージ更新の確定には <span class="ApiLink_nn__fs__Commit">nn::fs::Commit</span>() を使用してください。</p>
<p>NX Addon 5.1.0 未満の SDK では <span class="ApiLink_nn__fs__Commit">nn::fs::Commit</span>() の代わりに <span class="ApiLink_nn__fs__CommitSaveData">nn::fs::CommitSaveData</span>() を利用してください。</p>
<h1 id="Anchor_224957652_h1_4">制限・特性</h1>
<p>制限・特性は&nbsp;<a href="../Pages/Page_107320205.html">セーブデータ</a>&nbsp;および&nbsp;<a href="../Pages/Page_107782148.html">セーブデータ (NX Addon)</a>&nbsp;と同様です。</p>
<h1 id="Anchor_224957652_h1_5">削除</h1>
<p>
  <a href="../Pages/Page_310878092.html">DevMenu&nbsp;のセーブデータ管理</a>から、他のセーブデータと同様に単体削除することができます。</p>
<p>また、HOME メニューの <strong>データ管理＞ソフトの詳細管理＞データの整理</strong> を選んだ場合に削除されます。</p>
<h1 id="Anchor_224957652_h1_6">配置場所</h1>
<p>キャッシュストレージは、基本的に SD カードに配置されます。SD カードが未挿入、または SD カードが容量不足の時には本体保存メモリーに配置されます。</p>
<p>キャッシュストレージの配置先は本体保存メモリーに固定されないため、本体保存メモリーの読み書き速度を期待した使い方は禁止します。<br />記録メディア（本体保存メモリー、SDカード）へのアクセス速度は、読み書き対象の記録メディアの種類によって異なります。また同一のメディアであっても、容量や製品の世代、個体差、経年劣化、データ配置の断片化などによってアクセス速度が異なる場合があります。そのため、キャッシュストレージに対して読み書きを行う際に、アクセス速度に依存した処理を実装した場合、速度の違いによる不具合を招く恐れがあります。それを防ぐために、各記録メディアのアクセス速度に依存しないように処理を実装してください。</p>
<p>キャッシュストレージ機能を使用する場合は、次のようにテストしてください。</p>
<ol>
  <li>開発機を NintendoSDK Firmware for NX 4.0.0-2 以降で初期化する</li>
  <li>開発機に UHS-I 非対応の SD カード（任天堂純正 SD カードなど）を挿入する<br />（任天堂ではユーザーに UHS-I 対応 SD カードの使用をすすめていますが、市場には UHS-I 対応の SD カードでも UHS-I 非対応に相当するアクセス速度の SD カードが存在するためです）</li>
  <li>テスト対象となるアプリケーション（アプリケーション本体、パッチ、追加コンテンツ）を開発機の本体保存メモリーにインストールする</li>
  <li>
    <span style="color: rgb(51,51,51);">
      <a href="../Pages/Page_310879077.html">DevMenu</a>&nbsp;の Debug &gt; FS Speed Emulation Mode で「Slower」を設定し、手順2.でインストールしたアプリケーションを一通りプレイする</span>
    <br />
    <span style="color: rgb(51,51,51);">（アプリケーション初回起動時に SD カードが挿入されている状態により、SD カード上にキャッシュストレージが生成されるようにし、キャッシュストレージに対して定常的に遅めのアクセス速度でアプリケーションの動作を確認します）</span>
  </li>
  <li>
    <span style="color: rgb(51,51,51);">
      <span style="color: rgb(51,51,51);">SD カードを開発機から抜く</span>
      <br />
    </span>
  </li>
  <li>
    <a href="../Pages/Page_310879077.html">DevMenu</a> の Debug &gt; FS Speed Emulation Mode で「Faster」、「Random」にそれぞれ設定し、手順2.でインストールしたアプリケーションを一通りプレイする<br />（アプリケーション起動時に SD カードが挿入されていない状態により、本体保存メモリー上にキャッシュストレージが生成され、キャッシュストレージに対して定常的に速めのアクセス速度とランダムに変動するアクセス速度でアプリケーションの動作を確認します）</li>
</ol>
<h1 id="Anchor_224957652_h1_7">クリーンナップ機能</h1>
<p>SD カードを交換したり、強制電源断による再起動によって、本体に記録のないアプリケーションのキャッシュストレージが SD カード上に存在する場合クリーンナップされます。<br />RunOnTarget や VSI で起動すると、本体に記録のない状態なので、再起動するたびにアプリケーションのキャッシュストレージがクリーンナップされることになってしまいます。</p>
<p>それを回避するため、<strong>開発機ではデフォルトではこのクリーンナップ機能は無効にしています。</strong><br />アプリをインストールして実行したり、ゲームカードから実行したりする際には有効にすることをお勧めします。<br />具体的な有効家の方法は&nbsp;<a href="../Pages/Page_107328760.html#Anchor_107328760_h3_107">開発機の制御／DevMenuCommand</a>&nbsp;の「アプリケーションキャッシュストレージのクリーンナップ制御」をご参照ください。</p>
<h1 id="Anchor_224957652_h1_8">既知の不具合</h1>
<ul>
  <li>
    <span style="color: rgb(51,51,51);">4.x&nbsp;</span>NUP ではキャッシュストレージの拡張を行うことができません。</li>
  <li>5.0.0 NUP では可能になる予定です。</li>
</ul>
<h1 id="Anchor_224957652_h1_9">注意事項</h1>
<p>注意事項のまとめです。</p>
<ul style="list-style-type: square;">
  <li>
    <p style="margin-left: 0.2em;">キャッシュストレージ機能を利用する場合は事前に任天堂の窓口に相談してください。</p>
  </li>
  <li>
    <p style="margin-left: 0.2em;">キャッシュストレージ機能は&nbsp;<span style="color: rgb(51,51,51);">NX Addon 3.1.0 以降で利用できます。</span></p>
  </li>
  <li>
    <p style="margin-left: 0.2em;">セーブデータを保存しないでください。<br />指定したサイズのキャッシュストレージが確保できない場合、アプリケーションは起動できません。必要以上に大きなサイズを指定しないよう注意してください。</p>
  </li>
  <li>
    <p style="margin-left: 0.2em;">以下のそれぞれの場合において、正しくアプリケーションが動くことをデバッグしてください。</p>
    <ul style="list-style-type: square;">
      <li>キャッシュストレージを単独で削除した場合</li>
      <li>キャッシュストレージの内容が巻き戻っている場合</li>
      <li>キャッシュストレージの内容が先行している場合</li>
    </ul>
  </li>
  <li>
    <p style="margin-left: 0.2em;">低速な外部ストレージでもアプリケーションが問題無く動くことを速度エミュレーション機能でデバッグしてください。</p>
  </li>
</ul>
</div>
<div class="breadcrumb_bottom"></div>
<div class="page_navigation">
<table class="page_navi_root">
<tr>
<td class="page_navi_left"></td>
<td class="page_navi_right"></td>
</tr>
<tr><td colspan="2" class="page_navi_bottom"></td></tr>
</table>
</div>
</div>
</div>
<!--AddLink-->
<script>
var NintendoSdkApiRefernce = {
    idMap: {},
    linkRewrite: function ()
    {
        var idMap = NintendoSdkApiRefernce.idMap;
        function rewrite(el)
        {
            var e = idMap[el.className];
            if (e === undefined)
            {
                return;
            }
            var html = '';
            html += '<a href=';
            html += e.url;
            html += ' target="_blank">';
            html += el.innerHTML;
            html += '</a>';
            el.innerHTML = html;
        }
        var apiLinkElems = document.querySelectorAll('span[class*="ApiLink_"]');
        for (var i = 0, n = apiLinkElems.length; i< n; ++i) {
            rewrite(apiLinkElems[i]);
        }
    }
};
function SetUrl( id, url )
{
    NintendoSdkApiRefernce.idMap[id] = { url: url };
}
SetUrl( 'ApiLink_nn__fs__MountCacheStorage', '../../../Api/HtmlNX/namespacenn_1_1fs.html#ab217b088ff86a675d869cc9fb38390ac' )
SetUrl( 'ApiLink_nn__fs__Commit', '../../../Api/HtmlNX/namespacenn_1_1fs.html#ab534529ae3c325863fe1eb34bd03c872' )
SetUrl( 'ApiLink_nn__fs__CommitSaveData', '../../../Api/HtmlNX/namespacenn_1_1fs.html#ac2f25cffd056f24d6facfda13f977fa6' )

NintendoSdkApiRefernce.linkRewrite();
</script>
<!--AddLink-->
</body>
</html>
