<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>NintendoSDK API Reference: Town.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="openclose.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">NintendoSDK API Reference
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 構築: Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'検索');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>総合概要</span></a></li>
      <li><a href="pages.html"><span>諸情報</span></a></li>
      <li><a href="modules.html"><span>モジュール</span></a></li>
      <li><a href="namespaces.html"><span>名前空間</span></a></li>
      <li><a href="annotated.html"><span>クラス</span></a></li>
      <li><a href="files.html"><span>ファイル</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="検索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Town.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>ソースコードの説明は、<a class="el" href="_page_sample_g3d_town.html">G3dDemo Town</a> および <a class="el" href="_town_8cpp.html" title="実際のゲームに近い内容のサンプルプログラム ">Town.cpp</a> を参照してください。</p>
<div class="fragment"><div class="line"><span class="comment">/*--------------------------------------------------------------------------------*</span></div>
<div class="line"><span class="comment">  Copyright (C)Nintendo All rights reserved.</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  These coded instructions, statements, and computer programs contain proprietary</span></div>
<div class="line"><span class="comment">  information of Nintendo and/or its licensed developers and are protected by</span></div>
<div class="line"><span class="comment">  national and international copyright laws. They may not be disclosed to third</span></div>
<div class="line"><span class="comment">  parties or copied or duplicated in any form, in whole or in part, without the</span></div>
<div class="line"><span class="comment">  prior written consent of Nintendo.</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  The content herein is highly confidential and should be handled accordingly.</span></div>
<div class="line"><span class="comment"> *--------------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="preprocessor">#include &quot;g3ddemo_ViewerUtility.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;TextureAverageShader.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Town.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="g3d___viewer_8h.html">nn/g3d/g3d_Viewer.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cfloat&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespacenn_1_1g3d_1_1demo.html">g3ddemo</a> = <a class="code" href="namespacenn_1_1g3d_1_1demo.html">nn::g3d::demo</a>;</div>
<div class="line"></div>
<div class="line">g3ddemo::ResourceHolder         g_Holder;</div>
<div class="line"></div>
<div class="line"><a name="_a0"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html">nns::g3d::RenderView</a>            g_RenderView;</div>
<div class="line"><a name="_a1"></a><a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a>          g_CameraPosition;</div>
<div class="line"><a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a>          g_CameraTarget;</div>
<div class="line"></div>
<div class="line">TownViewer                      g_TownViewer;</div>
<div class="line"><a name="_a2"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_archive.html">nn::g3d::ResShaderArchive</a>*      g_pTownShaderArchive = <span class="keyword">nullptr</span>;</div>
<div class="line"><a class="code" href="classnn_1_1g3d_1_1_res_shader_archive.html">nn::g3d::ResShaderArchive</a>*      g_pTownDemoShaderArchive = <span class="keyword">nullptr</span>;</div>
<div class="line"><a name="_a3"></a><a class="code" href="classnn_1_1g3d_1_1_res_shading_model.html">nn::g3d::ResShadingModel</a>*       g_pResShadingModelPtr[ShadingModelType_Count];</div>
<div class="line"></div>
<div class="line"><span class="keyword">extern</span> <span class="keywordtype">int</span>                      g_SelectedModelIndex;</div>
<div class="line"><span class="keyword">extern</span> <span class="keywordtype">int</span>                      g_SelectedShapeIndex;</div>
<div class="line"><span class="keyword">extern</span> <span class="keywordtype">int</span>                      g_SelectedSubmeshIndex;</div>
<div class="line"><span class="keyword">extern</span> <span class="keywordtype">int</span>                      g_SelectedViewType;</div>
<div class="line"><span class="keyword">extern</span> <span class="keywordtype">int</span>                      g_SelectedFrameBufferType;</div>
<div class="line"><span class="keyword">extern</span> MenuFlagSet              g_MenuFlag;</div>
<div class="line"><span class="keyword">extern</span> <span class="keywordtype">int</span>                      g_InvalidForceLodLevel;</div>
<div class="line"></div>
<div class="line"><span class="keyword">namespace </span>{</div>
<div class="line"></div>
<div class="line"><a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a>          g_CameraUp;</div>
<div class="line"><a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a>          g_LightPosition;</div>
<div class="line"></div>
<div class="line">TownContext                     g_Context;</div>
<div class="line">TextureAverageShader            g_TextureAverageShader;</div>
<div class="line">TownPointLight                  g_PointLight;</div>
<div class="line">g3ddemo::ScreenInfo             g_ScreenInfo;</div>
<div class="line">g3ddemo::BoundingRenderer       g_BoundingRenderer;</div>
<div class="line"><a name="_a4"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html">nn::g3d::ModelObj</a>*              g_pEnvModelObj = <span class="keyword">nullptr</span>;</div>
<div class="line"></div>
<div class="line">nns::gfx::DepthStencilBuffer    g_DepthBufferShadow;</div>
<div class="line">nns::gfx::FrameBuffer           g_FrameBuffer[FrameBufferType_Count];</div>
<div class="line">nns::gfx::ColorBuffer           g_ColorBuffer;</div>
<div class="line"><a name="_a5"></a><a class="code" href="classnn_1_1gfx_1_1_descriptor_slot.html">nn::gfx::DescriptorSlot</a>         g_WaterDescriptorSlot;</div>
<div class="line"><a class="code" href="classnn_1_1gfx_1_1_descriptor_slot.html">nn::gfx::DescriptorSlot</a>         g_DepthDescriptorSlot;</div>
<div class="line"><a class="code" href="classnn_1_1gfx_1_1_descriptor_slot.html">nn::gfx::DescriptorSlot</a>         g_GeometryColorDescriptorSlot;</div>
<div class="line"><a class="code" href="classnn_1_1gfx_1_1_descriptor_slot.html">nn::gfx::DescriptorSlot</a>         g_GeometryDepthDescriptorSlot;</div>
<div class="line"><a class="code" href="classnn_1_1gfx_1_1_descriptor_slot.html">nn::gfx::DescriptorSlot</a>         g_LightDescriptorSlot;</div>
<div class="line"><a class="code" href="classnn_1_1gfx_1_1_descriptor_slot.html">nn::gfx::DescriptorSlot</a>         g_ColorDescriptorSlot;</div>
<div class="line"><a class="code" href="classnn_1_1gfx_1_1_descriptor_slot.html">nn::gfx::DescriptorSlot</a>         g_DebugFrameBufferSamplerDescriptorSlot;</div>
<div class="line"></div>
<div class="line">CalculateLod                    g_CalculateLodDefault;</div>
<div class="line">CalculateLod                    g_CalculateLodWater;</div>
<div class="line"></div>
<div class="line">ViewVolumeRenderer              g_ViewVolumeRenderer;</div>
<div class="line"><a name="_a6"></a><a class="code" href="structnn_1_1util_1_1_matrix_row_major4x4f_type.html">nn::util::Matrix4x4fType</a>        g_InvViewProjectionMatrix;</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span>                             g_FrameCount = 0;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span>                       g_BufferingCount = 2;</div>
<div class="line"></div>
<div class="line"><span class="comment">// 環境テクスチャ</span></div>
<div class="line"><span class="keyword">struct </span>EnvTexture</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* name;</div>
<div class="line">    <a name="_a7"></a><a class="code" href="classnn_1_1g3d_1_1_texture_ref.html">nn::g3d::TextureRef</a> textureRef;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> g_EnvTextureCount = 6;</div>
<div class="line">EnvTexture g_EnvTextures[g_EnvTextureCount];</div>
<div class="line"></div>
<div class="line"><span class="comment">// モデル固有で無いシェーディングモデル名と格納されているアーカイブ名</span></div>
<div class="line"><span class="keyword">struct </span>ShaderName</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* shaderArchiveName;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* shadingModelName;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> ShaderName g_ShaderNameArray[ShadingModelType_Count] = {</div>
<div class="line">    { <span class="stringliteral">&quot;shadow&quot;</span>, <span class="stringliteral">&quot;shadow&quot;</span> },</div>
<div class="line">    { <span class="stringliteral">&quot;gbuffer&quot;</span>, <span class="stringliteral">&quot;gbuffer&quot;</span> },</div>
<div class="line">    { <span class="stringliteral">&quot;tex_average&quot;</span>, <span class="stringliteral">&quot;tex_average&quot;</span> },</div>
<div class="line">    { <span class="stringliteral">&quot;town&quot;</span>, <span class="stringliteral">&quot;town_light&quot;</span> }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// サブメッシュ LOD 計算</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> g_MaxLodLevel = 8;</div>
<div class="line"></div>
<div class="line"><span class="keyword">enum</span> File</div>
<div class="line">{</div>
<div class="line">    File_TownEnv = 0,</div>
<div class="line">    File_WhiteTownWaterCaustics,</div>
<div class="line">    File_WhiteTownWaterFlat,</div>
<div class="line">    File_BgWhiteTown,</div>
<div class="line">    File_Duck,</div>
<div class="line">    File_FemaleA,</div>
<div class="line">    File_Fish,</div>
<div class="line">    File_MaleA,</div>
<div class="line">    File_Light,</div>
<div class="line">    File_Count</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define RESOURCE_PATH &quot;Resource:/&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* BfshaPath[] = {</div>
<div class="line">    RESOURCE_PATH <span class="stringliteral">&quot;shader/demo.bfsha&quot;</span>,  <span class="comment">// 3D Editor 用</span></div>
<div class="line">    RESOURCE_PATH <span class="stringliteral">&quot;shader/town.bfsha&quot;</span>,  <span class="comment">// 3D Editor 用</span></div>
<div class="line">    RESOURCE_PATH <span class="stringliteral">&quot;shader/shadow.bfsha&quot;</span>,</div>
<div class="line">    RESOURCE_PATH <span class="stringliteral">&quot;shader/gbuffer.bfsha&quot;</span>,</div>
<div class="line">    RESOURCE_PATH <span class="stringliteral">&quot;shader/tex_average.bfsha&quot;</span>,</div>
<div class="line">};</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* BfresPath[] = {</div>
<div class="line">    RESOURCE_PATH <span class="stringliteral">&quot;town_env.bfres&quot;</span>,</div>
<div class="line">    RESOURCE_PATH <span class="stringliteral">&quot;WhiteTown_Water_Caustics.bfres&quot;</span>,</div>
<div class="line">    RESOURCE_PATH <span class="stringliteral">&quot;WhiteTown_Water_Flat.bfres&quot;</span>,</div>
<div class="line">    RESOURCE_PATH <span class="stringliteral">&quot;bg_WhiteTown.bfres&quot;</span>,</div>
<div class="line">    RESOURCE_PATH <span class="stringliteral">&quot;Duck.bfres&quot;</span>,</div>
<div class="line">    RESOURCE_PATH <span class="stringliteral">&quot;FemaleA.bfres&quot;</span>,</div>
<div class="line">    RESOURCE_PATH <span class="stringliteral">&quot;Fish.bfres&quot;</span>,</div>
<div class="line">    RESOURCE_PATH <span class="stringliteral">&quot;MaleA.bfres&quot;</span>,</div>
<div class="line">    RESOURCE_PATH <span class="stringliteral">&quot;Light.bfres&quot;</span>,</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">//-------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">//  初期化・終了処理</span></div>
<div class="line"><span class="comment">//-------------------------------------------------------------------</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// 表示情報の初期化</span></div>
<div class="line"><span class="keywordtype">void</span> InitializeScreenInfo(<a name="_a8"></a><a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice) <a name="a9"></a><a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// テキストメニューを初期化</span></div>
<div class="line">    g_ScreenInfo.Initialize(pDevice);</div>
<div class="line">    g_ScreenInfo.SetWindowPosition(16, 16);</div>
<div class="line">    g_ScreenInfo.SetFontSize(20);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// フレームバッファーを初期化</span></div>
<div class="line"><span class="keywordtype">void</span> InitializeFrameBuffer(<a name="_a10"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html">nns::gfx::GraphicsFramework</a>* pGfxFramework, <a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// 水面用フレームバッファーをセットアップ</span></div>
<div class="line">    {</div>
<div class="line">        nns::gfx::FrameBuffer::InfoType info(640, 360);</div>
<div class="line">        info.SetColorBufferFormat(<a name="a11"></a><a class="code" href="namespacenn_1_1gfx.html#ae794c2b6a518a4ae9ada4d3339b87605ac8c99c8d634a1a71ba05e16b6de4536e">nn::gfx::ImageFormat_R11_G11_B10_Float</a>);</div>
<div class="line">        g3ddemo::InitializeFrameBuffer(&amp;g_FrameBuffer[FrameBufferType_Water], &amp;info);</div>
<div class="line">        g_FrameBuffer[FrameBufferType_Water].SetClearColor(0.3f, 0.3f, 0.3f);</div>
<div class="line">        g_WaterDescriptorSlot = g3ddemo::RegisterTextureToDescriptorPool(g_FrameBuffer[FrameBufferType_Water].GetColorBuffer()-&gt;GetTextureView());</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// シャドウ用デプスバッファー初期化</span></div>
<div class="line">    {</div>
<div class="line">        <a name="_a12"></a><a class="code" href="classnn_1_1gfx_1_1_texture_info.html">nn::gfx::Texture::InfoType</a> info;</div>
<div class="line">        info.<a name="a13"></a><a class="code" href="classnn_1_1gfx_1_1_texture_info.html#a7347a6f3179dc816dc7eb761cdc37152">SetDefault</a>();</div>
<div class="line">        info.<a name="a14"></a><a class="code" href="classnn_1_1gfx_1_1_texture_info.html#aa9542aaf7fe4dea102f8ec01188c3227">SetWidth</a>(640);</div>
<div class="line">        info.<a name="a15"></a><a class="code" href="classnn_1_1gfx_1_1_texture_info.html#a2351f69b4b5c3bece70bfc416a74f96a">SetHeight</a>(640);</div>
<div class="line">        info.<a name="a16"></a><a class="code" href="classnn_1_1gfx_1_1_texture_info.html#a214c396c13c6086b75cf63dc374f14ab">SetGpuAccessFlags</a>(<a name="a17"></a><a class="code" href="namespacenn_1_1gfx.html#a24dbcd6d86531138895622b5a854e4f5a1663c5652d151ae04844adb9a3784bea">nn::gfx::GpuAccess_DepthStencil</a> | <a name="a18"></a><a class="code" href="namespacenn_1_1gfx.html#a24dbcd6d86531138895622b5a854e4f5a4a531ae2d7e145f647300ea67bc76ccc">nn::gfx::GpuAccess_Texture</a>);</div>
<div class="line">        info.<a name="a19"></a><a class="code" href="classnn_1_1gfx_1_1_texture_info.html#ac1912ab092b3f1acd897e96ea4eb7ffc">SetImageStorageDimension</a>(<a name="a20"></a><a class="code" href="namespacenn_1_1gfx.html#a52703c69a29adb8ba4cf3d02c6be65d6aeecfd005f00573cce0430313e61bc33e">nn::gfx::ImageStorageDimension_2d</a>);</div>
<div class="line">        info.<a name="a21"></a><a class="code" href="classnn_1_1gfx_1_1_texture_info.html#aabd5c4ee3aaf0dfc3577843da1d8bc1f">SetImageFormat</a>(<a name="a22"></a><a class="code" href="namespacenn_1_1gfx.html#ae794c2b6a518a4ae9ada4d3339b87605a2f64d2e25bf61ef9571b504d2b86a895">nn::gfx::ImageFormat_D32_Float</a>);</div>
<div class="line">        info.<a name="a23"></a><a class="code" href="classnn_1_1gfx_1_1_texture_info.html#a8187f32da9bbbed65c49a1c00932d796">SetMipCount</a>(1);</div>
<div class="line">        info.<a name="a24"></a><a class="code" href="classnn_1_1gfx_1_1_texture_info.html#a1b6439172b5749537b1a6020a2a8b5ec">SetArrayLength</a>(TownContext::cascadeShadowCount);</div>
<div class="line">        <span class="keywordtype">size_t</span> size = <a name="a25"></a><a class="code" href="classnn_1_1gfx_1_1_t_texture.html#ac9d3334566c6451da3f015e5ed1fd1ad">nn::gfx::Texture::CalculateMipDataSize</a>(pDevice, info);</div>
<div class="line">        <span class="keywordtype">size_t</span> align = <a name="a26"></a><a class="code" href="classnn_1_1gfx_1_1_t_texture.html#a6580c829bab613b6e9850e543f9a7203">nn::gfx::Texture::CalculateMipDataAlignment</a>(pDevice, info);</div>
<div class="line">        ptrdiff_t offset = pGfxFramework-&gt;<a name="a27"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#acfe9bb061211e7cea1984525a9391152">AllocatePoolMemory</a>(nns::gfx::GraphicsFramework::MemoryPoolType_RenderTarget, size, align);</div>
<div class="line">        <a name="_a28"></a><a class="code" href="classnn_1_1gfx_1_1_t_memory_pool.html">nn::gfx::MemoryPool</a>* pMemoryPool = pGfxFramework-&gt;<a name="a29"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a9c662e2ac88106a0cb9828ef1e8f0faa">GetMemoryPool</a>(nns::gfx::GraphicsFramework::MemoryPoolType_RenderTarget);</div>
<div class="line">        g_DepthBufferShadow.<a name="a30"></a><a class="code" href="classnn_1_1gfx_1_1_t_memory_pool.html#a59045ae9d58968a0b6448d66f0b4781f">Initialize</a>(pDevice, info, pMemoryPool, offset, size);</div>
<div class="line">        g_DepthDescriptorSlot = g3ddemo::RegisterTextureToDescriptorPool(g_DepthBufferShadow.GetTextureView());</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// シャドウ用フレームバッファー初期化</span></div>
<div class="line">    {</div>
<div class="line">        nns::gfx::FrameBuffer::InfoType info(640, 640);</div>
<div class="line">        info.SetDepthBufferDisabled();</div>
<div class="line">        g3ddemo::InitializeFrameBuffer(&amp;g_FrameBuffer[FrameBufferType_Shadow], &amp;info);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ジオメトリ用フレームバッファー初期化</span></div>
<div class="line">    {</div>
<div class="line">        nns::gfx::FrameBuffer::InfoType info(640, 360);</div>
<div class="line">        info.SetColorBufferFormat(<a class="code" href="namespacenn_1_1gfx.html#ae794c2b6a518a4ae9ada4d3339b87605ac8c99c8d634a1a71ba05e16b6de4536e">nn::gfx::ImageFormat_R11_G11_B10_Float</a>);</div>
<div class="line">        g3ddemo::InitializeFrameBuffer(&amp;g_FrameBuffer[FrameBufferType_Geometry], &amp;info);</div>
<div class="line">        g_GeometryColorDescriptorSlot = g3ddemo::RegisterTextureToDescriptorPool(g_FrameBuffer[FrameBufferType_Geometry].GetColorBuffer()-&gt;GetTextureView());</div>
<div class="line">        g_GeometryDepthDescriptorSlot = g3ddemo::RegisterTextureToDescriptorPool(g_FrameBuffer[FrameBufferType_Geometry].GetDepthBuffer()-&gt;GetTextureView());</div>
<div class="line">        g_FrameBuffer[FrameBufferType_Geometry].SetClearColor(0.3f, 0.3f, 0.3f);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ライト用フレームバッファー初期化</span></div>
<div class="line">    {</div>
<div class="line">        nns::gfx::FrameBuffer::InfoType info(640, 360);</div>
<div class="line">        info.SetColorBufferFormat(<a name="a31"></a><a class="code" href="namespacenn_1_1gfx.html#ae794c2b6a518a4ae9ada4d3339b87605ae9a6f4b8714c06cc877193b5635c8019">nn::gfx::ImageFormat_R8_G8_B8_A8_Unorm</a>);</div>
<div class="line">        info.SetDepthBufferDisabled();</div>
<div class="line">        g3ddemo::InitializeFrameBuffer(&amp;g_FrameBuffer[FrameBufferType_Light], &amp;info);</div>
<div class="line">        g_FrameBuffer[FrameBufferType_Light].SetClearColor(0.0f, 0.0f, 0.0f, 0.0f);</div>
<div class="line">        g_LightDescriptorSlot = g3ddemo::RegisterTextureToDescriptorPool(g_FrameBuffer[FrameBufferType_Light].GetColorBuffer()-&gt;GetTextureView());</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// コピー用カラーバッファー初期化</span></div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnn_1_1gfx_1_1_texture_info.html">nn::gfx::Texture::InfoType</a> info;</div>
<div class="line">        info.<a class="code" href="classnn_1_1gfx_1_1_texture_info.html#a7347a6f3179dc816dc7eb761cdc37152">SetDefault</a>();</div>
<div class="line">        info.<a class="code" href="classnn_1_1gfx_1_1_texture_info.html#aa9542aaf7fe4dea102f8ec01188c3227">SetWidth</a>(pGfxFramework-&gt;<a name="a32"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a68decd5e5c7a89df27eb8d428515e92d">GetDisplayWidth</a>());</div>
<div class="line">        info.<a class="code" href="classnn_1_1gfx_1_1_texture_info.html#a2351f69b4b5c3bece70bfc416a74f96a">SetHeight</a>(pGfxFramework-&gt;<a name="a33"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#af0da71ea5a113a27c596366259db882e">GetDisplayHeight</a>());</div>
<div class="line">        info.<a class="code" href="classnn_1_1gfx_1_1_texture_info.html#a214c396c13c6086b75cf63dc374f14ab">SetGpuAccessFlags</a>(<a class="code" href="namespacenn_1_1gfx.html#a24dbcd6d86531138895622b5a854e4f5a4a531ae2d7e145f647300ea67bc76ccc">nn::gfx::GpuAccess_Texture</a> | <a name="a34"></a><a class="code" href="namespacenn_1_1gfx.html#a24dbcd6d86531138895622b5a854e4f5a0db6d0fe517ccdbde996e7748f0c69f8">nn::gfx::GpuAccess_ColorBuffer</a>);</div>
<div class="line">        info.<a class="code" href="classnn_1_1gfx_1_1_texture_info.html#ac1912ab092b3f1acd897e96ea4eb7ffc">SetImageStorageDimension</a>(<a class="code" href="namespacenn_1_1gfx.html#a52703c69a29adb8ba4cf3d02c6be65d6aeecfd005f00573cce0430313e61bc33e">nn::gfx::ImageStorageDimension_2d</a>);</div>
<div class="line">        info.<a class="code" href="classnn_1_1gfx_1_1_texture_info.html#aabd5c4ee3aaf0dfc3577843da1d8bc1f">SetImageFormat</a>(<a class="code" href="namespacenn_1_1gfx.html#ae794c2b6a518a4ae9ada4d3339b87605ac8c99c8d634a1a71ba05e16b6de4536e">nn::gfx::ImageFormat_R11_G11_B10_Float</a>);</div>
<div class="line">        info.<a class="code" href="classnn_1_1gfx_1_1_texture_info.html#a8187f32da9bbbed65c49a1c00932d796">SetMipCount</a>(1);</div>
<div class="line">        <span class="keywordtype">size_t</span> size = <a class="code" href="classnn_1_1gfx_1_1_t_texture.html#ac9d3334566c6451da3f015e5ed1fd1ad">nn::gfx::Texture::CalculateMipDataSize</a>(pDevice, info);</div>
<div class="line">        <span class="keywordtype">size_t</span> align = <a class="code" href="classnn_1_1gfx_1_1_t_texture.html#a6580c829bab613b6e9850e543f9a7203">nn::gfx::Texture::CalculateMipDataAlignment</a>(pDevice, info);</div>
<div class="line">        ptrdiff_t offset = pGfxFramework-&gt;<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#acfe9bb061211e7cea1984525a9391152">AllocatePoolMemory</a>(nns::gfx::GraphicsFramework::MemoryPoolType_RenderTarget, size, align);</div>
<div class="line">        <a class="code" href="classnn_1_1gfx_1_1_t_memory_pool.html">nn::gfx::MemoryPool</a>* pMemoryPool = pGfxFramework-&gt;<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a9c662e2ac88106a0cb9828ef1e8f0faa">GetMemoryPool</a>(nns::gfx::GraphicsFramework::MemoryPoolType_RenderTarget);</div>
<div class="line">        g_ColorBuffer.<a class="code" href="classnn_1_1gfx_1_1_t_memory_pool.html#a59045ae9d58968a0b6448d66f0b4781f">Initialize</a>(pDevice, info, pMemoryPool, offset, size);</div>
<div class="line">        g_ColorDescriptorSlot = g3ddemo::RegisterTextureToDescriptorPool(g_ColorBuffer.GetTextureView());</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// フレームバッファーのデバッグ描画用サンプラーを取得し、登録</span></div>
<div class="line">    {</div>
<div class="line">        <a name="_a35"></a><a class="code" href="classnn_1_1gfx_1_1_t_sampler.html">nn::gfx::Sampler</a>* pSampler = pGfxFramework-&gt;<a name="a36"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#abafa38f3c2c4064d405b2f1a0eba1b6a">GetSampler</a>(nns::gfx::GraphicsFramework::SamplerType_FilterMode_MinLinear_MagLinear_MipPoint_AddressMode_Clamp);</div>
<div class="line">        <span class="keywordtype">int</span> slot = pGfxFramework-&gt;<a name="a37"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a6d3945456e4bf23c7d3977fd0043b80e">AllocateDescriptorSlot</a>(<a name="a38"></a><a class="code" href="namespacenn_1_1gfx.html#a14fc8bd39227425748a8fb55c035d10ca831f2090660e1269d9440b8095bf004d">nn::gfx::DescriptorPoolType_Sampler</a>, 1);</div>
<div class="line">        pGfxFramework-&gt;<a name="a39"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a91b17754fd4bffccccdf74909f3309a8">SetSamplerToDescriptorPool</a>(slot, pSampler);</div>
<div class="line">        <span class="keywordtype">int</span>* pSlot = g3ddemo::AllocateMemory&lt;int&gt;(<span class="keyword">sizeof</span>(int));</div>
<div class="line">        *pSlot = slot;</div>
<div class="line">        pSampler-&gt;<a name="a40"></a><a class="code" href="classnn_1_1gfx_1_1_t_sampler.html#a4f44162a43dc8df520a4c9482a5d509c">SetUserPtr</a>(pSlot);</div>
<div class="line"></div>
<div class="line">        <a name="_a41"></a><a class="code" href="classnn_1_1gfx_1_1_t_descriptor_pool.html">nn::gfx::DescriptorPool</a>* pSamplerDescriptorPool = pGfxFramework-&gt;<a name="a42"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a63daddc97cda967c1af03780556c3abd">GetDescriptorPool</a>(<a class="code" href="namespacenn_1_1gfx.html#a14fc8bd39227425748a8fb55c035d10ca831f2090660e1269d9440b8095bf004d">nn::gfx::DescriptorPoolType_Sampler</a>);</div>
<div class="line">        pSamplerDescriptorPool-&gt;<a name="a43"></a><a class="code" href="classnn_1_1gfx_1_1_t_descriptor_pool.html#ac2b65342f8057bd6423d99bfa6aa526b">GetDescriptorSlot</a>(&amp;g_DebugFrameBufferSamplerDescriptorSlot, slot);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// EnvTexture の設定</span></div>
<div class="line">    {</div>
<div class="line">        g_EnvTextures[0] = { <span class="stringliteral">&quot;water&quot;</span>, <a class="code" href="classnn_1_1g3d_1_1_texture_ref.html">nn::g3d::TextureRef</a>(g_FrameBuffer[FrameBufferType_Water].GetColorBuffer()-&gt;GetTextureView(), g_WaterDescriptorSlot) };</div>
<div class="line">        g_EnvTextures[1] = { <span class="stringliteral">&quot;shadow&quot;</span>, <a class="code" href="classnn_1_1g3d_1_1_texture_ref.html">nn::g3d::TextureRef</a>(g_DepthBufferShadow.GetTextureView(), g_DepthDescriptorSlot) };</div>
<div class="line">        g_EnvTextures[2] = { <span class="stringliteral">&quot;normal&quot;</span>, <a class="code" href="classnn_1_1g3d_1_1_texture_ref.html">nn::g3d::TextureRef</a>(g_FrameBuffer[FrameBufferType_Geometry].GetColorBuffer()-&gt;GetTextureView(), g_GeometryColorDescriptorSlot) };</div>
<div class="line">        g_EnvTextures[3] = { <span class="stringliteral">&quot;depth&quot;</span>, <a class="code" href="classnn_1_1g3d_1_1_texture_ref.html">nn::g3d::TextureRef</a>(g_FrameBuffer[FrameBufferType_Geometry].GetDepthBuffer()-&gt;GetTextureView(), g_GeometryDepthDescriptorSlot) };</div>
<div class="line">        g_EnvTextures[4] = { <span class="stringliteral">&quot;light&quot;</span>, <a class="code" href="classnn_1_1g3d_1_1_texture_ref.html">nn::g3d::TextureRef</a>(g_FrameBuffer[FrameBufferType_Light].GetColorBuffer()-&gt;GetTextureView(), g_LightDescriptorSlot) };</div>
<div class="line">        g_EnvTextures[5] = { <span class="stringliteral">&quot;color&quot;</span>, <a class="code" href="classnn_1_1g3d_1_1_texture_ref.html">nn::g3d::TextureRef</a>(g_ColorBuffer.GetTextureView(), g_ColorDescriptorSlot) };</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// フレームバッファの破棄</span></div>
<div class="line"><span class="keywordtype">void</span> FinalizeFrameBuffer(<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html">nns::gfx::GraphicsFramework</a>* pGfxFramework) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice = pGfxFramework-&gt;<a name="a44"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a6dbabc4b1fab1df227e879443468b749">GetDevice</a>();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// フレームバッファのデバッグ描画用 サンプラーの登録を解除</span></div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnn_1_1gfx_1_1_t_sampler.html">nn::gfx::Sampler</a>* pSampler = pGfxFramework-&gt;<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#abafa38f3c2c4064d405b2f1a0eba1b6a">GetSampler</a>(nns::gfx::GraphicsFramework::SamplerType_FilterMode_MinLinear_MagLinear_MipPoint_AddressMode_Clamp);</div>
<div class="line">        <span class="keywordtype">int</span>* pSlot = <span class="keyword">reinterpret_cast&lt;</span><span class="keywordtype">int</span>*<span class="keyword">&gt;</span>(pSampler-&gt;<a name="a45"></a><a class="code" href="classnn_1_1gfx_1_1_t_sampler.html#a04dc0f44b8c1712af6084aaecdca63c5">GetUserPtr</a>());</div>
<div class="line">        pGfxFramework-&gt;<a name="a46"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a5219f952d3b59eb87c683d31793c8fc4">FreeDescriptorSlot</a>(<a class="code" href="namespacenn_1_1gfx.html#a14fc8bd39227425748a8fb55c035d10ca831f2090660e1269d9440b8095bf004d">nn::gfx::DescriptorPoolType_Sampler</a>, *pSlot);</div>
<div class="line">        g3ddemo::FreeMemory(pSlot);</div>
<div class="line">        pSampler-&gt;<a class="code" href="classnn_1_1gfx_1_1_t_sampler.html#a4f44162a43dc8df520a4c9482a5d509c">SetUserPtr</a>(<span class="keyword">nullptr</span>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ディスクリプタプールからテクスチャーの登録を解除</span></div>
<div class="line">    g3ddemo::UnregisterTextureFromDescriptorPool(g_FrameBuffer[FrameBufferType_Water].GetColorBuffer()-&gt;GetTextureView());</div>
<div class="line">    g3ddemo::UnregisterTextureFromDescriptorPool(g_DepthBufferShadow.GetTextureView());</div>
<div class="line">    g3ddemo::UnregisterTextureFromDescriptorPool(g_FrameBuffer[FrameBufferType_Light].GetColorBuffer()-&gt;GetTextureView());</div>
<div class="line">    g3ddemo::UnregisterTextureFromDescriptorPool(g_FrameBuffer[FrameBufferType_Geometry].GetColorBuffer()-&gt;GetTextureView());</div>
<div class="line">    g3ddemo::UnregisterTextureFromDescriptorPool(g_FrameBuffer[FrameBufferType_Geometry].GetDepthBuffer()-&gt;GetTextureView());</div>
<div class="line">    g3ddemo::UnregisterTextureFromDescriptorPool(g_ColorBuffer.GetTextureView());</div>
<div class="line"></div>
<div class="line">    <span class="comment">// フレームバッファーの破棄</span></div>
<div class="line">    g3ddemo::FinalizeFrameBuffer(&amp;g_FrameBuffer[FrameBufferType_Light]);</div>
<div class="line">    g3ddemo::FinalizeFrameBuffer(&amp;g_FrameBuffer[FrameBufferType_Geometry]);</div>
<div class="line">    g3ddemo::FinalizeFrameBuffer(&amp;g_FrameBuffer[FrameBufferType_Shadow]);</div>
<div class="line">    g3ddemo::FinalizeFrameBuffer(&amp;g_FrameBuffer[FrameBufferType_Water]);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// シャドウ用デプスバッファーの破棄</span></div>
<div class="line">    {</div>
<div class="line">        ptrdiff_t offset = g_DepthBufferShadow.GetMemoryPoolOffset();</div>
<div class="line">        g_DepthBufferShadow.Finalize(pDevice);</div>
<div class="line">        pGfxFramework-&gt;<a name="a47"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a7342a183bbe66874974bff3bb4de7450">FreePoolMemory</a>(nns::gfx::GraphicsFramework::MemoryPoolType_RenderTarget, offset);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// カラーバッファーの破棄</span></div>
<div class="line">    {</div>
<div class="line">        ptrdiff_t offset = g_ColorBuffer.GetMemoryPoolOffset();</div>
<div class="line">        g_ColorBuffer.Finalize(pDevice);</div>
<div class="line">        pGfxFramework-&gt;<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a7342a183bbe66874974bff3bb4de7450">FreePoolMemory</a>(nns::gfx::GraphicsFramework::MemoryPoolType_RenderTarget, offset);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// ビューの初期化</span></div>
<div class="line"><span class="keywordtype">void</span> InitializeRenderView(<a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    g_RenderView.<a name="a48"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#a6520169e698d615f7cc77553e32ca88c">Initialize</a>(pDevice, ViewType_Count, g_BufferingCount);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 投影行列を設定</span></div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x4f_type.html">nn::util::Matrix4x4fType</a> matrix;</div>
<div class="line">        MatrixPerspectiveFieldOfViewRightHanded(&amp;matrix, <a name="a49"></a><a class="code" href="namespacenn_1_1util.html#a342713848fbb4ce6750da90d297bc824">nn::util::DegreeToRadian</a>(45.0f),</div>
<div class="line">            16.0f / 9.0f, 10.0f, 40000.0f);</div>
<div class="line">        g_RenderView.<a name="a50"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#ab2d9de5f49ec96d7672389badb1acf46">SetProjectionMtx</a>(ViewType_Default, matrix);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x4f_type.html">nn::util::Matrix4x4fType</a> matrix;</div>
<div class="line">        MatrixPerspectiveFieldOfViewRightHanded(&amp;matrix, <a class="code" href="namespacenn_1_1util.html#a342713848fbb4ce6750da90d297bc824">nn::util::DegreeToRadian</a>(45.0f),</div>
<div class="line">            static_cast&lt;float&gt;(g_FrameBuffer[FrameBufferType_Water].GetWidth()) / static_cast&lt;float&gt;(g_FrameBuffer[FrameBufferType_Water].GetHeight()),</div>
<div class="line">            10.0f, 40000.0f);</div>
<div class="line">        g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#ab2d9de5f49ec96d7672389badb1acf46">SetProjectionMtx</a>(ViewType_Water, matrix);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// リソースの初期化</span></div>
<div class="line"><span class="keywordtype">void</span> InitializeResource(<a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// リソースホルダの初期化</span></div>
<div class="line">    g_Holder.Initialize();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// シェーダーアーカイブの初期化</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> pathIndex = 0; pathIndex &lt; <a name="a51"></a><a class="code" href="nn___macro_8h.html#acd3a418aa2fc4a6379eaa722181a46a6">NN_ARRAY_SIZE</a>(BfshaPath); ++pathIndex)</div>
<div class="line">    {</div>
<div class="line">        <a name="_a52"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_file.html">nn::g3d::ResShaderFile</a>* pFile = g3ddemo::LoadResource&lt;nn::g3d::ResShaderFile&gt;(BfshaPath[pathIndex]);</div>
<div class="line">        pFile-&gt;<a name="a53"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_file.html#a6ca625333d1fb3f4b903d0ee4533666c">Setup</a>(pDevice);</div>
<div class="line">        g_Holder.shaderFiles.PushBack(pFile);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<a class="code" href="classnn_1_1g3d_1_1_res_shader_file.html">nn::g3d::ResShaderFile</a>* pShaderFile : g_Holder.shaderFiles)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnn_1_1g3d_1_1_res_shader_archive.html">nn::g3d::ResShaderArchive</a>* pResShaderArchive = pShaderFile-&gt;<a name="a54"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_file.html#ab2a9392d9a139efe97b011ac5aec96c4">GetResShaderArchive</a>();</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Viewer で利用するシェーダーを設定します。</span></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span>* pResShaderArchiveName = pResShaderArchive-&gt;<a name="a55"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_archive.html#a5ed5eaebeae9492aeaa64fabaf6e743c">GetName</a>();</div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(pResShaderArchiveName, <span class="stringliteral">&quot;town&quot;</span>) == 0)</div>
<div class="line">        {</div>
<div class="line">            g_pTownShaderArchive = pResShaderArchive;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(pResShaderArchiveName, <span class="stringliteral">&quot;demo&quot;</span>) == 0)</div>
<div class="line">        {</div>
<div class="line">            g_pTownDemoShaderArchive = pResShaderArchive;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// モデル固有では無いシェーディングモデルのポインターを設定します。</span></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> shaderIndex = 0; shaderIndex &lt; ShadingModelType_Count; ++shaderIndex)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (strcmp(pResShaderArchiveName, g_ShaderNameArray[shaderIndex].shaderArchiveName) != 0)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line">            <a class="code" href="classnn_1_1g3d_1_1_res_shading_model.html">nn::g3d::ResShadingModel</a>* pResShadingModel = pResShaderArchive-&gt;<a name="a56"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_archive.html#a17c81d3fe346cbcc531ad38138b7117b">FindShadingModel</a>(g_ShaderNameArray[shaderIndex].shadingModelName);</div>
<div class="line">            g_pResShadingModelPtr[shaderIndex] = pResShadingModel;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <a name="a57"></a><a class="code" href="nn___assert_8h.html#a0473ebccccc250efd6100a9bbfec406b">NN_ASSERT_NOT_NULL</a>(g_pTownShaderArchive);</div>
<div class="line">    <a class="code" href="nn___assert_8h.html#a0473ebccccc250efd6100a9bbfec406b">NN_ASSERT_NOT_NULL</a>(g_pTownDemoShaderArchive);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<a class="code" href="classnn_1_1g3d_1_1_res_shading_model.html">nn::g3d::ResShadingModel</a>* pResShadingModel : g_pResShadingModelPtr)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___assert_8h.html#a0473ebccccc250efd6100a9bbfec406b">NN_ASSERT_NOT_NULL</a>(pResShadingModel);</div>
<div class="line">        <a name="a58"></a><a class="code" href="nn___macro_8h.html#af2d1673769927c5eae977d8dde3ce106">NN_UNUSED</a>(pResShadingModel);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// サンプラーの参照テクスチャーが空の場合に割り当てられるダミーテクスチャーの初期化</span></div>
<div class="line">    g3ddemo::CreateDummyTextureAndSampler(pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// リソースモデルの初期化</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> pathIndex = 0; pathIndex &lt; <a class="code" href="nn___macro_8h.html#acd3a418aa2fc4a6379eaa722181a46a6">NN_ARRAY_SIZE</a>(BfresPath); ++pathIndex)</div>
<div class="line">    {</div>
<div class="line">        <a name="_a59"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html">nn::g3d::ResFile</a>* pResFile = g3ddemo::LoadResource&lt;nn::g3d::ResFile&gt;(BfresPath[pathIndex]);</div>
<div class="line">        pResFile-&gt;<a name="a60"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html#afeaf3b666d229f4e30fe374ee5707909">Setup</a>(pDevice);</div>
<div class="line">        g_Holder.files.PushBack(pResFile);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// テクスチャーおよびサンプラーをディスクリプタプールに登録</span></div>
<div class="line">        g3ddemo::SetupTexture(pDevice, pResFile, g3ddemo::TextureBindCallback);</div>
<div class="line">        g3ddemo::RegisterSamplerToDescriptorPool(pResFile);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// モデル固有のシェーダーのセットアップ</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* materialShaderArchiveFileName = <span class="stringliteral">&quot;town.bfsha&quot;</span>;</div>
<div class="line">    <span class="keywordflow">for</span> (<a class="code" href="classnn_1_1g3d_1_1_res_file.html">nn::g3d::ResFile</a>* pResFile : g_Holder.files)</div>
<div class="line">    {</div>
<div class="line">        <a name="_a61"></a><a class="code" href="classnn_1_1g3d_1_1_res_external_file.html">nn::g3d::ResExternalFile</a>* pResExternalFile = pResFile-&gt;<a name="a62"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html#a0de53bc695b00cecf5fd0c9b08d13034">FindExternalFile</a>(materialShaderArchiveFileName);</div>
<div class="line">        <span class="keywordflow">if</span> (pResExternalFile)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">void</span>* pExternalFile = pResExternalFile-&gt;<a name="a63"></a><a class="code" href="classnn_1_1g3d_1_1_res_external_file.html#a9207cd3bcc5ffe210f8cd4ce37460c23">GetData</a>();</div>
<div class="line">            <a name="a64"></a><a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(<a name="a65"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_file.html#a733f0fed01ac50f68f743fb47a8813f6">nn::g3d::ResShaderFile::IsValid</a>(pExternalFile));</div>
<div class="line">            <a class="code" href="classnn_1_1g3d_1_1_res_shader_archive.html">nn::g3d::ResShaderArchive</a>* pModelShader = <a name="a66"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_file.html#a39a1802d90e4a26b504d97710bfdca5a">nn::g3d::ResShaderFile::ResCast</a>(pExternalFile)-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_shader_file.html#ab2a9392d9a139efe97b011ac5aec96c4">GetResShaderArchive</a>();</div>
<div class="line">            pModelShader-&gt;<a name="a67"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_archive.html#a0bd2ecf27e62dd885eb25a1c57e29c9d">Setup</a>(pDevice);</div>
<div class="line">            pResFile-&gt;<a name="a68"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html#a013b6097af603cc2611627cba86fa6ed">SetUserPtr</a>(pModelShader);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// リソースの破棄</span></div>
<div class="line"><span class="keywordtype">void</span> FinalizeResource(<a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// モデルに付加されているシェーダーアーカイブを破棄</span></div>
<div class="line">    <span class="keywordflow">for</span> (<a class="code" href="classnn_1_1g3d_1_1_res_file.html">nn::g3d::ResFile</a>* pResFile : g_Holder.files)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnn_1_1g3d_1_1_res_external_file.html">nn::g3d::ResExternalFile</a>* pResExternalFile = pResFile-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_file.html#a0de53bc695b00cecf5fd0c9b08d13034">FindExternalFile</a>(<span class="stringliteral">&quot;town.bfsha&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (pResExternalFile)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">void</span>* pExternalFile = pResExternalFile-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_external_file.html#a9207cd3bcc5ffe210f8cd4ce37460c23">GetData</a>();</div>
<div class="line">            <a class="code" href="classnn_1_1g3d_1_1_res_shader_archive.html">nn::g3d::ResShaderArchive</a>* pModelShader = <a class="code" href="classnn_1_1g3d_1_1_res_shader_file.html#a39a1802d90e4a26b504d97710bfdca5a">nn::g3d::ResShaderFile::ResCast</a>(pExternalFile)-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_shader_file.html#ab2a9392d9a139efe97b011ac5aec96c4">GetResShaderArchive</a>();</div>
<div class="line">            pModelShader-&gt;<a name="a69"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_archive.html#ad03541d45efb24c2f6991b780ec42add">Cleanup</a>(pDevice);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// リソースホルダ内を破棄</span></div>
<div class="line">    g3ddemo::DestroyAll(pDevice, &amp;g_Holder);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// 環境モデルのテクスチャにフレームバッファを割り当てます。</span></div>
<div class="line"><span class="keywordtype">void</span> SetEnvTexture(<a name="_a70"></a><a class="code" href="classnn_1_1g3d_1_1_material_obj.html">nn::g3d::MaterialObj</a>* pEnvMaterialObj, <span class="keywordtype">int</span> textureIndex) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* textureName = pEnvMaterialObj-&gt;<a name="a71"></a><a class="code" href="classnn_1_1g3d_1_1_material_obj.html#ae5afd91a6558530d5dbd8bc1b4ab6f74">GetTextureName</a>(textureIndex);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keyword">const</span> EnvTexture&amp; envTexture : g_EnvTextures)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(textureName, envTexture.name) != 0)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        pEnvMaterialObj-&gt;<a name="a72"></a><a class="code" href="classnn_1_1g3d_1_1_material_obj.html#a431f8932a5e95bc2c559cbf0817c9aed">SetTexture</a>(textureIndex, envTexture.textureRef);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// 環境モデルの設定</span></div>
<div class="line"><span class="keywordtype">void</span> SetupEnvModel(<a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice, <a class="code" href="classnn_1_1g3d_1_1_material_obj.html">nn::g3d::MaterialObj</a>* pEnvMaterial) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <a name="_a73"></a><a class="code" href="classnn_1_1g3d_1_1_res_material.html">nn::g3d::ResMaterial</a>* pResMaterial = <span class="keyword">const_cast&lt;</span><a class="code" href="classnn_1_1g3d_1_1_res_material.html">nn::g3d::ResMaterial</a>*<span class="keyword">&gt;</span>(pEnvMaterial-&gt;<a name="a74"></a><a class="code" href="classnn_1_1g3d_1_1_material_obj.html#ac83012bf24ce5dafd6fed058a9700975">GetResource</a>());</div>
<div class="line"></div>
<div class="line">    <span class="comment">// シャドウサンプラーの生成</span></div>
<div class="line">    CreateShadowSampler(pDevice, pResMaterial);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 環境モデルのテクスチャにフレームバッファを割り当てます。</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> textureIndex = 0, textureCount = pEnvMaterial-&gt;<a name="a75"></a><a class="code" href="classnn_1_1g3d_1_1_material_obj.html#a9ba8a6a18216f2332f4bf74cbef5475c">GetTextureCount</a>(); textureIndex &lt; textureCount; ++textureIndex)</div>
<div class="line">    {</div>
<div class="line">        SetEnvTexture(pEnvMaterial, textureIndex);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 環境モデルのテクスチャがビューアーによって上書きされないように設定します。</span></div>
<div class="line">    pEnvMaterial-&gt;<a name="a76"></a><a class="code" href="classnn_1_1g3d_1_1_material_obj.html#a9b90787b3470416fee29cd6b23159a75">SetTextureChangeCallback</a>(SetEnvTexture);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// コンピュートシェーダー用に SSBO とディスパッチパラメータの設定を行います。</span></div>
<div class="line"><span class="keywordtype">void</span> InitializeTextureAverageShader(<a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    g_TextureAverageShader.Initialize(pDevice, g_pResShadingModelPtr[ShadingModelType_TextureAverage]);</div>
<div class="line">    g_TextureAverageShader.SetTileResolution(pDevice, 64, 64);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// モデルの描画設定を初期化</span></div>
<div class="line"><span class="keywordtype">void</span> InitializeRenderModel(g3ddemo::ResourceHolder* pHolder, <a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> fileIndex = File_TownEnv; fileIndex &lt;= File_MaleA; ++fileIndex)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnn_1_1g3d_1_1_res_file.html">nn::g3d::ResFile</a>* pResFile = pHolder-&gt;files[fileIndex];</div>
<div class="line">        CreateRenderModel(pHolder, pDevice, pResFile);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// ShapeObj の ユーザーエリアに LOD 情報を設定します。</span></div>
<div class="line"><span class="keywordtype">void</span> SetupShapeUserArea(<a class="code" href="classnn_1_1g3d_1_1_model_obj.html">nn::g3d::ModelObj</a>* pModelObj) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> shapeIndex = 0, shapeCount = pModelObj-&gt;<a name="a77"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a54e1cf48111ecb56b8dde5824d13a1fd">GetShapeCount</a>(); shapeIndex &lt; shapeCount; ++shapeIndex)</div>
<div class="line">    {</div>
<div class="line">        <a name="_a78"></a><a class="code" href="classnn_1_1g3d_1_1_shape_obj.html">nn::g3d::ShapeObj</a>* pShapeObj = pModelObj-&gt;<a name="a79"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a4f56c9a4a685ff577c44b60bc50f5a8b">GetShape</a>(shapeIndex);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// 各LODレベルの頂点バッファー内での開始オフセットを設定する</span></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> meshIndex = 0; meshIndex &lt; g_MaxLodLevel; ++meshIndex)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (meshIndex &lt; pShapeObj-&gt;GetMeshCount())</div>
<div class="line">            {</div>
<div class="line">                <span class="keyword">const</span> <a name="_a80"></a><a class="code" href="classnn_1_1g3d_1_1_res_mesh.html">nn::g3d::ResMesh</a>* pResMesh = pShapeObj-&gt;<a name="a81"></a><a class="code" href="classnn_1_1g3d_1_1_shape_obj.html#a4250dd1621b8717ab126aa3d43a18fa8">GetResMesh</a>(meshIndex);</div>
<div class="line">                pShapeObj-&gt;<a name="a82"></a><a class="code" href="classnn_1_1g3d_1_1_shape_obj.html#a366192ea48975363a42b6793469b484c">GetUserArea</a>&lt;<span class="keywordtype">int</span>&gt;()[meshIndex] = static_cast&lt;int&gt;(pResMesh-&gt;<a name="a83"></a><a class="code" href="classnn_1_1g3d_1_1_res_mesh.html#a74c7c4bf93c150f0a0c4d85f6b23d21f">GetOffset</a>());</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// LODレベルが存在しない場合は-1</span></div>
<div class="line">                pShapeObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_shape_obj.html#a366192ea48975363a42b6793469b484c">GetUserArea</a>&lt;<span class="keywordtype">int</span>&gt;()[meshIndex] = -1;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ユーザーエリアの更新を必ず行う</span></div>
<div class="line">    pModelObj-&gt;<a name="a84"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#af814bd6f8fe716e4ae3c8eea11603338">SetShapeUserAreaForceUpdateEnabled</a>();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// モデルインスタンスの生成</span></div>
<div class="line"><span class="keywordtype">void</span> InitializeModelAnimObj(g3ddemo::ResourceHolder* pHolder, <a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> fileIndex = File_TownEnv; fileIndex &lt;= File_MaleA; ++fileIndex)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnn_1_1g3d_1_1_res_file.html">nn::g3d::ResFile</a>* pResFile = pHolder-&gt;files[fileIndex];</div>
<div class="line">        CreateModelAnimObj(pHolder, pDevice, pResFile, <span class="keyword">nullptr</span>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// env モデルは非表示</span></div>
<div class="line">    {</div>
<div class="line">        g_pEnvModelObj = pHolder-&gt;modelAnimObjs[File_TownEnv]-&gt;GetModelObj();</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> materialIndex = 0, materialCount = g_pEnvModelObj-&gt;<a name="a85"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a78560f853ae973b9383a52a2d52f8253">GetMaterialCount</a>(); materialIndex &lt; materialCount; ++materialIndex)</div>
<div class="line">        {</div>
<div class="line">            g_pEnvModelObj-&gt;<a name="a86"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a6d96fa2003a6099ea92df607e5ddc78e">SetMaterialVisible</a>(materialIndex, <span class="keyword">false</span>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// RenderModelObj の初期化</span></div>
<div class="line"><span class="keywordtype">void</span> InitializeRenderModelObj(g3ddemo::ResourceHolder* pHolder) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <a name="a87"></a><a class="code" href="nn___assert_8h.html#a55d6b188692ffffd64e69532738ed2fc">NN_ASSERT_EQUAL</a>(pHolder-&gt;modelAnimObjs.GetCount(), pHolder-&gt;renderModels.GetCount());</div>
<div class="line"></div>
<div class="line">    <span class="comment">// RenderModelObj の構築</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> modelIndex = 0, modelCount = pHolder-&gt;modelAnimObjs.GetCount(); modelIndex &lt; modelCount; ++modelIndex)</div>
<div class="line">    {</div>
<div class="line">        CreateRenderModelObj(pHolder, pHolder-&gt;modelAnimObjs[modelIndex], pHolder-&gt;renderModels[modelIndex]);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// RenderModelObj 内にあるシェーダーセレクターに水面描画用のキーを書き込みます。</span></div>
<div class="line"><span class="keywordtype">void</span> SetupWaterVariation(<a name="_a88"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pRenderModelObj) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> shapeCount = pRenderModelObj-&gt;<a name="a89"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#aa0a852cc2943033071f80f6660185518">GetModelObj</a>()-&gt;<a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a54e1cf48111ecb56b8dde5824d13a1fd">GetShapeCount</a>();</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> shapeIndex = 0; shapeIndex &lt; shapeCount; ++shapeIndex)</div>
<div class="line">    {</div>
<div class="line">        <a name="_a90"></a><a class="code" href="classnns_1_1g3d_1_1_render_unit_obj.html">nns::g3d::RenderUnitObj</a>* pRenderUnitObj = pRenderModelObj-&gt;<a name="a91"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a7c323f2e5100196cc55a5d778de6630a">GetRenderUnitObj</a>(shapeIndex);</div>
<div class="line">        <a name="_a92"></a><a class="code" href="classnn_1_1g3d_1_1_shader_selector.html">nn::g3d::ShaderSelector</a>* pShaderSelector = pRenderUnitObj-&gt;<a name="a93"></a><a class="code" href="classnns_1_1g3d_1_1_render_unit_obj.html#ac3f3d5d30665ffbeb4b004dc45aadf23">GetShaderSelector</a>(DrawPassType_Water);</div>
<div class="line">        <span class="keywordtype">int</span> optionIndex = pShaderSelector-&gt;<a name="a94"></a><a class="code" href="classnn_1_1g3d_1_1_shader_selector.html#a6d3d502fd6ee5a967e41fcfe6d42be51">FindDynamicOptionIndex</a>(<span class="stringliteral">&quot;water_world&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (optionIndex == <a name="a95"></a><a class="code" href="classnn_1_1util_1_1_res_dic.html#a825d9c73f03e6d02e9f8d0050b0e11a6">nn::util::ResDic::Npos</a>)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> <a name="_a96"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_option.html">nn::g3d::ResShaderOption</a>* pResShaderOption = pShaderSelector-&gt;<a name="a97"></a><a class="code" href="classnn_1_1g3d_1_1_shader_selector.html#a245ecc912327099dc0d517a40a71e5d8">GetDynamicOption</a>(optionIndex);</div>
<div class="line">        <span class="keywordtype">int</span> choiceIndex = pResShaderOption-&gt;<a name="a98"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_option.html#a221f5561148d29f8930f3342e8401430">FindChoiceIndex</a>(<span class="stringliteral">&quot;1&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (choiceIndex == <a class="code" href="classnn_1_1util_1_1_res_dic.html#a825d9c73f03e6d02e9f8d0050b0e11a6">nn::util::ResDic::Npos</a>)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        pShaderSelector-&gt;<a name="a99"></a><a class="code" href="classnn_1_1g3d_1_1_shader_selector.html#a3afe10975f2f1896503ceedda3e04773">WriteDynamicKey</a>(optionIndex, choiceIndex);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// モデルに LOD やフラスタムカリングの設定</span></div>
<div class="line"><span class="keywordtype">void</span> SetupRenderModelObj(g3ddemo::ResourceHolder* pHolder) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pRenderModelObj : pHolder-&gt;renderModelObjs)</div>
<div class="line">    {</div>
<div class="line">        ::SetupRenderModelObj(pRenderModelObj);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// アニメーションの登録</span></div>
<div class="line"><span class="keywordtype">void</span> RegisterAnimation(<span class="keyword">const</span> <span class="keywordtype">char</span>* pModelName, <span class="keyword">const</span> <span class="keywordtype">char</span>* pAnimName, <span class="keywordtype">float</span> step) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> objIndex = 0, objCount = g_Holder.modelAnimObjs.GetCount(); objIndex &lt; objCount; ++objIndex)</div>
<div class="line">    {</div>
<div class="line">        <a name="_a100"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html">nns::g3d::ModelAnimObj</a>* pModelAnimObj = g_Holder.modelAnimObjs[objIndex];</div>
<div class="line">        <span class="keywordtype">int</span>* pAnimId = g_Holder.animationIds[objIndex];</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(pModelName, pModelAnimObj-&gt;<a name="a101"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a75f2e005c7b06d62f33d69508db503e9">GetModelObj</a>()-&gt;<a name="a102"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a71faa678be49b342e738072ed3783ed3">GetResource</a>()-&gt;<a name="a103"></a><a class="code" href="classnn_1_1g3d_1_1_res_model.html#aca2ca478cace80e46c68071c86330880">GetName</a>()) == 0)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">for</span> (<a class="code" href="classnn_1_1g3d_1_1_res_file.html">nn::g3d::ResFile</a>* pFile : g_Holder.files)</div>
<div class="line">            {</div>
<div class="line">                <a name="_a104"></a><a class="code" href="classnn_1_1g3d_1_1_res_skeletal_anim.html">nn::g3d::ResSkeletalAnim</a>* pResSkeletalAnim;</div>
<div class="line">                <span class="keywordflow">if</span> ((pResSkeletalAnim = pFile-&gt;<a name="a105"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html#a4f00478003a8c27bbb820a8aee35b357">FindSkeletalAnim</a>(pAnimName)) != <span class="keyword">nullptr</span>)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordtype">int</span> <span class="keywordtype">id</span> = pModelAnimObj-&gt;<a name="a106"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a3b6789d198e48ec3a253974aa35879a2">CreateAnim</a>(pResSkeletalAnim);</div>
<div class="line">                    pModelAnimObj-&gt;<a name="a107"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a96e279ac5daea23a15c152b783bc2c7c">GetAnimObj</a>(<span class="keywordtype">id</span>)-&gt;<a name="a108"></a><a class="code" href="classnn_1_1g3d_1_1_anim_obj.html#ac2f590c6bdb160d6e7b7e640826b4362">GetFrameCtrl</a>().<a name="a109"></a><a class="code" href="classnn_1_1g3d_1_1_anim_frame_ctrl.html#acc8290c7f3020efa545336804fbb7ea0">SetStep</a>(step);</div>
<div class="line">                    pAnimId[AnimationType_Skeletal] = id;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <a name="_a110"></a><a class="code" href="classnn_1_1g3d_1_1_res_material_anim.html">nn::g3d::ResMaterialAnim</a>* pResMaterialAnim;</div>
<div class="line">                <span class="keywordflow">if</span> ((pResMaterialAnim = pFile-&gt;<a name="a111"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html#a4e6bf2223e05531032dd18f523c224c4">FindMaterialAnim</a>(pAnimName)) != <span class="keyword">nullptr</span>)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordtype">int</span> <span class="keywordtype">id</span> = pModelAnimObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a3b6789d198e48ec3a253974aa35879a2">CreateAnim</a>(pResMaterialAnim);</div>
<div class="line">                    pModelAnimObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a96e279ac5daea23a15c152b783bc2c7c">GetAnimObj</a>(<span class="keywordtype">id</span>)-&gt;<a class="code" href="classnn_1_1g3d_1_1_anim_obj.html#ac2f590c6bdb160d6e7b7e640826b4362">GetFrameCtrl</a>().<a class="code" href="classnn_1_1g3d_1_1_anim_frame_ctrl.html#acc8290c7f3020efa545336804fbb7ea0">SetStep</a>(step);</div>
<div class="line">                    pAnimId[AnimationType_Material] = id;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <a name="_a112"></a><a class="code" href="classnn_1_1g3d_1_1_res_bone_visibility_anim.html">nn::g3d::ResBoneVisibilityAnim</a>* pResBoneVisibilityAnim;</div>
<div class="line">                <span class="keywordflow">if</span> ((pResBoneVisibilityAnim = pFile-&gt;<a name="a113"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html#a0f972d96f615b397c35f24e83bbef80c">FindBoneVisibilityAnim</a>(pAnimName)) != <span class="keyword">nullptr</span>)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordtype">int</span> <span class="keywordtype">id</span> = pModelAnimObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a3b6789d198e48ec3a253974aa35879a2">CreateAnim</a>(pResBoneVisibilityAnim);</div>
<div class="line">                    pModelAnimObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a96e279ac5daea23a15c152b783bc2c7c">GetAnimObj</a>(<span class="keywordtype">id</span>)-&gt;<a class="code" href="classnn_1_1g3d_1_1_anim_obj.html#ac2f590c6bdb160d6e7b7e640826b4362">GetFrameCtrl</a>().<a class="code" href="classnn_1_1g3d_1_1_anim_frame_ctrl.html#acc8290c7f3020efa545336804fbb7ea0">SetStep</a>(step);</div>
<div class="line">                    pAnimId[AnimationType_BoneVisibility] = id;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <a name="_a114"></a><a class="code" href="classnn_1_1g3d_1_1_res_shape_anim.html">nn::g3d::ResShapeAnim</a>* pResShapeAnim;</div>
<div class="line">                <span class="keywordflow">if</span> ((pResShapeAnim = pFile-&gt;<a name="a115"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html#a9aa26a8344b39de22d2493584f55e000">FindShapeAnim</a>(pAnimName)) != <span class="keyword">nullptr</span>)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordtype">int</span> <span class="keywordtype">id</span> = pModelAnimObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a3b6789d198e48ec3a253974aa35879a2">CreateAnim</a>(pResShapeAnim);</div>
<div class="line">                    pModelAnimObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a96e279ac5daea23a15c152b783bc2c7c">GetAnimObj</a>(<span class="keywordtype">id</span>)-&gt;<a class="code" href="classnn_1_1g3d_1_1_anim_obj.html#ac2f590c6bdb160d6e7b7e640826b4362">GetFrameCtrl</a>().<a class="code" href="classnn_1_1g3d_1_1_anim_frame_ctrl.html#acc8290c7f3020efa545336804fbb7ea0">SetStep</a>(step);</div>
<div class="line">                    pAnimId[AnimationType_Shape] = id;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// アニメーションの初期化</span></div>
<div class="line"><span class="keywordtype">void</span> InitializeAnimation() <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    RegisterAnimation(<span class="stringliteral">&quot;bg_WhiteTown&quot;</span>, <span class="stringliteral">&quot;bg_WhiteTown&quot;</span>, 1.0f);</div>
<div class="line">    RegisterAnimation(<span class="stringliteral">&quot;bg_WhiteTown_cloth&quot;</span>, <span class="stringliteral">&quot;bg_WhiteTown_cloth&quot;</span>, 1.0f);</div>
<div class="line">    RegisterAnimation(<span class="stringliteral">&quot;Duck&quot;</span>, <span class="stringliteral">&quot;Duck&quot;</span>, 1.0f);</div>
<div class="line">    RegisterAnimation(<span class="stringliteral">&quot;FemaleA&quot;</span>, <span class="stringliteral">&quot;FemaleA_MoAnime&quot;</span>, 1.0f);</div>
<div class="line">    RegisterAnimation(<span class="stringliteral">&quot;Fish&quot;</span>, <span class="stringliteral">&quot;Fish&quot;</span>, 1.0f);</div>
<div class="line">    RegisterAnimation(<span class="stringliteral">&quot;MaleA&quot;</span>, <span class="stringliteral">&quot;MaleA_MoAnime&quot;</span>, 1.0f);</div>
<div class="line">    RegisterAnimation(<span class="stringliteral">&quot;WhiteTown_Water_Caustics&quot;</span>, <span class="stringliteral">&quot;WhiteTown_Water_Caustics&quot;</span>, 0.2f);</div>
<div class="line">    RegisterAnimation(<span class="stringliteral">&quot;bg_WhiteTown_Water_Flat&quot;</span>, <span class="stringliteral">&quot;bg_WhiteTown_Water_Flat&quot;</span>, 0.5f);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// モデルの位置を初期化</span></div>
<div class="line"><span class="keywordtype">void</span> InitializeModelPosition() <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (<a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html">nns::g3d::ModelAnimObj</a>* pModelAnimObj : g_Holder.modelAnimObjs)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span>* pName = pModelAnimObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a75f2e005c7b06d62f33d69508db503e9">GetModelObj</a>()-&gt;<a name="a116"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#af58166699404cb37a59cb3e6daf96011">GetName</a>();</div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(pName, <span class="stringliteral">&quot;FemaleA&quot;</span>) == 0)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> rotate;</div>
<div class="line">            <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> translate;</div>
<div class="line">            VectorSet(&amp;rotate, 0.0f, <a class="code" href="namespacenn_1_1util.html#a342713848fbb4ce6750da90d297bc824">nn::util::DegreeToRadian</a>(60.0f), 0.0f);</div>
<div class="line">            VectorSet(&amp;translate, -300.0f, 12.0f, 1550.0f);</div>
<div class="line">            pModelAnimObj-&gt;<a name="a117"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a6d65fa83870517442782cd0c6d676ff7">SetRotate</a>(rotate);</div>
<div class="line">            pModelAnimObj-&gt;<a name="a118"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#ab1d22a1e60ac9dd1fb7693064364f02d">SetTranslate</a>(translate);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(pName, <span class="stringliteral">&quot;MaleA&quot;</span>) == 0)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> rotate;</div>
<div class="line">            <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> translate;</div>
<div class="line">            VectorSet(&amp;rotate, 0.0f, 0.0f, 0.0f);</div>
<div class="line">            VectorSet(&amp;translate, 0.0f, 15.0f, 170.0f);</div>
<div class="line">            pModelAnimObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a6d65fa83870517442782cd0c6d676ff7">SetRotate</a>(rotate);</div>
<div class="line">            pModelAnimObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#ab1d22a1e60ac9dd1fb7693064364f02d">SetTranslate</a>(translate);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// ModelAnimObj を更新</span></div>
<div class="line"><span class="keywordtype">void</span> CalculateModelAnimObjs(<span class="keywordtype">int</span> uniformBufferIndex, <span class="keywordtype">bool</span> enableAnimation) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a>;</div>
<div class="line"></div>
<div class="line"><span class="comment">// リソースホルダーから指定した名前の RenderModelObj を取得</span></div>
<div class="line"><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* FindRenderModelObj(<span class="keyword">const</span> <span class="keywordtype">char</span>* pModelName) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a>;</div>
<div class="line"></div>
<div class="line"><span class="comment">// ライトの配置を初期化</span></div>
<div class="line"><span class="keywordtype">void</span> InitializePointLight(<a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// 配置座標を得るために更新</span></div>
<div class="line">    CalculateModelAnimObjs(0, <span class="keyword">true</span>);</div>
<div class="line">    CalculateModelAnimObjs(1, <span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classnn_1_1g3d_1_1_res_file.html">nn::g3d::ResFile</a>* pLightFile = g_Holder.files[File_Light];</div>
<div class="line">    <a name="_a119"></a><a class="code" href="classnn_1_1g3d_1_1_res_model.html">nn::g3d::ResModel</a>* pLightResModel = pLightFile-&gt;<a name="a120"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html#aea207d962515bd832f33b3efd734ccbc">FindModel</a>(<span class="stringliteral">&quot;Point&quot;</span>);</div>
<div class="line">    <a class="code" href="nn___assert_8h.html#a0473ebccccc250efd6100a9bbfec406b">NN_ASSERT_NOT_NULL</a>(pLightResModel);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ライトの設定を初期化</span></div>
<div class="line">    g_PointLight.Initialize(pDevice, pLightResModel, g_pResShadingModelPtr[ShadingModelType_Light]);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Town のモデルを取得</span></div>
<div class="line">    <a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pTownRenderModelObj = FindRenderModelObj(<span class="stringliteral">&quot;bg_WhiteTown&quot;</span>);</div>
<div class="line">    <a class="code" href="nn___assert_8h.html#a0473ebccccc250efd6100a9bbfec406b">NN_ASSERT_NOT_NULL</a>(pTownRenderModelObj);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* pointLightPrefix = <span class="stringliteral">&quot;PointLight_&quot;</span>;</div>
<div class="line">    <span class="keyword">const</span> <a name="_a121"></a><a class="code" href="structnn_1_1util_1_1_float3.html">nn::util::Float3</a> pointLightColor = NN_UTIL_FLOAT_3_INITIALIZER(1.0f, 0.8f, 0.4f);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ポイントライト用のボーンを取得し、ライトを配置</span></div>
<div class="line">    <span class="keyword">const</span> <a name="_a122"></a><a class="code" href="classnn_1_1g3d_1_1_skeleton_obj.html">nn::g3d::SkeletonObj</a>* pSkeletonObj = pTownRenderModelObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#aa0a852cc2943033071f80f6660185518">GetModelObj</a>()-&gt;<a name="a123"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#af8c5bbd80c73ab37280e7505ea4a0292">GetSkeleton</a>();</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> boneIndex = 0, boneCount = pSkeletonObj-&gt;<a name="a124"></a><a class="code" href="classnn_1_1g3d_1_1_skeleton_obj.html#ab15be070fb286ad141a8c93607f55c67">GetBoneCount</a>(); boneIndex &lt; boneCount; ++boneIndex)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> <a name="_a125"></a><a class="code" href="classnn_1_1g3d_1_1_res_bone.html">nn::g3d::ResBone</a>* pResBone = pSkeletonObj-&gt;<a name="a126"></a><a class="code" href="classnn_1_1g3d_1_1_skeleton_obj.html#aa68e8daa205d4be875ce8d4381729d1b">GetResBone</a>(boneIndex);</div>
<div class="line">        <span class="keywordflow">if</span> (strncmp(pResBone-&gt;<a name="a127"></a><a class="code" href="classnn_1_1g3d_1_1_res_bone.html#ada6b32d204c3db8b73db76e781d0a0a1">GetName</a>(), pointLightPrefix, strlen(pointLightPrefix)) != 0)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// ライト用のボーンから位置を取得</span></div>
<div class="line">        <span class="keyword">const</span> <a name="_a128"></a><a class="code" href="structnn_1_1util_1_1_matrix_row_major4x3f_type.html">nn::util::Matrix4x3fType</a>&amp; matrix = pSkeletonObj-&gt;<a name="a129"></a><a class="code" href="classnn_1_1g3d_1_1_skeleton_obj.html#a97fdc7d1e1740b2e49d3c5365589adda">GetWorldMtxArray</a>()[boneIndex];</div>
<div class="line">        <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> center;</div>
<div class="line">        MatrixGetAxisW(&amp;center, matrix);</div>
<div class="line"></div>
<div class="line">        g_PointLight.AddLight(pDevice, pointLightColor, center);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// カメラ配置の初期化</span></div>
<div class="line"><span class="keywordtype">void</span> InitializeCamera() NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    VectorSet(&amp;g_CameraPosition, 380.0f, 140.0f, 2400.0f);</div>
<div class="line">    VectorSet(&amp;g_CameraUp, 0.0f, 1.0f, 0.0f);</div>
<div class="line">    VectorSet(&amp;g_CameraTarget, -400.0f, 0.0f, 0.0f);</div>
<div class="line">    VectorSet(&amp;g_LightPosition, 2000.0f, 2200.0f, 2000.0f);</div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x3f_type.html">nn::util::Matrix4x3fType</a> matrix;</div>
<div class="line">    MatrixLookAtRightHanded(&amp;matrix, g_CameraPosition, g_CameraTarget, g_CameraUp);</div>
<div class="line">    g_RenderView.<a name="a130"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#a5b633742724f63bffdb11389a06b974b">SetViewMtx</a>(ViewType_Default, matrix);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// ビューアーライブラリの初期化</span></div>
<div class="line"><span class="keywordtype">void</span> InitializeViewer() NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    g_TownViewer.Initialize(g_Holder, TownViewer::TownViewerCallback, TownViewer::ViewerTextureBindCallback);</div>
<div class="line">    g_TownViewer.StartPollThread();</div>
<div class="line">    g_TownViewer.Open();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> FinalizeViewer() NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// ビューアーの終了処理</span></div>
<div class="line">    g_TownViewer.Close();</div>
<div class="line">    g_TownViewer.StopPollThread();</div>
<div class="line">    g_TownViewer.Finalize();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Townの初期化</span></div>
<div class="line"><span class="keywordtype">void</span> InitializeTown(nns::gfx::DebugGraphicsFramework* pGfxFramework) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice = pGfxFramework-&gt;GetDevice();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// メニュー表示用パラメーターの初期化</span></div>
<div class="line">    InitializeMenu();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 表示情報の初期化</span></div>
<div class="line">    InitializeScreenInfo(pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// バウンディング表示の初期化</span></div>
<div class="line">    g_BoundingRenderer.Initialize(pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 現在のスレッド(メインスレッド)を 0 番コアに割り当て</span></div>
<div class="line">    <a name="a131"></a><a class="code" href="namespacenn_1_1os.html#ac50b86561c15ee3e8195c83fddc8e732">nn::os::SetThreadCoreMask</a>(<a name="a132"></a><a class="code" href="namespacenn_1_1os.html#ad106866a5b13bc3d430104333966b479">nn::os::GetCurrentThread</a>(), 0, 1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 負荷計測機能の初期化</span></div>
<div class="line">    pGfxFramework-&gt;InitializePerf();</div>
<div class="line"><span class="preprocessor">#if defined( NN_BUILD_CONFIG_OS_WIN )</span></div>
<div class="line">    <a name="a133"></a><a class="code" href="perf___profile_8h.html#a3506f976dd0501c40d1605db7811ceed">NN_PERF_SET_GET_CORE_NUMBER_FUNCTION</a>(g3ddemo::GetFixedCoreNumber);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// フレームバッファーの初期化</span></div>
<div class="line">    InitializeFrameBuffer(pGfxFramework, pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// コンテキストの初期化</span></div>
<div class="line">    g_Context.Initialize(pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ビューの初期化</span></div>
<div class="line">    InitializeRenderView(pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// リソースの初期化</span></div>
<div class="line">    InitializeResource(pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// フレームバッファの平均輝度を求めるシェーダーを初期化</span></div>
<div class="line">    InitializeTextureAverageShader(pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// モデルの描画設定を初期化</span></div>
<div class="line">    InitializeRenderModel(&amp;g_Holder, pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// モデルインスタンスの生成</span></div>
<div class="line">    InitializeModelAnimObj(&amp;g_Holder, pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 環境モデルの設定</span></div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnn_1_1g3d_1_1_material_obj.html">nn::g3d::MaterialObj</a>* pEnvMaterial = g_pEnvModelObj-&gt;<a name="a134"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a225cda4a0e7881df5dc4ebb15ac6c6f6">GetMaterial</a>(0);</div>
<div class="line">        SetupEnvModel(pDevice, pEnvMaterial);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// モデル描画設定とモデルインスタンスの関連付け</span></div>
<div class="line">    InitializeRenderModelObj(&amp;g_Holder);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// モデルに LOD やフラスタムカリングの設定</span></div>
<div class="line">    SetupRenderModelObj(&amp;g_Holder);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// アニメーションの登録</span></div>
<div class="line">    InitializeAnimation();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// モデルの位置を初期化</span></div>
<div class="line">    InitializeModelPosition();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ポイントライトを初期化</span></div>
<div class="line">    InitializePointLight(pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// カメラ配置の初期化</span></div>
<div class="line">    InitializeCamera();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ビューアーライブラリの初期化</span></div>
<div class="line">    InitializeViewer();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ビューボリューム表示の初期化</span></div>
<div class="line">    g_ViewVolumeRenderer.Initialize();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// シェーダーに必要なスクラッチメモリーを設定</span></div>
<div class="line">    g3ddemo::SetShaderScratchMemory(g_Holder.shaderFiles);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Townの終了処理</span></div>
<div class="line"><span class="keywordtype">void</span> FinalizeTown(nns::gfx::DebugGraphicsFramework* pGfxFramework, <a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// ビューボリューム表示の終了処理</span></div>
<div class="line">    g_ViewVolumeRenderer.<a name="a135"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a1e04c1ecea4a94b55f119a1526c09278">Finalize</a>();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ライトの終了処理</span></div>
<div class="line">    g_PointLight.Finalize(pDevice);</div>
<div class="line"></div>
<div class="line">    FinalizeViewer();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 平均輝度を求めるシェーダーの破棄</span></div>
<div class="line">    g_TextureAverageShader.Finalize(pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ダミーテクスチャーの破棄</span></div>
<div class="line">    g3ddemo::DeleteDummyTextureAndSampler(pDevice);</div>
<div class="line"></div>
<div class="line">     <span class="comment">// リソースの破棄</span></div>
<div class="line">    FinalizeResource(pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ビューの破棄</span></div>
<div class="line">    g_RenderView.<a name="a136"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#ae2461a77f4a4a5f2c954516604f35a9e">Finalize</a>(pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// コンテキストの破棄</span></div>
<div class="line">    g_Context.Finalize(pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// フレームバッファの終了処理</span></div>
<div class="line">    FinalizeFrameBuffer(pGfxFramework);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 負荷計測メーターの破棄</span></div>
<div class="line">    pGfxFramework-&gt;FinalizePerf();</div>
<div class="line"></div>
<div class="line">     <span class="comment">// バウンディング表示の破棄</span></div>
<div class="line">    g_BoundingRenderer.Finalize(pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// スクリーン情報表示の破棄</span></div>
<div class="line">    g_ScreenInfo.Cleanup(pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// フレームワークのコールバック関数を無効化</span></div>
<div class="line">    pGfxFramework-&gt;SetCalculateCallback(<span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>);</div>
<div class="line">    pGfxFramework-&gt;SetMakeCommandCallback(<span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//-------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">//  更新</span></div>
<div class="line"><span class="comment">//-------------------------------------------------------------------</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// カメラの更新処理</span></div>
<div class="line"><span class="keywordtype">void</span> UpdateCamera(<span class="keyword">const</span> g3ddemo::Pad&amp; pad) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a>&amp; pos = g_CameraPosition;</div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a>&amp; target = g_CameraTarget;</div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a>&amp; up = g_CameraUp;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x3f_type.html">nn::util::Matrix4x3fType</a>&amp; viewMtx = g_RenderView.<a name="a137"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#aff24f2ebd999e9d9f423945fa9d4e8e0">GetViewMtx</a>(ViewType_Default);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> RotSpeed = 0.02f;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> AtMoveSpeed = 20.0f;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> right;</div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> camUp;</div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> look;</div>
<div class="line">    g3ddemo::MatrixGetColumn0(&amp;right, viewMtx);</div>
<div class="line">    g3ddemo::MatrixGetColumn1(&amp;camUp, viewMtx);</div>
<div class="line">    g3ddemo::MatrixGetColumn2(&amp;look, viewMtx);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> diff;</div>
<div class="line">    VectorSubtract(&amp;diff, target, g_CameraPosition);</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">float</span> sqrtLength = VectorLengthSquared(diff);</div>
<div class="line">    <span class="keywordtype">float</span> dist = sqrtLength / std::sqrt(sqrtLength);</div>
<div class="line">    VectorNormalize(&amp;diff, diff);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> dirX;</div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> dirY;</div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> dirZ;</div>
<div class="line"></div>
<div class="line">    VectorCross(&amp;dirZ, right, camUp);</div>
<div class="line">    VectorNormalize(&amp;dirZ, dirZ);</div>
<div class="line"></div>
<div class="line">    VectorCross(&amp;dirY, dirZ, right);</div>
<div class="line">    VectorNormalize(&amp;dirY, dirY);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> g3ddemo::Pad::AnalogStick&amp; analogStick = pad.GetAnalogStick();</div>
<div class="line"></div>
<div class="line">    VectorMultiply(&amp;dirX, right, AtMoveSpeed * (analogStick.rightX));</div>
<div class="line">    VectorAdd(&amp;pos, dirX, pos);</div>
<div class="line">    VectorMultiply(&amp;dirZ, dirZ, AtMoveSpeed * (-analogStick.rightY));</div>
<div class="line">    VectorAdd(&amp;pos, dirZ, pos);</div>
<div class="line"></div>
<div class="line">    <a name="_a138"></a><a class="code" href="structnn_1_1util_1_1_vector4f_type.html">nn::util::Vector4fType</a> quatanion;</div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_vector4f_type.html">nn::util::Vector4fType</a> quatanionX;</div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_vector4f_type.html">nn::util::Vector4fType</a> quatanionY;</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">float</span> angle = analogStick.leftY * RotSpeed * 0.5f;</div>
<div class="line">        <span class="keywordtype">float</span> cos = std::cos(angle);</div>
<div class="line">        <span class="keywordtype">float</span> sin = std::sin(angle);</div>
<div class="line">        VectorSet(&amp;quatanionX, sin * VectorGetX(right), sin * VectorGetY(right), sin * VectorGetZ(right), cos);</div>
<div class="line">    }</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">float</span> angle = analogStick.leftX * -RotSpeed * 0.5f;</div>
<div class="line">        VectorSet(&amp;quatanionY, 0.0f, std::sin(angle), 0.0f, std::cos(angle));</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    QuaternionMultiply(&amp;quatanion, quatanionY, quatanionX);</div>
<div class="line"></div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x3f_type.html">nn::util::Matrix4x3fType</a> matrix;</div>
<div class="line">        MatrixSetRotate(&amp;matrix, quatanion);</div>
<div class="line"></div>
<div class="line">        VectorTransformNormal(&amp;diff, diff, matrix);</div>
<div class="line">        VectorNormalize(&amp;diff, diff);</div>
<div class="line"></div>
<div class="line">        VectorMultiply(&amp;target, diff, dist);</div>
<div class="line">        VectorAdd(&amp;target, target, pos);</div>
<div class="line"></div>
<div class="line">        VectorCross(&amp;up, right, diff);</div>
<div class="line">        VectorSet(&amp;up, 0.0f, (VectorGetY(up) &gt;= 0) ? 1.0f : -1.0f, 0.0f);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x3f_type.html">nn::util::Matrix4x3fType</a> matrix;</div>
<div class="line">        MatrixLookAtRightHanded(&amp;matrix, pos, target, up);</div>
<div class="line">        g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#a5b633742724f63bffdb11389a06b974b">SetViewMtx</a>(ViewType_Default, matrix);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// モデルの更新処理</span></div>
<div class="line"><span class="keywordtype">void</span> CalculateModelAnimObjs(<span class="keywordtype">int</span> uniformBufferIndex, <span class="keywordtype">bool</span> enableAnimation) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// 各描画パス共通のModelAnimObjを更新</span></div>
<div class="line">    <span class="keywordflow">for</span> (<a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html">nns::g3d::ModelAnimObj</a>* pModelAnimObj : g_Holder.modelAnimObjs)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// アニメーションの実行</span></div>
<div class="line">        <span class="keywordflow">if</span> (enableAnimation)</div>
<div class="line">        {</div>
<div class="line">            pModelAnimObj-&gt;<a name="a139"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a82b107da95e7e3d784c583231239312c">CalculateAnimations</a>();</div>
<div class="line"></div>
<div class="line">            <span class="comment">// 3DEditor でスケルタルア二メーションが再生されていた場合には、</span></div>
<div class="line">            <span class="comment">// CalculateAnimations() で更新されたアニメーションを上書きします。</span></div>
<div class="line">            <span class="comment">// また、キャッシュを活用するためにスケルタルアニメーションの計算から</span></div>
<div class="line">            <span class="comment">// ワールド行列計算までを連続して行います。</span></div>
<div class="line">            <a name="a140"></a><a class="code" href="classnn_1_1g3d_1_1viewer_1_1_viewer_server.html#a47e4dee10fee77c93daece0d2f6ccd83">nn::g3d::viewer::ViewerServer::GetInstance</a>().<a name="a141"></a><a class="code" href="classnn_1_1g3d_1_1viewer_1_1_viewer_server.html#af3db15d17f92c36d93953eab0413163a">CalculateSkeletalAnimations</a>(pModelAnimObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a75f2e005c7b06d62f33d69508db503e9">GetModelObj</a>());</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        pModelAnimObj-&gt;<a name="a142"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a02e5ba16654e2ac74bcb2caaed0900ec">CalculateWorld</a>();</div>
<div class="line">        pModelAnimObj-&gt;<a name="a143"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#acefaadd93924a74297cad50f9b37ec5f">CalculateBounding</a>();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (enableAnimation)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnn_1_1g3d_1_1viewer_1_1_viewer_server.html#a47e4dee10fee77c93daece0d2f6ccd83">nn::g3d::viewer::ViewerServer::GetInstance</a>().<a name="a144"></a><a class="code" href="classnn_1_1g3d_1_1viewer_1_1_viewer_server.html#a59245dea48b7f205905c636c40db9806">CalculateAnimations</a>();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html">nns::g3d::ModelAnimObj</a>* pModelAnimObj : g_Holder.modelAnimObjs)</div>
<div class="line">    {</div>
<div class="line">        pModelAnimObj-&gt;<a name="a145"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a42dadacf320552419e3c79da07846ad4">CalculateUniformBlock</a>(uniformBufferIndex);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// リソースホルダーから指定した名前の RenderModelObj を取得</span></div>
<div class="line"><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* FindRenderModelObj(<span class="keyword">const</span> <span class="keywordtype">char</span>* pModelName) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pRenderModelObj : g_Holder.renderModelObjs)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(pRenderModelObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#aa0a852cc2943033071f80f6660185518">GetModelObj</a>()-&gt;<a class="code" href="classnn_1_1g3d_1_1_model_obj.html#af58166699404cb37a59cb3e6daf96011">GetName</a>(), pModelName) != 0)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> pRenderModelObj;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// AABB のサイズを計算</span></div>
<div class="line"><span class="keywordtype">void</span> CalculateAdjustedAabb(</div>
<div class="line">    <a name="_a146"></a><a class="code" href="structnn_1_1g3d_1_1_aabb.html">nn::g3d::Aabb</a>* pAabbObj,</div>
<div class="line">    <a class="code" href="classnns_1_1g3d_1_1_render_unit_obj.html">nns::g3d::RenderUnitObj</a>* pRenderUnitObj,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x3f_type.html">nn::util::Matrix4x3fType</a>* pLightView,</div>
<div class="line">    <a name="_a147"></a><a class="code" href="structnn_1_1g3d_1_1_view_volume.html">nn::g3d::ViewVolume</a>* pViewVolume</div>
<div class="line">) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classnn_1_1g3d_1_1_shape_obj.html">nn::g3d::ShapeObj</a>* pShapeObj = pRenderUnitObj-&gt;<a name="a148"></a><a class="code" href="classnns_1_1g3d_1_1_render_unit_obj.html#a070b738c99704e910bce8d8f332ce988">GetShapeObj</a>();</div>
<div class="line">    <span class="keyword">const</span> <a name="_a149"></a><a class="code" href="structnn_1_1g3d_1_1_sphere.html">nn::g3d::Sphere</a>* pSphere = pShapeObj-&gt;<a name="a150"></a><a class="code" href="classnn_1_1g3d_1_1_shape_obj.html#a311a863e4d0810ddffa988344af47974">GetBounding</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (!pSphere || !pViewVolume-&gt;<a name="a151"></a><a class="code" href="structnn_1_1g3d_1_1_view_volume.html#a27699906ae01800c90654c7cab3d38da">TestIntersection</a>(*pSphere))</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> pos;</div>
<div class="line">    VectorTransform(&amp;pos, pSphere-&gt;<a name="a152"></a><a class="code" href="structnn_1_1g3d_1_1_sphere.html#af9b926645587dc30bef63829d00c6b04">center</a>, *pLightView);</div>
<div class="line">    VectorSet(&amp;pAabbObj-&gt;<a name="a153"></a><a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac88079a3f7535c5f9de555ccdded8a0d">min</a>,</div>
<div class="line">        (std::min)(VectorGetX(pAabbObj-&gt;<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac88079a3f7535c5f9de555ccdded8a0d">min</a>), VectorGetX(pos) - pSphere-&gt;<a name="a154"></a><a class="code" href="structnn_1_1g3d_1_1_sphere.html#a6a3b0a90d98a62e136cf04663c001f6a">radius</a>),</div>
<div class="line">        (std::min)(VectorGetY(pAabbObj-&gt;<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac88079a3f7535c5f9de555ccdded8a0d">min</a>), VectorGetY(pos) - pSphere-&gt;<a class="code" href="structnn_1_1g3d_1_1_sphere.html#a6a3b0a90d98a62e136cf04663c001f6a">radius</a>),</div>
<div class="line">        (std::min)(VectorGetZ(pAabbObj-&gt;<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac88079a3f7535c5f9de555ccdded8a0d">min</a>), VectorGetZ(pos) - pSphere-&gt;<a class="code" href="structnn_1_1g3d_1_1_sphere.html#a6a3b0a90d98a62e136cf04663c001f6a">radius</a>));</div>
<div class="line">    VectorSet(&amp;pAabbObj-&gt;<a name="a155"></a><a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac799e985cdb7fbc2654b04331b03fec8">max</a>,</div>
<div class="line">        (std::max)(VectorGetX(pAabbObj-&gt;<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac799e985cdb7fbc2654b04331b03fec8">max</a>), VectorGetX(pos) + pSphere-&gt;<a class="code" href="structnn_1_1g3d_1_1_sphere.html#a6a3b0a90d98a62e136cf04663c001f6a">radius</a>),</div>
<div class="line">        (std::max)(VectorGetY(pAabbObj-&gt;<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac799e985cdb7fbc2654b04331b03fec8">max</a>), VectorGetY(pos) + pSphere-&gt;<a class="code" href="structnn_1_1g3d_1_1_sphere.html#a6a3b0a90d98a62e136cf04663c001f6a">radius</a>),</div>
<div class="line">        (std::max)(VectorGetZ(pAabbObj-&gt;<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac799e985cdb7fbc2654b04331b03fec8">max</a>), VectorGetZ(pos) + pSphere-&gt;<a class="code" href="structnn_1_1g3d_1_1_sphere.html#a6a3b0a90d98a62e136cf04663c001f6a">radius</a>));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> CanDrawToShadowMap(<span class="keyword">const</span> <a class="code" href="classnns_1_1g3d_1_1_render_unit_obj.html">nns::g3d::RenderUnitObj</a>* pRenderUnitObj, <span class="keywordtype">int</span> passIndex) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a>;</div>
<div class="line"></div>
<div class="line"><span class="comment">// 光源のプロジェクション行列を計算</span></div>
<div class="line"><span class="keywordtype">void</span> CalculateLightProj(</div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x4f_type.html">nn::util::Matrix4x4fType</a>* pOutLightProj,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x3f_type.html">nn::util::Matrix4x3fType</a>* pLightView,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x3f_type.html">nn::util::Matrix4x3fType</a>* pCameraView,</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x4f_type.html">nn::util::Matrix4x4fType</a>* pCameraProj</div>
<div class="line">) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x4f_type.html">nn::util::Matrix4x4fType</a> cameraViewProj;</div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x4f_type.html">nn::util::Matrix4x4fType</a> invCameraViewProj;</div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x4f_type.html">nn::util::Matrix4x4fType</a> screenToLightView;</div>
<div class="line">    MatrixMultiply(&amp;cameraViewProj, *pCameraView, *pCameraProj);</div>
<div class="line">    MatrixInverse(&amp;invCameraViewProj, cameraViewProj);</div>
<div class="line">    MatrixMultiply(&amp;screenToLightView, invCameraViewProj, *pLightView);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="structnn_1_1g3d_1_1_aabb.html">nn::g3d::Aabb</a> aabb;</div>
<div class="line">    <a class="code" href="structnn_1_1g3d_1_1_aabb.html">nn::g3d::Aabb</a> aabbObj;</div>
<div class="line">    VectorSet(&amp;aabb.<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac88079a3f7535c5f9de555ccdded8a0d">min</a>, FLT_MAX, FLT_MAX, FLT_MAX);</div>
<div class="line">    VectorSet(&amp;aabbObj.<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac88079a3f7535c5f9de555ccdded8a0d">min</a>, FLT_MAX, FLT_MAX, FLT_MAX);</div>
<div class="line">    VectorSet(&amp;aabb.<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac799e985cdb7fbc2654b04331b03fec8">max</a>, -FLT_MAX, -FLT_MAX, -FLT_MAX);</div>
<div class="line">    VectorSet(&amp;aabbObj.<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac799e985cdb7fbc2654b04331b03fec8">max</a>, -FLT_MAX, -FLT_MAX, -FLT_MAX);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> posLightView;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x &lt; 2; ++x)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y &lt; 2; ++y)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> z = 0; z &lt; 2; ++z)</div>
<div class="line">            {</div>
<div class="line">                VectorSet(&amp;posLightView,</div>
<div class="line">                    x == 0 ? -1.0f : 1.0f,</div>
<div class="line">                    y == 0 ? -1.0f : 1.0f,</div>
<div class="line">                    z == 0 ? -1.0f : 1.0f);</div>
<div class="line">                VectorTransformCoord(&amp;posLightView, posLightView, screenToLightView);</div>
<div class="line">                VectorSet(&amp;aabb.<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac88079a3f7535c5f9de555ccdded8a0d">min</a>,</div>
<div class="line">                    (std::min)(VectorGetX(aabb.<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac88079a3f7535c5f9de555ccdded8a0d">min</a>), VectorGetX(posLightView)),</div>
<div class="line">                    (std::min)(VectorGetY(aabb.<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac88079a3f7535c5f9de555ccdded8a0d">min</a>), VectorGetY(posLightView)),</div>
<div class="line">                    (std::min)(VectorGetZ(aabb.<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac88079a3f7535c5f9de555ccdded8a0d">min</a>), VectorGetZ(posLightView)));</div>
<div class="line">                VectorSet(&amp;aabb.<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac799e985cdb7fbc2654b04331b03fec8">max</a>,</div>
<div class="line">                    (std::max)(VectorGetX(aabb.<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac799e985cdb7fbc2654b04331b03fec8">max</a>), VectorGetX(posLightView)),</div>
<div class="line">                    (std::max)(VectorGetY(aabb.<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac799e985cdb7fbc2654b04331b03fec8">max</a>), VectorGetY(posLightView)),</div>
<div class="line">                    (std::max)(VectorGetZ(aabb.<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac799e985cdb7fbc2654b04331b03fec8">max</a>), VectorGetZ(posLightView)));</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="structnn_1_1g3d_1_1_view_volume.html">nn::g3d::ViewVolume</a> viewVolume;</div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x3f_type.html">nn::util::Matrix4x3fType</a> invLightView;</div>
<div class="line">    MatrixInverse(&amp;invLightView, *pLightView);</div>
<div class="line">    viewVolume.<a name="a156"></a><a class="code" href="structnn_1_1g3d_1_1_view_volume.html#a1c153ca33802ebdffa981311c7d515eb">SetOrtho</a>(VectorGetY(aabb.<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac799e985cdb7fbc2654b04331b03fec8">max</a>), VectorGetY(aabb.<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac88079a3f7535c5f9de555ccdded8a0d">min</a>), VectorGetX(aabb.<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac88079a3f7535c5f9de555ccdded8a0d">min</a>), VectorGetX(aabb.<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac799e985cdb7fbc2654b04331b03fec8">max</a>), 0.0f, -VectorGetZ(aabb.<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac88079a3f7535c5f9de555ccdded8a0d">min</a>), invLightView);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pRenderModelObj : g_Holder.renderModelObjs)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> shapeIndex = 0, shapeCount = pRenderModelObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#aa0a852cc2943033071f80f6660185518">GetModelObj</a>()-&gt;<a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a54e1cf48111ecb56b8dde5824d13a1fd">GetShapeCount</a>(); shapeIndex &lt; shapeCount; ++shapeIndex)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="classnns_1_1g3d_1_1_render_unit_obj.html">nns::g3d::RenderUnitObj</a>* pRenderUnitObj = pRenderModelObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a7c323f2e5100196cc55a5d778de6630a">GetRenderUnitObj</a>(shapeIndex);</div>
<div class="line">            <span class="keywordflow">if</span> (!CanDrawToShadowMap(pRenderUnitObj, DrawPassType_Shadow))</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line">            CalculateAdjustedAabb(&amp;aabbObj, pRenderUnitObj, pLightView, &amp;viewVolume);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    MatrixOrthographicOffCenterRightHanded(pOutLightProj,</div>
<div class="line">        VectorGetX(aabbObj.<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac88079a3f7535c5f9de555ccdded8a0d">min</a>), VectorGetX(aabbObj.<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac799e985cdb7fbc2654b04331b03fec8">max</a>), VectorGetY(aabbObj.<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac88079a3f7535c5f9de555ccdded8a0d">min</a>),</div>
<div class="line">        VectorGetY(aabbObj.<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac799e985cdb7fbc2654b04331b03fec8">max</a>), -VectorGetZ(aabbObj.<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac799e985cdb7fbc2654b04331b03fec8">max</a>), -VectorGetZ(aabbObj.<a class="code" href="structnn_1_1g3d_1_1_aabb.html#ac88079a3f7535c5f9de555ccdded8a0d">min</a>));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// コンテキストの計算</span></div>
<div class="line"><span class="keywordtype">void</span> CalculateContext(<span class="keywordtype">int</span> bufferIndex) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">float</span> cascadeDepth[TownContext::cascadeShadowCount + 1] = { 10.0f, 800.0f, 1600.0f, 4500.0f, 40000.0f };</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ライトの位置をマテリアルから更新</span></div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classnn_1_1g3d_1_1_material_obj.html">nn::g3d::MaterialObj</a>* pEnvMaterial = g_pEnvModelObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a225cda4a0e7881df5dc4ebb15ac6c6f6">GetMaterial</a>(0);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> paramIndex = 0, paramCount = pEnvMaterial-&gt;<a name="a157"></a><a class="code" href="classnn_1_1g3d_1_1_material_obj.html#a92e4a14e18379878b68e8a1df4906e8f">GetShaderParamCount</a>(); paramIndex &lt; paramCount; ++paramIndex)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span>* paramName = pEnvMaterial-&gt;<a name="a158"></a><a class="code" href="classnn_1_1g3d_1_1_material_obj.html#ad0d7594dd997ea0ce862ed400fb82793">GetShaderParamName</a>(paramIndex);</div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(paramName, <span class="stringliteral">&quot;dir_light_dir&quot;</span>) != 0)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="structnn_1_1util_1_1_float3.html">nn::util::Float3</a>* lightDir = pEnvMaterial-&gt;<a name="a159"></a><a class="code" href="classnn_1_1g3d_1_1_material_obj.html#a1864c83787f076a1bd8edf556ef82c48">GetShaderParam</a>&lt;<a class="code" href="structnn_1_1util_1_1_float3.html">nn::util::Float3</a>&gt;(paramIndex);</div>
<div class="line">        nn::util::VectorSet(&amp;g_LightPosition, -lightDir-&gt;<a name="a160"></a>x * 2000.0f, -lightDir-&gt;<a name="a161"></a>y * 2200.0f, -lightDir-&gt;<a name="a162"></a>z * 2000.0f);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> sliceIndex = 0; sliceIndex &lt; TownContext::cascadeShadowCount; ++sliceIndex)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x4f_type.html">nn::util::Matrix4x4fType</a> projMtx;</div>
<div class="line">        MatrixPerspectiveFieldOfViewRightHanded(&amp;projMtx, <a class="code" href="namespacenn_1_1util.html#a342713848fbb4ce6750da90d297bc824">nn::util::DegreeToRadian</a>(45.0f), 16.0f / 9.0f, cascadeDepth[sliceIndex], cascadeDepth[sliceIndex + 1]);</div>
<div class="line"></div>
<div class="line">        <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> up = <a name="a163"></a><a class="code" href="util___vector_api_8h.html#ad240ddb9de10d0854bf3af10a4bead74">NN_UTIL_VECTOR_3F_INITIALIZER</a>(0.0f, 1.0f, 0.0f);</div>
<div class="line">        <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> target = <a class="code" href="util___vector_api_8h.html#ad240ddb9de10d0854bf3af10a4bead74">NN_UTIL_VECTOR_3F_INITIALIZER</a>(0.0f, 0.0f, 0.0f);</div>
<div class="line"></div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x3f_type.html">nn::util::Matrix4x3fType</a> matrix;</div>
<div class="line">            MatrixLookAtRightHanded(&amp;matrix, g_LightPosition, target, up);</div>
<div class="line">            g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#a5b633742724f63bffdb11389a06b974b">SetViewMtx</a>(ViewType_Light0 + sliceIndex, matrix);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x4f_type.html">nn::util::Matrix4x4fType</a> matrix;</div>
<div class="line">            CalculateLightProj(</div>
<div class="line">                &amp;matrix,</div>
<div class="line">                &amp;g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#aff24f2ebd999e9d9f423945fa9d4e8e0">GetViewMtx</a>(ViewType_Light0 + sliceIndex),</div>
<div class="line">                &amp;g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#aff24f2ebd999e9d9f423945fa9d4e8e0">GetViewMtx</a>(ViewType_Default),</div>
<div class="line">                &amp;projMtx</div>
<div class="line">            );</div>
<div class="line"></div>
<div class="line">            g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#ab2d9de5f49ec96d7672389badb1acf46">SetProjectionMtx</a>(ViewType_Light0 + sliceIndex, matrix);</div>
<div class="line">        }</div>
<div class="line">        MatrixMultiply(&amp;projMtx, g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#aff24f2ebd999e9d9f423945fa9d4e8e0">GetViewMtx</a>(ViewType_Light0 + sliceIndex), g_RenderView.<a name="a164"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#afa649636fe025a114183f493e836c328">GetProjectionMtx</a>(ViewType_Light0 + sliceIndex));</div>
<div class="line"></div>
<div class="line">        g_Context.SetLightProjection(bufferIndex, sliceIndex, projMtx);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    g_Context.SetCascadeDepth(bufferIndex, &amp;cascadeDepth[1]);</div>
<div class="line">    g_Context.SetNearFar(bufferIndex, 10.0f, 40000.0f);</div>
<div class="line">    <span class="keywordtype">float</span> tanFovY = std::tan(<a class="code" href="namespacenn_1_1util.html#a342713848fbb4ce6750da90d297bc824">nn::util::DegreeToRadian</a>(45.0f * 0.5f));</div>
<div class="line">    g_Context.SetTangentFov(bufferIndex, tanFovY * (16.0f / 9.0f), tanFovY);</div>
<div class="line">    <span class="keywordflow">if</span> (g_MenuFlag.Test&lt;MenuFlag::TextureCompute&gt;() &amp;&amp; g_FrameCount &gt; 1)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// 輝度平均を算出</span></div>
<div class="line">        g_TextureAverageShader.CalculateAverage(bufferIndex);</div>
<div class="line">        <a name="_a165"></a><a class="code" href="structnn_1_1util_1_1_float4.html">nn::util::Float4</a>&amp; texAverage = g_TextureAverageShader.GetTextureAverage(bufferIndex);</div>
<div class="line">        <span class="keywordtype">float</span> diff = texAverage.<a name="a166"></a>x + texAverage.<a name="a167"></a>y + texAverage.<a name="a168"></a>z - 0.65f;</div>
<div class="line">        <span class="comment">// 前回計算した結果</span></div>
<div class="line">        <span class="keywordtype">float</span> diffIntensity = g_Context.GetDiffIntensity(1 - bufferIndex);</div>
<div class="line">        diffIntensity -= diff * diff * diff * 0.04f;</div>
<div class="line">        <span class="keywordflow">if</span> (diffIntensity &lt; 0.3f) diffIntensity = 0.3f;</div>
<div class="line">        <span class="keywordflow">if</span> (diffIntensity &gt; 1.7f) diffIntensity = 1.7f;</div>
<div class="line">        g_Context.SetDiffIntensity(bufferIndex, diffIntensity);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        g_Context.SetDiffIntensity(bufferIndex, nn::g3d::Math::Abs(((g_FrameCount + 27000) % 36000 - 18000) / 18000.0f) * 2.0f);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    g_Context.Calculate(bufferIndex);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Env ユニフォームブロックの更新</span></div>
<div class="line"><span class="keywordtype">void</span> RegisterEnvUniformBlock(<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pRenderModelObj) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">     <span class="keyword">const</span> <a class="code" href="classnn_1_1g3d_1_1_material_obj.html">nn::g3d::MaterialObj</a>* pEnvMaterialObj = g_pEnvModelObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a225cda4a0e7881df5dc4ebb15ac6c6f6">GetMaterial</a>(0);</div>
<div class="line">     <span class="keyword">const</span> <a name="_a169"></a><a class="code" href="classnn_1_1gfx_1_1_t_buffer.html">nn::gfx::Buffer</a>* buffers[g_BufferingCount];</div>
<div class="line">     {</div>
<div class="line">         buffers[0] = pEnvMaterialObj-&gt;<a name="a170"></a><a class="code" href="classnn_1_1g3d_1_1_material_obj.html#aef15d5bfda74edf022aa6337f13d52ed">GetMaterialBlock</a>(0);</div>
<div class="line">         buffers[1] = pEnvMaterialObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_material_obj.html#aef15d5bfda74edf022aa6337f13d52ed">GetMaterialBlock</a>(1);</div>
<div class="line">     }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// シェーダーアサインに定義されてるシェーディングモデル名が env だった場合には、</span></div>
<div class="line">    <span class="comment">// マテリアルユニフォームブロックを利用するため設定を行いません。</span></div>
<div class="line">    <a class="code" href="classnn_1_1g3d_1_1_model_obj.html">nn::g3d::ModelObj</a>* pModelObj = pRenderModelObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#aa0a852cc2943033071f80f6660185518">GetModelObj</a>();</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> shapeIndex = 0, shapeCount = pModelObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a54e1cf48111ecb56b8dde5824d13a1fd">GetShapeCount</a>(); shapeIndex &lt; shapeCount; ++shapeIndex)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">int</span> materialIndex = pModelObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a4f56c9a4a685ff577c44b60bc50f5a8b">GetShape</a>(shapeIndex)-&gt;<a name="a171"></a><a class="code" href="classnn_1_1g3d_1_1_shape_obj.html#af40ab5352dfd30bc5e42f9aff17a70dc">GetMaterialIndex</a>();</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classnn_1_1g3d_1_1_material_obj.html">nn::g3d::MaterialObj</a>* pMaterialObj = pModelObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a225cda4a0e7881df5dc4ebb15ac6c6f6">GetMaterial</a>(materialIndex);</div>
<div class="line">        <span class="keyword">const</span> <a name="_a172"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_assign.html">nn::g3d::ResShaderAssign</a>* pShaderAssign = pMaterialObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_material_obj.html#ac83012bf24ce5dafd6fed058a9700975">GetResource</a>()-&gt;<a name="a173"></a><a class="code" href="classnn_1_1g3d_1_1_res_material.html#a264b8eaf26b01fcf6dc0771b27c03aad">GetShaderAssign</a>();</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span>* shadingModelName = pShaderAssign-&gt;<a name="a174"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_assign.html#af19bb02607868a0ee63245e8eda8d642">GetShadingModelName</a>();</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (strcmp(shadingModelName, <span class="stringliteral">&quot;town_env&quot;</span>) == 0)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        pRenderModelObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a7c323f2e5100196cc55a5d778de6630a">GetRenderUnitObj</a>(shapeIndex)-&gt;<a name="a175"></a><a class="code" href="classnns_1_1g3d_1_1_render_unit_obj.html#a879b6856bffb1352bc6a4f5ba5ee93cc">BindUniformBlock</a>(<span class="stringliteral">&quot;env&quot;</span>, buffers, g_BufferingCount);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// 計算処理</span></div>
<div class="line"><span class="keywordtype">void</span> Calculate(<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html">nns::gfx::GraphicsFramework</a>* pGfxFramework, <span class="keywordtype">void</span>* pUserData) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="nn___macro_8h.html#af2d1673769927c5eae977d8dde3ce106">NN_UNUSED</a>(pGfxFramework);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice = pGfxFramework-&gt;<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a6dbabc4b1fab1df227e879443468b749">GetDevice</a>();</div>
<div class="line">    <span class="keywordtype">int</span> uniformBufferIndex = *<span class="keyword">reinterpret_cast&lt;</span><span class="keywordtype">int</span>*<span class="keyword">&gt;</span>(pUserData);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 計算</span></div>
<div class="line">    <a name="a176"></a><a class="code" href="perf___profile_8h.html#ac0cbbec62451185954e3e6a11cac2fa8">NN_PERF_SET_COLOR</a>(<a name="a177"></a><a class="code" href="classnn_1_1util_1_1_color4u8.html#a60d33066a521b0728f8660d12e010d8c">nn::util::Color4u8::Green</a>());</div>
<div class="line">    <a name="a178"></a><a class="code" href="perf___profile_8h.html#a9589655224905f671b5e15a02838305c">NN_PERF_BEGIN_MEASURE_NAME</a>(<span class="stringliteral">&quot;Calculate 1&quot;</span>);</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> g3ddemo::Pad&amp; pad = g3ddemo::GetPad();</div>
<div class="line"></div>
<div class="line">        <span class="comment">// メニューコントロール</span></div>
<div class="line">        UpdateMenuParameter(pad);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// カメラコントロール</span></div>
<div class="line">        UpdateCamera(pad);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// 水面用のビュー行列を更新</span></div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> pos;</div>
<div class="line">            VectorSet(&amp;pos, VectorGetX(g_CameraPosition), -VectorGetY(g_CameraPosition), VectorGetZ(g_CameraPosition));</div>
<div class="line">            <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> target;</div>
<div class="line">            VectorSet(&amp;target, VectorGetX(g_CameraTarget), -VectorGetY(g_CameraTarget), VectorGetZ(g_CameraTarget));</div>
<div class="line"></div>
<div class="line">            <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x3f_type.html">nn::util::Matrix4x3fType</a> matrix;</div>
<div class="line">            MatrixLookAtRightHanded(&amp;matrix, pos, target, g_CameraUp);</div>
<div class="line">            g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#a5b633742724f63bffdb11389a06b974b">SetViewMtx</a>(ViewType_Water, matrix);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// 環境モデルの更新処理</span></div>
<div class="line">        g_pEnvModelObj-&gt;<a name="a179"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a674b6b3417778ae519cf3bc6d6f5ff65">CalculateMaterial</a>(uniformBufferIndex);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// ビューアーの更新処理</span></div>
<div class="line">        g_TownViewer.Update();</div>
<div class="line"></div>
<div class="line">        <span class="comment">// ModelAnimObjの更新処理</span></div>
<div class="line">        CalculateModelAnimObjs(uniformBufferIndex, g_MenuFlag.Test&lt;MenuFlag::ModelAnimation&gt;());</div>
<div class="line"></div>
<div class="line">        <span class="comment">// シェーダーの更新処理</span></div>
<div class="line">        <span class="keywordflow">for</span> (<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pRenderModelObj : g_Holder.renderModelObjs)</div>
<div class="line">        {</div>
<div class="line">            RegisterEnvUniformBlock(pRenderModelObj);</div>
<div class="line"></div>
<div class="line">            <span class="keywordtype">bool</span> isSucceeded = pRenderModelObj-&gt;<a name="a180"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a2abf914afb4d7489f87c6ea7a3fe5ac1">UpdateShader</a>(pDevice);</div>
<div class="line">            <a class="code" href="nn___macro_8h.html#af2d1673769927c5eae977d8dde3ce106">NN_UNUSED</a>(isSucceeded);</div>
<div class="line">            <a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(isSucceeded);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">bool</span> isSucceeded = g_TextureAverageShader.UpdateShader(pDevice);</div>
<div class="line">            <a class="code" href="nn___macro_8h.html#af2d1673769927c5eae977d8dde3ce106">NN_UNUSED</a>(isSucceeded);</div>
<div class="line">            <a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(isSucceeded);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// ライトの更新処理</span></div>
<div class="line">        g_PointLight.Calculate(pDevice, uniformBufferIndex, g_MenuFlag.Test&lt;MenuFlag::LightAnimation&gt;());</div>
<div class="line"></div>
<div class="line">        <span class="comment">// コンテキストの計算</span></div>
<div class="line">        CalculateContext(uniformBufferIndex);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// ビューの更新処理</span></div>
<div class="line">        g_RenderView.<a name="a181"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#aea54457661666de292743fe0cb6c75a0">Calculate</a>(uniformBufferIndex);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// ビューボリューム描画設定の更新</span></div>
<div class="line">        g_ViewVolumeRenderer.Update(uniformBufferIndex);</div>
<div class="line">        g_ViewVolumeRenderer.SetViewMatrix(g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#aff24f2ebd999e9d9f423945fa9d4e8e0">GetViewMtx</a>(ViewType_Default));</div>
<div class="line">        g_ViewVolumeRenderer.SetProjectionMatrix(g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#afa649636fe025a114183f493e836c328">GetProjectionMtx</a>(ViewType_Default));</div>
<div class="line"></div>
<div class="line">        <span class="comment">// フラスタムカリング用のビューボリュームを更新</span></div>
<div class="line">        <span class="keywordflow">if</span> (g_MenuFlag.Test&lt;MenuFlag::FreezeViewVolume&gt;())</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (g_SelectedViewType != ViewType_Default)</div>
<div class="line">            {</div>
<div class="line">                 g_RenderView.<a name="a182"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#a100b745a702bfed5c0e2192d3c943a3f">GetViewVolume</a>(ViewType_Default).<a name="a183"></a><a class="code" href="structnn_1_1g3d_1_1_view_volume.html#a243414ea182959c9e1685d2e5e756339">SetPerspective</a>(<a class="code" href="namespacenn_1_1util.html#a342713848fbb4ce6750da90d297bc824">nn::util::DegreeToRadian</a>(45.0f), 16.0f / 9.0f,</div>
<div class="line">                10.0f, 40000.0f, g_RenderView.<a name="a184"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#a836001447f77827d1ec62ccead0df40f">GetInverseViewMtx</a>(ViewType_Default));</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (g_SelectedViewType != ViewType_Water)</div>
<div class="line">            {</div>
<div class="line">                g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#a100b745a702bfed5c0e2192d3c943a3f">GetViewVolume</a>(ViewType_Water).<a class="code" href="structnn_1_1g3d_1_1_view_volume.html#a243414ea182959c9e1685d2e5e756339">SetPerspective</a>(<a class="code" href="namespacenn_1_1util.html#a342713848fbb4ce6750da90d297bc824">nn::util::DegreeToRadian</a>(45.0f), 16.0f / 9.0f,</div>
<div class="line">                10.0f, 40000.0f, g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#a836001447f77827d1ec62ccead0df40f">GetInverseViewMtx</a>(ViewType_Water));</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#a100b745a702bfed5c0e2192d3c943a3f">GetViewVolume</a>(ViewType_Default).<a class="code" href="structnn_1_1g3d_1_1_view_volume.html#a243414ea182959c9e1685d2e5e756339">SetPerspective</a>(<a class="code" href="namespacenn_1_1util.html#a342713848fbb4ce6750da90d297bc824">nn::util::DegreeToRadian</a>(45.0f), 16.0f / 9.0f,</div>
<div class="line">                10.0f, 40000.0f, g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#a836001447f77827d1ec62ccead0df40f">GetInverseViewMtx</a>(ViewType_Default));</div>
<div class="line">            g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#a100b745a702bfed5c0e2192d3c943a3f">GetViewVolume</a>(ViewType_Water).<a class="code" href="structnn_1_1g3d_1_1_view_volume.html#a243414ea182959c9e1685d2e5e756339">SetPerspective</a>(<a class="code" href="namespacenn_1_1util.html#a342713848fbb4ce6750da90d297bc824">nn::util::DegreeToRadian</a>(45.0f), 16.0f / 9.0f,</div>
<div class="line">                10.0f, 40000.0f, g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#a836001447f77827d1ec62ccead0df40f">GetInverseViewMtx</a>(ViewType_Water));</div>
<div class="line"></div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x3f_type.html">nn::util::Matrix4x3fType</a> viewMatrix = g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#aff24f2ebd999e9d9f423945fa9d4e8e0">GetViewMtx</a>(g_SelectedViewType);</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x4f_type.html">nn::util::Matrix4x4fType</a> projectionMatrix = g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#afa649636fe025a114183f493e836c328">GetProjectionMtx</a>(g_SelectedViewType);</div>
<div class="line">            <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x4f_type.html">nn::util::Matrix4x4fType</a> viewProjectionMatrix;</div>
<div class="line">            nn::util::MatrixMultiply(&amp;viewProjectionMatrix, viewMatrix, projectionMatrix);</div>
<div class="line"></div>
<div class="line">            nn::util::MatrixInverse(&amp;g_InvViewProjectionMatrix, viewProjectionMatrix);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <a name="a185"></a><a class="code" href="perf___profile_8h.html#a0a94d0601ec383fed996a444d77c3e53">NN_PERF_END_MEASURE</a>();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//-------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">//  描画</span></div>
<div class="line"><span class="comment">//-------------------------------------------------------------------</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// 画面のクリア</span></div>
<div class="line"><span class="keywordtype">void</span> ClearScreen(<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html">nns::gfx::GraphicsFramework</a>* pGfxFramework, <a name="_a186"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html">nn::gfx::CommandBuffer</a>* pCommandBuffer) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <a name="a187"></a><a class="code" href="perf___profile_8h.html#af2d54f7bfca84e3d33b2009f6334f169">NN_PERF_SET_COLOR_GPU</a>(<a name="a188"></a><a class="code" href="classnn_1_1util_1_1_color4u8.html#a491184555fc9bbc5a4020fa8d37c70ac">nn::util::Color4u8::Black</a>());</div>
<div class="line">    <a name="a189"></a><a class="code" href="perf___profile_8h.html#ae7dc0bda5eab2fc0a3c36f5a92683580">NN_PERF_BEGIN_MEASURE_NAME_GPU</a>(pCommandBuffer, <span class="stringliteral">&quot;Clear&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// フレームバッファーをクリア</span></div>
<div class="line">    g3ddemo::ClearFrameBuffer(pCommandBuffer, &amp;g_FrameBuffer[FrameBufferType_Water]);</div>
<div class="line">    g3ddemo::ClearFrameBuffer(pCommandBuffer, &amp;g_FrameBuffer[FrameBufferType_Geometry]);</div>
<div class="line">    g3ddemo::ClearFrameBuffer(pCommandBuffer, &amp;g_FrameBuffer[FrameBufferType_Shadow]);</div>
<div class="line">    g3ddemo::ClearFrameBuffer(pCommandBuffer, &amp;g_FrameBuffer[FrameBufferType_Light]);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// シャドウ用の深度ステンシルをクリア</span></div>
<div class="line">    <a name="_a190"></a><a class="code" href="classnn_1_1gfx_1_1_t_depth_stencil_view.html">nn::gfx::DepthStencilView</a>* pShadowDepth = g_DepthBufferShadow.GetDepthStencilView(0);</div>
<div class="line">    pCommandBuffer-&gt;<a name="a191"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#ae51f685157847b92ffb0c05362a4a6ef">ClearDepthStencil</a>(pShadowDepth, 1.0f, 0, <a name="a192"></a><a class="code" href="namespacenn_1_1gfx.html#a733cd65018ead22dd2cd0a62a8bd2ec9a93c09969027b90e4794060197dedb5fb">nn::gfx::DepthStencilClearMode_DepthStencil</a>, <span class="keyword">nullptr</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// カラーターゲットをクリア</span></div>
<div class="line">    <a name="_a193"></a><a class="code" href="classnn_1_1gfx_1_1_t_color_target_view.html">nn::gfx::ColorTargetView</a>* pColor = pGfxFramework-&gt;<a name="a194"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#ab825acf6f1e23e4946e8915d087a94a1">GetColorTargetView</a>();</div>
<div class="line">    pCommandBuffer-&gt;<a name="a195"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#a3da2d3c95fe888adb5a3f84dcc013d45">ClearColor</a>(pColor, 0.0f, 0.0f, 0.0f, 1.0f, <span class="keyword">nullptr</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 深度ステンシルをクリア</span></div>
<div class="line">    <a class="code" href="classnn_1_1gfx_1_1_t_depth_stencil_view.html">nn::gfx::DepthStencilView</a>* pDepth = pGfxFramework-&gt;<a name="a196"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#ae375791c8ef66431a6910dafd0156bb2">GetDepthStencilView</a>();</div>
<div class="line">    pCommandBuffer-&gt;<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#ae51f685157847b92ffb0c05362a4a6ef">ClearDepthStencil</a>(pDepth, 1.0f, 0, <a class="code" href="namespacenn_1_1gfx.html#a733cd65018ead22dd2cd0a62a8bd2ec9a93c09969027b90e4794060197dedb5fb">nn::gfx::DepthStencilClearMode_DepthStencil</a>, <span class="keyword">nullptr</span>);</div>
<div class="line"></div>
<div class="line">    <a name="a197"></a><a class="code" href="perf___profile_8h.html#a5289e91681166ba39ce97d6eb116c59d">NN_PERF_END_MEASURE_GPU</a>(pCommandBuffer);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// シャドウマップに描画するか判定</span></div>
<div class="line"><span class="keywordtype">bool</span> CanDrawToShadowMap(<span class="keyword">const</span> <a class="code" href="classnns_1_1g3d_1_1_render_unit_obj.html">nns::g3d::RenderUnitObj</a>* pRenderUnitObj, <span class="keywordtype">int</span> passIndex) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classnn_1_1g3d_1_1_res_material.html">nn::g3d::ResMaterial</a>* pResMaterial = pRenderUnitObj-&gt;<a name="a198"></a><a class="code" href="classnns_1_1g3d_1_1_render_unit_obj.html#ae92c38daa56f51aaffec96046eaea77d">GetRenderShape</a>(passIndex)-&gt;<a name="a199"></a><a class="code" href="classnns_1_1g3d_1_1_render_shape.html#a2d71fdcacfb733e7c945b46f0497f417">GetRenderMaterial</a>()-&gt;<a name="a200"></a><a class="code" href="classnns_1_1g3d_1_1_render_material.html#a056a695c32d1ffa9ba15478b21d80175">GetResMaterial</a>();</div>
<div class="line">    <span class="keyword">const</span> <a name="_a201"></a><a class="code" href="classnn_1_1g3d_1_1_res_render_info.html">nn::g3d::ResRenderInfo</a>* pRenderInfo = pResMaterial-&gt;<a name="a202"></a><a class="code" href="classnn_1_1g3d_1_1_res_material.html#a173fe82a044bd944283cfb617b8111c1">FindRenderInfo</a>(<span class="stringliteral">&quot;dynamic_shadow&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!pRenderInfo)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> *pRenderInfo-&gt;<a name="a203"></a><a class="code" href="classnn_1_1g3d_1_1_res_render_info.html#ad7542986cc293f55fbb39a116597ce1a">GetInt</a>() == 1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// シャドウの描画</span></div>
<div class="line"><span class="keywordtype">void</span> DrawShadow(<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html">nn::gfx::CommandBuffer</a>* pCommandBuffer, <span class="keywordtype">int</span> uniformBufferIndex) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!g_MenuFlag.Test&lt;MenuFlag::ShadowRendering&gt;())</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="perf___profile_8h.html#af2d54f7bfca84e3d33b2009f6334f169">NN_PERF_SET_COLOR_GPU</a>(<a name="a204"></a><a class="code" href="classnn_1_1util_1_1_color4u8.html#a74cab22bd85f0940aec269c535ee5b54">nn::util::Color4u8::Red</a>());</div>
<div class="line">    <a class="code" href="perf___profile_8h.html#ae7dc0bda5eab2fc0a3c36f5a92683580">NN_PERF_BEGIN_MEASURE_NAME_GPU</a>(pCommandBuffer, <span class="stringliteral">&quot;Shadow&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> sliceIndex = 0; sliceIndex &lt; TownContext::cascadeShadowCount; ++sliceIndex)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnn_1_1gfx_1_1_t_color_target_view.html">nn::gfx::ColorTargetView</a>* pColorTargetView = g_FrameBuffer[FrameBufferType_Shadow].GetColorBuffer()-&gt;GetColorTargetView();</div>
<div class="line">        pCommandBuffer-&gt;<a name="a205"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#a3698a1cbd3b59b649c048f709ddd766c">SetRenderTargets</a>(1, &amp;pColorTargetView, g_DepthBufferShadow.GetDepthStencilView(sliceIndex + 1));</div>
<div class="line">        pCommandBuffer-&gt;<a name="a206"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#ab1c541475f015777b8ce4bdfffe7c1c3">SetViewportScissorState</a>(g_FrameBuffer[FrameBufferType_Shadow].GetViewportScissorState());</div>
<div class="line"></div>
<div class="line">        <span class="comment">// ユニフォームブロックを再バインド</span></div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classnn_1_1gfx_1_1_t_buffer.html">nn::gfx::Buffer</a>* buffers[g_BufferingCount];</div>
<div class="line">        buffers[0] = g_RenderView.<a name="a207"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#ac12827c0d0788017a196ef5b80304304">GetViewUniformBlock</a>(ViewType_Light0 + sliceIndex, 0);</div>
<div class="line">        buffers[1] = g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#ac12827c0d0788017a196ef5b80304304">GetViewUniformBlock</a>(ViewType_Light0 + sliceIndex, 1);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pRenderModelObj : g_Holder.renderModelObjs)</div>
<div class="line">        {</div>
<div class="line">            pRenderModelObj-&gt;<a name="a208"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a51705d6e0cbec14deae05e0dc0724835">BindUniformBlock</a>(DrawPassType_Shadow, <span class="stringliteral">&quot;view&quot;</span>, buffers, g_BufferingCount);</div>
<div class="line">            pRenderModelObj-&gt;<a name="a209"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#aa4061058dfcb32e29b89c6f50cb23738">Draw</a>(</div>
<div class="line">                pCommandBuffer,</div>
<div class="line">                DrawPassType_Shadow,</div>
<div class="line">                ViewType_Light0 + sliceIndex,</div>
<div class="line">                uniformBufferIndex,</div>
<div class="line">                CanDrawToShadowMap</div>
<div class="line">            );</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="perf___profile_8h.html#a5289e91681166ba39ce97d6eb116c59d">NN_PERF_END_MEASURE_GPU</a>(pCommandBuffer);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// 水面の描画</span></div>
<div class="line"><span class="keywordtype">void</span> DrawWater(<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html">nn::gfx::CommandBuffer</a>* pCommandBuffer, <span class="keywordtype">int</span> uniformBufferIndex) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!g_MenuFlag.Test&lt;MenuFlag::WaterRendering&gt;())</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="perf___profile_8h.html#af2d54f7bfca84e3d33b2009f6334f169">NN_PERF_SET_COLOR_GPU</a>(<a name="a210"></a><a class="code" href="classnn_1_1util_1_1_color4u8.html#a5ad1502b37a61d84307433906727813c">nn::util::Color4u8::Blue</a>());</div>
<div class="line">    <a class="code" href="perf___profile_8h.html#ae7dc0bda5eab2fc0a3c36f5a92683580">NN_PERF_BEGIN_MEASURE_NAME_GPU</a>(pCommandBuffer, <span class="stringliteral">&quot;Water&quot;</span>);</div>
<div class="line"></div>
<div class="line">    g3ddemo::SetFrameBufferToRenderTarget(pCommandBuffer, &amp;g_FrameBuffer[FrameBufferType_Water]);</div>
<div class="line">    pCommandBuffer-&gt;<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#ab1c541475f015777b8ce4bdfffe7c1c3">SetViewportScissorState</a>(g_FrameBuffer[FrameBufferType_Water].GetViewportScissorState());</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pRenderModelObj : g_Holder.renderModelObjs)</div>
<div class="line">    {</div>
<div class="line">        pRenderModelObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#aa4061058dfcb32e29b89c6f50cb23738">Draw</a>(pCommandBuffer, DrawPassType_Water, ViewType_Water, uniformBufferIndex);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="perf___profile_8h.html#a5289e91681166ba39ce97d6eb116c59d">NN_PERF_END_MEASURE_GPU</a>(pCommandBuffer);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Gバッファーの描画</span></div>
<div class="line"><span class="keywordtype">void</span> DrawGeometry(<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html">nn::gfx::CommandBuffer</a>* pCommandBuffer, <span class="keywordtype">int</span> uniformBufferIndex) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!g_MenuFlag.Test&lt;MenuFlag::GeometryRendering&gt;())</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="perf___profile_8h.html#af2d54f7bfca84e3d33b2009f6334f169">NN_PERF_SET_COLOR_GPU</a>(<a class="code" href="classnn_1_1util_1_1_color4u8.html#a60d33066a521b0728f8660d12e010d8c">nn::util::Color4u8::Green</a>());</div>
<div class="line">    <a class="code" href="perf___profile_8h.html#ae7dc0bda5eab2fc0a3c36f5a92683580">NN_PERF_BEGIN_MEASURE_NAME_GPU</a>(pCommandBuffer, <span class="stringliteral">&quot;Geometry&quot;</span>);</div>
<div class="line"></div>
<div class="line">    g3ddemo::SetFrameBufferToRenderTarget(pCommandBuffer, &amp;g_FrameBuffer[FrameBufferType_Geometry]);</div>
<div class="line">    pCommandBuffer-&gt;<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#ab1c541475f015777b8ce4bdfffe7c1c3">SetViewportScissorState</a>(g_FrameBuffer[FrameBufferType_Geometry].GetViewportScissorState());</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pRenderModelObj : g_Holder.renderModelObjs)</div>
<div class="line">    {</div>
<div class="line">        pRenderModelObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#aa4061058dfcb32e29b89c6f50cb23738">Draw</a>(pCommandBuffer, DrawPassType_Geometry, ViewType_Default, uniformBufferIndex);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="perf___profile_8h.html#a5289e91681166ba39ce97d6eb116c59d">NN_PERF_END_MEASURE_GPU</a>(pCommandBuffer);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// ライトの描画</span></div>
<div class="line"><span class="keywordtype">void</span> DrawLight(<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html">nn::gfx::CommandBuffer</a>* pCommandBuffer, <span class="keywordtype">int</span> uniformBufferIndex) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!g_MenuFlag.Test&lt;MenuFlag::LightRendering&gt;())</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="perf___profile_8h.html#af2d54f7bfca84e3d33b2009f6334f169">NN_PERF_SET_COLOR_GPU</a>(<a name="a211"></a><a class="code" href="classnn_1_1util_1_1_color4u8.html#a9d134cd2f801f8f6045e48c8af2eab3d">nn::util::Color4u8::Yellow</a>());</div>
<div class="line">    <a class="code" href="perf___profile_8h.html#ae7dc0bda5eab2fc0a3c36f5a92683580">NN_PERF_BEGIN_MEASURE_NAME_GPU</a>(pCommandBuffer, <span class="stringliteral">&quot;Light&quot;</span>);</div>
<div class="line"></div>
<div class="line">    g3ddemo::SetFrameBufferToRenderTarget(pCommandBuffer, &amp;g_FrameBuffer[FrameBufferType_Light]);</div>
<div class="line">    pCommandBuffer-&gt;<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#ab1c541475f015777b8ce4bdfffe7c1c3">SetViewportScissorState</a>(g_FrameBuffer[FrameBufferType_Light].GetViewportScissorState());</div>
<div class="line">    g_PointLight.Draw(pCommandBuffer, uniformBufferIndex);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="perf___profile_8h.html#a5289e91681166ba39ce97d6eb116c59d">NN_PERF_END_MEASURE_GPU</a>(pCommandBuffer);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// 不透明オブジェクトか判定</span></div>
<div class="line"><span class="keywordtype">bool</span> IsOpaqueObject(<span class="keyword">const</span> <a class="code" href="classnns_1_1g3d_1_1_render_unit_obj.html">nns::g3d::RenderUnitObj</a>* pRenderUnitObj, <span class="keywordtype">int</span> passIndex) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classnn_1_1g3d_1_1_res_material.html">nn::g3d::ResMaterial</a>* pResMaterial = pRenderUnitObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_unit_obj.html#ae92c38daa56f51aaffec96046eaea77d">GetRenderShape</a>(passIndex)-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_shape.html#a2d71fdcacfb733e7c945b46f0497f417">GetRenderMaterial</a>()-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_material.html#a056a695c32d1ffa9ba15478b21d80175">GetResMaterial</a>();</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classnn_1_1g3d_1_1_res_render_info.html">nn::g3d::ResRenderInfo</a>* pRenderInfo = pResMaterial-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_material.html#a173fe82a044bd944283cfb617b8111c1">FindRenderInfo</a>(<span class="stringliteral">&quot;blend&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (!pRenderInfo)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> *pRenderInfo-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_render_info.html#ad7542986cc293f55fbb39a116597ce1a">GetInt</a>() == g3ddemo::BlendMode_Opaque;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// 不透明オブジェクトの描画</span></div>
<div class="line"><span class="keywordtype">void</span> DrawOpaque(<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html">nn::gfx::CommandBuffer</a>* pCommandBuffer, <span class="keywordtype">int</span> uniformBufferIndex) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="perf___profile_8h.html#af2d54f7bfca84e3d33b2009f6334f169">NN_PERF_SET_COLOR_GPU</a>(<a name="_a212"></a><a class="code" href="classnn_1_1util_1_1_color4u8.html">nn::util::Color4u8</a>(255, 0, 200));</div>
<div class="line">    <a class="code" href="perf___profile_8h.html#ae7dc0bda5eab2fc0a3c36f5a92683580">NN_PERF_BEGIN_MEASURE_NAME_GPU</a>(pCommandBuffer, <span class="stringliteral">&quot;Opaque&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pRenderModelObj : g_Holder.renderModelObjs)</div>
<div class="line">    {</div>
<div class="line">        pRenderModelObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#aa4061058dfcb32e29b89c6f50cb23738">Draw</a>(</div>
<div class="line">            pCommandBuffer,</div>
<div class="line">            DrawPassType_Model,</div>
<div class="line">            ViewType_Default,</div>
<div class="line">            uniformBufferIndex,</div>
<div class="line">            IsOpaqueObject</div>
<div class="line">        );</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="perf___profile_8h.html#a5289e91681166ba39ce97d6eb116c59d">NN_PERF_END_MEASURE_GPU</a>(pCommandBuffer);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// 半透明オブジェクトの描画</span></div>
<div class="line"><span class="keywordtype">void</span> DrawTranslucent(<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html">nn::gfx::CommandBuffer</a>* pCommandBuffer, <span class="keywordtype">int</span> uniformBufferIndex) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="perf___profile_8h.html#af2d54f7bfca84e3d33b2009f6334f169">NN_PERF_SET_COLOR_GPU</a>(<a class="code" href="classnn_1_1util_1_1_color4u8.html#a5ad1502b37a61d84307433906727813c">nn::util::Color4u8::Blue</a>());</div>
<div class="line">    <a class="code" href="perf___profile_8h.html#ae7dc0bda5eab2fc0a3c36f5a92683580">NN_PERF_BEGIN_MEASURE_NAME_GPU</a>(pCommandBuffer, <span class="stringliteral">&quot;Translucent&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pRenderModelObj : g_Holder.renderModelObjs)</div>
<div class="line">    {</div>
<div class="line">        pRenderModelObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#aa4061058dfcb32e29b89c6f50cb23738">Draw</a>(</div>
<div class="line">            pCommandBuffer,</div>
<div class="line">            DrawPassType_Model,</div>
<div class="line">            ViewType_Default,</div>
<div class="line">            uniformBufferIndex,</div>
<div class="line">            [](<span class="keyword">const</span> <a class="code" href="classnns_1_1g3d_1_1_render_unit_obj.html">nns::g3d::RenderUnitObj</a>* pRenderUnitObj, <span class="keywordtype">int</span> passIndex)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> !IsOpaqueObject(pRenderUnitObj, passIndex);</div>
<div class="line">            }</div>
<div class="line">        );</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="perf___profile_8h.html#a5289e91681166ba39ce97d6eb116c59d">NN_PERF_END_MEASURE_GPU</a>(pCommandBuffer);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// カラーバッファーへコピー</span></div>
<div class="line"><span class="keywordtype">void</span> CopyColorBuffer(<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html">nns::gfx::GraphicsFramework</a>* pGfxFramework, <a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html">nn::gfx::CommandBuffer</a>* pCommandBuffer) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="perf___profile_8h.html#af2d54f7bfca84e3d33b2009f6334f169">NN_PERF_SET_COLOR_GPU</a>(<a name="a213"></a><a class="code" href="classnn_1_1util_1_1_color4u8.html#a07833fdd4841fb2351cf085f336834c8">nn::util::Color4u8::White</a>());</div>
<div class="line">    <a class="code" href="perf___profile_8h.html#ae7dc0bda5eab2fc0a3c36f5a92683580">NN_PERF_BEGIN_MEASURE_NAME_GPU</a>(pCommandBuffer, <span class="stringliteral">&quot;Copy&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <a name="_a214"></a><a class="code" href="classnn_1_1gfx_1_1_texture_subresource.html">nn::gfx::TextureSubresource</a> subresource;</div>
<div class="line">    subresource.<a name="a215"></a><a class="code" href="classnn_1_1gfx_1_1_texture_subresource.html#aa788017964f3e18dcd398dbd206c12c7">SetDefault</a>();</div>
<div class="line">    <a name="_a216"></a><a class="code" href="classnn_1_1gfx_1_1_texture_copy_region.html">nn::gfx::TextureCopyRegion</a> copyRegion;</div>
<div class="line">    copyRegion.<a name="a217"></a><a class="code" href="classnn_1_1gfx_1_1_texture_copy_region.html#a1aac318a74055dd68e5c323eab8688bd">SetDefault</a>();</div>
<div class="line">    copyRegion.<a name="a218"></a><a class="code" href="classnn_1_1gfx_1_1_texture_copy_region.html#abbfd901ca7ce1eb8fb022abf37a8a1ef">SetWidth</a>(pGfxFramework-&gt;<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a68decd5e5c7a89df27eb8d428515e92d">GetDisplayWidth</a>());</div>
<div class="line">    copyRegion.<a name="a219"></a><a class="code" href="classnn_1_1gfx_1_1_texture_copy_region.html#a577f1ac98fe6e3ff5b67b2642a775155">SetHeight</a>(pGfxFramework-&gt;<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#af0da71ea5a113a27c596366259db882e">GetDisplayHeight</a>());</div>
<div class="line">    pCommandBuffer-&gt;<a name="a220"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#afd05d1e63d9009d74cf7de5088dab91c">CopyImage</a>(g_ColorBuffer.GetTexture(), subresource, 0, 0, 0, pGfxFramework-&gt;<a name="a221"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#afff5cb7c9f0790dab3f15823bb1120f4">GetColorBuffer</a>(), copyRegion);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="perf___profile_8h.html#a5289e91681166ba39ce97d6eb116c59d">NN_PERF_END_MEASURE_GPU</a>(pCommandBuffer);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// 選択されているオブジェクトのみを描画</span></div>
<div class="line"><span class="keywordtype">void</span> DrawSelectedObj(<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html">nn::gfx::CommandBuffer</a>* pCommandBuffer, <span class="keywordtype">int</span> uniformBufferIndex) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="perf___profile_8h.html#af2d54f7bfca84e3d33b2009f6334f169">NN_PERF_SET_COLOR_GPU</a>(<a class="code" href="classnn_1_1util_1_1_color4u8.html">nn::util::Color4u8</a>(255, 0, 200));</div>
<div class="line">    <a class="code" href="perf___profile_8h.html#ae7dc0bda5eab2fc0a3c36f5a92683580">NN_PERF_BEGIN_MEASURE_NAME_GPU</a>(pCommandBuffer, <span class="stringliteral">&quot;DrawSelectedObj&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span> modelIndex = g_SelectedModelIndex;</div>
<div class="line">    <span class="keywordtype">int</span> shapeIndex = g_SelectedShapeIndex;</div>
<div class="line">    <span class="keywordtype">int</span> submeshIndex = g_SelectedSubmeshIndex;</div>
<div class="line"></div>
<div class="line">    <a name="a222"></a><a class="code" href="nn___assert_8h.html#a7db3abee8e8c71d5dd8629b35e228afa">NN_ASSERT_RANGE</a>(modelIndex, 0, g_Holder.modelAnimObjs.GetCount());</div>
<div class="line">    <a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pRenderModelObj = g_Holder.renderModelObjs[modelIndex];</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classnn_1_1g3d_1_1_model_obj.html">nn::g3d::ModelObj</a>* pModelObj = pRenderModelObj-&gt;GetModelObj();</div>
<div class="line">    <a class="code" href="nn___assert_8h.html#a7db3abee8e8c71d5dd8629b35e228afa">NN_ASSERT_RANGE</a>(shapeIndex, 0, pModelObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a54e1cf48111ecb56b8dde5824d13a1fd">GetShapeCount</a>());</div>
<div class="line">    pRenderModelObj-&gt;SetDrawSingleShapeEnabled(shapeIndex);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (g_MenuFlag.Test&lt;MenuFlag::SingleSubmesh&gt;())</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___assert_8h.html#a7db3abee8e8c71d5dd8629b35e228afa">NN_ASSERT_RANGE</a>(submeshIndex, 0, pModelObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a4f56c9a4a685ff577c44b60bc50f5a8b">GetShape</a>(shapeIndex)-&gt;<a name="a223"></a><a class="code" href="classnn_1_1g3d_1_1_shape_obj.html#a07131b7bd1633a73acff2b021ebd45a7">GetSubMeshCount</a>());</div>
<div class="line">        pRenderModelObj-&gt;GetRenderUnitObj(shapeIndex)-&gt;SetDrawSingleSubmeshEnabled(submeshIndex);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    pRenderModelObj-&gt;Draw(pCommandBuffer, DrawPassType_Model, ViewType_Default, uniformBufferIndex);</div>
<div class="line">    pRenderModelObj-&gt;SetDrawSingleShapeDisabled();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (g_MenuFlag.Test&lt;MenuFlag::SingleSubmesh&gt;())</div>
<div class="line">    {</div>
<div class="line">        pRenderModelObj-&gt;GetRenderUnitObj(shapeIndex)-&gt;SetDrawSingleSubmeshDisabled();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="perf___profile_8h.html#a5289e91681166ba39ce97d6eb116c59d">NN_PERF_END_MEASURE_GPU</a>(pCommandBuffer);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// 最終出力を描画</span></div>
<div class="line"><span class="keywordtype">void</span> DrawFinalImage(<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html">nns::gfx::GraphicsFramework</a>* pGfxFramework, <a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html">nn::gfx::CommandBuffer</a>* pCommandBuffer, <span class="keywordtype">int</span> uniformBufferIndex) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// 指定のLODレベルでの強制表示を設定</span></div>
<div class="line">    <span class="keywordtype">int</span> modelIndex = g_SelectedModelIndex;</div>
<div class="line">    <span class="keywordtype">int</span> forceLodLevel = GetForceLodLevel();</div>
<div class="line"></div>
<div class="line">    <a class="code" href="nn___assert_8h.html#a7db3abee8e8c71d5dd8629b35e228afa">NN_ASSERT_RANGE</a>(modelIndex, 0, g_Holder.modelAnimObjs.GetCount());</div>
<div class="line">    <a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pRenderModelObj = g_Holder.renderModelObjs[modelIndex];</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (forceLodLevel == g_InvalidForceLodLevel)</div>
<div class="line">    {</div>
<div class="line">        pRenderModelObj-&gt;SetDrawLodDisabled();</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        pRenderModelObj-&gt;SetDrawLodEnabled(forceLodLevel);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// レンダーターゲットを設定</span></div>
<div class="line">    <a class="code" href="classnn_1_1gfx_1_1_t_color_target_view.html">nn::gfx::ColorTargetView</a>* pColor = pGfxFramework-&gt;<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#ab825acf6f1e23e4946e8915d087a94a1">GetColorTargetView</a>();</div>
<div class="line">    <a class="code" href="classnn_1_1gfx_1_1_t_depth_stencil_view.html">nn::gfx::DepthStencilView</a>* pDepth = pGfxFramework-&gt;<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#ae375791c8ef66431a6910dafd0156bb2">GetDepthStencilView</a>();</div>
<div class="line">    pCommandBuffer-&gt;<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#a3698a1cbd3b59b649c048f709ddd766c">SetRenderTargets</a>(1, &amp;pColor, pDepth);</div>
<div class="line">    pCommandBuffer-&gt;<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#ab1c541475f015777b8ce4bdfffe7c1c3">SetViewportScissorState</a>(pGfxFramework-&gt;<a name="a224"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#ae13f7a4f898b54ab4d566ee2d1aec56e">GetViewportScissorState</a>());</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 選択されたオブジェクトだけ描画</span></div>
<div class="line">    <span class="keywordflow">if</span> (g_MenuFlag.Test&lt;MenuFlag::SingleShape&gt;())</div>
<div class="line">    {</div>
<div class="line">        DrawSelectedObj(pCommandBuffer, uniformBufferIndex);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 不透明オブジェクトの描画</span></div>
<div class="line">    DrawOpaque(pCommandBuffer, uniformBufferIndex);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// カラーバッファーへコピー</span></div>
<div class="line">    CopyColorBuffer(pGfxFramework, pCommandBuffer);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 半透明オブジェクトの描画</span></div>
<div class="line">    DrawTranslucent(pCommandBuffer, uniformBufferIndex);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// バウンディング球を描画</span></div>
<div class="line"><span class="keywordtype">void</span> DrawBoundingSphere(<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html">nn::gfx::CommandBuffer</a>* pCommandBuffer) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="nn___assert_8h.html#a7db3abee8e8c71d5dd8629b35e228afa">NN_ASSERT_RANGE</a>(g_SelectedModelIndex, 0, g_Holder.renderModelObjs.GetCount());</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pRenderModelObj = g_Holder.renderModelObjs[g_SelectedModelIndex];</div>
<div class="line">    g_BoundingRenderer.DrawSphere(pRenderModelObj-&gt;GetModelObj(), pCommandBuffer, GetForceLodLevel());</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// バウンディングボックスを描画</span></div>
<div class="line"><span class="keywordtype">void</span> DrawBoundingBox(<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html">nn::gfx::CommandBuffer</a>* pCommandBuffer) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="nn___assert_8h.html#a7db3abee8e8c71d5dd8629b35e228afa">NN_ASSERT_RANGE</a>(g_SelectedModelIndex, 0, g_Holder.renderModelObjs.GetCount());</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pRenderModelObj = g_Holder.renderModelObjs[g_SelectedModelIndex];</div>
<div class="line">    <a class="code" href="classnn_1_1g3d_1_1_model_obj.html">nn::g3d::ModelObj</a>* pModelObj = pRenderModelObj-&gt;GetModelObj();</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span> forceLodLevel = GetForceLodLevel();</div>
<div class="line">    <span class="keywordtype">int</span> shapeIndex = g_SelectedShapeIndex;</div>
<div class="line">    <span class="keywordflow">if</span> (g_MenuFlag.Test&lt;MenuFlag::SingleSubmesh&gt;())</div>
<div class="line">    {</div>
<div class="line">        g_BoundingRenderer.DrawBox(pModelObj, pCommandBuffer, shapeIndex, forceLodLevel, g_SelectedSubmeshIndex);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    g_BoundingRenderer.DrawBox(pModelObj, pCommandBuffer, shapeIndex, forceLodLevel);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// バウンディングを描画</span></div>
<div class="line"><span class="keywordtype">void</span> DrawBounding(<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html">nn::gfx::CommandBuffer</a>* pCommandBuffer) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x3f_type.html">nn::util::Matrix4x3fType</a> viewMtx = g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#aff24f2ebd999e9d9f423945fa9d4e8e0">GetViewMtx</a>(ViewType_Default);</div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x4f_type.html">nn::util::Matrix4x4fType</a> projMtx = g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#afa649636fe025a114183f493e836c328">GetProjectionMtx</a>(ViewType_Default);</div>
<div class="line">    g_BoundingRenderer.Update(pCommandBuffer, &amp;viewMtx, &amp;projMtx);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (g_MenuFlag.Test&lt;MenuFlag::BoundingSphere&gt;())</div>
<div class="line">    {</div>
<div class="line">        DrawBoundingSphere(pCommandBuffer);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (g_MenuFlag.Test&lt;MenuFlag::BoundingBox&gt;())</div>
<div class="line">    {</div>
<div class="line">        DrawBoundingBox(pCommandBuffer);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// ビューボリュームを描画</span></div>
<div class="line"><span class="keywordtype">void</span> DrawViewVolume(<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html">nn::gfx::CommandBuffer</a>* pCommandBuffer) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!g_MenuFlag.Test&lt;MenuFlag::DrawViewVolume&gt;())</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (g_SelectedViewType == ViewType_Default &amp;&amp; !g_MenuFlag.Test&lt;MenuFlag::FreezeViewVolume&gt;())</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a name="_a225"></a><a class="code" href="structnn_1_1util_1_1_unorm8x4.html">nn::util::Color4u8Type</a> color;</div>
<div class="line">    color.<a name="a226"></a><a class="code" href="structnn_1_1util_1_1_unorm8x4.html#a1dd7b3754750ca1cfbf9663f216df96d">v</a>[0] = 0;</div>
<div class="line">    color.<a class="code" href="structnn_1_1util_1_1_unorm8x4.html#a1dd7b3754750ca1cfbf9663f216df96d">v</a>[1] = 255;</div>
<div class="line">    color.<a class="code" href="structnn_1_1util_1_1_unorm8x4.html#a1dd7b3754750ca1cfbf9663f216df96d">v</a>[2] = 255;</div>
<div class="line">    color.<a class="code" href="structnn_1_1util_1_1_unorm8x4.html#a1dd7b3754750ca1cfbf9663f216df96d">v</a>[3] = 32;</div>
<div class="line"></div>
<div class="line">    g_ViewVolumeRenderer.Draw(pCommandBuffer, g_InvViewProjectionMatrix, color);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// デバッグ用フレームバッファーの描画</span></div>
<div class="line"><span class="keywordtype">void</span> CalculateDebugFrameBufferInfo(<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html">nns::gfx::GraphicsFramework</a>* pGfxFramework) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!g_MenuFlag.Test&lt;MenuFlag::DrawDebugFrameBuffer&gt;())</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="nn___assert_8h.html#a7db3abee8e8c71d5dd8629b35e228afa">NN_ASSERT_RANGE</a>(g_SelectedFrameBufferType, FrameBufferType_Shadow, FrameBufferType_Count);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classnn_1_1gfx_1_1_descriptor_slot.html">nn::gfx::DescriptorSlot</a>* descriptorSlots[FrameBufferType_Count] =</div>
<div class="line">    {</div>
<div class="line">      &amp;g_DepthDescriptorSlot,</div>
<div class="line">      &amp;g_WaterDescriptorSlot,</div>
<div class="line">      &amp;g_GeometryColorDescriptorSlot,</div>
<div class="line">      &amp;g_LightDescriptorSlot</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_unorm8x4.html">nn::util::Color4u8Type</a> color = { { 255, 255, 255, 255 } };</div>
<div class="line">    <span class="keywordflow">if</span> (g_SelectedFrameBufferType != FrameBufferType_Shadow)</div>
<div class="line">    {</div>
<div class="line">        g_ScreenInfo.AddQuadTexture(</div>
<div class="line">            pGfxFramework-&gt;<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a68decd5e5c7a89df27eb8d428515e92d">GetDisplayWidth</a>() * 0.5f,</div>
<div class="line">            0.0f,</div>
<div class="line">            pGfxFramework-&gt;<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a68decd5e5c7a89df27eb8d428515e92d">GetDisplayWidth</a>() * 0.5f,</div>
<div class="line">            pGfxFramework-&gt;<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#af0da71ea5a113a27c596366259db882e">GetDisplayHeight</a>() * 0.5f,</div>
<div class="line">            color,</div>
<div class="line">            *descriptorSlots[g_SelectedFrameBufferType],</div>
<div class="line">            g_DebugFrameBufferSamplerDescriptorSlot</div>
<div class="line">        );</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> depthIndex = 0; depthIndex &lt; TownContext::cascadeShadowCount; ++depthIndex)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">float</span> x = pGfxFramework-&gt;<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a68decd5e5c7a89df27eb8d428515e92d">GetDisplayWidth</a>() * 0.5f;</div>
<div class="line">        <span class="keywordtype">float</span> offsetRate = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(depthIndex) / static_cast&lt;float&gt;(TownContext::cascadeShadowCount);</div>
<div class="line">        x += (pGfxFramework-&gt;<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a68decd5e5c7a89df27eb8d428515e92d">GetDisplayWidth</a>() * 0.5f) * offsetRate;</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">float</span> size = pGfxFramework-&gt;<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a68decd5e5c7a89df27eb8d428515e92d">GetDisplayWidth</a>() * 0.5f / <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(TownContext::cascadeShadowCount);</div>
<div class="line">        g_ScreenInfo.AddQuadTexture(</div>
<div class="line">            x,</div>
<div class="line">            0.0f,</div>
<div class="line">            size,</div>
<div class="line">            size,</div>
<div class="line">            depthIndex,</div>
<div class="line">            color,</div>
<div class="line">            g_DepthDescriptorSlot,</div>
<div class="line">            g_DebugFrameBufferSamplerDescriptorSlot</div>
<div class="line">        );</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// 情報テキストの描画</span></div>
<div class="line"><span class="keywordtype">void</span> DrawInfo(<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html">nns::gfx::GraphicsFramework</a>* pGfxFramework, <a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html">nn::gfx::CommandBuffer</a>* pCommandBuffer, <span class="keywordtype">int</span> bufferIndex) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!IsMenuEnabled())</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="perf___profile_8h.html#af2d54f7bfca84e3d33b2009f6334f169">NN_PERF_SET_COLOR_GPU</a>(<a name="a227"></a><a class="code" href="classnn_1_1util_1_1_color4u8.html#a7c997c375202d7cf5c0643d4c6f47a20">nn::util::Color4u8::Cyan</a>());</div>
<div class="line">    <a class="code" href="perf___profile_8h.html#ae7dc0bda5eab2fc0a3c36f5a92683580">NN_PERF_BEGIN_MEASURE_NAME_GPU</a>(pCommandBuffer, <span class="stringliteral">&quot;Info&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classnn_1_1gfx_1_1_t_color_target_view.html">nn::gfx::ColorTargetView</a>* pColor = pGfxFramework-&gt;<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#ab825acf6f1e23e4946e8915d087a94a1">GetColorTargetView</a>();</div>
<div class="line">    <a class="code" href="classnn_1_1gfx_1_1_t_depth_stencil_view.html">nn::gfx::DepthStencilView</a>* pDepth = pGfxFramework-&gt;<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#ae375791c8ef66431a6910dafd0156bb2">GetDepthStencilView</a>();</div>
<div class="line">    pCommandBuffer-&gt;<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#a3698a1cbd3b59b649c048f709ddd766c">SetRenderTargets</a>(1, &amp;pColor, pDepth);</div>
<div class="line">    pCommandBuffer-&gt;<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#ab1c541475f015777b8ce4bdfffe7c1c3">SetViewportScissorState</a>(pGfxFramework-&gt;<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#ae13f7a4f898b54ab4d566ee2d1aec56e">GetViewportScissorState</a>());</div>
<div class="line"></div>
<div class="line">    CalculateMenuInfo(g_ScreenInfo, g_TextureAverageShader.GetTextureAverage(bufferIndex));</div>
<div class="line">    CalculateDebugFrameBufferInfo(pGfxFramework);</div>
<div class="line">    g_ScreenInfo.Draw(pCommandBuffer);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="perf___profile_8h.html#a5289e91681166ba39ce97d6eb116c59d">NN_PERF_END_MEASURE_GPU</a>(pCommandBuffer);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// コンピュートシェーダー実行</span></div>
<div class="line"><span class="keywordtype">void</span> CalculateTextureCompute(<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html">nn::gfx::CommandBuffer</a>* pCommandBuffer, <span class="keywordtype">int</span> bufferIndex) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!g_MenuFlag.Test&lt;MenuFlag::TextureCompute&gt;())</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="perf___profile_8h.html#af2d54f7bfca84e3d33b2009f6334f169">NN_PERF_SET_COLOR_GPU</a>(<a class="code" href="classnn_1_1util_1_1_color4u8.html#a74cab22bd85f0940aec269c535ee5b54">nn::util::Color4u8::Red</a>());</div>
<div class="line">    <a class="code" href="perf___profile_8h.html#ae7dc0bda5eab2fc0a3c36f5a92683580">NN_PERF_BEGIN_MEASURE_NAME_GPU</a>(pCommandBuffer, <span class="stringliteral">&quot;Calculate&quot;</span>);</div>
<div class="line"></div>
<div class="line">    g_TextureAverageShader.MakeCommand(pCommandBuffer, bufferIndex, g_ColorDescriptorSlot);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="perf___profile_8h.html#a5289e91681166ba39ce97d6eb116c59d">NN_PERF_END_MEASURE_GPU</a>(pCommandBuffer);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// 描画コマンドを作成</span></div>
<div class="line"><span class="keywordtype">void</span> MakeCommand(<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html">nns::gfx::GraphicsFramework</a>* pGfxFramework, <span class="keywordtype">int</span> uniformBufferIndex, <span class="keywordtype">void</span>* pUserData) NN_NOEXCEPT</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="nn___macro_8h.html#af2d1673769927c5eae977d8dde3ce106">NN_UNUSED</a>(pUserData);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// コマンド生成</span></div>
<div class="line">    <a class="code" href="perf___profile_8h.html#ac0cbbec62451185954e3e6a11cac2fa8">NN_PERF_SET_COLOR</a>(<a class="code" href="classnn_1_1util_1_1_color4u8.html#a60d33066a521b0728f8660d12e010d8c">nn::util::Color4u8::Green</a>());</div>
<div class="line">    <a class="code" href="perf___profile_8h.html#a9589655224905f671b5e15a02838305c">NN_PERF_BEGIN_MEASURE_NAME</a>(<span class="stringliteral">&quot;Make Command&quot;</span>);</div>
<div class="line">    pGfxFramework-&gt;<a name="a228"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a1682d81714db542ef9bb6aae8908b19f">BeginFrame</a>(uniformBufferIndex);</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html">nn::gfx::CommandBuffer</a>* pCommandBuffer = pGfxFramework-&gt;<a name="a229"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a80b4defad13752d673db840e439d1a7f">GetRootCommandBuffer</a>(uniformBufferIndex);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// ディスクリプタとシェーダーコードのGPUキャッシュを無効化</span></div>
<div class="line">        pCommandBuffer-&gt;<a name="a230"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#a7e5cade7802122a5272657dfaec5d1f1">InvalidateMemory</a>(<a name="a231"></a><a class="code" href="namespacenn_1_1gfx.html#a24dbcd6d86531138895622b5a854e4f5a569fa278473bf8871cece2df59df5e68">nn::gfx::GpuAccess_ShaderCode</a> | <a name="a232"></a><a class="code" href="namespacenn_1_1gfx.html#a24dbcd6d86531138895622b5a854e4f5ab49f83cffb7a771c178eafdbbd93ca1a">nn::gfx::GpuAccess_Descriptor</a>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// テクスチャーキャッシュ無効化</span></div>
<div class="line">        pCommandBuffer-&gt;<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#a7e5cade7802122a5272657dfaec5d1f1">InvalidateMemory</a>(<a class="code" href="namespacenn_1_1gfx.html#a24dbcd6d86531138895622b5a854e4f5a4a531ae2d7e145f647300ea67bc76ccc">nn::gfx::GpuAccess_Texture</a>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// 画面のクリア</span></div>
<div class="line">        ClearScreen(pGfxFramework, pCommandBuffer);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// シャドウの描画</span></div>
<div class="line">        DrawShadow(pCommandBuffer, uniformBufferIndex);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// 水面の描画</span></div>
<div class="line">        DrawWater(pCommandBuffer, uniformBufferIndex);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Gバッファーの描画</span></div>
<div class="line">        DrawGeometry(pCommandBuffer, uniformBufferIndex);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// キャッシュをフラッシュ</span></div>
<div class="line">        pCommandBuffer-&gt;<a name="a233"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#a3b43b17e57f564190229a914370bfb9b">FlushMemory</a>(<a class="code" href="namespacenn_1_1gfx.html#a24dbcd6d86531138895622b5a854e4f5a0db6d0fe517ccdbde996e7748f0c69f8">nn::gfx::GpuAccess_ColorBuffer</a>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// ライトの描画</span></div>
<div class="line">        DrawLight(pCommandBuffer, uniformBufferIndex);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// キャッシュをフラッシュ</span></div>
<div class="line">        pCommandBuffer-&gt;<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#a3b43b17e57f564190229a914370bfb9b">FlushMemory</a>(<a class="code" href="namespacenn_1_1gfx.html#a24dbcd6d86531138895622b5a854e4f5a0db6d0fe517ccdbde996e7748f0c69f8">nn::gfx::GpuAccess_ColorBuffer</a>);</div>
<div class="line">        pCommandBuffer-&gt;<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#a3b43b17e57f564190229a914370bfb9b">FlushMemory</a>(<a class="code" href="namespacenn_1_1gfx.html#a24dbcd6d86531138895622b5a854e4f5a1663c5652d151ae04844adb9a3784bea">nn::gfx::GpuAccess_DepthStencil</a>);</div>
<div class="line"></div>
<div class="line">        pCommandBuffer-&gt;<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#a7e5cade7802122a5272657dfaec5d1f1">InvalidateMemory</a>(<a class="code" href="namespacenn_1_1gfx.html#a24dbcd6d86531138895622b5a854e4f5a4a531ae2d7e145f647300ea67bc76ccc">nn::gfx::GpuAccess_Texture</a>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// 最終画面描画</span></div>
<div class="line">        DrawFinalImage(pGfxFramework, pCommandBuffer, uniformBufferIndex);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// バウンディング描画</span></div>
<div class="line">        DrawBounding(pCommandBuffer);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// ViewVolume 描画</span></div>
<div class="line">        DrawViewVolume(pCommandBuffer);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// 情報テキストの描画</span></div>
<div class="line">        DrawInfo(pGfxFramework, pCommandBuffer, uniformBufferIndex);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// GPU演算</span></div>
<div class="line">        CalculateTextureCompute(pCommandBuffer, uniformBufferIndex);</div>
<div class="line"></div>
<div class="line">        pCommandBuffer-&gt;<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#a3b43b17e57f564190229a914370bfb9b">FlushMemory</a>(<a name="a234"></a><a class="code" href="namespacenn_1_1gfx.html#a24dbcd6d86531138895622b5a854e4f5a37837da53e8a54a085715aa973eb8475">nn::gfx::GpuAccess_QueryBuffer</a>);</div>
<div class="line">    }</div>
<div class="line">    pGfxFramework-&gt;<a name="a235"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#ae8a95943cd296bb2ad8ab6e6532b7b0e">EndFrame</a>(uniformBufferIndex);</div>
<div class="line">    <a class="code" href="perf___profile_8h.html#a0a94d0601ec383fed996a444d77c3e53">NN_PERF_END_MEASURE</a>();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">} <span class="comment">// anonymous namespace</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// ワイヤーフレーム切り替え</span></div>
<div class="line"><span class="keywordtype">void</span> SetWireframe(<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pRenderModelObj, <span class="keywordtype">int</span> fillMode, <span class="keywordtype">int</span> materialIndex) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <a class="code" href="classnn_1_1g3d_1_1_model_obj.html">nn::g3d::ModelObj</a>* pModelObj = pRenderModelObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#aa0a852cc2943033071f80f6660185518">GetModelObj</a>();</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classnn_1_1g3d_1_1_material_obj.html">nn::g3d::MaterialObj</a>* pMaterialObj = pModelObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a225cda4a0e7881df5dc4ebb15ac6c6f6">GetMaterial</a>(materialIndex);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classnn_1_1g3d_1_1_res_material.html">nn::g3d::ResMaterial</a>* pResMaterial = pMaterialObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_material_obj.html#ac83012bf24ce5dafd6fed058a9700975">GetResource</a>();</div>
<div class="line">    <a name="_a236"></a><a class="code" href="classnns_1_1g3d_1_1_render_model.html">nns::g3d::RenderModel</a>* pRenderModel = pRenderModelObj-&gt;<a name="a237"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a17b469fd1d5951075d68febca8f45294">GetRenderModel</a>();</div>
<div class="line">    <a name="_a238"></a><a class="code" href="classnns_1_1g3d_1_1_render_material.html">nns::g3d::RenderMaterial</a>* pRenderMaterial = pRenderModel-&gt;<a name="a239"></a><a class="code" href="classnns_1_1g3d_1_1_render_model.html#ad45b845dbac942d76c5156deaef65d7f">GetRenderMaterial</a>(materialIndex);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// マテリアルにラスタライザーステートを設定</span></div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="classnn_1_1g3d_1_1_res_render_info.html">nn::g3d::ResRenderInfo</a>* pRenderInfo = pResMaterial-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_material.html#a173fe82a044bd944283cfb617b8111c1">FindRenderInfo</a>(<span class="stringliteral">&quot;culling&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (pRenderInfo)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> <a name="_a240"></a><a class="code" href="classnn_1_1gfx_1_1_t_rasterizer_state.html">nn::gfx::RasterizerState</a>* pRasterizerState;</div>
<div class="line">        <a name="a241"></a><a class="code" href="nn___assert_8h.html#a500008249e93282dc7552e33f586af86">NN_ASSERT_GREATER</a>(pRenderInfo-&gt;<a name="a242"></a><a class="code" href="classnn_1_1g3d_1_1_res_render_info.html#a7325e489c6d8d37b2a6af77a54f5b090">GetArrayLength</a>(), 0);</div>
<div class="line"></div>
<div class="line">        <a name="a243"></a><a class="code" href="namespacenn_1_1gfx.html#af10f98bfe496b042c8efd7e5a99e8a3a">g3ddemo::CullMode</a> cullMode = <span class="keyword">static_cast&lt;</span><a class="code" href="namespacenn_1_1gfx.html#af10f98bfe496b042c8efd7e5a99e8a3a">g3ddemo::CullMode</a><span class="keyword">&gt;</span>(pRenderInfo-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_render_info.html#ad7542986cc293f55fbb39a116597ce1a">GetInt</a>()[0]);</div>
<div class="line">        <a class="code" href="nn___assert_8h.html#a7db3abee8e8c71d5dd8629b35e228afa">NN_ASSERT_RANGE</a>(cullMode, <a name="a244"></a><a class="code" href="namespacenn_1_1gfx.html#af10f98bfe496b042c8efd7e5a99e8a3aa9849dcbd85fd6c38d8c5759534ebf98b">g3ddemo::CullMode_Back</a>, g3ddemo::CullMode_Max);</div>
<div class="line"></div>
<div class="line">        pRasterizerState = g3ddemo::GetRasterizerState(cullMode, fillMode);</div>
<div class="line">        pRenderMaterial-&gt;<a name="a245"></a><a class="code" href="classnns_1_1g3d_1_1_render_material.html#a209f62ddd0bb627cea0d2c4c95170e21">SetRasterizerState</a>(pRasterizerState);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// レンダーステートを設定</span></div>
<div class="line"><span class="keywordtype">void</span> SetupRenderState(<a class="code" href="classnns_1_1g3d_1_1_render_model.html">nns::g3d::RenderModel</a>* pRenderModel) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> passIndex = 0, passCount = pRenderModel-&gt;<a name="a246"></a><a class="code" href="classnns_1_1g3d_1_1_render_model.html#a4a508d50588189376589e56d72ebd8ba">GetPassCount</a>(); passIndex &lt; passCount; ++passIndex)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> materialIndex = 0, materialCount = pRenderModel-&gt;<a name="a247"></a><a class="code" href="classnns_1_1g3d_1_1_render_model.html#a8a79574afbd1af521b7dedbc75b5e376">GetResModel</a>()-&gt;<a name="a248"></a><a class="code" href="classnn_1_1g3d_1_1_res_model.html#a662b85825b72eec712907483573e334a">GetMaterialCount</a>(); materialIndex &lt; materialCount; ++materialIndex)</div>
<div class="line">        {</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classnn_1_1g3d_1_1_res_material.html">nn::g3d::ResMaterial</a>* pResMaterial = pRenderModel-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model.html#a8a79574afbd1af521b7dedbc75b5e376">GetResModel</a>()-&gt;<a name="a249"></a><a class="code" href="classnn_1_1g3d_1_1_res_model.html#af57b0b32fc406e4c07a02133b0df1009">GetMaterial</a>(materialIndex);</div>
<div class="line">            <a class="code" href="classnns_1_1g3d_1_1_render_material.html">nns::g3d::RenderMaterial</a>* pRenderMaterial = pRenderModel-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model.html#ad45b845dbac942d76c5156deaef65d7f">GetRenderMaterial</a>(passIndex, materialIndex);</div>
<div class="line"></div>
<div class="line">            <span class="comment">// ブレンドステートを設定</span></div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classnn_1_1g3d_1_1_res_render_info.html">nn::g3d::ResRenderInfo</a>* pRenderInfo = pResMaterial-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_material.html#a173fe82a044bd944283cfb617b8111c1">FindRenderInfo</a>(<span class="stringliteral">&quot;blend&quot;</span>);</div>
<div class="line">            <span class="keywordflow">if</span> (pRenderInfo)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordtype">int</span> blendType = *pRenderInfo-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_render_info.html#ad7542986cc293f55fbb39a116597ce1a">GetInt</a>();</div>
<div class="line">                <a class="code" href="nn___assert_8h.html#a7db3abee8e8c71d5dd8629b35e228afa">NN_ASSERT_RANGE</a>(blendType, g3ddemo::BlendMode_Opaque, g3ddemo::BlendMode_Max);</div>
<div class="line">                <span class="keyword">const</span> <a name="_a250"></a><a class="code" href="classnn_1_1gfx_1_1_t_blend_state.html">nn::gfx::BlendState</a>* pBlendState = g3ddemo::GetBlendState(blendType);</div>
<div class="line">                pRenderMaterial-&gt;<a name="a251"></a><a class="code" href="classnns_1_1g3d_1_1_render_material.html#a7a42be9e7fffcf333a54d9b1dfb5ed0a">SetBlendState</a>(pBlendState);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// ラスタライザーステートを設定</span></div>
<div class="line">            <span class="keywordflow">if</span> (passIndex == DrawPassType_Shadow)</div>
<div class="line">            {</div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classnn_1_1gfx_1_1_t_rasterizer_state.html">nn::gfx::RasterizerState</a>* pRasterizerState = g3ddemo::GetRasterizerState(<a name="a252"></a><a class="code" href="namespacenn_1_1gfx.html#af10f98bfe496b042c8efd7e5a99e8a3aabfb2859639f72555364f46528aa4ac09">g3ddemo::CullMode_Front</a>);</div>
<div class="line">                pRenderMaterial-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_material.html#a209f62ddd0bb627cea0d2c4c95170e21">SetRasterizerState</a>(pRasterizerState);</div>
<div class="line">                <span class="keywordflow">continue</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            pRenderInfo = pResMaterial-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_material.html#a173fe82a044bd944283cfb617b8111c1">FindRenderInfo</a>(<span class="stringliteral">&quot;culling&quot;</span>);</div>
<div class="line">            <span class="keywordflow">if</span> (pRenderInfo)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordtype">int</span> cullType = *pRenderInfo-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_render_info.html#ad7542986cc293f55fbb39a116597ce1a">GetInt</a>();</div>
<div class="line">                <a class="code" href="nn___assert_8h.html#a7db3abee8e8c71d5dd8629b35e228afa">NN_ASSERT_RANGE</a>(cullType, <a class="code" href="namespacenn_1_1gfx.html#af10f98bfe496b042c8efd7e5a99e8a3aa9849dcbd85fd6c38d8c5759534ebf98b">g3ddemo::CullMode_Back</a>, g3ddemo::CullMode_Max);</div>
<div class="line">                <span class="keyword">const</span> <a class="code" href="classnn_1_1gfx_1_1_t_rasterizer_state.html">nn::gfx::RasterizerState</a>* pRasterizerState = g3ddemo::GetRasterizerState(cullType);</div>
<div class="line">                pRenderMaterial-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_material.html#a209f62ddd0bb627cea0d2c4c95170e21">SetRasterizerState</a>(pRasterizerState);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// デプスステンシルステートは変更しない</span></div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// ユニフォームブロックの設定を行います。</span></div>
<div class="line"><span class="keywordtype">void</span> BindUniformBlockAndSampler(<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pRenderModelObj) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// envモデルのユニフォームブロックとサンプラーをバインド</span></div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___assert_8h.html#a0473ebccccc250efd6100a9bbfec406b">NN_ASSERT_NOT_NULL</a>(g_pEnvModelObj);</div>
<div class="line">        RegisterEnvUniformBlock(pRenderModelObj);</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classnn_1_1g3d_1_1_material_obj.html">nn::g3d::MaterialObj</a>* pEnvMaterialObj = g_pEnvModelObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a225cda4a0e7881df5dc4ebb15ac6c6f6">GetMaterial</a>(0);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// サンプラーを設定</span></div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classnn_1_1g3d_1_1_res_material.html">nn::g3d::ResMaterial</a>* pResMaterial = pEnvMaterialObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_material_obj.html#ac83012bf24ce5dafd6fed058a9700975">GetResource</a>();</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> samplerIndex = 0, samplerCount = pResMaterial-&gt;<a name="a253"></a><a class="code" href="classnn_1_1g3d_1_1_res_material.html#a3764f643940e0f05ec03630e6a0e4341">GetSamplerCount</a>(); samplerIndex &lt; samplerCount; ++samplerIndex)</div>
<div class="line">        {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">char</span>* pSamplerName = pResMaterial-&gt;<a name="a254"></a><a class="code" href="classnn_1_1g3d_1_1_res_material.html#a432a9aa610adeec1bbafb85811e85f05">GetSamplerName</a>(samplerIndex);</div>
<div class="line">            <a name="_a255"></a><a class="code" href="classnn_1_1g3d_1_1_sampler_ref.html">nn::g3d::SamplerRef</a> samplerRef = pEnvMaterialObj-&gt;<a name="a256"></a><a class="code" href="classnn_1_1g3d_1_1_material_obj.html#ac92fd4547dded42b97cc7ca9715d053d">GetSampler</a>(samplerIndex);</div>
<div class="line">            <a class="code" href="classnn_1_1g3d_1_1_texture_ref.html">nn::g3d::TextureRef</a> textureRef = pEnvMaterialObj-&gt;<a name="a257"></a><a class="code" href="classnn_1_1g3d_1_1_material_obj.html#a57b77c44f4e6bdedc0b190c1f1f93448">GetTexture</a>(samplerIndex);</div>
<div class="line">            pRenderModelObj-&gt;<a name="a258"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a741490f4b757df1b2e573665d251b48a">BindSampler</a>(pSamplerName, textureRef.<a name="a259"></a><a class="code" href="classnn_1_1g3d_1_1_texture_ref.html#a6371d19f32919f27e2e52155c097cf98">GetDescriptorSlot</a>(), samplerRef.<a name="a260"></a><a class="code" href="classnn_1_1g3d_1_1_sampler_ref.html#ac1c6ff5f92bc0c57f2be911aa9ba3f1c">GetDescriptorSlot</a>());</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// コンテキストのユニフォームブロックを設定</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classnn_1_1gfx_1_1_t_buffer.html">nn::gfx::Buffer</a>* buffers[g_BufferingCount];</div>
<div class="line">        buffers[0] = g_Context.GetContextBlock(0);</div>
<div class="line">        buffers[1] = g_Context.GetContextBlock(1);</div>
<div class="line">        pRenderModelObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a51705d6e0cbec14deae05e0dc0724835">BindUniformBlock</a>(<span class="stringliteral">&quot;context&quot;</span>, buffers, g_BufferingCount);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ビューのユニフォームブロックを設定</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classnn_1_1gfx_1_1_t_buffer.html">nn::gfx::Buffer</a>* buffers[g_BufferingCount];</div>
<div class="line">        buffers[0] = g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#ac12827c0d0788017a196ef5b80304304">GetViewUniformBlock</a>(ViewType_Default, 0);</div>
<div class="line">        buffers[1] = g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#ac12827c0d0788017a196ef5b80304304">GetViewUniformBlock</a>(ViewType_Default, 1);</div>
<div class="line">        pRenderModelObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a51705d6e0cbec14deae05e0dc0724835">BindUniformBlock</a>(<span class="stringliteral">&quot;view&quot;</span>, buffers, g_BufferingCount);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// フラスタムカリング用のビューボリュームを設定</span></div>
<div class="line">    pRenderModelObj-&gt;<a name="a261"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a23c1d8bb281f5f05e885dcc40e36c627">SetViewVolume</a>(ViewType_Default, &amp;g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#a100b745a702bfed5c0e2192d3c943a3f">GetViewVolume</a>(ViewType_Default));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// RenderModelObj にユニフォームブロックや LOD に関する設定を行います。</span></div>
<div class="line"><span class="keywordtype">void</span> SetupRenderModelObj(<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pRenderModelObj) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// LODレベルの判定に使用される関数を初期化</span></div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">float</span> lodThresholds[] = { 1.0f, 0.4f, 0.2f, 0.1f };</div>
<div class="line">    g_CalculateLodDefault = CalculateLod(&amp;g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#aff24f2ebd999e9d9f423945fa9d4e8e0">GetViewMtx</a>(ViewType_Default),</div>
<div class="line">        1.0f / <a name="a262"></a><a class="code" href="namespacenn_1_1util.html#a0cdc076bfbd01224d54074c1f312165b">nn::util::TanEst</a>(<a class="code" href="namespacenn_1_1util.html#a342713848fbb4ce6750da90d297bc824">nn::util::DegreeToRadian</a>(45.0f) * 0.5f), lodThresholds,</div>
<div class="line">        <span class="keyword">sizeof</span>(lodThresholds) / <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));</div>
<div class="line"></div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">float</span> lodThresholdsWater[] = { 1.0f, 0.8f, 0.4f, 0.2f };</div>
<div class="line">    g_CalculateLodWater = CalculateLod(&amp;g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#aff24f2ebd999e9d9f423945fa9d4e8e0">GetViewMtx</a>(ViewType_Water),</div>
<div class="line">        1.0f / <a class="code" href="namespacenn_1_1util.html#a0cdc076bfbd01224d54074c1f312165b">nn::util::TanEst</a>(<a class="code" href="namespacenn_1_1util.html#a342713848fbb4ce6750da90d297bc824">nn::util::DegreeToRadian</a>(45.0f) * 0.5f), lodThresholdsWater,</div>
<div class="line">        <span class="keyword">sizeof</span>(lodThresholdsWater) / <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));</div>
<div class="line"></div>
<div class="line">    <span class="comment">// LOD レベル判定関数の設定</span></div>
<div class="line">    {</div>
<div class="line">        pRenderModelObj-&gt;<a name="a263"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a10e2bd136071f66b72babb6fbd38ffa3">SetCalculateLodLevelFunctor</a>(ViewType_Default, &amp;g_CalculateLodDefault);</div>
<div class="line">        pRenderModelObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a10e2bd136071f66b72babb6fbd38ffa3">SetCalculateLodLevelFunctor</a>(ViewType_Water, &amp;g_CalculateLodWater);</div>
<div class="line">        pRenderModelObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a10e2bd136071f66b72babb6fbd38ffa3">SetCalculateLodLevelFunctor</a>(ViewType_Light0, &amp;g_CalculateLodDefault);</div>
<div class="line">        pRenderModelObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a10e2bd136071f66b72babb6fbd38ffa3">SetCalculateLodLevelFunctor</a>(ViewType_Light1, &amp;g_CalculateLodDefault);</div>
<div class="line">        pRenderModelObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a10e2bd136071f66b72babb6fbd38ffa3">SetCalculateLodLevelFunctor</a>(ViewType_Light2, &amp;g_CalculateLodDefault);</div>
<div class="line">        pRenderModelObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a10e2bd136071f66b72babb6fbd38ffa3">SetCalculateLodLevelFunctor</a>(ViewType_Light3, &amp;g_CalculateLodDefault);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 複数パス共通の設定</span></div>
<div class="line">    BindUniformBlockAndSampler(pRenderModelObj);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 水面描画パスの設定</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classnn_1_1gfx_1_1_t_buffer.html">nn::gfx::Buffer</a>* buffers[g_BufferingCount];</div>
<div class="line">        buffers[0] = g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#ac12827c0d0788017a196ef5b80304304">GetViewUniformBlock</a>(ViewType_Water, 0);</div>
<div class="line">        buffers[1] = g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#ac12827c0d0788017a196ef5b80304304">GetViewUniformBlock</a>(ViewType_Water, 1);</div>
<div class="line"></div>
<div class="line">        pRenderModelObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a51705d6e0cbec14deae05e0dc0724835">BindUniformBlock</a>(DrawPassType_Water, <span class="stringliteral">&quot;view&quot;</span>, buffers, g_BufferingCount);</div>
<div class="line">        SetupWaterVariation(pRenderModelObj);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// フラスタムカリング用のビューボリュームを設定</span></div>
<div class="line">        pRenderModelObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a23c1d8bb281f5f05e885dcc40e36c627">SetViewVolume</a>(ViewType_Water, &amp;g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#a100b745a702bfed5c0e2192d3c943a3f">GetViewVolume</a>(ViewType_Water));</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// スキニングに関するダイナミックオプションを設定</span></div>
<div class="line">    g3ddemo::WriteSkinningOption(pRenderModelObj);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ダミーサンプラーを設定</span></div>
<div class="line">    pRenderModelObj-&gt;<a name="a264"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a683d1f2d656a642018e98a96025c4e1b">BindDummySampler</a>(g3ddemo::GetDummyTextureRef().GetDescriptorSlot(), g3ddemo::GetDummySamplerDescriptorSlot());</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// シャドウサンプラーの作成</span></div>
<div class="line"><span class="keywordtype">void</span> CreateShadowSampler(<a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice, <a class="code" href="classnn_1_1g3d_1_1_res_material.html">nn::g3d::ResMaterial</a>* pResMaterial) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* shadowSamplerName = <span class="stringliteral">&quot;_d0&quot;</span>;</div>
<div class="line">    <a class="code" href="classnn_1_1gfx_1_1_t_sampler.html">nn::gfx::Sampler</a>* pSampler = pResMaterial-&gt;<a name="a265"></a><a class="code" href="classnn_1_1g3d_1_1_res_material.html#a53d3cbd783b76b7480fab34bfea24977">FindSampler</a>(shadowSamplerName);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// マテリアルに設定されているサンプラーを破棄し、シャドウサンプラーを作成</span></div>
<div class="line">    g3ddemo::UnregisterSamplerFromDescriptorPool(pSampler);</div>
<div class="line">    pSampler-&gt;<a name="a266"></a><a class="code" href="classnn_1_1gfx_1_1_t_sampler.html#af725b5cfc86c86d203b292253db4c12b">Finalize</a>(pDevice);</div>
<div class="line"></div>
<div class="line">    <a name="_a267"></a><a class="code" href="classnn_1_1gfx_1_1_sampler_info.html">nn::gfx::Sampler::InfoType</a> samplerInfo;</div>
<div class="line">    samplerInfo.<a name="a268"></a><a class="code" href="classnn_1_1gfx_1_1_sampler_info.html#a0a8b936b65f761b509f7c9873983f75f">SetDefault</a>();</div>
<div class="line">    samplerInfo.<a name="a269"></a><a class="code" href="classnn_1_1gfx_1_1_sampler_info.html#a729bb669172b22822c2b3e3b206cd6f1">SetAddressU</a>(<a name="a270"></a><a class="code" href="namespacenn_1_1gfx.html#a196a725dd687649e105dc924a75ab40ba5e64ed3305625fbfd1a41f7e07bf922e">nn::gfx::TextureAddressMode_ClampToBorder</a>);</div>
<div class="line">    samplerInfo.<a name="a271"></a><a class="code" href="classnn_1_1gfx_1_1_sampler_info.html#a4b884f39b099e21ee9bf99933cd99e7b">SetAddressV</a>(<a class="code" href="namespacenn_1_1gfx.html#a196a725dd687649e105dc924a75ab40ba5e64ed3305625fbfd1a41f7e07bf922e">nn::gfx::TextureAddressMode_ClampToBorder</a>);</div>
<div class="line">    samplerInfo.<a name="a272"></a><a class="code" href="classnn_1_1gfx_1_1_sampler_info.html#aad204b43e3fe75fa2a5d386e8061ea10">SetAddressW</a>(<a name="a273"></a><a class="code" href="namespacenn_1_1gfx.html#a196a725dd687649e105dc924a75ab40baf587fdb03960ed5c7fcf3ad21458a8a0">nn::gfx::TextureAddressMode_ClampToEdge</a>);</div>
<div class="line">    samplerInfo.<a name="a274"></a><a class="code" href="classnn_1_1gfx_1_1_sampler_info.html#a14b99ee8e4e76d7df522bbe4c9ef5b8b">SetBorderColorType</a>(<a name="a275"></a><a class="code" href="namespacenn_1_1gfx.html#a55131be8acb19fc0a4a24d395fa2df0aa3d4e6c7b91ed8cd0de11f0e143174f57">nn::gfx::TextureBorderColorType_White</a>);</div>
<div class="line">    samplerInfo.<a name="a276"></a><a class="code" href="classnn_1_1gfx_1_1_sampler_info.html#a5834b5ed1253675f8cc144267b982689">SetFilterMode</a>(<a name="a277"></a><a class="code" href="namespacenn_1_1gfx.html#ad02723fd1d5795fe8801dc262eae6e1aa71c748257c0ed44c4e11e1aa698a1834">nn::gfx::FilterMode_Comparison_MinLinear_MagLinear_MipLinear</a>);</div>
<div class="line">    samplerInfo.<a name="a278"></a><a class="code" href="classnn_1_1gfx_1_1_sampler_info.html#a7ce8cb4ae53432bea9c0f7d788dd0072">SetComparisonFunction</a>(<a name="a279"></a><a class="code" href="namespacenn_1_1gfx.html#a853c8c6e8cb3e59241f1fd893d6da280aeb6605a4d8b9b5bb65f08e73f2f8c7eb">nn::gfx::ComparisonFunction_LessEqual</a>);</div>
<div class="line"></div>
<div class="line">    pSampler-&gt;<a name="a280"></a><a class="code" href="classnn_1_1gfx_1_1_t_sampler.html#a409b6c740f965c39549d46d496d1ba0d">Initialize</a>(pDevice, samplerInfo);</div>
<div class="line">    <a class="code" href="classnn_1_1gfx_1_1_descriptor_slot.html">nn::gfx::DescriptorSlot</a> samplerDescriptorSlot = g3ddemo::RegisterSamplerToDescriptorPool(pSampler);</div>
<div class="line">    pResMaterial-&gt;<a name="a281"></a><a class="code" href="classnn_1_1g3d_1_1_res_material.html#aa0ddfa9f89e78d9329bb9ecb2f7158b9">SetSamplerDescriptorSlot</a>(shadowSamplerName, samplerDescriptorSlot);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// RenderModel の初期化</span></div>
<div class="line"><span class="keywordtype">void</span> CreateRenderModel(g3ddemo::ResourceHolder* pHolder, <a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice, <a class="code" href="classnn_1_1g3d_1_1_res_file.html">nn::g3d::ResFile</a>* pResFile) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <a class="code" href="classnn_1_1g3d_1_1_res_shader_archive.html">nn::g3d::ResShaderArchive</a>* pModelResShaderArchive = pResFile-&gt;<a name="a282"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html#ac0bd4f38bce04f5e16e61ced09cdaacc">GetUserPtr</a>&lt;<a class="code" href="classnn_1_1g3d_1_1_res_shader_archive.html">nn::g3d::ResShaderArchive</a>&gt;();</div>
<div class="line">    <a class="code" href="nn___assert_8h.html#a0473ebccccc250efd6100a9bbfec406b">NN_ASSERT_NOT_NULL</a>(pModelResShaderArchive);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> modelIndex = 0, modelCount = pResFile-&gt;<a name="a283"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html#a11812c9a4decdc580ae89986b9454498">GetModelCount</a>(); modelIndex &lt; modelCount; ++modelIndex)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnn_1_1g3d_1_1_res_model.html">nn::g3d::ResModel</a>* pResModel = pResFile-&gt;<a name="a284"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html#ab776cb75749d955956b5b2d4522da962">GetModel</a>(modelIndex);</div>
<div class="line">        <a class="code" href="classnns_1_1g3d_1_1_render_model.html">nns::g3d::RenderModel</a>* pRenderModel = <a name="a285"></a><a class="code" href="namespacenns_1_1g3d.html#aa1c714afc7a0cf4a993dcbc6774f1643">nns::g3d::CreateRenderModel</a>(pDevice, pResModel, DrawPassType_Count);</div>
<div class="line">        pRenderModel-&gt;<a name="a286"></a><a class="code" href="classnns_1_1g3d_1_1_render_model.html#aa157d2168a767b3333c62aa5cc120973">CreateDrawPass</a>(pDevice, DrawPassType_Model, pModelResShaderArchive);</div>
<div class="line">        pRenderModel-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model.html#aa157d2168a767b3333c62aa5cc120973">CreateDrawPass</a>(pDevice, DrawPassType_Water, pModelResShaderArchive);</div>
<div class="line">        pRenderModel-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model.html#aa157d2168a767b3333c62aa5cc120973">CreateDrawPass</a>(pDevice, DrawPassType_Geometry, g_pResShadingModelPtr[ShadingModelType_Geometry]);</div>
<div class="line">        pRenderModel-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model.html#aa157d2168a767b3333c62aa5cc120973">CreateDrawPass</a>(pDevice, DrawPassType_Shadow, g_pResShadingModelPtr[ShadingModelType_Shadow]);</div>
<div class="line">        SetupRenderState(pRenderModel);</div>
<div class="line">        pHolder-&gt;renderModels.PushBack(pRenderModel);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// ModelAnimObj の初期化</span></div>
<div class="line"><span class="keywordtype">void</span> CreateModelAnimObj(g3ddemo::ResourceHolder* pHolder, <a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice, <a class="code" href="classnn_1_1g3d_1_1_res_file.html">nn::g3d::ResFile</a>* pResFile, CreateModelInstanceCallback pCallback) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> modelIndex = 0, modelCount = pResFile-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_file.html#a11812c9a4decdc580ae89986b9454498">GetModelCount</a>(); modelIndex &lt; modelCount; ++modelIndex)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnn_1_1g3d_1_1_res_model.html">nn::g3d::ResModel</a>* pResModel = pResFile-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_file.html#ab776cb75749d955956b5b2d4522da962">GetModel</a>(modelIndex);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// ModelAnimObj の初期化</span></div>
<div class="line">        <a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html">nns::g3d::ModelAnimObj</a>* pModelAnimObj;</div>
<div class="line">        {</div>
<div class="line">            <a name="_a287"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj_1_1_builder.html">nn::g3d::ModelObj::Builder</a> builder(pResModel);</div>
<div class="line">            builder.<a name="a288"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj_1_1_initialize_argument.html#a62e836c2b8875536ef6952fc1272ae3f">ViewCount</a>(ViewType_Count);</div>
<div class="line">            builder.<a name="a289"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj_1_1_initialize_argument.html#acd583ad430a0d87edc34259daedb7cff">ShapeBufferingCount</a>(g_BufferingCount);</div>
<div class="line">            builder.<a name="a290"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj_1_1_initialize_argument.html#ae2d93db7573a8afa3a576d94651f9e80">SkeletonBufferingCount</a>(g_BufferingCount);</div>
<div class="line">            builder.<a name="a291"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj_1_1_initialize_argument.html#a4487cd834e5a84490ab47745b420169a">MaterialBufferingCount</a>(g_BufferingCount);</div>
<div class="line">            builder.<a name="a292"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj_1_1_initialize_argument.html#a7b0e8df78694e7d0a5d8d283b6098e8d">SetBoundingEnabled</a>();</div>
<div class="line">            builder.<a name="a293"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj_1_1_initialize_argument.html#a080cfb61a1dea5c048f417a2a9d272bf">ShapeUserAreaSize</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * g_MaxLodLevel);</div>
<div class="line">            pModelAnimObj = <a name="a294"></a><a class="code" href="namespacenns_1_1g3d.html#a72152fa94a41e3511738bf0a9bc7c255">nns::g3d::CreateModelAnimObj</a>(pDevice, builder);</div>
<div class="line">        }</div>
<div class="line">        <a class="code" href="nn___assert_8h.html#a0473ebccccc250efd6100a9bbfec406b">NN_ASSERT_NOT_NULL</a>(pModelAnimObj);</div>
<div class="line">        pHolder-&gt;modelAnimObjs.PushBack(pModelAnimObj);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// LOD 情報を設定</span></div>
<div class="line">        SetupShapeUserArea(pModelAnimObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a75f2e005c7b06d62f33d69508db503e9">GetModelObj</a>());</div>
<div class="line"></div>
<div class="line">        <span class="comment">// アニメーションIDの記録用バッファーを作成</span></div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">size_t</span> bufferSize = <span class="keyword">sizeof</span>(int) * AnimationType_Count;</div>
<div class="line">            <span class="keywordtype">int</span>* pAnimId = g3ddemo::AllocateMemory&lt;int&gt;(bufferSize);</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> animationIndex = 0; animationIndex &lt; AnimationType_Count; ++animationIndex)</div>
<div class="line">            {</div>
<div class="line">                pAnimId[animationIndex] = <a name="a295"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a362b50b68f24886e203fa3bad05f25d9">nns::g3d::ModelAnimObj::InvalidAnimId</a>;</div>
<div class="line">            }</div>
<div class="line">            pHolder-&gt;animationIds.PushBack(pAnimId);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// コールバック関数が設定されていた場合、呼び出します。</span></div>
<div class="line">        <span class="keywordflow">if</span> (pCallback)</div>
<div class="line">        {</div>
<div class="line">            pCallback(pModelAnimObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a75f2e005c7b06d62f33d69508db503e9">GetModelObj</a>());</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// RenderModelObj の初期化</span></div>
<div class="line"><span class="keywordtype">void</span> CreateRenderModelObj(g3ddemo::ResourceHolder* pHolder, <a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html">nns::g3d::ModelAnimObj</a>* pModelAnimObj, <a class="code" href="classnns_1_1g3d_1_1_render_model.html">nns::g3d::RenderModel</a>* pRenderModel) <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    <a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(pModelAnimObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a75f2e005c7b06d62f33d69508db503e9">GetModelObj</a>()-&gt;<a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a71faa678be49b342e738072ed3783ed3">GetResource</a>() == pRenderModel-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model.html#a8a79574afbd1af521b7dedbc75b5e376">GetResModel</a>());</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pRenderModelObj = <a name="a296"></a><a class="code" href="namespacenns_1_1g3d.html#a4d8d828fb260a742ceca742312144c68">nns::g3d::CreateRenderModelObj</a>(pModelAnimObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a75f2e005c7b06d62f33d69508db503e9">GetModelObj</a>(), pRenderModel);</div>
<div class="line">    pHolder-&gt;renderModelObjs.PushBack(pRenderModelObj);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> TownMain() <a class="code" href="nn___macro_8h.html#a0e31cc4dc24d85253a31e48b1a85ab33">NN_NOEXCEPT</a></div>
<div class="line">{</div>
<div class="line">    nns::gfx::DebugGraphicsFramework* pGfxFramework = g3ddemo::GetGfxFramework();</div>
<div class="line">    pGfxFramework-&gt;SetFrameworkMode(<a name="a297"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a4987555fae0e257658ffef4beb51a674a6d2e6861717e82c71ea532bf89e5b1f0">nns::gfx::GraphicsFramework::FrameworkMode_DeferredSubmission</a>);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice = pGfxFramework-&gt;GetDevice();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Townの初期化</span></div>
<div class="line">    InitializeTown(pGfxFramework);</div>
<div class="line"></div>
<div class="line">    g3ddemo::Pad&amp; pad = g3ddemo::GetPad();</div>
<div class="line">    pad.Reset();</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span> uniformBufferIndex = 0;</div>
<div class="line">    pGfxFramework-&gt;SetCalculateCallback(Calculate, &amp;uniformBufferIndex);</div>
<div class="line">    pGfxFramework-&gt;SetMakeCommandCallback(MakeCommand, &amp;uniformBufferIndex);</div>
<div class="line">    pGfxFramework-&gt;ResetFrame();</div>
<div class="line">    g_FrameCount = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// メインループ</span></div>
<div class="line">    <span class="keywordflow">while</span> (<a name="a298"></a><a class="code" href="nn___macro_8h.html#a71c0f58f6d49fe1392380eed4509ab9a">NN_STATIC_CONDITION</a>(1))</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (GetMenuMode() != MenuType_Debug1)</div>
<div class="line">        {</div>
<div class="line">            <a name="a299"></a><a class="code" href="perf___profile_8h.html#a5131b7b04a8b13456f6f2c7f8b3f0c61">NN_PERF_SET_ENABLED</a>(<span class="keyword">false</span>);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="perf___profile_8h.html#a5131b7b04a8b13456f6f2c7f8b3f0c61">NN_PERF_SET_ENABLED</a>(<span class="keyword">true</span>);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// タッチ長押しで終了</span></div>
<div class="line">        g3ddemo::GetControllerManager()-&gt;Update();</div>
<div class="line">        <span class="keywordflow">if</span> (g3ddemo::isExitDemo())</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!pad.Read() || pad.IsTriggered(g3ddemo::Pad::BUTTON_START))</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// フレーム処理実行</span></div>
<div class="line">        pGfxFramework-&gt;ProcessFrame();</div>
<div class="line"></div>
<div class="line">        uniformBufferIndex ^= 1;</div>
<div class="line">        ++g_FrameCount;</div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line">    pGfxFramework-&gt;QueueFinish();</div>
<div class="line"></div>
<div class="line">    pGfxFramework-&gt;SetCalculateCallback(<span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>);</div>
<div class="line">    pGfxFramework-&gt;SetMakeCommandCallback(<span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Townの解放処理</span></div>
<div class="line">    FinalizeTown(pGfxFramework, pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> EXIT_SUCCESS;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
</body>
</html>
