<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>NintendoSDK API Reference: Parallel.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="openclose.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">NintendoSDK API Reference
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 構築: Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'検索');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>総合概要</span></a></li>
      <li><a href="pages.html"><span>諸情報</span></a></li>
      <li><a href="modules.html"><span>モジュール</span></a></li>
      <li><a href="namespaces.html"><span>名前空間</span></a></li>
      <li><a href="annotated.html"><span>クラス</span></a></li>
      <li><a href="files.html"><span>ファイル</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="検索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Parallel.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>ソースコードの説明は、<a class="el" href="_page_sample_g3d_parallel.html">G3dDemo Parallel</a> および <a class="el" href="_parallel_8cpp.html" title="並列処理を使用するサンプルプログラム ">Parallel.cpp</a> を参照してください。</p>
<div class="fragment"><div class="line"><span class="comment">/*--------------------------------------------------------------------------------*</span></div>
<div class="line"><span class="comment">Copyright (C)Nintendo All rights reserved.</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">These coded instructions, statements, and computer programs contain proprietary</span></div>
<div class="line"><span class="comment">information of Nintendo and/or its licensed developers and are protected by</span></div>
<div class="line"><span class="comment">national and international copyright laws. They may not be disclosed to third</span></div>
<div class="line"><span class="comment">parties or copied or duplicated in any form, in whole or in part, without the</span></div>
<div class="line"><span class="comment">prior written consent of Nintendo.</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">The content herein is highly confidential and should be handled accordingly.</span></div>
<div class="line"><span class="comment">*--------------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="preprocessor">#include &quot;g3ddemo_GfxUtility.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;g3ddemo_ModelUtility.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;g3ddemo_ViewerUtility.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;nn/os.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="g3d___viewer_8h.html">nn/g3d/g3d_Viewer.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="_programs_2_nintendo_ware_2_include_2nn_2g3d_8h.html">nn/g3d.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespacenn_1_1g3d_1_1demo.html">g3ddemo</a> = <a class="code" href="namespacenn_1_1g3d_1_1demo.html">nn::g3d::demo</a>;</div>
<div class="line"></div>
<div class="line"><span class="keyword">namespace </span>{</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define RESOURCE_PATH &quot;Resource:/&quot;</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* g_DemoBfshaPath = RESOURCE_PATH <span class="stringliteral">&quot;shader/demo.bfsha&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* g_EnvBfresPath = RESOURCE_PATH <span class="stringliteral">&quot;env.bfres&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* g_BoyBfresPath = RESOURCE_PATH <span class="stringliteral">&quot;boy.bfres&quot;</span>;</div>
<div class="line"></div>
<div class="line"><a name="_a0"></a><a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> g_CameraPosition;</div>
<div class="line"><a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> g_CameraUp;</div>
<div class="line"><a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> g_CameraTarget;</div>
<div class="line"></div>
<div class="line">g3ddemo::ResourceHolder g_Holder;</div>
<div class="line">g3ddemo::ScreenInfo g_ScreenInfo;</div>
<div class="line"><a name="_a1"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html">nns::g3d::RenderView</a> g_RenderView;</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">size_t</span> g_ThreadCommandBufferCount = 2; <span class="comment">// コマンドバッファーをダブルバッファーで作成する</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">size_t</span> g_ThreadCount = 3; <span class="comment">// 並列処理に使用するスレッド数</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">size_t</span> g_ThreadStackSize = 0x10000; <span class="comment">// スレッド操作スレッドのスタックサイズ</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">size_t</span> g_WorkMemoryCount = 64; <span class="comment">// ワークメモリーを確保できる個数</span></div>
<div class="line"></div>
<div class="line"><a name="a2"></a><a class="code" href="os___thread_common_8h.html#a5ce0c3c0aaceb976178a60a18d90f470">NN_OS_ALIGNAS_THREAD_STACK</a> <span class="keywordtype">char</span> g_ThreadStack[g_ThreadCount][g_ThreadStackSize]; <span class="comment">//スレッドのスタック</span></div>
<div class="line"><a name="_a3"></a><a class="code" href="structnn_1_1os_1_1_thread_type.html">nn::os::ThreadType</a> g_Thread[g_ThreadCount];</div>
<div class="line"><a name="_a4"></a><a class="code" href="structnn_1_1os_1_1_event_type.html">nn::os::EventType</a> g_EventStart[g_ThreadCount];</div>
<div class="line"><a class="code" href="structnn_1_1os_1_1_event_type.html">nn::os::EventType</a> g_EventEnd[g_ThreadCount];</div>
<div class="line"><a name="_a5"></a><a class="code" href="structnns_1_1gfx_1_1_graphics_framework_1_1_command_buffer.html">nns::gfx::GraphicsFramework::CommandBuffer</a> g_ThreadCommandBuffer[g_ThreadCount][g_ThreadCommandBufferCount];</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">float</span> g_GridDistance = 200.0f;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> g_InstanceModelCount = 1000;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> g_ModelLodCount = 2;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">float</span> g_LodThresholds[g_ModelLodCount] = { 1.0f, 0.2f };</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">float</span> g_DoubleZnear = 1.0f / <a name="a6"></a><a class="code" href="namespacenn_1_1util.html#a0cdc076bfbd01224d54074c1f312165b">nn::util::TanEst</a>(<a name="a7"></a><a class="code" href="namespacenn_1_1util.html#a342713848fbb4ce6750da90d297bc824">nn::util::DegreeToRadian</a>(45.0f) * 0.5f);</div>
<div class="line"><span class="keyword">const</span> nn::Bit64 g_CoreMask[] = { 1, 2, 4 };</div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> void (*TaskFunc)(int, int); <span class="comment">// 並列処理される関数ポインター型</span></div>
<div class="line">TaskFunc g_TaskFunc;</div>
<div class="line"><span class="keywordtype">int</span> g_BufferIndex;</div>
<div class="line"><span class="keywordtype">bool</span> g_IsExit;</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> g_BufferingCount = 2;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if defined( NN_BUILD_CONFIG_OS_WIN )</span></div>
<div class="line">nn::os::ThreadId g_MainThreadId;</div>
<div class="line">nn::os::ThreadId g_ThreadId[g_ThreadCount];</div>
<div class="line"><span class="comment">// windows 版では nn::os::SetThreadCoreMask による設定が効かない場合があるため</span></div>
<div class="line"><span class="comment">// スレッド ID からコア番号を解決する。</span></div>
<div class="line"><span class="keywordtype">int</span> GetFixedMultiCoreNumber()</div>
<div class="line">{</div>
<div class="line">    nn::os::ThreadId threadId = nn::os::GetThreadId(<a name="a8"></a><a class="code" href="namespacenn_1_1os.html#ad106866a5b13bc3d430104333966b479">nn::os::GetCurrentThread</a>());</div>
<div class="line">    <span class="keywordflow">if</span> (threadId == g_MainThreadId)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> threadIndex = 0; threadIndex &lt; g_ThreadCount; ++threadIndex)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (threadId == g_ThreadId[threadIndex])</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span> threadIndex;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <a name="a9"></a><a class="code" href="nn___abort_8h.html#a205eaac89c47d49cb982bf136e113de2">NN_ABORT</a>(<span class="stringliteral">&quot;Invalid thread id is detected\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>TaskQueue</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    TaskQueue() {}</div>
<div class="line"></div>
<div class="line">    <span class="keyword">struct </span>Task</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">int</span> modelIndex;</div>
<div class="line">    };</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> <a name="a10"></a><a class="code" href="namespacenn_1_1htcs.html#a7eab72b8843a2a9ff763f52b78da680e">Initialize</a>(<span class="keywordtype">int</span> threadId, <span class="keywordtype">int</span> queueCount)</div>
<div class="line">    {</div>
<div class="line">        m_ThreadId = threadId;</div>
<div class="line">        m_QueueCount = queueCount;</div>
<div class="line">        <span class="keywordtype">size_t</span> size = <span class="keyword">sizeof</span>(Task) * m_QueueCount;</div>
<div class="line">        <span class="keywordtype">void</span>* pBuffer = g3ddemo::AllocateMemory(size);</div>
<div class="line">        m_Tasks.SetBuffer(pBuffer, size);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> Cleanup()</div>
<div class="line">    {</div>
<div class="line">        m_Tasks.Clear();</div>
<div class="line">        <span class="keywordflow">if</span> (<span class="keywordtype">void</span>* pBuffer = m_Tasks.GetBuffer())</div>
<div class="line">        {</div>
<div class="line">            g3ddemo::FreeMemory(pBuffer);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span> PushBack(<span class="keywordtype">int</span> modelIndex)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (m_Tasks.GetCount() &lt; m_QueueCount)</div>
<div class="line">        {</div>
<div class="line">            Task task;</div>
<div class="line">            task.modelIndex = modelIndex;</div>
<div class="line">            m_Tasks.PushBack(task);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span> GetTaskCount()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> m_Tasks.GetCount();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    Task* GetTask(<span class="keywordtype">int</span> index)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> (index &gt;= 0 &amp;&amp; index &lt; m_Tasks.GetCount()) ? &amp;m_Tasks[index] : <span class="keyword">nullptr</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span> GetThreadId()<span class="keyword"> const</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> m_ThreadId;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line">    g3ddemo::Vector&lt;Task&gt; m_Tasks;</div>
<div class="line">    <span class="keywordtype">int</span> m_ThreadId;</div>
<div class="line">    <span class="keywordtype">int</span> m_QueueCount;</div>
<div class="line"></div>
<div class="line">} g_TaskQueue[g_ThreadCount];</div>
<div class="line"></div>
<div class="line"><a class="code" href="structnns_1_1gfx_1_1_graphics_framework_1_1_command_buffer.html">nns::gfx::GraphicsFramework::CommandBuffer</a>* GetThreadCommandBuffer(<span class="keywordtype">int</span> threadIndex)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> &amp;g_ThreadCommandBuffer[threadIndex][g_BufferIndex];</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> RunTaskQueue(TaskFunc taskFunc, <span class="keywordtype">int</span> bufferIndex)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// タスク処理に使用される関数を設定</span></div>
<div class="line">    g_TaskFunc = taskFunc;</div>
<div class="line">    g_BufferIndex = bufferIndex;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 並列処理の開始</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> threadIndex = 0; threadIndex &lt; g_ThreadCount; ++threadIndex)</div>
<div class="line">    {</div>
<div class="line">        <a name="a11"></a><a class="code" href="namespacenn_1_1os.html#a9b959a51c1d28b76894597695fd3d081">nn::os::SignalEvent</a>(&amp;g_EventStart[threadIndex]);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// すべてのスレッドが終了するまで待つ</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> threadIndex = 0; threadIndex &lt; g_ThreadCount; ++threadIndex)</div>
<div class="line">    {</div>
<div class="line">        <a name="a12"></a><a class="code" href="namespacenn_1_1os.html#aabdcb2de0b5dbdd64a0ec3d7e65c72f4">nn::os::WaitEvent</a>(&amp;g_EventEnd[threadIndex]);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">float</span> CalcProjectionRatio(<span class="keyword">const</span> <a name="_a13"></a><a class="code" href="structnn_1_1g3d_1_1_sphere.html">nn::g3d::Sphere</a>* sphere)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">float</span> centerX = nn::util::VectorGetX(sphere-&gt;<a name="a14"></a><a class="code" href="structnn_1_1g3d_1_1_sphere.html#af9b926645587dc30bef63829d00c6b04">center</a>);</div>
<div class="line">    <span class="keywordtype">float</span> centerY = nn::util::VectorGetY(sphere-&gt;<a class="code" href="structnn_1_1g3d_1_1_sphere.html#af9b926645587dc30bef63829d00c6b04">center</a>);</div>
<div class="line">    <span class="keywordtype">float</span> centerZ = nn::util::VectorGetZ(sphere-&gt;<a class="code" href="structnn_1_1g3d_1_1_sphere.html#af9b926645587dc30bef63829d00c6b04">center</a>);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <a name="_a15"></a><a class="code" href="structnn_1_1util_1_1_matrix_row_major4x3f_type.html">nn::util::Matrix4x3fType</a>&amp; view = g_RenderView.<a name="a16"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#aff24f2ebd999e9d9f423945fa9d4e8e0">GetViewMtx</a>(0);</div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> vec[4];</div>
<div class="line">    nn::util::MatrixGetAxisX(&amp;vec[0], view);</div>
<div class="line">    nn::util::MatrixGetAxisY(&amp;vec[1], view);</div>
<div class="line">    nn::util::MatrixGetAxisZ(&amp;vec[2], view);</div>
<div class="line">    nn::util::MatrixGetAxisW(&amp;vec[3], view);</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">float</span> view02 = nn::util::VectorGetZ(vec[0]);</div>
<div class="line">    <span class="keywordtype">float</span> view12 = nn::util::VectorGetZ(vec[1]);</div>
<div class="line">    <span class="keywordtype">float</span> view22 = nn::util::VectorGetZ(vec[2]);</div>
<div class="line">    <span class="keywordtype">float</span> view32 = nn::util::VectorGetZ(vec[3]);</div>
<div class="line">    <span class="keywordtype">float</span> viewZ = view02 * centerX + view12 * centerY + view22 * centerZ + view32;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// バウンディングスフィアをカメラ投影したときの割合を計算</span></div>
<div class="line">    <span class="keywordflow">return</span> (viewZ != 0.0f) ? std::abs(sphere-&gt;<a name="a17"></a><a class="code" href="structnn_1_1g3d_1_1_sphere.html#a6a3b0a90d98a62e136cf04663c001f6a">radius</a> * g_DoubleZnear / viewZ) : 1.0f;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> UpdateAnimModelObj(<span class="keywordtype">int</span> modelIndex, <span class="keywordtype">int</span> threadIndex)</div>
<div class="line">{</div>
<div class="line">    <a name="a18"></a><a class="code" href="nn___macro_8h.html#af2d1673769927c5eae977d8dde3ce106">NN_UNUSED</a>(threadIndex);</div>
<div class="line"></div>
<div class="line">    <a name="_a19"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pRenderModelObj = g_Holder.renderModelObjs[modelIndex];</div>
<div class="line">    <span class="keywordtype">float</span> ratio = -1.0f;</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="structnn_1_1g3d_1_1_sphere.html">nn::g3d::Sphere</a>* sphere = pRenderModelObj-&gt;<a name="a20"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#aa0a852cc2943033071f80f6660185518">GetModelObj</a>()-&gt;<a name="a21"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a27842ce94493d5891b1cffd92233a73a">GetBounding</a>();</div>
<div class="line">    pRenderModelObj-&gt;<a name="a22"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#af1a9446c300e6fa439e90d73b07e7d03">SetDrawLodEnabled</a>(0);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (sphere)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (ratio &lt; 0.0f)</div>
<div class="line">        {</div>
<div class="line">            ratio = CalcProjectionRatio(sphere);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> lodIndex = 1; lodIndex &lt; g_ModelLodCount; ++lodIndex)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span> (ratio &lt; g_LodThresholds[lodIndex])</div>
<div class="line">            {</div>
<div class="line">                pRenderModelObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#af1a9446c300e6fa439e90d73b07e7d03">SetDrawLodEnabled</a>(lodIndex);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a name="_a23"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html">nns::g3d::ModelAnimObj</a>* pModelAnimObj = g_Holder.modelAnimObjs[modelIndex];</div>
<div class="line">    pModelAnimObj-&gt;<a name="a24"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a138bf661637dd7746f7eb3f22a810553">CalculateView</a>(0, g_BufferIndex, g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#aff24f2ebd999e9d9f423945fa9d4e8e0">GetViewMtx</a>(0));</div>
<div class="line">    pModelAnimObj-&gt;<a name="a25"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a7617f902f6a526edb87b9857e8b6d106">Calculate</a>();</div>
<div class="line">    pModelAnimObj-&gt;<a name="a26"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a42dadacf320552419e3c79da07846ad4">CalculateUniformBlock</a>(g_BufferIndex);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 描画コマンドを追加</span></div>
<div class="line">    <a class="code" href="structnns_1_1gfx_1_1_graphics_framework_1_1_command_buffer.html">nns::gfx::GraphicsFramework::CommandBuffer</a>* pCommandBuffer = GetThreadCommandBuffer(threadIndex);</div>
<div class="line">    pRenderModelObj-&gt;<a name="a27"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#aa4061058dfcb32e29b89c6f50cb23738">Draw</a>(&amp;pCommandBuffer-&gt;<a name="a28"></a>object, 0, g_BufferIndex);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> ExecuteTask(TaskQueue* pTaskQueue)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> threadIndex = pTaskQueue-&gt;GetThreadId();</div>
<div class="line">    <a class="code" href="structnns_1_1gfx_1_1_graphics_framework_1_1_command_buffer.html">nns::gfx::GraphicsFramework::CommandBuffer</a>* pCommandBuffer = GetThreadCommandBuffer(threadIndex);</div>
<div class="line">    <a name="_a29"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html">nns::gfx::GraphicsFramework</a>* pGfxFramework = g3ddemo::GetGfxFramework();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// コマンドバッファーをリセット</span></div>
<div class="line">    pGfxFramework-&gt;<a name="a30"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#aa4d0ac88fdb9c2c9532ae73974c74069">ResetCommandBuffer</a>(pCommandBuffer);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// コマンドバッファーへの追加を開始</span></div>
<div class="line">    pCommandBuffer-&gt;object.<a name="a31"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#ab22bb14832e8fca483b977dcb18d5286">Begin</a>();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> taskIndex = 0, taskCount = pTaskQueue-&gt;GetTaskCount(); taskIndex &lt; taskCount; ++taskIndex)</div>
<div class="line">    {</div>
<div class="line">        TaskQueue::Task* pTask = pTaskQueue-&gt;GetTask(taskIndex);</div>
<div class="line">        g_TaskFunc(pTask-&gt;modelIndex, threadIndex);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// コマンドバッファーへの追加を終了</span></div>
<div class="line">    pCommandBuffer-&gt;object.<a name="a32"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#a3b4d64880cd75e66c314bdbac29c04f0">End</a>();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> ThreadMain(<span class="keywordtype">void</span>* arg)</div>
<div class="line">{</div>
<div class="line">    TaskQueue* pTaskQueue = <span class="keyword">reinterpret_cast&lt;</span>TaskQueue*<span class="keyword">&gt;</span>(arg);</div>
<div class="line">    <span class="keywordtype">int</span> threadId = pTaskQueue-&gt;GetThreadId();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (!g_IsExit)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="namespacenn_1_1os.html#aabdcb2de0b5dbdd64a0ec3d7e65c72f4">nn::os::WaitEvent</a>(&amp;g_EventStart[threadId]);</div>
<div class="line"></div>
<div class="line">        <a name="a33"></a><a class="code" href="perf___profile_8h.html#ac0cbbec62451185954e3e6a11cac2fa8">NN_PERF_SET_COLOR</a>(<a name="a34"></a><a class="code" href="classnn_1_1util_1_1_color4u8.html#a74cab22bd85f0940aec269c535ee5b54">nn::util::Color4u8::Red</a>());</div>
<div class="line">        <a name="a35"></a><a class="code" href="perf___profile_8h.html#aac326a91e81805962b5d180f2758dacc">NN_PERF_BEGIN_MEASURE</a>();</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!g_IsExit) <span class="comment">// 終了要求時には更新せず抜ける</span></div>
<div class="line">        {</div>
<div class="line">            ExecuteTask(pTaskQueue);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <a name="a36"></a><a class="code" href="perf___profile_8h.html#a0a94d0601ec383fed996a444d77c3e53">NN_PERF_END_MEASURE</a>();</div>
<div class="line"></div>
<div class="line">        <a class="code" href="namespacenn_1_1os.html#a9b959a51c1d28b76894597695fd3d081">nn::os::SignalEvent</a>(&amp;g_EventEnd[threadId]);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> Calculate(<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html">nns::gfx::GraphicsFramework</a>* pGfxFramework, <span class="keywordtype">void</span>* pUserData)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="nn___macro_8h.html#af2d1673769927c5eae977d8dde3ce106">NN_UNUSED</a>(pGfxFramework);</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span> uniformBufferIndex = *<span class="keyword">reinterpret_cast&lt;</span><span class="keywordtype">int</span>*<span class="keyword">&gt;</span>(pUserData);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="perf___profile_8h.html#ac0cbbec62451185954e3e6a11cac2fa8">NN_PERF_SET_COLOR</a>(<a name="a37"></a><a class="code" href="classnn_1_1util_1_1_color4u8.html#a60d33066a521b0728f8660d12e010d8c">nn::util::Color4u8::Green</a>());</div>
<div class="line">    <a class="code" href="perf___profile_8h.html#aac326a91e81805962b5d180f2758dacc">NN_PERF_BEGIN_MEASURE</a>();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 計算</span></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// カメラ設定</span></div>
<div class="line">        VectorSet(&amp;g_CameraPosition, 0.0f, 100.0f, 3600.0f);</div>
<div class="line">        VectorSet(&amp;g_CameraUp, 0.0f, 1.0f, 0.0f);</div>
<div class="line">        VectorSet(&amp;g_CameraTarget, 0.0f, 0.0f, 0.0f);</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x3f_type.html">nn::util::Matrix4x3fType</a> matrix;</div>
<div class="line">            MatrixLookAtRightHanded(&amp;matrix,</div>
<div class="line">                g_CameraPosition,</div>
<div class="line">                g_CameraTarget,</div>
<div class="line">                g_CameraUp);</div>
<div class="line">            g_RenderView.<a name="a38"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#a5b633742724f63bffdb11389a06b974b">SetViewMtx</a>(0, matrix);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// 投影行列</span></div>
<div class="line">        {</div>
<div class="line">            <a name="_a39"></a><a class="code" href="structnn_1_1util_1_1_matrix_row_major4x4f_type.html">nn::util::Matrix4x4fType</a> matrix;</div>
<div class="line">            MatrixPerspectiveFieldOfViewRightHanded(&amp;matrix,</div>
<div class="line">                <a class="code" href="namespacenn_1_1util.html#a342713848fbb4ce6750da90d297bc824">nn::util::DegreeToRadian</a>(45.0f), 16.0f / 9.0f, 10.0f, 40000.0f);</div>
<div class="line">            g_RenderView.<a name="a40"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#ab2d9de5f49ec96d7672389badb1acf46">SetProjectionMtx</a>(0, matrix);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// ビューの更新処理</span></div>
<div class="line">        g_RenderView.<a name="a41"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#aea54457661666de292743fe0cb6c75a0">Calculate</a>(uniformBufferIndex);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="perf___profile_8h.html#a0a94d0601ec383fed996a444d77c3e53">NN_PERF_END_MEASURE</a>();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> MakeCommand(<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html">nns::gfx::GraphicsFramework</a>* pGfxFramework, <span class="keywordtype">int</span> bufferIndex, <span class="keywordtype">void</span>* pUserData)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> uniformBufferIndex = *<span class="keyword">reinterpret_cast&lt;</span><span class="keywordtype">int</span>*<span class="keyword">&gt;</span>(pUserData);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="perf___profile_8h.html#ac0cbbec62451185954e3e6a11cac2fa8">NN_PERF_SET_COLOR</a>(<a class="code" href="classnn_1_1util_1_1_color4u8.html#a60d33066a521b0728f8660d12e010d8c">nn::util::Color4u8::Green</a>());</div>
<div class="line">    <a class="code" href="perf___profile_8h.html#aac326a91e81805962b5d180f2758dacc">NN_PERF_BEGIN_MEASURE</a>();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// コマンド生成</span></div>
<div class="line">    pGfxFramework-&gt;<a name="a42"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a1682d81714db542ef9bb6aae8908b19f">BeginFrame</a>(bufferIndex);</div>
<div class="line">    {</div>
<div class="line">        <a name="_a43"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html">nn::gfx::CommandBuffer</a>* pGfxCommandBuffer = pGfxFramework-&gt;<a name="a44"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a80b4defad13752d673db840e439d1a7f">GetRootCommandBuffer</a>(bufferIndex);</div>
<div class="line"></div>
<div class="line">        <a name="a45"></a><a class="code" href="perf___profile_8h.html#af2d54f7bfca84e3d33b2009f6334f169">NN_PERF_SET_COLOR_GPU</a>(<a name="a46"></a><a class="code" href="classnn_1_1util_1_1_color4u8.html#a5ad1502b37a61d84307433906727813c">nn::util::Color4u8::Blue</a>());</div>
<div class="line">        <a name="a47"></a><a class="code" href="perf___profile_8h.html#a1401127601eef2f70a9916b2fbbf5b4a">NN_PERF_BEGIN_MEASURE_GPU</a>(pGfxCommandBuffer);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// カラーターゲットをクリア</span></div>
<div class="line">        <a name="_a48"></a><a class="code" href="classnn_1_1gfx_1_1_t_color_target_view.html">nn::gfx::ColorTargetView</a>* pColor = pGfxFramework-&gt;<a name="a49"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#ab825acf6f1e23e4946e8915d087a94a1">GetColorTargetView</a>();</div>
<div class="line">        pGfxCommandBuffer-&gt;<a name="a50"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#a3da2d3c95fe888adb5a3f84dcc013d45">ClearColor</a>(pColor, 0.0f, 0.0f, 0.0f, 1.0f, <span class="keyword">nullptr</span>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// 深度ステンシルをクリア</span></div>
<div class="line">        <a name="_a51"></a><a class="code" href="classnn_1_1gfx_1_1_t_depth_stencil_view.html">nn::gfx::DepthStencilView</a>* pDepth = pGfxFramework-&gt;<a name="a52"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#ae375791c8ef66431a6910dafd0156bb2">GetDepthStencilView</a>();</div>
<div class="line">        pGfxCommandBuffer-&gt;<a name="a53"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#ae51f685157847b92ffb0c05362a4a6ef">ClearDepthStencil</a>(pDepth, 1.0f, 0, <a name="a54"></a><a class="code" href="namespacenn_1_1gfx.html#a733cd65018ead22dd2cd0a62a8bd2ec9a93c09969027b90e4794060197dedb5fb">nn::gfx::DepthStencilClearMode_DepthStencil</a>, <span class="keyword">nullptr</span>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// レンダーターゲットをセット</span></div>
<div class="line">        pGfxCommandBuffer-&gt;<a name="a55"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#a3698a1cbd3b59b649c048f709ddd766c">SetRenderTargets</a>(1, &amp;pColor, pDepth);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// ビューポートシザーステートをセット</span></div>
<div class="line">        pGfxCommandBuffer-&gt;<a name="a56"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#ab1c541475f015777b8ce4bdfffe7c1c3">SetViewportScissorState</a>(pGfxFramework-&gt;<a name="a57"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#ae13f7a4f898b54ab4d566ee2d1aec56e">GetViewportScissorState</a>());</div>
<div class="line"></div>
<div class="line">        <span class="comment">// モデルの描画コマンドの作成をマルチスレッドで並列実行</span></div>
<div class="line">        RunTaskQueue(UpdateAnimModelObj, uniformBufferIndex);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// 各スレッドで作成されたコマンドバッファーをメインのコマンドバッファーに追加</span></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> threadIndex = 0; threadIndex &lt; g_ThreadCount; ++threadIndex)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="structnns_1_1gfx_1_1_graphics_framework_1_1_command_buffer.html">nns::gfx::GraphicsFramework::CommandBuffer</a>* pCommandBuffer = GetThreadCommandBuffer(threadIndex);</div>
<div class="line">            pGfxCommandBuffer-&gt;<a name="a58"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#a41c75c6bf8f1ef0f723480ac1b93e52b">CallCommandBuffer</a>(&amp;pCommandBuffer-&gt;object);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// テキスト表示 コマンド生成</span></div>
<div class="line">        {</div>
<div class="line">            g_ScreenInfo.StartPrint();</div>
<div class="line">            g_ScreenInfo.Print(<span class="stringliteral">&quot;[Parallel]\n&quot;</span>);</div>
<div class="line">            g_ScreenInfo.EndPrint();</div>
<div class="line">            g_ScreenInfo.AdjustWindowSize();</div>
<div class="line">            g_ScreenInfo.Draw(pGfxCommandBuffer);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <a name="a59"></a><a class="code" href="perf___profile_8h.html#a5289e91681166ba39ce97d6eb116c59d">NN_PERF_END_MEASURE_GPU</a>(pGfxCommandBuffer);</div>
<div class="line">    }</div>
<div class="line">    pGfxFramework-&gt;<a name="a60"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#ae8a95943cd296bb2ad8ab6e6532b7b0e">EndFrame</a>(bufferIndex);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="perf___profile_8h.html#a0a94d0601ec383fed996a444d77c3e53">NN_PERF_END_MEASURE</a>();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// リソースの初期化</span></div>
<div class="line"><span class="keywordtype">void</span> InitializeResource(<a name="_a61"></a><a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice)</div>
<div class="line">{</div>
<div class="line">    g_Holder.Initialize();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// シェーダーアーカイブの初期化</span></div>
<div class="line">    <a name="_a62"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_archive.html">nn::g3d::ResShaderArchive</a>* pDemoShaderArchive;</div>
<div class="line">    {</div>
<div class="line">        <a name="_a63"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_file.html">nn::g3d::ResShaderFile</a>* pFile = g3ddemo::LoadResource&lt;nn::g3d::ResShaderFile&gt;(g_DemoBfshaPath);</div>
<div class="line">        pFile-&gt;<a name="a64"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_file.html#a6ca625333d1fb3f4b903d0ee4533666c">Setup</a>(pDevice);</div>
<div class="line">        g_Holder.shaderFiles.PushBack(pFile);</div>
<div class="line">        pDemoShaderArchive = pFile-&gt;<a name="a65"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_file.html#ab2a9392d9a139efe97b011ac5aec96c4">GetResShaderArchive</a>();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// モデルリソースの初期化</span></div>
<div class="line">    <a name="_a66"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html">nn::g3d::ResFile</a>* pEnvModelFile;</div>
<div class="line">    {</div>
<div class="line">        pEnvModelFile = g3ddemo::LoadResource&lt;nn::g3d::ResFile&gt;(g_EnvBfresPath);</div>
<div class="line">        pEnvModelFile-&gt;<a name="a67"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html#afeaf3b666d229f4e30fe374ee5707909">Setup</a>(pDevice);</div>
<div class="line">        g_Holder.files.PushBack(pEnvModelFile);</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="classnn_1_1g3d_1_1_res_file.html">nn::g3d::ResFile</a>* pBoyModelFile;</div>
<div class="line">    {</div>
<div class="line">        pBoyModelFile = g3ddemo::LoadResource&lt;nn::g3d::ResFile&gt;(g_BoyBfresPath);</div>
<div class="line">        pBoyModelFile-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_file.html#afeaf3b666d229f4e30fe374ee5707909">Setup</a>(pDevice);</div>
<div class="line">        g3ddemo::SetupTexture(pDevice, pBoyModelFile, g3ddemo::TextureBindCallback);</div>
<div class="line">        g3ddemo::RegisterSamplerToDescriptorPool(pBoyModelFile);</div>
<div class="line">        g_Holder.files.PushBack(pBoyModelFile);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// モデルの頂点ステート、デプスステンシルステート、ブレンドステート、ラスタライザーステート、シェーディングモデルを管理するRenderModelを作成</span></div>
<div class="line">    <a name="_a68"></a><a class="code" href="classnns_1_1g3d_1_1_render_model.html">nns::g3d::RenderModel</a>* pDemoRenderModel;</div>
<div class="line">    {</div>
<div class="line">        <a name="_a69"></a><a class="code" href="classnn_1_1g3d_1_1_res_model.html">nn::g3d::ResModel</a>* pResModel = pBoyModelFile-&gt;<a name="a70"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html#ab776cb75749d955956b5b2d4522da962">GetModel</a>(0);</div>
<div class="line">        pDemoRenderModel = <a name="a71"></a><a class="code" href="namespacenns_1_1g3d.html#aa1c714afc7a0cf4a993dcbc6774f1643">nns::g3d::CreateRenderModel</a>(pDevice, pResModel);</div>
<div class="line">        pDemoRenderModel-&gt;<a name="a72"></a><a class="code" href="classnns_1_1g3d_1_1_render_model.html#aa157d2168a767b3333c62aa5cc120973">CreateDrawPass</a>(pDevice, pDemoShaderArchive);</div>
<div class="line">        g_Holder.renderModels.PushBack(pDemoRenderModel);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ビューを初期化</span></div>
<div class="line">    g_RenderView.<a name="a73"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#a6520169e698d615f7cc77553e32ca88c">Initialize</a>(pDevice, 1, g_BufferingCount);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 描画時に必要となるg3dの管理外のユニフォームブロックを作成</span></div>
<div class="line">    <a name="_a74"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html">nn::g3d::ModelObj</a>* pEnvModelObj;</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnn_1_1g3d_1_1_res_model.html">nn::g3d::ResModel</a>* pResModel = pEnvModelFile-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_file.html#ab776cb75749d955956b5b2d4522da962">GetModel</a>(0);</div>
<div class="line">        <a name="a75"></a><a class="code" href="classnn_1_1g3d_1_1_shader_utility.html#a26b394ba1043958e5f64a6d6f25efe9b">nn::g3d::ShaderUtility::BindShaderParam</a>(pResModel-&gt;<a name="a76"></a><a class="code" href="classnn_1_1g3d_1_1_res_model.html#af57b0b32fc406e4c07a02133b0df1009">GetMaterial</a>(0), pDemoShaderArchive-&gt;<a name="a77"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_archive.html#a17c81d3fe346cbcc531ad38138b7117b">FindShadingModel</a>(<span class="stringliteral">&quot;env&quot;</span>));</div>
<div class="line">        <a name="_a78"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj_1_1_builder.html">nn::g3d::ModelObj::Builder</a> builder(pResModel);</div>
<div class="line">        builder.MaterialBufferingCount(g_BufferingCount);</div>
<div class="line">        pEnvModelObj = <a name="a79"></a><a class="code" href="namespacenns_1_1g3d.html#ae7cfdc41c478154e34bc8350851099ac">nns::g3d::CreateModelObj</a>(pDevice, builder);</div>
<div class="line">        <span class="comment">// このデモでは毎フレーム更新が必要でないため、ここで1度だけ計算を行う</span></div>
<div class="line">        pEnvModelObj-&gt;<a name="a80"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a674b6b3417778ae519cf3bc6d6f5ff65">CalculateMaterial</a>(0);</div>
<div class="line">        pEnvModelObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a674b6b3417778ae519cf3bc6d6f5ff65">CalculateMaterial</a>(1);</div>
<div class="line">        g_Holder.modelObjs.PushBack(pEnvModelObj);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a name="_a81"></a><a class="code" href="classnn_1_1g3d_1_1_res_skeletal_anim.html">nn::g3d::ResSkeletalAnim</a>* pJumpAnim = pBoyModelFile-&gt;<a name="a82"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html#a4f00478003a8c27bbb820a8aee35b357">FindSkeletalAnim</a>(<span class="stringliteral">&quot;boy_jump&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// モデルおよびアニメーションの計算処理を簡略化するModelAnimObjを作成</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> instanceIndex = 0; instanceIndex &lt; g_InstanceModelCount; ++instanceIndex)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html">nns::g3d::ModelAnimObj</a>* pBoyModelAnimObj;</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="classnn_1_1g3d_1_1_model_obj_1_1_builder.html">nn::g3d::ModelObj::Builder</a> builder(pBoyModelFile-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_file.html#ab776cb75749d955956b5b2d4522da962">GetModel</a>(0));</div>
<div class="line">            <span class="comment">// CPUとGPUで並列実行出来るようにバッファー数に2を指定</span></div>
<div class="line">            builder.<a name="a83"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj_1_1_initialize_argument.html#acd583ad430a0d87edc34259daedb7cff">ShapeBufferingCount</a>(g_BufferingCount);</div>
<div class="line">            builder.SkeletonBufferingCount(g_BufferingCount);</div>
<div class="line">            builder.MaterialBufferingCount(g_BufferingCount);</div>
<div class="line">            builder.SetBoundingEnabled();</div>
<div class="line">            pBoyModelAnimObj = <a name="a84"></a><a class="code" href="namespacenns_1_1g3d.html#a72152fa94a41e3511738bf0a9bc7c255">nns::g3d::CreateModelAnimObj</a>(pDevice, builder);</div>
<div class="line">            g_Holder.modelAnimObjs.PushBack(pBoyModelAnimObj);</div>
<div class="line"></div>
<div class="line">            <span class="comment">// アニメーション追加</span></div>
<div class="line">            <span class="keywordtype">int</span> jumpId = pBoyModelAnimObj-&gt;<a name="a85"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a3b6789d198e48ec3a253974aa35879a2">CreateAnim</a>(pJumpAnim);</div>
<div class="line"></div>
<div class="line">            <span class="comment">// 再生開始フレームをランダムに設定</span></div>
<div class="line">            <span class="keywordtype">float</span> frame = pJumpAnim-&gt;<a name="a86"></a><a class="code" href="classnn_1_1g3d_1_1_res_skeletal_anim.html#a2d938f44f8a7bfbdc5129ebffcd5ab60">GetFrameCount</a>() * (<span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(rand()) / static_cast&lt;float&gt;(RAND_MAX));</div>
<div class="line">            pBoyModelAnimObj-&gt;<a name="a87"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a96e279ac5daea23a15c152b783bc2c7c">GetAnimObj</a>(jumpId)-&gt;<a name="a88"></a><a class="code" href="classnn_1_1g3d_1_1_anim_obj.html#ac2f590c6bdb160d6e7b7e640826b4362">GetFrameCtrl</a>().<a name="a89"></a><a class="code" href="classnn_1_1g3d_1_1_anim_frame_ctrl.html#af7022b2827d078b2f8972664c9f28fdc">SetFrame</a>(frame);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// RenderModelとModelObjを組み合わせ、描画を行うRenderModelObjを作成</span></div>
<div class="line">        <a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pBoyRenderModelObj;</div>
<div class="line">        {</div>
<div class="line">            pBoyRenderModelObj = <a name="a90"></a><a class="code" href="namespacenns_1_1g3d.html#a4d8d828fb260a742ceca742312144c68">nns::g3d::CreateRenderModelObj</a>(pBoyModelAnimObj-&gt;<a name="a91"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a75f2e005c7b06d62f33d69508db503e9">GetModelObj</a>(), pDemoRenderModel);</div>
<div class="line">            g_Holder.renderModelObjs.PushBack(pBoyRenderModelObj);</div>
<div class="line">            <span class="comment">// このデモではシェーダーを動的に切り替えないため、ここでシェーダーを選択</span></div>
<div class="line">            g3ddemo::WriteSkinningOption(pBoyRenderModelObj);</div>
<div class="line">            pBoyRenderModelObj-&gt;<a name="a92"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a2abf914afb4d7489f87c6ea7a3fe5ac1">UpdateShader</a>(pDevice);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// EnvモデルのユニフォームブロックをRenderModelObjに設定</span></div>
<div class="line">        {</div>
<div class="line">            <span class="keyword">const</span> <a name="_a93"></a><a class="code" href="classnn_1_1gfx_1_1_t_buffer.html">nn::gfx::Buffer</a>* buffers[g_BufferingCount];</div>
<div class="line">            buffers[0] = pEnvModelObj-&gt;<a name="a94"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a225cda4a0e7881df5dc4ebb15ac6c6f6">GetMaterial</a>(0)-&gt;<a name="a95"></a><a class="code" href="classnn_1_1g3d_1_1_material_obj.html#aef15d5bfda74edf022aa6337f13d52ed">GetMaterialBlock</a>(0);</div>
<div class="line">            buffers[1] = pEnvModelObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a225cda4a0e7881df5dc4ebb15ac6c6f6">GetMaterial</a>(0)-&gt;<a class="code" href="classnn_1_1g3d_1_1_material_obj.html#aef15d5bfda74edf022aa6337f13d52ed">GetMaterialBlock</a>(1);</div>
<div class="line">            pBoyRenderModelObj-&gt;<a name="a96"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a51705d6e0cbec14deae05e0dc0724835">BindUniformBlock</a>(<span class="stringliteral">&quot;env&quot;</span>, buffers, g_BufferingCount);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        {</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classnn_1_1gfx_1_1_t_buffer.html">nn::gfx::Buffer</a>* buffers[g_BufferingCount];</div>
<div class="line">            buffers[0] = g_RenderView.<a name="a97"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#ac12827c0d0788017a196ef5b80304304">GetViewUniformBlock</a>(0, 0);</div>
<div class="line">            buffers[1] = g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#ac12827c0d0788017a196ef5b80304304">GetViewUniformBlock</a>(0, 1);</div>
<div class="line">            pBoyRenderModelObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a51705d6e0cbec14deae05e0dc0724835">BindUniformBlock</a>(<span class="stringliteral">&quot;view&quot;</span>, buffers, g_BufferingCount);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// シェーダーに必要なスクラッチメモリーを設定</span></div>
<div class="line">    g3ddemo::SetShaderScratchMemory(g_Holder.shaderFiles);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// レイアウト計算</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">int</span> matrixSize = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(std::sqrt(static_cast&lt;float&gt;(g_Holder.modelAnimObjs.GetCount())));</div>
<div class="line">        <span class="keywordtype">float</span> center = (g_GridDistance * matrixSize) / 2;</div>
<div class="line">        <span class="keywordtype">int</span> xGrid = 0, zGrid = 0;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (<a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html">nns::g3d::ModelAnimObj</a>* pModelAnimObj : g_Holder.modelAnimObjs)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">float</span> randomX = (<span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(rand()) / static_cast&lt;float&gt;(RAND_MAX)) - 0.5f;</div>
<div class="line">            <span class="keywordtype">float</span> xStir = randomX * 0.5f * g_GridDistance;</div>
<div class="line"></div>
<div class="line">            <span class="keywordtype">float</span> randomZ = (<span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(rand()) / static_cast&lt;float&gt;(RAND_MAX)) - 0.5f;</div>
<div class="line">            <span class="keywordtype">float</span> zStir = randomZ * 0.5f * g_GridDistance;</div>
<div class="line"></div>
<div class="line">            <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> position;</div>
<div class="line">            nn::util::VectorSet(&amp;position, xGrid * g_GridDistance - center + xStir, 0.0f, zGrid * g_GridDistance - center + zStir);</div>
<div class="line">            pModelAnimObj-&gt;<a name="a98"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#ab1d22a1e60ac9dd1fb7693064364f02d">SetTranslate</a>(position);</div>
<div class="line"></div>
<div class="line">            ++xGrid;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (xGrid == matrixSize)</div>
<div class="line">            {</div>
<div class="line">                xGrid = 0;</div>
<div class="line">                ++zGrid;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">} <span class="comment">// anonymous namespace</span></div>
<div class="line"></div>
<div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="keywordtype">int</span> ParallelMain()</div>
<div class="line">{</div>
<div class="line">    nns::gfx::DebugGraphicsFramework* pGfxFramework = g3ddemo::GetGfxFramework();</div>
<div class="line">    pGfxFramework-&gt;SetFrameworkMode(<a name="a99"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a4987555fae0e257658ffef4beb51a674a6d2e6861717e82c71ea532bf89e5b1f0">nns::gfx::GraphicsFramework::FrameworkMode_DeferredSubmission</a>);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice = pGfxFramework-&gt;GetDevice();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// スクリーン情報表示を初期化</span></div>
<div class="line">    {</div>
<div class="line">        g_ScreenInfo.<a name="a100"></a><a class="code" href="classnn_1_1gfx_1_1_t_device.html#a78cd197d82ff797eeb658446e9cfe387">Initialize</a>(pDevice);</div>
<div class="line">        g_ScreenInfo.SetWindowPosition(16, 16);</div>
<div class="line">        g_ScreenInfo.SetFontSize(20);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 負荷計測機能の初期化</span></div>
<div class="line">    {</div>
<div class="line">        <a name="_a101"></a><a class="code" href="classnn_1_1perf_1_1_load_meter_center_info.html">nn::perf::LoadMeterCenterInfo</a> info;</div>
<div class="line">        info.<a name="a102"></a><a class="code" href="classnn_1_1perf_1_1_load_meter_center_info.html#af498c498d1a566ae06b3967e6c9d16ba">SetDefault</a>();</div>
<div class="line">        info.<a name="a103"></a><a class="code" href="classnn_1_1perf_1_1_load_meter_center_info.html#a372f6f660e8d835bdc8caf0805784a3f">SetCoreCount</a>(3);</div>
<div class="line">        info.<a name="a104"></a><a class="code" href="classnn_1_1perf_1_1_load_meter_center_info.html#aecf8347128518aee83e2680cf6ca7b64">SetCpuSectionCountMax</a>(64);</div>
<div class="line">        info.<a name="a105"></a><a class="code" href="classnn_1_1perf_1_1_load_meter_center_info.html#aa73627b39ed7d2f96ed72b34990c8f34">SetGpuSectionCountMax</a>(64);</div>
<div class="line">        info.<a name="a106"></a><a class="code" href="classnn_1_1perf_1_1_load_meter_center_info.html#a9075d3e6987564b7037373b5b42bff53">SetCpuBufferCount</a>(2);</div>
<div class="line">        info.<a name="a107"></a><a class="code" href="classnn_1_1perf_1_1_load_meter_center_info.html#aeaae49849ef5a404ecce49d34f2d48d4">SetGpuBufferCount</a>(3);</div>
<div class="line">        pGfxFramework-&gt;InitializePerf(info);</div>
<div class="line"><span class="preprocessor">#if defined( NN_BUILD_CONFIG_OS_WIN )</span></div>
<div class="line">        <a name="a108"></a><a class="code" href="perf___profile_8h.html#a3506f976dd0501c40d1605db7811ceed">NN_PERF_SET_GET_CORE_NUMBER_FUNCTION</a>(GetFixedMultiCoreNumber);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ワークメモリー管理の初期化</span></div>
<div class="line">    g3ddemo::Vector&lt;void*&gt; workMemorys;</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">size_t</span> size = <span class="keyword">sizeof</span>(<span class="keywordtype">void</span>*) * g_WorkMemoryCount;</div>
<div class="line">        <span class="keywordtype">void</span>* pBuffer = g3ddemo::AllocateMemory(size);</div>
<div class="line">        workMemorys.SetBuffer(pBuffer, size);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 現在のスレッド(メインスレッド)を 0 番コアに割り当て</span></div>
<div class="line">    <a name="a109"></a><a class="code" href="namespacenn_1_1os.html#ac50b86561c15ee3e8195c83fddc8e732">nn::os::SetThreadCoreMask</a>(<a class="code" href="namespacenn_1_1os.html#ad106866a5b13bc3d430104333966b479">nn::os::GetCurrentThread</a>(), 0, 1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// リソースの初期化</span></div>
<div class="line">    InitializeResource(pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// マルチタスク起動</span></div>
<div class="line">    {</div>
<div class="line">        g_IsExit = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// 各スレッドで使用するコマンドバッファーを作成</span></div>
<div class="line">        <a name="_a110"></a><a class="code" href="classnn_1_1gfx_1_1_command_buffer_info.html">nn::gfx::CommandBuffer::InfoType</a> info;</div>
<div class="line">        info.<a name="a111"></a><a class="code" href="classnn_1_1gfx_1_1_command_buffer_info.html#ae2c8f9bbcf68ce7d42deba2352e4836c">SetDefault</a>();</div>
<div class="line">        info.<a name="a112"></a><a class="code" href="classnn_1_1gfx_1_1_command_buffer_info.html#a1ee219b3f9aa9bc7ffb878de1e4e7574">SetQueueCapability</a>(<a name="a113"></a><a class="code" href="namespacenn_1_1gfx.html#a305234f652e5c28bf7caed3bcfab60d3a3c85c0b4d0af93ffe600e26ea8a89e57">nn::gfx::QueueCapability_Graphics</a>);</div>
<div class="line">        info.<a name="a114"></a><a class="code" href="classnn_1_1gfx_1_1_command_buffer_info.html#a2dc75925a14c5d81ebd838b730a6a026">SetCommandBufferType</a>(<a name="a115"></a><a class="code" href="namespacenn_1_1gfx.html#a0e171a31353ada1910b428cd08e7d2d3a334e30250c695f8bfed86fc89b3dc49e">nn::gfx::CommandBufferType_Nested</a>);</div>
<div class="line">        <span class="keywordtype">size_t</span> commandMemorySize = 1024 * 1024 * 2;</div>
<div class="line">        <span class="keywordtype">size_t</span> controlMemorySize = 1024;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> threadIndex = 0; threadIndex &lt; g_ThreadCount; ++threadIndex)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> bufferIndex = 0; bufferIndex &lt; g_ThreadCommandBufferCount; ++bufferIndex)</div>
<div class="line">            {</div>
<div class="line">                pGfxFramework-&gt;InitializeCommandBuffer(&amp;g_ThreadCommandBuffer[threadIndex][bufferIndex],</div>
<div class="line">                    info, commandMemorySize, controlMemorySize);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// スレッド上で処理するタスクを作成</span></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> threadIndex = 0; threadIndex &lt; g_ThreadCount; ++threadIndex)</div>
<div class="line">        {</div>
<div class="line">            TaskQueue* pTaskQueue = &amp;g_TaskQueue[threadIndex];</div>
<div class="line">            pTaskQueue-&gt;Initialize(threadIndex, g_InstanceModelCount);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// 各タスクに計算するモデルを振り分け</span></div>
<div class="line">        <span class="keywordtype">int</span> modelCount = g_Holder.renderModelObjs.GetCount();</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> modelIndex = 0; modelIndex &lt; modelCount; ++modelIndex)</div>
<div class="line">        {</div>
<div class="line">            TaskQueue* pTaskQueue = &amp;g_TaskQueue[modelIndex % g_ThreadCount];</div>
<div class="line">            pTaskQueue-&gt;PushBack(modelIndex);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// 同期用イベントを作成</span></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> threadIndex = 0; threadIndex &lt; g_ThreadCount; ++threadIndex)</div>
<div class="line">        {</div>
<div class="line">            <a name="a116"></a><a class="code" href="namespacenn_1_1os.html#af07abef747ac6b51112b9e800ba9632c">nn::os::InitializeEvent</a>(&amp;g_EventStart[threadIndex], <span class="keyword">false</span>, <a name="a117"></a><a class="code" href="namespacenn_1_1os.html#a11ab71d44973a4135958c420e5682452a31f6133098296b3ddb7e14da3dc695cc">nn::os::EventClearMode_AutoClear</a>);</div>
<div class="line">            <a class="code" href="namespacenn_1_1os.html#af07abef747ac6b51112b9e800ba9632c">nn::os::InitializeEvent</a>(&amp;g_EventEnd[threadIndex], <span class="keyword">false</span>, <a class="code" href="namespacenn_1_1os.html#a11ab71d44973a4135958c420e5682452a31f6133098296b3ddb7e14da3dc695cc">nn::os::EventClearMode_AutoClear</a>);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// コア番号を指定してスレッドを作成</span></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> threadIndex = 0; threadIndex &lt; g_ThreadCount; ++threadIndex)</div>
<div class="line">        {</div>
<div class="line">            <a name="_a118"></a><a class="code" href="classnn_1_1_result.html">nn::Result</a> result;</div>
<div class="line">            result = <a name="a119"></a><a class="code" href="namespacenn_1_1os.html#a75f43e1d3c194c0d2173ef5d95785933">nn::os::CreateThread</a>(&amp;g_Thread[threadIndex], ThreadMain, &amp;g_TaskQueue[threadIndex], g_ThreadStack[threadIndex], g_ThreadStackSize, <a name="a120"></a><a class="code" href="namespacenn_1_1os.html#a5985811d04e64c0823ed758fd420591d">nn::os::DefaultThreadPriority</a>);</div>
<div class="line">            <a name="a121"></a><a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(result.<a name="a122"></a><a class="code" href="classnn_1_1_result.html#a80792d8ec8b6b9e9b34025100baa67ec">IsSuccess</a>(), <span class="stringliteral">&quot;Cannot create thread.&quot;</span>);</div>
<div class="line">            <a class="code" href="namespacenn_1_1os.html#ac50b86561c15ee3e8195c83fddc8e732">nn::os::SetThreadCoreMask</a>(&amp;g_Thread[threadIndex], threadIndex, g_CoreMask[threadIndex]);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if defined( NN_BUILD_CONFIG_OS_WIN )</span></div>
<div class="line">        <span class="comment">// コア番号解決のためにスレッドID を記録</span></div>
<div class="line">        g_MainThreadId = nn::os::GetThreadId(<a class="code" href="namespacenn_1_1os.html#ad106866a5b13bc3d430104333966b479">nn::os::GetCurrentThread</a>());</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> threadIndex = 0; threadIndex &lt; g_ThreadCount; ++threadIndex)</div>
<div class="line">        {</div>
<div class="line">            g_ThreadId[threadIndex] = nn::os::GetThreadId(&amp;g_Thread[threadIndex]);</div>
<div class="line">        }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">        <span class="comment">// スレッドの実行を開始</span></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> threadIndex = 0; threadIndex &lt; g_ThreadCount; ++threadIndex)</div>
<div class="line">        {</div>
<div class="line">            <a name="a123"></a><a class="code" href="namespacenn_1_1os.html#a18eec7c4c4c298f7abaa9ef41d6de76b">nn::os::StartThread</a>(&amp;g_Thread[threadIndex]);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span> uniformBufferIndex = 0;</div>
<div class="line">    pGfxFramework-&gt;SetCalculateCallback(Calculate, &amp;uniformBufferIndex);</div>
<div class="line">    pGfxFramework-&gt;SetMakeCommandCallback(MakeCommand, &amp;uniformBufferIndex);</div>
<div class="line">    pGfxFramework-&gt;ResetFrame();</div>
<div class="line"></div>
<div class="line">    g3ddemo::Pad&amp; pad = g3ddemo::GetPad();</div>
<div class="line">    pad.Reset();</div>
<div class="line">    <span class="comment">// メインループ</span></div>
<div class="line">    <span class="keywordflow">while</span> (<a name="a124"></a><a class="code" href="nn___macro_8h.html#a71c0f58f6d49fe1392380eed4509ab9a">NN_STATIC_CONDITION</a>(1))</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// タッチ長押しで終了</span></div>
<div class="line">        <span class="keywordflow">if</span> (g3ddemo::isExitDemo())</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!pad.Read() || pad.IsTriggered(g3ddemo::Pad::BUTTON_START))</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// フレーム処理実行</span></div>
<div class="line">        pGfxFramework-&gt;ProcessFrame();</div>
<div class="line">        uniformBufferIndex ^= 1;</div>
<div class="line">    }</div>
<div class="line">    pGfxFramework-&gt;QueueFinish();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// マルチタスク終了</span></div>
<div class="line">    {</div>
<div class="line">        g_IsExit = <span class="keyword">true</span>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// スレッドが終了するのを待つ</span></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> threadIndex = 0; threadIndex &lt; g_ThreadCount; ++threadIndex)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="namespacenn_1_1os.html#a9b959a51c1d28b76894597695fd3d081">nn::os::SignalEvent</a>(&amp;g_EventStart[threadIndex]);</div>
<div class="line">            <a name="a125"></a><a class="code" href="namespacenn_1_1os.html#a8070c91be85c5ccb36b56e9ff3a75b26">nn::os::WaitThread</a>(&amp;g_Thread[threadIndex]);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// スレッドを破棄</span></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> threadIndex = 0; threadIndex &lt; g_ThreadCount; ++threadIndex)</div>
<div class="line">        {</div>
<div class="line">            <a name="a126"></a><a class="code" href="namespacenn_1_1os.html#a9dbfcfb82583a9e34431e8c11d2411dd">nn::os::DestroyThread</a>(&amp;g_Thread[threadIndex]);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// 同期イベントを破棄</span></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> threadIndex = 0; threadIndex &lt; g_ThreadCount; ++threadIndex)</div>
<div class="line">        {</div>
<div class="line">            <a name="a127"></a><a class="code" href="namespacenn_1_1os.html#adae3d14bd5e37dd1feee56bbf1717e37">nn::os::FinalizeEvent</a>(&amp;g_EventStart[threadIndex]);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// シェーダーの排他制御用のメモリーの破棄</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">int</span> workMemoryCount = workMemorys.GetCount();</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> workMemoryIndex = 0; workMemoryIndex &lt; workMemoryCount; ++workMemoryIndex)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">void</span>* pWorkMemory = workMemorys[workMemoryIndex];</div>
<div class="line">            g3ddemo::FreeMemory(pWorkMemory);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<span class="keywordtype">void</span>* pBuffer = workMemorys.GetBuffer())</div>
<div class="line">        {</div>
<div class="line">            g3ddemo::FreeMemory(pBuffer);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 各スレッドで使用したコマンドバッファーの破棄</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> threadIndex = 0; threadIndex &lt; g_ThreadCount; ++threadIndex)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> bufferIndex = 0; bufferIndex &lt; g_ThreadCommandBufferCount; ++bufferIndex)</div>
<div class="line">        {</div>
<div class="line">            pGfxFramework-&gt;FinalizeCommandBuffer(&amp;g_ThreadCommandBuffer[threadIndex][bufferIndex]);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// タスクの破棄</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> threadIndex = 0; threadIndex &lt; g_ThreadCount; ++threadIndex)</div>
<div class="line">        {</div>
<div class="line">            TaskQueue* pTaskQueue = &amp;g_TaskQueue[threadIndex];</div>
<div class="line">            pTaskQueue-&gt;Cleanup();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 終了処理</span></div>
<div class="line">    g3ddemo::DestroyAll(pDevice, &amp;g_Holder);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ビュー用ユニフォームブロックの破棄</span></div>
<div class="line">    g_RenderView.<a name="a128"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#ae2461a77f4a4a5f2c954516604f35a9e">Finalize</a>(pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 負荷計測メーターの破棄</span></div>
<div class="line">    pGfxFramework-&gt;FinalizePerf();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// スクリーン情報表示の破棄</span></div>
<div class="line">    g_ScreenInfo.Cleanup(pDevice);</div>
<div class="line"></div>
<div class="line">    pGfxFramework-&gt;SetCalculateCallback(<span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>);</div>
<div class="line">    pGfxFramework-&gt;SetMakeCommandCallback(<span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> EXIT_SUCCESS;</div>
<div class="line">} <span class="comment">// NOLINT</span></div>
</div><!-- fragment --> </div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
</body>
</html>
