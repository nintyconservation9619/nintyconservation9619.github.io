<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>NintendoSDK API Reference: ShapeAnimation.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="openclose.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">NintendoSDK API Reference
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 構築: Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'検索');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>総合概要</span></a></li>
      <li><a href="pages.html"><span>諸情報</span></a></li>
      <li><a href="modules.html"><span>モジュール</span></a></li>
      <li><a href="namespaces.html"><span>名前空間</span></a></li>
      <li><a href="annotated.html"><span>クラス</span></a></li>
      <li><a href="files.html"><span>ファイル</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="検索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">ShapeAnimation.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>ソースコードの説明は、<a class="el" href="_page_sample_g3d_shape_animation.html">G3dDemo ShapeAnimation</a> および <a class="el" href="_shape_animation_8cpp.html" title="シェイプアニメーションを使用したモデル表示のサンプルプログラム ">ShapeAnimation.cpp</a> を参照してください。</p>
<div class="fragment"><div class="line"><span class="comment">/*--------------------------------------------------------------------------------*</span></div>
<div class="line"><span class="comment">  Copyright (C)Nintendo All rights reserved.</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  These coded instructions, statements, and computer programs contain proprietary</span></div>
<div class="line"><span class="comment">  information of Nintendo and/or its licensed developers and are protected by</span></div>
<div class="line"><span class="comment">  national and international copyright laws. They may not be disclosed to third</span></div>
<div class="line"><span class="comment">  parties or copied or duplicated in any form, in whole or in part, without the</span></div>
<div class="line"><span class="comment">  prior written consent of Nintendo.</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  The content herein is highly confidential and should be handled accordingly.</span></div>
<div class="line"><span class="comment"> *--------------------------------------------------------------------------------*/</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="_programs_2_nintendo_ware_2_include_2nn_2g3d_8h.html">nn/g3d.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;g3ddemo_GfxUtility.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;g3ddemo_ModelUtility.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespacenn_1_1g3d_1_1demo.html">g3ddemo</a> = <a class="code" href="namespacenn_1_1g3d_1_1demo.html">nn::g3d::demo</a>;</div>
<div class="line"></div>
<div class="line"><span class="keyword">namespace </span>{</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define RESOURCE_PATH &quot;Resource:/&quot;</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* g_DemoBfshaPath = RESOURCE_PATH <span class="stringliteral">&quot;shader/demo.bfsha&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* g_ComputeBfshaPath = RESOURCE_PATH <span class="stringliteral">&quot;shader/shape_anim_compute.bfsha&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* g_EnvBfresPath = RESOURCE_PATH <span class="stringliteral">&quot;env.bfres&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* g_ModelBfresPath = RESOURCE_PATH <span class="stringliteral">&quot;shape_anim.bfres&quot;</span>;</div>
<div class="line"></div>
<div class="line"><a name="_a0"></a><a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> g_CameraPosition;</div>
<div class="line"><a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> g_CameraUp;</div>
<div class="line"><a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> g_CameraTarget;</div>
<div class="line"></div>
<div class="line">g3ddemo::ResourceHolder g_Holder;</div>
<div class="line">g3ddemo::ScreenInfo g_ScreenInfo;</div>
<div class="line"><a name="_a1"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html">nns::g3d::RenderView</a> g_RenderView;</div>
<div class="line"><span class="keywordtype">int</span> g_ShapeAnimId = <a name="a2"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a362b50b68f24886e203fa3bad05f25d9">nns::g3d::ModelAnimObj::InvalidAnimId</a>;</div>
<div class="line"></div>
<div class="line"><span class="comment">// 計算モード</span></div>
<div class="line"><span class="keyword">enum</span> CalcMode</div>
<div class="line">{</div>
<div class="line">    CalcMode_GPU = 0,</div>
<div class="line">    CalcMode_CPU,</div>
<div class="line">};</div>
<div class="line"><span class="keywordtype">int</span> g_CalcMode;</div>
<div class="line"></div>
<div class="line"><span class="comment">// ブレンドする頂点属性</span></div>
<div class="line"><span class="keyword">enum</span> BlendAttribute</div>
<div class="line">{</div>
<div class="line">    BlendAttribute_Position,</div>
<div class="line">    BlendAttribute_Normal,</div>
<div class="line">    BlendAttribute_CountMax</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// キーシェイプ数</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> g_KeyShapeCount = 5;</div>
<div class="line"></div>
<div class="line"><span class="comment">// 頂点ブレンドを行うシェイプのインデクス</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> g_BlendShapeIndex = 0;</div>
<div class="line"></div>
<div class="line"><span class="comment">// バッファーリング数</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> g_BufferingCount = 2;</div>
<div class="line"></div>
<div class="line"><span class="comment">// GPU バッファー</span></div>
<div class="line"><a name="_a3"></a><a class="code" href="classnn_1_1gfx_1_1_t_buffer.html">nn::gfx::Buffer</a> g_ExportBuffer[BlendAttribute_CountMax];</div>
<div class="line"><a class="code" href="classnn_1_1gfx_1_1_t_buffer.html">nn::gfx::Buffer</a> g_WeightBuffer;</div>
<div class="line"><a class="code" href="classnn_1_1gfx_1_1_t_buffer.html">nn::gfx::Buffer</a> g_KeyShapeBuffers[BlendAttribute_CountMax];</div>
<div class="line"><a class="code" href="classnn_1_1gfx_1_1_t_buffer.html">nn::gfx::Buffer</a> g_ShapeAnimParamBuffer;</div>
<div class="line"><span class="keyword">struct </span>shapeAnimParamBuffer</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> vertexCount;</div>
<div class="line">    <span class="keywordtype">int</span> keyShapeCount;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// メモリープールオフセット</span></div>
<div class="line">ptrdiff_t g_ExportMemoryPoolOffset[BlendAttribute_CountMax];</div>
<div class="line">ptrdiff_t g_WeightMemoryPoolOffset;</div>
<div class="line">ptrdiff_t g_KeyShapeMemoryPoolOffset[BlendAttribute_CountMax];</div>
<div class="line">ptrdiff_t g_ShapeAnimParamMemoryPoolOffset;</div>
<div class="line"></div>
<div class="line"><span class="comment">// 頂点ブレンドに使用するシェイプの情報</span></div>
<div class="line">uint32_t g_ShapeVertexCount;</div>
<div class="line"><span class="keywordtype">size_t</span> g_KeyShapeBuffersSize;</div>
<div class="line"><span class="keywordtype">size_t</span> g_BlendWeightBufferSize;</div>
<div class="line"><span class="keywordtype">size_t</span> g_ExportBufferSize;</div>
<div class="line"><span class="keywordtype">size_t</span> g_ShapeAnimParamBufferSize;</div>
<div class="line"><span class="keywordtype">float</span> g_ShapeBlendWeight[g_KeyShapeCount];</div>
<div class="line"></div>
<div class="line"><span class="comment">// コンピュートシェーダーで使用する GPU バッファーの初期化</span></div>
<div class="line"><span class="keywordtype">void</span> InitializeGpuBuffer(<a name="_a4"></a><a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice, <a name="_a5"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html">nn::g3d::ModelObj</a>* pModelObj)</div>
<div class="line">{</div>
<div class="line">    <a name="_a6"></a><a class="code" href="classnn_1_1g3d_1_1_shape_obj.html">nn::g3d::ShapeObj</a>* pShapeObj = pModelObj-&gt;<a name="a7"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a4f56c9a4a685ff577c44b60bc50f5a8b">GetShape</a>(g_BlendShapeIndex);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ブレンドするシェイプの頂点数を取得</span></div>
<div class="line">    <span class="keyword">const</span> <a name="_a8"></a><a class="code" href="classnn_1_1g3d_1_1_res_vertex.html">nn::g3d::ResVertex</a>* pResVertex = pShapeObj-&gt;<a name="a9"></a><a class="code" href="classnn_1_1g3d_1_1_shape_obj.html#a877f7c0f4f853151966321c4b969c45b">GetResource</a>()-&gt;<a name="a10"></a><a class="code" href="classnn_1_1g3d_1_1_res_shape.html#af36e930fe8fc8484b41dbe0b6e62ac9a">GetVertex</a>();</div>
<div class="line">    g_ShapeVertexCount = pShapeObj-&gt;<a name="a11"></a><a class="code" href="classnn_1_1g3d_1_1_shape_obj.html#acd76605a682a3ca3676ab91d6fe62c24">GetResVertex</a>()-&gt;<a name="a12"></a><a class="code" href="classnn_1_1g3d_1_1_res_vertex.html#a7c7ef1113d8931c9f506c280848ff0e9">GetCount</a>();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// モデルのキーシェイプ数がサンプル想定数であることをチェック</span></div>
<div class="line">    <a name="a13"></a><a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(g_KeyShapeCount == pModelObj-&gt;<a name="a14"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a71faa678be49b342e738072ed3783ed3">GetResource</a>()-&gt;<a name="a15"></a><a class="code" href="classnn_1_1g3d_1_1_res_model.html#a5ef4cf8efe64a6415d67fc3e52860b6f">GetShape</a>(g_BlendShapeIndex)-&gt;<a name="a16"></a><a class="code" href="classnn_1_1g3d_1_1_res_shape.html#aafacda67bfbcd663f739e41212580755">GetKeyShapeCount</a>());</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 各バッファーのサイズを計算</span></div>
<div class="line">    g_ExportBufferSize = <span class="keyword">sizeof</span>(<a name="_a17"></a><a class="code" href="structnn_1_1util_1_1_float4.html">nn::util::Float4</a>) * g_ShapeVertexCount;</div>
<div class="line">    g_BlendWeightBufferSize =  <span class="keyword">sizeof</span>(float) * g_KeyShapeCount;</div>
<div class="line">    g_KeyShapeBuffersSize = <span class="keyword">sizeof</span>(<a class="code" href="structnn_1_1util_1_1_float4.html">nn::util::Float4</a>) * g_ShapeVertexCount * g_KeyShapeCount;</div>
<div class="line">    g_ShapeAnimParamBufferSize = <span class="keyword">sizeof</span>(shapeAnimParamBuffer);</div>
<div class="line"></div>
<div class="line">    <a name="_a18"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html">nns::gfx::GraphicsFramework</a>* pFramework = g3ddemo::GetGfxFramework();</div>
<div class="line">    <a name="_a19"></a><a class="code" href="classnn_1_1gfx_1_1_t_memory_pool.html">nn::gfx::MemoryPool</a>* pMemoryPool = pFramework-&gt;<a name="a20"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a9c662e2ac88106a0cb9828ef1e8f0faa">GetMemoryPool</a>(nns::gfx::GraphicsFramework::MemoryPoolType_ConstantBuffer);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// コンピュートシェーダー用のキーシェイプの頂点属性を保持するバッファーの初期化</span></div>
<div class="line">    <span class="comment">// g_KeyShapeBuffers は 頂点数×sizeof(nn::util::Float4)×キーシェイプ数のサイズを持ち、全てのキーシェイプの頂点属性の値を順番に保持する。</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* srcBlendAttributeName[BlendAttribute_CountMax][g_KeyShapeCount] =</div>
<div class="line">    {</div>
<div class="line">        { <span class="stringliteral">&quot;_p0&quot;</span>, <span class="stringliteral">&quot;_p1&quot;</span>, <span class="stringliteral">&quot;_p2&quot;</span>, <span class="stringliteral">&quot;_p3&quot;</span>, <span class="stringliteral">&quot;_p4&quot;</span> },</div>
<div class="line">        { <span class="stringliteral">&quot;_n0&quot;</span>, <span class="stringliteral">&quot;_n1&quot;</span>, <span class="stringliteral">&quot;_n2&quot;</span>, <span class="stringliteral">&quot;_n3&quot;</span>, <span class="stringliteral">&quot;_n4&quot;</span> }</div>
<div class="line">    };</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> blendAttributeIndex = 0; blendAttributeIndex &lt; BlendAttribute_CountMax; ++blendAttributeIndex)</div>
<div class="line">    {</div>
<div class="line">        <a name="_a21"></a><a class="code" href="classnn_1_1gfx_1_1_buffer_info.html">nn::gfx::Buffer::InfoType</a> info;</div>
<div class="line">        info.<a name="a22"></a><a class="code" href="classnn_1_1gfx_1_1_buffer_info.html#a234ab03cd4d0ea8dfdfbe588a0895eac">SetDefault</a>();</div>
<div class="line">        info.<a name="a23"></a><a class="code" href="classnn_1_1gfx_1_1_buffer_info.html#a8baa33ab5cf098fcec0e1609c6ecf0c7">SetGpuAccessFlags</a>(<a name="a24"></a><a class="code" href="namespacenn_1_1gfx.html#a24dbcd6d86531138895622b5a854e4f5a736fb431c450f21d2b8386ecc1577caf">nn::gfx::GpuAccess_UnorderedAccessBuffer</a>);</div>
<div class="line">        info.<a name="a25"></a><a class="code" href="classnn_1_1gfx_1_1_buffer_info.html#acf66bfe2703001b5c3c800d73fae0dc5">SetSize</a>(g_KeyShapeBuffersSize);</div>
<div class="line"></div>
<div class="line">        g_KeyShapeMemoryPoolOffset[blendAttributeIndex] = g3ddemo::GetGfxFramework()-&gt;AllocatePoolMemory(</div>
<div class="line">            nns::gfx::GraphicsFramework::MemoryPoolType_ConstantBuffer,</div>
<div class="line">            info.<a name="a26"></a><a class="code" href="classnn_1_1gfx_1_1_buffer_info.html#ade5a953d5136e969a8a7a225eb91b436">GetSize</a>(),</div>
<div class="line">            <a name="a27"></a><a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a99b1cd500e55e26460655d68eee13842">nn::gfx::Buffer::GetBufferAlignment</a>(pDevice, info));</div>
<div class="line">        g_KeyShapeBuffers[blendAttributeIndex].<a name="a28"></a><a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a4052c47a96fb7c0b60f851b423fa6d39">Initialize</a>(pDevice,</div>
<div class="line">            info, pMemoryPool, g_KeyShapeMemoryPoolOffset[blendAttributeIndex], info.<a class="code" href="classnn_1_1gfx_1_1_buffer_info.html#ade5a953d5136e969a8a7a225eb91b436">GetSize</a>());</div>
<div class="line"></div>
<div class="line">        <span class="comment">// 頂点ブレンドに使用する頂点属性を頂点バッファーから取得</span></div>
<div class="line">        <a class="code" href="structnn_1_1util_1_1_float4.html">nn::util::Float4</a>* pMapped = g_KeyShapeBuffers[blendAttributeIndex].<a name="a29"></a><a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#ae4ea23c81cbef8a6cd39a378678d2df6">Map</a>&lt;<a class="code" href="structnn_1_1util_1_1_float4.html">nn::util::Float4</a>&gt;();</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> shapeIndex = 0; shapeIndex &lt; g_KeyShapeCount; ++shapeIndex)</div>
<div class="line">        {</div>
<div class="line">            <span class="keyword">const</span> <a name="_a30"></a><a class="code" href="classnn_1_1g3d_1_1_res_vertex_attr.html">nn::g3d::ResVertexAttr</a>* pAttr = pShapeObj-&gt;<a name="a31"></a><a class="code" href="classnn_1_1g3d_1_1_shape_obj.html#aa7115a44dc383289e8887b4c20c00313">FindResVertexAttr</a>(srcBlendAttributeName[blendAttributeIndex][shapeIndex]);</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">int</span> bufferIndex = pAttr-&gt;<a name="a32"></a><a class="code" href="classnn_1_1g3d_1_1_res_vertex_attr.html#a4cbb0102aa08c896e755fe297edd506a">GetBufferIndex</a>();</div>
<div class="line">            ptrdiff_t stride = pResVertex-&gt;<a name="a33"></a><a class="code" href="classnn_1_1g3d_1_1_res_vertex.html#aa4289b726aa155bdcf578db76c12f538">GetVertexBufferStride</a>(bufferIndex);</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="classnn_1_1gfx_1_1_t_buffer.html">nn::gfx::Buffer</a>* pBuffer = pShapeObj-&gt;<a name="a34"></a><a class="code" href="classnn_1_1g3d_1_1_shape_obj.html#a1c79150775d457e82c04d5ba635ef7c5">GetVertexBuffer</a>(bufferIndex);</div>
<div class="line">            <a name="_a35"></a><a class="code" href="classnn_1_1util_1_1_byte_ptr.html">nn::util::BytePtr</a> bytePtr(pBuffer-&gt;<a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#ae4ea23c81cbef8a6cd39a378678d2df6">Map</a>());</div>
<div class="line">            bytePtr.<a name="a36"></a><a class="code" href="classnn_1_1util_1_1_byte_ptr.html#af44783b143e4350c3aaef5d576007f96">Advance</a>(pAttr-&gt;<a name="a37"></a><a class="code" href="classnn_1_1g3d_1_1_res_vertex_attr.html#a7b26072b6c08d631d50780f68c0f4597">GetOffset</a>());</div>
<div class="line">            <span class="keywordflow">for</span> (uint32_t vertexIndex = 0; vertexIndex &lt; g_ShapeVertexCount; ++vertexIndex)</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="structnn_1_1util_1_1_float4.html">nn::util::Float4</a>* pAttrValue = bytePtr.Get&lt;<a class="code" href="structnn_1_1util_1_1_float4.html">nn::util::Float4</a>&gt;();</div>
<div class="line">                pMapped-&gt;<a name="a38"></a>x = pAttrValue-&gt;x;</div>
<div class="line">                pMapped-&gt;<a name="a39"></a>y = pAttrValue-&gt;y;</div>
<div class="line">                pMapped-&gt;<a name="a40"></a>z = pAttrValue-&gt;z;</div>
<div class="line">                pMapped-&gt;<a name="a41"></a>w = 0.0f;</div>
<div class="line">                pMapped++;</div>
<div class="line"></div>
<div class="line">                bytePtr.Advance(stride);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        g_KeyShapeBuffers[blendAttributeIndex].<a name="a42"></a><a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a8a5e6d06cc7f541da91237ddf540f4b8">Unmap</a>();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// コンピュートシェーダー用の各キーシェイプの weight 値を保持するバッファーの初期化</span></div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnn_1_1gfx_1_1_buffer_info.html">nn::gfx::Buffer::InfoType</a> info;</div>
<div class="line">        info.<a class="code" href="classnn_1_1gfx_1_1_buffer_info.html#a234ab03cd4d0ea8dfdfbe588a0895eac">SetDefault</a>();</div>
<div class="line">        info.<a class="code" href="classnn_1_1gfx_1_1_buffer_info.html#a8baa33ab5cf098fcec0e1609c6ecf0c7">SetGpuAccessFlags</a>(<a class="code" href="namespacenn_1_1gfx.html#a24dbcd6d86531138895622b5a854e4f5a736fb431c450f21d2b8386ecc1577caf">nn::gfx::GpuAccess_UnorderedAccessBuffer</a>);</div>
<div class="line">        info.<a class="code" href="classnn_1_1gfx_1_1_buffer_info.html#acf66bfe2703001b5c3c800d73fae0dc5">SetSize</a>(g_BlendWeightBufferSize);</div>
<div class="line"></div>
<div class="line">        g_WeightMemoryPoolOffset = pFramework-&gt;<a name="a43"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#acfe9bb061211e7cea1984525a9391152">AllocatePoolMemory</a>(</div>
<div class="line">            nns::gfx::GraphicsFramework::MemoryPoolType_ConstantBuffer,</div>
<div class="line">            info.<a class="code" href="classnn_1_1gfx_1_1_buffer_info.html#ade5a953d5136e969a8a7a225eb91b436">GetSize</a>(),</div>
<div class="line">            <a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a99b1cd500e55e26460655d68eee13842">nn::gfx::Buffer::GetBufferAlignment</a>(pDevice, info));</div>
<div class="line">        g_WeightBuffer.<a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a4052c47a96fb7c0b60f851b423fa6d39">Initialize</a>(pDevice, info, pMemoryPool, g_WeightMemoryPoolOffset, info.<a class="code" href="classnn_1_1gfx_1_1_buffer_info.html#ade5a953d5136e969a8a7a225eb91b436">GetSize</a>());</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// コンピュートシェーダー用の演算結果を格納するバッファーの初期化</span></div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnn_1_1gfx_1_1_buffer_info.html">nn::gfx::Buffer::InfoType</a> info;</div>
<div class="line">        info.<a class="code" href="classnn_1_1gfx_1_1_buffer_info.html#a234ab03cd4d0ea8dfdfbe588a0895eac">SetDefault</a>();</div>
<div class="line">        info.<a class="code" href="classnn_1_1gfx_1_1_buffer_info.html#a8baa33ab5cf098fcec0e1609c6ecf0c7">SetGpuAccessFlags</a>(<a class="code" href="namespacenn_1_1gfx.html#a24dbcd6d86531138895622b5a854e4f5a736fb431c450f21d2b8386ecc1577caf">nn::gfx::GpuAccess_UnorderedAccessBuffer</a>);</div>
<div class="line">        info.<a class="code" href="classnn_1_1gfx_1_1_buffer_info.html#acf66bfe2703001b5c3c800d73fae0dc5">SetSize</a>(g_ExportBufferSize);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> blendAttributeIndex = 0; blendAttributeIndex &lt; BlendAttribute_CountMax; ++blendAttributeIndex)</div>
<div class="line">        {</div>
<div class="line">            g_ExportMemoryPoolOffset[blendAttributeIndex] = g3ddemo::GetGfxFramework()-&gt;AllocatePoolMemory(nns::gfx::GraphicsFramework::MemoryPoolType_ConstantBuffer,</div>
<div class="line">                info.<a class="code" href="classnn_1_1gfx_1_1_buffer_info.html#ade5a953d5136e969a8a7a225eb91b436">GetSize</a>(), <a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a99b1cd500e55e26460655d68eee13842">nn::gfx::Buffer::GetBufferAlignment</a>(pDevice, info));</div>
<div class="line">            g_ExportBuffer[blendAttributeIndex].<a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a4052c47a96fb7c0b60f851b423fa6d39">Initialize</a>(pDevice, info, pMemoryPool, g_ExportMemoryPoolOffset[blendAttributeIndex], info.<a class="code" href="classnn_1_1gfx_1_1_buffer_info.html#ade5a953d5136e969a8a7a225eb91b436">GetSize</a>());</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ユニフォームブロック用バッファー</span></div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnn_1_1gfx_1_1_buffer_info.html">nn::gfx::Buffer::InfoType</a> info;</div>
<div class="line">        info.<a class="code" href="classnn_1_1gfx_1_1_buffer_info.html#a234ab03cd4d0ea8dfdfbe588a0895eac">SetDefault</a>();</div>
<div class="line">        info.<a class="code" href="classnn_1_1gfx_1_1_buffer_info.html#a8baa33ab5cf098fcec0e1609c6ecf0c7">SetGpuAccessFlags</a>(<a name="a44"></a><a class="code" href="namespacenn_1_1gfx.html#a24dbcd6d86531138895622b5a854e4f5af73fa5ff79cf33f75dfecb4cbe5c139d">nn::gfx::GpuAccess_ConstantBuffer</a>);</div>
<div class="line">        info.<a class="code" href="classnn_1_1gfx_1_1_buffer_info.html#acf66bfe2703001b5c3c800d73fae0dc5">SetSize</a>(g_ShapeAnimParamBufferSize);</div>
<div class="line"></div>
<div class="line">        g_ShapeAnimParamMemoryPoolOffset = g3ddemo::GetGfxFramework()-&gt;AllocatePoolMemory(nns::gfx::GraphicsFramework::MemoryPoolType_ConstantBuffer,</div>
<div class="line">            info.<a class="code" href="classnn_1_1gfx_1_1_buffer_info.html#ade5a953d5136e969a8a7a225eb91b436">GetSize</a>(), <a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a99b1cd500e55e26460655d68eee13842">nn::gfx::Buffer::GetBufferAlignment</a>(pDevice, info));</div>
<div class="line">        g_ShapeAnimParamBuffer.<a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a4052c47a96fb7c0b60f851b423fa6d39">Initialize</a>(pDevice, info, pMemoryPool, g_ShapeAnimParamMemoryPoolOffset, info.<a class="code" href="classnn_1_1gfx_1_1_buffer_info.html#ade5a953d5136e969a8a7a225eb91b436">GetSize</a>());</div>
<div class="line"></div>
<div class="line">        shapeAnimParamBuffer* pMapped = g_ShapeAnimParamBuffer.<a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#ae4ea23c81cbef8a6cd39a378678d2df6">Map</a>&lt;shapeAnimParamBuffer&gt;();</div>
<div class="line">        pMapped-&gt;vertexCount = g_ShapeVertexCount;</div>
<div class="line">        pMapped-&gt;keyShapeCount = g_KeyShapeCount;</div>
<div class="line">        g_ShapeAnimParamBuffer.<a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a8a5e6d06cc7f541da91237ddf540f4b8">Unmap</a>();</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// コンピュートシェーダーの初期化</span></div>
<div class="line"><span class="keywordtype">void</span> InitializeComputeShader(<a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice)</div>
<div class="line">{</div>
<div class="line">    <a name="_a45"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_archive.html">nn::g3d::ResShaderArchive</a>* pResShaderArchive = g_Holder.shaderFiles[1]-&gt;GetResShaderArchive();</div>
<div class="line">    <a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(pResShaderArchive);</div>
<div class="line">    <a name="_a46"></a><a class="code" href="classnn_1_1g3d_1_1_res_shading_model.html">nn::g3d::ResShadingModel</a>* pResShadingModel = pResShaderArchive-&gt;<a name="a47"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_archive.html#a17c81d3fe346cbcc531ad38138b7117b">FindShadingModel</a>(<span class="stringliteral">&quot;shape_anim_compute&quot;</span>);</div>
<div class="line">    <a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(pResShadingModel);</div>
<div class="line">    <a name="_a48"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_program.html">nn::g3d::ResShaderProgram</a>* pResShaderProgram = pResShadingModel-&gt;<a name="a49"></a><a class="code" href="classnn_1_1g3d_1_1_res_shading_model.html#a479ac33b23065e8ef76cd359c122f871">GetShaderProgram</a>(0);</div>
<div class="line">    <a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(pResShaderProgram);</div>
<div class="line">    pResShaderProgram-&gt;<a name="a50"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_program.html#aafe83b170f69457eaa1d396eb6885288">Update</a>(pDevice);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// コンピュートシェーダーの破棄</span></div>
<div class="line"><span class="keywordtype">void</span> FinalizeGpuBuffer(<a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html">nns::gfx::GraphicsFramework</a>* pFramework = g3ddemo::GetGfxFramework();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// コンピュートシェーダー用のユニフォームブロックのバッファーの破棄</span></div>
<div class="line">    g_ShapeAnimParamBuffer.<a name="a51"></a><a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a208391f1e05916badd0ed1709ee7ae39">Finalize</a>(pDevice);</div>
<div class="line">    pFramework-&gt;<a name="a52"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a7342a183bbe66874974bff3bb4de7450">FreePoolMemory</a>(nns::gfx::GraphicsFramework::MemoryPoolType_ConstantBuffer, g_ShapeAnimParamMemoryPoolOffset);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// コンピュートシェーダー用の演算結果を格納するバッファーの破棄</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> blendAttributeIndex = 0; blendAttributeIndex &lt; BlendAttribute_CountMax; ++blendAttributeIndex)</div>
<div class="line">    {</div>
<div class="line">        g_ExportBuffer[blendAttributeIndex].<a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a208391f1e05916badd0ed1709ee7ae39">Finalize</a>(pDevice);</div>
<div class="line">        pFramework-&gt;<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a7342a183bbe66874974bff3bb4de7450">FreePoolMemory</a>(nns::gfx::GraphicsFramework::MemoryPoolType_ConstantBuffer, g_ExportMemoryPoolOffset[blendAttributeIndex]);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// コンピュートシェーダー用の各キーシェイプの weight 値を保持するバッファーの破棄</span></div>
<div class="line">    g_WeightBuffer.<a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a208391f1e05916badd0ed1709ee7ae39">Finalize</a>(pDevice);</div>
<div class="line">    pFramework-&gt;<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a7342a183bbe66874974bff3bb4de7450">FreePoolMemory</a>(nns::gfx::GraphicsFramework::MemoryPoolType_ConstantBuffer, g_WeightMemoryPoolOffset);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// コンピュートシェーダー用のキーシェイプの頂点属性を保持するバッファーの破棄</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> blendAttributeIndex = 0; blendAttributeIndex &lt; BlendAttribute_CountMax; ++blendAttributeIndex)</div>
<div class="line">    {</div>
<div class="line">        g_KeyShapeBuffers[blendAttributeIndex].<a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a208391f1e05916badd0ed1709ee7ae39">Finalize</a>(pDevice);</div>
<div class="line">        pFramework-&gt;<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a7342a183bbe66874974bff3bb4de7450">FreePoolMemory</a>(nns::gfx::GraphicsFramework::MemoryPoolType_ConstantBuffer, g_KeyShapeMemoryPoolOffset[blendAttributeIndex]);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> MakeComputeShaderCommand(<a name="_a53"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html">nn::gfx::CommandBuffer</a>* pCommandBuffer)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="classnn_1_1g3d_1_1_res_shader_archive.html">nn::g3d::ResShaderArchive</a>* pResShaderArchive= g_Holder.shaderFiles[1]-&gt;GetResShaderArchive();</div>
<div class="line">    <a class="code" href="classnn_1_1g3d_1_1_res_shading_model.html">nn::g3d::ResShadingModel</a>* pResShadingModel = pResShaderArchive-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_shader_archive.html#a17c81d3fe346cbcc531ad38138b7117b">FindShadingModel</a>(<span class="stringliteral">&quot;shape_anim_compute&quot;</span>);</div>
<div class="line">    <a class="code" href="classnn_1_1g3d_1_1_res_shader_program.html">nn::g3d::ResShaderProgram</a>* pComputeShaderProgram = pResShadingModel-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_shading_model.html#a479ac33b23065e8ef76cd359c122f871">GetShaderProgram</a>(0);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <a name="_a54"></a><a class="code" href="classnn_1_1gfx_1_1_t_shader.html">nn::gfx::Shader</a>* pShader = pComputeShaderProgram-&gt;<a name="a55"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_program.html#a56bc0905db115f89833ece4c0388c7f3">GetShader</a>();</div>
<div class="line">    pCommandBuffer-&gt;<a name="a56"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#affa101add0b7e50e308ef467bb3a574c">SetShader</a>(pShader, <a name="a57"></a><a class="code" href="namespacenn_1_1gfx.html#a1e02bfe3380ee94c02ac4f0c762c4196a0bef8c04786ad594a3e6160d4a77e3f1">nn::gfx::ShaderStageBit_Compute</a>);</div>
<div class="line"></div>
<div class="line">    <a name="_a58"></a><a class="code" href="classnn_1_1gfx_1_1_gpu_address.html">nn::gfx::GpuAddress</a> gpuAddress;</div>
<div class="line">    <a class="code" href="namespacenn_1_1g3d.html#af6088ee27e9e42fdac18748c63c4b0c8">nn::g3d::Stage</a> stage = <a name="a59"></a><a class="code" href="namespacenn_1_1g3d.html#af6088ee27e9e42fdac18748c63c4b0c8adb7f401104f3fd19bb449a4a92ecbb66">nn::g3d::Stage_Compute</a>;</div>
<div class="line">    <a class="code" href="namespacenn_1_1gfx.html#a23a67c7d8f6b5765e2de8173797f73fe">nn::gfx::ShaderStage</a> gfxStageBit = <a name="a60"></a><a class="code" href="namespacenn_1_1gfx.html#a23a67c7d8f6b5765e2de8173797f73feafb656bd13782e0bb57ec5e9891eac3fe">nn::gfx::ShaderStage_Compute</a>;</div>
<div class="line">    <span class="keywordtype">int</span> slotIndex = -1;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ユニフォームブロックの値をセット</span></div>
<div class="line">    g_ShapeAnimParamBuffer.<a name="a61"></a><a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a67df38d01bea9fdc073b6c3657a34011">GetGpuAddress</a>(&amp;gpuAddress);</div>
<div class="line">    slotIndex = pComputeShaderProgram-&gt;<a name="a62"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_program.html#ac913291aa562765be2d267a4c5829b92">GetUniformBlockLocation</a>(pResShadingModel-&gt;<a name="a63"></a><a class="code" href="classnn_1_1g3d_1_1_res_shading_model.html#a80dc8d654181109fc767500e0fc62d2c">FindUniformBlockIndex</a>(<span class="stringliteral">&quot;shape_anim_param_buf&quot;</span>), stage);</div>
<div class="line">    pCommandBuffer-&gt;<a name="a64"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#ab03dd5ed3b0bbb7ab222027003a4a829">SetConstantBuffer</a>(slotIndex, gfxStageBit, gpuAddress, g_ShapeAnimParamBufferSize);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 各キーシェイプの位置属性をセット</span></div>
<div class="line">    g_KeyShapeBuffers[BlendAttribute_Position].<a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a67df38d01bea9fdc073b6c3657a34011">GetGpuAddress</a>(&amp;gpuAddress);</div>
<div class="line">    slotIndex = pComputeShaderProgram-&gt;<a name="a65"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_program.html#afb3d55abc410e9b8fbcdbf05c9322b2d">GetShaderStorageBlockLocation</a>(pResShadingModel-&gt;<a name="a66"></a><a class="code" href="classnn_1_1g3d_1_1_res_shading_model.html#a0b4778932bbbbadd15376fc00bff49ae">FindShaderStorageBlockIndex</a>(<span class="stringliteral">&quot;pos_buf&quot;</span>), stage);</div>
<div class="line">    pCommandBuffer-&gt;<a name="a67"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#ae5d4a178d5ec714385d98f335b64ee34">SetUnorderedAccessBuffer</a>(slotIndex, gfxStageBit, gpuAddress, g_KeyShapeBuffersSize);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 各キーシェイプの法線属性をセット</span></div>
<div class="line">    g_KeyShapeBuffers[BlendAttribute_Normal].<a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a67df38d01bea9fdc073b6c3657a34011">GetGpuAddress</a>(&amp;gpuAddress);</div>
<div class="line">    slotIndex = pComputeShaderProgram-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_shader_program.html#afb3d55abc410e9b8fbcdbf05c9322b2d">GetShaderStorageBlockLocation</a>(pResShadingModel-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_shading_model.html#a0b4778932bbbbadd15376fc00bff49ae">FindShaderStorageBlockIndex</a>(<span class="stringliteral">&quot;norm_buf&quot;</span>), stage);</div>
<div class="line">    pCommandBuffer-&gt;<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#ae5d4a178d5ec714385d98f335b64ee34">SetUnorderedAccessBuffer</a>(slotIndex, gfxStageBit, gpuAddress, g_KeyShapeBuffersSize);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 各キーシェイプの weight 値をセット</span></div>
<div class="line">    g_WeightBuffer.<a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a67df38d01bea9fdc073b6c3657a34011">GetGpuAddress</a>(&amp;gpuAddress);</div>
<div class="line">    slotIndex = pComputeShaderProgram-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_shader_program.html#afb3d55abc410e9b8fbcdbf05c9322b2d">GetShaderStorageBlockLocation</a>(pResShadingModel-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_shading_model.html#a0b4778932bbbbadd15376fc00bff49ae">FindShaderStorageBlockIndex</a>(<span class="stringliteral">&quot;weight_buf&quot;</span>), stage);</div>
<div class="line">    pCommandBuffer-&gt;<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#ae5d4a178d5ec714385d98f335b64ee34">SetUnorderedAccessBuffer</a>(slotIndex, gfxStageBit, gpuAddress, g_BlendWeightBufferSize);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 位置属性のブレンド結果が格納されるバッファーをセット</span></div>
<div class="line">    g_ExportBuffer[BlendAttribute_Position].<a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a67df38d01bea9fdc073b6c3657a34011">GetGpuAddress</a>(&amp;gpuAddress);</div>
<div class="line">    slotIndex = pComputeShaderProgram-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_shader_program.html#afb3d55abc410e9b8fbcdbf05c9322b2d">GetShaderStorageBlockLocation</a>(pResShadingModel-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_shading_model.html#a0b4778932bbbbadd15376fc00bff49ae">FindShaderStorageBlockIndex</a>(<span class="stringliteral">&quot;export_pos_buf&quot;</span>), stage);</div>
<div class="line">    pCommandBuffer-&gt;<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#ae5d4a178d5ec714385d98f335b64ee34">SetUnorderedAccessBuffer</a>(slotIndex, gfxStageBit, gpuAddress, g_ExportBufferSize);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 法線属性のブレンド結果が格納されるバッファーをセット</span></div>
<div class="line">    g_ExportBuffer[BlendAttribute_Normal].<a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a67df38d01bea9fdc073b6c3657a34011">GetGpuAddress</a>(&amp;gpuAddress);</div>
<div class="line">    slotIndex = pComputeShaderProgram-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_shader_program.html#afb3d55abc410e9b8fbcdbf05c9322b2d">GetShaderStorageBlockLocation</a>(pResShadingModel-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_shading_model.html#a0b4778932bbbbadd15376fc00bff49ae">FindShaderStorageBlockIndex</a>(<span class="stringliteral">&quot;export_norm_buf&quot;</span>), stage);</div>
<div class="line">    pCommandBuffer-&gt;<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#ae5d4a178d5ec714385d98f335b64ee34">SetUnorderedAccessBuffer</a>(slotIndex, gfxStageBit, gpuAddress, g_ExportBufferSize);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 演算コマンドを追加</span></div>
<div class="line">    <span class="keywordtype">int</span> workGroupX;</div>
<div class="line">    <span class="keywordtype">int</span> workGroupY;</div>
<div class="line">    <span class="keywordtype">int</span> workGroupZ;</div>
<div class="line">    pShader-&gt;<a name="a68"></a><a class="code" href="classnn_1_1gfx_1_1_t_shader.html#afc8c9ebc71e345e052797b205d34a7e3">GetWorkGroupSize</a>(&amp;workGroupX, &amp;workGroupY, &amp;workGroupZ);</div>
<div class="line">    <span class="keywordtype">int</span> groupCount = (g_ShapeVertexCount - 1 + workGroupX) / workGroupX;</div>
<div class="line">    pCommandBuffer-&gt;<a name="a69"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#aea6ca6c590f78c2c94c9eeba63171b64">Dispatch</a>(groupCount, 1, 1);</div>
<div class="line">    pCommandBuffer-&gt;<a name="a70"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#a3b43b17e57f564190229a914370bfb9b">FlushMemory</a>(<a class="code" href="namespacenn_1_1gfx.html#a24dbcd6d86531138895622b5a854e4f5a736fb431c450f21d2b8386ecc1577caf">nn::gfx::GpuAccess_UnorderedAccessBuffer</a>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> CalcMenu(g3ddemo::Pad&amp; pad)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// 計算モードの切り替え</span></div>
<div class="line">    <span class="keywordflow">if</span> (pad.IsTriggered(g3ddemo::Pad::BUTTON_LEFT) || pad.IsTriggered(g3ddemo::Pad::BUTTON_RIGHT))</div>
<div class="line">    {</div>
<div class="line">        g_CalcMode ^= 1;</div>
<div class="line">        g_Holder.modelAnimObjs[0]-&gt;GetAnimObj(g_ShapeAnimId)-&gt;GetFrameCtrl().SetFrame(0.0f);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> MakeMenuCommand(<a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html">nn::gfx::CommandBuffer</a>* pGfxCommandBuffer)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// テキスト表示 コマンド生成</span></div>
<div class="line">    g_ScreenInfo.StartPrint();</div>
<div class="line">    g_ScreenInfo.Print(<span class="stringliteral">&quot;[ShapeAnimation]\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (g_CalcMode == CalcMode_GPU)</div>
<div class="line">    {</div>
<div class="line">        g_ScreenInfo.Print(<span class="stringliteral">&quot;Calculation mode:  GPU\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        g_ScreenInfo.Print(<span class="stringliteral">&quot;Calculation mode:  CPU\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    g_ScreenInfo.EndPrint();</div>
<div class="line">    g_ScreenInfo.AdjustWindowSize();</div>
<div class="line">    g_ScreenInfo.Draw(pGfxCommandBuffer);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// ・現フレームのコンピュートシェーダーの計算結果の参照</span></div>
<div class="line"><span class="comment">// ・頂点バッファーの書き換え</span></div>
<div class="line"><span class="comment">// ・次フレームのコンピュートシェーダーで使用する weight バッファーの更新</span></div>
<div class="line"><span class="keywordtype">void</span> UpdateVertexBuffer()</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="classnn_1_1g3d_1_1_model_obj.html">nn::g3d::ModelObj</a>* pModelObj = g_Holder.renderModelObjs[0]-&gt;GetModelObj();</div>
<div class="line">    <a class="code" href="classnn_1_1g3d_1_1_shape_obj.html">nn::g3d::ShapeObj</a>* pShapeObj = pModelObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a4f56c9a4a685ff577c44b60bc50f5a8b">GetShape</a>(g_BlendShapeIndex);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 頂点ブレンドした結果を書き換える先の頂点属性名</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* destBlendAttributeName[BlendAttribute_CountMax] = {<span class="stringliteral">&quot;_p0&quot;</span>, <span class="stringliteral">&quot;_n0&quot;</span>};</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> blendAttributeIndex = 0; blendAttributeIndex &lt; BlendAttribute_CountMax; ++blendAttributeIndex)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classnn_1_1g3d_1_1_res_vertex_attr.html">nn::g3d::ResVertexAttr</a>* pAttr = pShapeObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_shape_obj.html#aa7115a44dc383289e8887b4c20c00313">FindResVertexAttr</a>(destBlendAttributeName[blendAttributeIndex]);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">int</span> attrBufferIndex = pAttr-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_vertex_attr.html#a4cbb0102aa08c896e755fe297edd506a">GetBufferIndex</a>();</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classnn_1_1g3d_1_1_res_vertex.html">nn::g3d::ResVertex</a>* pResVertex = pShapeObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_shape_obj.html#a877f7c0f4f853151966321c4b969c45b">GetResource</a>()-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_shape.html#af36e930fe8fc8484b41dbe0b6e62ac9a">GetVertex</a>();</div>
<div class="line">        ptrdiff_t stride = pResVertex-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_vertex.html#aa4289b726aa155bdcf578db76c12f538">GetVertexBufferStride</a>(attrBufferIndex);</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classnn_1_1gfx_1_1_t_buffer.html">nn::gfx::Buffer</a>* pBuffer = pShapeObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_shape_obj.html#a1c79150775d457e82c04d5ba635ef7c5">GetVertexBuffer</a>(attrBufferIndex);</div>
<div class="line">        uint8_t* pMapped = pBuffer-&gt;<a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#ae4ea23c81cbef8a6cd39a378678d2df6">Map</a>&lt;uint8_t&gt;();</div>
<div class="line"></div>
<div class="line">        <span class="comment">// GPU による頂点計算を行うモード、既にコンピュートシェーダーによって計算されたブレンド結果を頂点バッファーに書き込む</span></div>
<div class="line">        <span class="keywordflow">if</span> (g_CalcMode == CalcMode_GPU)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="structnn_1_1util_1_1_float4.html">nn::util::Float4</a>* pResult = g_ExportBuffer[blendAttributeIndex].<a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#ae4ea23c81cbef8a6cd39a378678d2df6">Map</a>&lt;<a class="code" href="structnn_1_1util_1_1_float4.html">nn::util::Float4</a>&gt;();</div>
<div class="line">            g_ExportBuffer[blendAttributeIndex].<a name="a71"></a><a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a19e27774f85edc7707f18ccfaf87ef49">InvalidateMappedRange</a>(0, g_ExportBufferSize);</div>
<div class="line">            <span class="keywordflow">for</span> (uint32_t vertexIndex = 0; vertexIndex &lt; g_ShapeVertexCount; ++vertexIndex)</div>
<div class="line">            {</div>
<div class="line">                <a name="_a72"></a><a class="code" href="structnn_1_1util_1_1_float3.html">nn::util::Float3</a>* pDst = <span class="keyword">reinterpret_cast&lt;</span><a class="code" href="structnn_1_1util_1_1_float3.html">nn::util::Float3</a>*<span class="keyword">&gt;</span>(pMapped + pAttr-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_vertex_attr.html#a7b26072b6c08d631d50780f68c0f4597">GetOffset</a>());</div>
<div class="line">                pDst-&gt;<a name="a73"></a>x = pResult[vertexIndex].x;</div>
<div class="line">                pDst-&gt;<a name="a74"></a>y = pResult[vertexIndex].y;</div>
<div class="line">                pDst-&gt;<a name="a75"></a>z = pResult[vertexIndex].z;</div>
<div class="line">                pMapped += stride;</div>
<div class="line">            }</div>
<div class="line">            g_ExportBuffer[blendAttributeIndex].<a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a8a5e6d06cc7f541da91237ddf540f4b8">Unmap</a>();</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">// CPU による頂点計算を行うモード、各キーシェイプの値とweight値からブレンド計算を行い、頂点バッファーに書き込む</span></div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (g_CalcMode == CalcMode_CPU)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="structnn_1_1util_1_1_float4.html">nn::util::Float4</a>* pKeyShapeBuffers = g_KeyShapeBuffers[blendAttributeIndex].<a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#ae4ea23c81cbef8a6cd39a378678d2df6">Map</a>&lt;<a class="code" href="structnn_1_1util_1_1_float4.html">nn::util::Float4</a>&gt;();</div>
<div class="line">            <span class="keywordflow">for</span> (uint32_t vertexIndex = 0; vertexIndex &lt; g_ShapeVertexCount; ++vertexIndex)</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> attributeValue[g_KeyShapeCount];</div>
<div class="line">                <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> result;</div>
<div class="line">                nn::util::VectorZero(&amp;result);</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> shapeIndex = 0; shapeIndex &lt; g_KeyShapeCount; ++shapeIndex)</div>
<div class="line">                {</div>
<div class="line">                    nn::util::VectorSet(&amp;attributeValue[shapeIndex],</div>
<div class="line">                        pKeyShapeBuffers[shapeIndex * g_ShapeVertexCount + vertexIndex].x,</div>
<div class="line">                        pKeyShapeBuffers[shapeIndex * g_ShapeVertexCount + vertexIndex].y,</div>
<div class="line">                        pKeyShapeBuffers[shapeIndex * g_ShapeVertexCount + vertexIndex].z);</div>
<div class="line"></div>
<div class="line">                    <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> tmpResult;</div>
<div class="line">                    nn::util::VectorMultiply(&amp;tmpResult, attributeValue[shapeIndex], g_ShapeBlendWeight[shapeIndex]);</div>
<div class="line">                    nn::util::VectorAdd(&amp;result, result, tmpResult);</div>
<div class="line">                }</div>
<div class="line">                <span class="comment">// 法線は正規化する</span></div>
<div class="line">                <span class="keywordflow">if</span> (blendAttributeIndex == BlendAttribute_Normal)</div>
<div class="line">                {</div>
<div class="line">                    nn::util::VectorNormalize(&amp;result, result);</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <a class="code" href="structnn_1_1util_1_1_float3.html">nn::util::Float3</a>* pDst = <span class="keyword">reinterpret_cast&lt;</span><a class="code" href="structnn_1_1util_1_1_float3.html">nn::util::Float3</a>*<span class="keyword">&gt;</span>(pMapped + pAttr-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_vertex_attr.html#a7b26072b6c08d631d50780f68c0f4597">GetOffset</a>());</div>
<div class="line">                nn::util::VectorStore(pDst, result);</div>
<div class="line">                pMapped += stride;</div>
<div class="line">            }</div>
<div class="line">            g_KeyShapeBuffers[blendAttributeIndex].<a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a8a5e6d06cc7f541da91237ddf540f4b8">Unmap</a>();</div>
<div class="line">        }</div>
<div class="line">        pBuffer-&gt;<a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a8a5e6d06cc7f541da91237ddf540f4b8">Unmap</a>();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ブレンディングウェイトを更新</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> keyShapeIndex = 0, destIndex = 0; keyShapeIndex &lt; g_KeyShapeCount; ++keyShapeIndex)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (pShapeObj-&gt;<a name="a76"></a><a class="code" href="classnn_1_1g3d_1_1_shape_obj.html#af0f338c38b6c82c09d6aa85edc5b47d2">IsBlendWeightValid</a>(keyShapeIndex))</div>
<div class="line">        {</div>
<div class="line">            g_ShapeBlendWeight[destIndex++] = pShapeObj-&gt;<a name="a77"></a><a class="code" href="classnn_1_1g3d_1_1_shape_obj.html#a60e4e6ea528f00f34f5c6a2913a435d9">GetBlendWeight</a>(keyShapeIndex);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// GPU による頂点計算を行う場合は GPU バッファーのウェイト値を更新</span></div>
<div class="line">    <span class="keywordflow">if</span> (g_CalcMode == CalcMode_GPU)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">float</span>* pMapped = g_WeightBuffer.<a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#ae4ea23c81cbef8a6cd39a378678d2df6">Map</a>&lt;<span class="keywordtype">float</span>&gt;();</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; g_KeyShapeCount; i++)</div>
<div class="line">        {</div>
<div class="line">            *pMapped = g_ShapeBlendWeight[i];</div>
<div class="line">            pMapped++;</div>
<div class="line">        }</div>
<div class="line">        g_WeightBuffer.<a class="code" href="classnn_1_1gfx_1_1_t_buffer.html#a8a5e6d06cc7f541da91237ddf540f4b8">Unmap</a>();</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> Calculate(<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html">nns::gfx::GraphicsFramework</a>* pGfxFramework, <span class="keywordtype">void</span>* pUserData)</div>
<div class="line">{</div>
<div class="line">    <a name="a78"></a><a class="code" href="nn___macro_8h.html#af2d1673769927c5eae977d8dde3ce106">NN_UNUSED</a>(pGfxFramework);</div>
<div class="line">    <span class="keywordtype">int</span> uniformBufferIndex = *<span class="keyword">reinterpret_cast&lt;</span><span class="keywordtype">int</span>*<span class="keyword">&gt;</span>(pUserData);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 計算</span></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// カメラ設定</span></div>
<div class="line">        g3ddemo::Pad&amp; pad = g3ddemo::GetPad();</div>
<div class="line">        ControlCamera(&amp;g_CameraPosition, &amp;g_CameraUp, &amp;g_CameraTarget, &amp;g_RenderView.<a name="a79"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#aff24f2ebd999e9d9f423945fa9d4e8e0">GetViewMtx</a>(0), &amp;pad);</div>
<div class="line">        {</div>
<div class="line">            <a name="_a80"></a><a class="code" href="structnn_1_1util_1_1_matrix_row_major4x3f_type.html">nn::util::Matrix4x3fType</a> matrix;</div>
<div class="line">            MatrixLookAtRightHanded(&amp;matrix,</div>
<div class="line">                g_CameraPosition, g_CameraTarget, g_CameraUp);</div>
<div class="line">            g_RenderView.<a name="a81"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#a5b633742724f63bffdb11389a06b974b">SetViewMtx</a>(0, matrix);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// 投影行列</span></div>
<div class="line">            <a name="_a82"></a><a class="code" href="structnn_1_1util_1_1_matrix_row_major4x4f_type.html">nn::util::Matrix4x4fType</a> matrix;</div>
<div class="line">            MatrixPerspectiveFieldOfViewRightHanded(&amp;matrix,</div>
<div class="line">                <a name="a83"></a><a class="code" href="namespacenn_1_1util.html#a342713848fbb4ce6750da90d297bc824">nn::util::DegreeToRadian</a>(45.0f), 16.0f / 9.0f, 10.0f, 40000.0f);</div>
<div class="line">            g_RenderView.<a name="a84"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#ab2d9de5f49ec96d7672389badb1acf46">SetProjectionMtx</a>(0, matrix);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// ビューの更新処理</span></div>
<div class="line">        g_RenderView.<a name="a85"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#aea54457661666de292743fe0cb6c75a0">Calculate</a>(uniformBufferIndex);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// モデルの更新処理</span></div>
<div class="line">        <span class="keywordflow">for</span> (<a name="_a86"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html">nns::g3d::ModelAnimObj</a>* pModelAnimObj : g_Holder.modelAnimObjs)</div>
<div class="line">        {</div>
<div class="line">            pModelAnimObj-&gt;<a name="a87"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a138bf661637dd7746f7eb3f22a810553">CalculateView</a>(0, uniformBufferIndex, g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#aff24f2ebd999e9d9f423945fa9d4e8e0">GetViewMtx</a>(0));</div>
<div class="line">            pModelAnimObj-&gt;<a name="a88"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a7617f902f6a526edb87b9857e8b6d106">Calculate</a>();</div>
<div class="line">            pModelAnimObj-&gt;<a name="a89"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a42dadacf320552419e3c79da07846ad4">CalculateUniformBlock</a>(uniformBufferIndex);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> MakeCommand(<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html">nns::gfx::GraphicsFramework</a>* pGfxFramework, <span class="keywordtype">int</span> bufferIndex, <span class="keywordtype">void</span>* pUserData)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> uniformBufferIndex = *<span class="keyword">reinterpret_cast&lt;</span><span class="keywordtype">int</span>*<span class="keyword">&gt;</span>(pUserData);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// コマンド生成</span></div>
<div class="line">    pGfxFramework-&gt;<a name="a90"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a1682d81714db542ef9bb6aae8908b19f">BeginFrame</a>(bufferIndex);</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html">nn::gfx::CommandBuffer</a>* pGfxCommandBuffer = pGfxFramework-&gt;<a name="a91"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a80b4defad13752d673db840e439d1a7f">GetRootCommandBuffer</a>(bufferIndex);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// カラーターゲットをクリア</span></div>
<div class="line">        <a name="_a92"></a><a class="code" href="classnn_1_1gfx_1_1_t_color_target_view.html">nn::gfx::ColorTargetView</a>* pColor = pGfxFramework-&gt;<a name="a93"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#ab825acf6f1e23e4946e8915d087a94a1">GetColorTargetView</a>();</div>
<div class="line">        pGfxCommandBuffer-&gt;<a name="a94"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#a3da2d3c95fe888adb5a3f84dcc013d45">ClearColor</a>(pColor, 0.3f, 0.3f, 0.3f, 1.0f, <span class="keyword">nullptr</span>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// 深度ステンシルをクリア</span></div>
<div class="line">        <a name="_a95"></a><a class="code" href="classnn_1_1gfx_1_1_t_depth_stencil_view.html">nn::gfx::DepthStencilView</a>* pDepth = pGfxFramework-&gt;<a name="a96"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#ae375791c8ef66431a6910dafd0156bb2">GetDepthStencilView</a>();</div>
<div class="line">        pGfxCommandBuffer-&gt;<a name="a97"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#ae51f685157847b92ffb0c05362a4a6ef">ClearDepthStencil</a>(pDepth, 1.0f, 0, <a name="a98"></a><a class="code" href="namespacenn_1_1gfx.html#a733cd65018ead22dd2cd0a62a8bd2ec9a93c09969027b90e4794060197dedb5fb">nn::gfx::DepthStencilClearMode_DepthStencil</a>, <span class="keyword">nullptr</span>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// レンダーターゲットをセット</span></div>
<div class="line">        pGfxCommandBuffer-&gt;<a name="a99"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#a3698a1cbd3b59b649c048f709ddd766c">SetRenderTargets</a>(1, &amp;pColor, pDepth);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// ビューポートシザーステートをセット</span></div>
<div class="line">        pGfxCommandBuffer-&gt;<a name="a100"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#ab1c541475f015777b8ce4bdfffe7c1c3">SetViewportScissorState</a>(pGfxFramework-&gt;<a name="a101"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#ae13f7a4f898b54ab4d566ee2d1aec56e">GetViewportScissorState</a>());</div>
<div class="line"></div>
<div class="line">        <span class="comment">// モデル表示 コマンド生成</span></div>
<div class="line">        <span class="keywordflow">for</span> (<a name="_a102"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pRenderModelObj : g_Holder.renderModelObjs)</div>
<div class="line">        {</div>
<div class="line">            pRenderModelObj-&gt;<a name="a103"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#aa4061058dfcb32e29b89c6f50cb23738">Draw</a>(pGfxCommandBuffer, 0, uniformBufferIndex);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// テキスト表示 コマンド生成</span></div>
<div class="line">        MakeMenuCommand(pGfxCommandBuffer);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// コンピュートシェーダーによる座標の演算コマンドを生成</span></div>
<div class="line">        <span class="keywordflow">if</span> (g_CalcMode == CalcMode_GPU)</div>
<div class="line">        {</div>
<div class="line">            <a name="a104"></a><a class="code" href="perf___profile_8h.html#af2d54f7bfca84e3d33b2009f6334f169">NN_PERF_SET_COLOR_GPU</a>(<a name="a105"></a><a class="code" href="classnn_1_1util_1_1_color4u8.html#a74cab22bd85f0940aec269c535ee5b54">nn::util::Color4u8::Red</a>());</div>
<div class="line">            <a name="a106"></a><a class="code" href="perf___profile_8h.html#a1401127601eef2f70a9916b2fbbf5b4a">NN_PERF_BEGIN_MEASURE_GPU</a>(pGfxCommandBuffer);</div>
<div class="line"></div>
<div class="line">            <a name="a107"></a><a class="code" href="perf___profile_8h.html#ac0cbbec62451185954e3e6a11cac2fa8">NN_PERF_SET_COLOR</a>(<a class="code" href="classnn_1_1util_1_1_color4u8.html#a74cab22bd85f0940aec269c535ee5b54">nn::util::Color4u8::Red</a>());</div>
<div class="line">            <a name="a108"></a><a class="code" href="perf___profile_8h.html#aac326a91e81805962b5d180f2758dacc">NN_PERF_BEGIN_MEASURE</a>();</div>
<div class="line">            MakeComputeShaderCommand(pGfxCommandBuffer);</div>
<div class="line">            <a name="a109"></a><a class="code" href="perf___profile_8h.html#a0a94d0601ec383fed996a444d77c3e53">NN_PERF_END_MEASURE</a>();</div>
<div class="line"></div>
<div class="line">            <a name="a110"></a><a class="code" href="perf___profile_8h.html#a5289e91681166ba39ce97d6eb116c59d">NN_PERF_END_MEASURE_GPU</a>(pGfxCommandBuffer);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    pGfxFramework-&gt;<a name="a111"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#ae8a95943cd296bb2ad8ab6e6532b7b0e">EndFrame</a>(bufferIndex);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 残っているコマンドの完了を待つ</span></div>
<div class="line">    pGfxFramework-&gt;<a name="a112"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a8123c6c4c936915e693da89b566f7d34">QueueFinish</a>();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 頂点バッファーの書き換え</span></div>
<div class="line">    <a class="code" href="perf___profile_8h.html#ac0cbbec62451185954e3e6a11cac2fa8">NN_PERF_SET_COLOR</a>(<a class="code" href="classnn_1_1util_1_1_color4u8.html#a74cab22bd85f0940aec269c535ee5b54">nn::util::Color4u8::Red</a>());</div>
<div class="line">    <a class="code" href="perf___profile_8h.html#aac326a91e81805962b5d180f2758dacc">NN_PERF_BEGIN_MEASURE</a>();</div>
<div class="line">    UpdateVertexBuffer();</div>
<div class="line">    <a class="code" href="perf___profile_8h.html#a0a94d0601ec383fed996a444d77c3e53">NN_PERF_END_MEASURE</a>();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// スクリーン情報表示を初期化</span></div>
<div class="line"><span class="keywordtype">void</span> InitializeScreenInfo(<a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice)</div>
<div class="line">{</div>
<div class="line">    g_ScreenInfo.Initialize(pDevice);</div>
<div class="line">    g_ScreenInfo.SetWindowPosition(16, 16);</div>
<div class="line">    g_ScreenInfo.SetFontSize(20);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// リソースの初期化</span></div>
<div class="line"><span class="keywordtype">void</span> InitializeResource(<a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice)</div>
<div class="line">{</div>
<div class="line">    g_Holder.Initialize();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// シェーダーアーカイブの初期化</span></div>
<div class="line">    <a class="code" href="classnn_1_1g3d_1_1_res_shader_archive.html">nn::g3d::ResShaderArchive</a>* pDemoShaderArchive;</div>
<div class="line">    {</div>
<div class="line">        <a name="_a113"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_file.html">nn::g3d::ResShaderFile</a>* pFile = g3ddemo::LoadResource&lt;nn::g3d::ResShaderFile&gt;(g_DemoBfshaPath);</div>
<div class="line">        pFile-&gt;<a name="a114"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_file.html#a6ca625333d1fb3f4b903d0ee4533666c">Setup</a>(pDevice);</div>
<div class="line">        g_Holder.shaderFiles.PushBack(pFile);</div>
<div class="line">        pDemoShaderArchive = pFile-&gt;<a name="a115"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_file.html#ab2a9392d9a139efe97b011ac5aec96c4">GetResShaderArchive</a>();</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="classnn_1_1g3d_1_1_res_shader_archive.html">nn::g3d::ResShaderArchive</a>* pComputeShaderArchive;</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnn_1_1g3d_1_1_res_shader_file.html">nn::g3d::ResShaderFile</a>* pFile = g3ddemo::LoadResource&lt;nn::g3d::ResShaderFile&gt;(g_ComputeBfshaPath);</div>
<div class="line">        pFile-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_shader_file.html#a6ca625333d1fb3f4b903d0ee4533666c">Setup</a>(pDevice);</div>
<div class="line">        g_Holder.shaderFiles.PushBack(pFile);</div>
<div class="line">        pComputeShaderArchive = pFile-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_shader_file.html#ab2a9392d9a139efe97b011ac5aec96c4">GetResShaderArchive</a>();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// モデルリソースの初期化</span></div>
<div class="line">    <a name="_a116"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html">nn::g3d::ResFile</a>* pEnvModelFile;</div>
<div class="line">    {</div>
<div class="line">        pEnvModelFile = g3ddemo::LoadResource&lt;nn::g3d::ResFile&gt;(g_EnvBfresPath);</div>
<div class="line">        pEnvModelFile-&gt;<a name="a117"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html#afeaf3b666d229f4e30fe374ee5707909">Setup</a>(pDevice);</div>
<div class="line">        g_Holder.files.PushBack(pEnvModelFile);</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="classnn_1_1g3d_1_1_res_file.html">nn::g3d::ResFile</a>* pShapeModelFile;</div>
<div class="line">    {</div>
<div class="line">        pShapeModelFile = g3ddemo::LoadResource&lt;nn::g3d::ResFile&gt;(g_ModelBfresPath);</div>
<div class="line">        pShapeModelFile-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_file.html#afeaf3b666d229f4e30fe374ee5707909">Setup</a>(pDevice);</div>
<div class="line">        g3ddemo::SetupTexture(pDevice, pShapeModelFile, g3ddemo::TextureBindCallback);</div>
<div class="line">        g3ddemo::RegisterSamplerToDescriptorPool(pShapeModelFile);</div>
<div class="line">        g_Holder.files.PushBack(pShapeModelFile);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// モデルの頂点ステート、デプスステンシルステート、ブレンドステート、ラスタライザーステート、シェーディングモデルを管理するRenderModelを作成</span></div>
<div class="line">    <a name="_a118"></a><a class="code" href="classnns_1_1g3d_1_1_render_model.html">nns::g3d::RenderModel</a>* pDemoRenderModel;</div>
<div class="line">    {</div>
<div class="line">        <a name="_a119"></a><a class="code" href="classnn_1_1g3d_1_1_res_model.html">nn::g3d::ResModel</a>* pResModel = pShapeModelFile-&gt;<a name="a120"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html#aea207d962515bd832f33b3efd734ccbc">FindModel</a>(<span class="stringliteral">&quot;Cat&quot;</span>);</div>
<div class="line">        pDemoRenderModel = <a name="a121"></a><a class="code" href="namespacenns_1_1g3d.html#aa1c714afc7a0cf4a993dcbc6774f1643">nns::g3d::CreateRenderModel</a>(pDevice, pResModel);</div>
<div class="line">        pDemoRenderModel-&gt;<a name="a122"></a><a class="code" href="classnns_1_1g3d_1_1_render_model.html#aa157d2168a767b3333c62aa5cc120973">CreateDrawPass</a>(pDevice, pDemoShaderArchive);</div>
<div class="line">        g_Holder.renderModels.PushBack(pDemoRenderModel);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// モデルおよびアニメーションの計算処理を簡略化するModelAnimObjを作成</span></div>
<div class="line">    <a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html">nns::g3d::ModelAnimObj</a>* pShapeModelAnimObj;</div>
<div class="line">    {</div>
<div class="line">        <a name="_a123"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj_1_1_builder.html">nn::g3d::ModelObj::Builder</a> builder(pShapeModelFile-&gt;<a name="a124"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html#ab776cb75749d955956b5b2d4522da962">GetModel</a>(0));</div>
<div class="line">        <span class="comment">// CPUとGPUで並列実行出来るようにバッファー数に2を指定</span></div>
<div class="line">        builder.<a name="a125"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj_1_1_initialize_argument.html#acd583ad430a0d87edc34259daedb7cff">ShapeBufferingCount</a>(g_BufferingCount);</div>
<div class="line">        builder.SkeletonBufferingCount(g_BufferingCount);</div>
<div class="line">        builder.MaterialBufferingCount(g_BufferingCount);</div>
<div class="line">        pShapeModelAnimObj = <a name="a126"></a><a class="code" href="namespacenns_1_1g3d.html#a72152fa94a41e3511738bf0a9bc7c255">nns::g3d::CreateModelAnimObj</a>(pDevice, builder);</div>
<div class="line">        g_Holder.modelAnimObjs.PushBack(pShapeModelAnimObj);</div>
<div class="line">        <span class="comment">// アニメーション追加</span></div>
<div class="line">        g_ShapeAnimId = pShapeModelAnimObj-&gt;<a name="a127"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a3b6789d198e48ec3a253974aa35879a2">CreateAnim</a>(pShapeModelFile-&gt;<a name="a128"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html#a9aa26a8344b39de22d2493584f55e000">FindShapeAnim</a>(<span class="stringliteral">&quot;Cat&quot;</span>));</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// RenderModelとModelObjを組み合わせ、描画を行うRenderModelObjを作成</span></div>
<div class="line">    <a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pShapeRenderModelObj;</div>
<div class="line">    {</div>
<div class="line">        pShapeRenderModelObj = <a name="a129"></a><a class="code" href="namespacenns_1_1g3d.html#a4d8d828fb260a742ceca742312144c68">nns::g3d::CreateRenderModelObj</a>(pShapeModelAnimObj-&gt;<a name="a130"></a><a class="code" href="classnns_1_1g3d_1_1_model_anim_obj.html#a75f2e005c7b06d62f33d69508db503e9">GetModelObj</a>(), pDemoRenderModel);</div>
<div class="line">        g_Holder.renderModelObjs.PushBack(pShapeRenderModelObj);</div>
<div class="line">        <span class="comment">// このデモではシェーダーを動的に切り替えないため、ここでシェーダーを選択</span></div>
<div class="line">        g3ddemo::WriteSkinningOption(pShapeRenderModelObj);</div>
<div class="line">        pShapeRenderModelObj-&gt;<a name="a131"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a2abf914afb4d7489f87c6ea7a3fe5ac1">UpdateShader</a>(pDevice);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 描画時に必要となるg3dの管理外のユニフォームブロックを作成し、RenderModelObjに設定</span></div>
<div class="line">    <span class="comment">// ユニフォームブロックの管理を簡単にするため、別モデルのマテリアルユニフォームブロックとして扱っています</span></div>
<div class="line">    <a class="code" href="classnn_1_1g3d_1_1_model_obj.html">nn::g3d::ModelObj</a>* pEnvModelObj;</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnn_1_1g3d_1_1_res_model.html">nn::g3d::ResModel</a>* pResModel = pEnvModelFile-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_file.html#ab776cb75749d955956b5b2d4522da962">GetModel</a>(0);</div>
<div class="line">        <a name="a132"></a><a class="code" href="classnn_1_1g3d_1_1_shader_utility.html#a26b394ba1043958e5f64a6d6f25efe9b">nn::g3d::ShaderUtility::BindShaderParam</a>(pResModel-&gt;<a name="a133"></a><a class="code" href="classnn_1_1g3d_1_1_res_model.html#af57b0b32fc406e4c07a02133b0df1009">GetMaterial</a>(0), pDemoShaderArchive-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_shader_archive.html#a17c81d3fe346cbcc531ad38138b7117b">FindShadingModel</a>(<span class="stringliteral">&quot;env&quot;</span>));</div>
<div class="line">        <a class="code" href="classnn_1_1g3d_1_1_model_obj_1_1_builder.html">nn::g3d::ModelObj::Builder</a> builder(pResModel);</div>
<div class="line">        builder.MaterialBufferingCount(g_BufferingCount);</div>
<div class="line">        pEnvModelObj = <a name="a134"></a><a class="code" href="namespacenns_1_1g3d.html#ae7cfdc41c478154e34bc8350851099ac">nns::g3d::CreateModelObj</a>(pDevice, builder);</div>
<div class="line">        <span class="comment">// このデモでは毎フレーム更新が必要でないため、ここで1度だけ計算を行う</span></div>
<div class="line">        pEnvModelObj-&gt;<a name="a135"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a674b6b3417778ae519cf3bc6d6f5ff65">CalculateMaterial</a>(0);</div>
<div class="line">        pEnvModelObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a674b6b3417778ae519cf3bc6d6f5ff65">CalculateMaterial</a>(1);</div>
<div class="line">        g_Holder.modelObjs.PushBack(pEnvModelObj);</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classnn_1_1gfx_1_1_t_buffer.html">nn::gfx::Buffer</a>* buffers[g_BufferingCount];</div>
<div class="line">        buffers[0] = pEnvModelObj-&gt;<a name="a136"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a225cda4a0e7881df5dc4ebb15ac6c6f6">GetMaterial</a>(0)-&gt;<a name="a137"></a><a class="code" href="classnn_1_1g3d_1_1_material_obj.html#aef15d5bfda74edf022aa6337f13d52ed">GetMaterialBlock</a>(0);</div>
<div class="line">        buffers[1] = pEnvModelObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a225cda4a0e7881df5dc4ebb15ac6c6f6">GetMaterial</a>(0)-&gt;<a class="code" href="classnn_1_1g3d_1_1_material_obj.html#aef15d5bfda74edf022aa6337f13d52ed">GetMaterialBlock</a>(1);</div>
<div class="line">        pShapeRenderModelObj-&gt;<a name="a138"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a51705d6e0cbec14deae05e0dc0724835">BindUniformBlock</a>(<span class="stringliteral">&quot;env&quot;</span>, buffers, g_BufferingCount);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ビュー用のユニフォームブロックを設定</span></div>
<div class="line">    g_RenderView.<a name="a139"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#a6520169e698d615f7cc77553e32ca88c">Initialize</a>(pDevice, 1, g_BufferingCount);</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classnn_1_1gfx_1_1_t_buffer.html">nn::gfx::Buffer</a>* buffers[g_BufferingCount];</div>
<div class="line">        buffers[0] = g_RenderView.<a name="a140"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#ac12827c0d0788017a196ef5b80304304">GetViewUniformBlock</a>(0, 0);</div>
<div class="line">        buffers[1] = g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#ac12827c0d0788017a196ef5b80304304">GetViewUniformBlock</a>(0, 1);</div>
<div class="line">        pShapeRenderModelObj-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a51705d6e0cbec14deae05e0dc0724835">BindUniformBlock</a>(<span class="stringliteral">&quot;view&quot;</span>, buffers, g_BufferingCount);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// シェーダーに必要なスクラッチメモリーを設定</span></div>
<div class="line">    g3ddemo::SetShaderScratchMemory(g_Holder.shaderFiles);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">} <span class="comment">// anonymous namespace</span></div>
<div class="line"></div>
<div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="keywordtype">int</span> ShapeAnimationMain()</div>
<div class="line">{</div>
<div class="line">    nns::gfx::DebugGraphicsFramework* pGfxFramework = g3ddemo::GetGfxFramework();</div>
<div class="line">    pGfxFramework-&gt;SetFrameworkMode(<a name="a141"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a4987555fae0e257658ffef4beb51a674a6d2e6861717e82c71ea532bf89e5b1f0">nns::gfx::GraphicsFramework::FrameworkMode_DeferredSubmission</a>);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice = pGfxFramework-&gt;GetDevice();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// スクリーン情報表示を初期化</span></div>
<div class="line">    InitializeScreenInfo(pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 負荷計測機能の初期化</span></div>
<div class="line">    pGfxFramework-&gt;InitializePerf();</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if defined( NN_BUILD_CONFIG_OS_WIN )</span></div>
<div class="line">    <a name="a142"></a><a class="code" href="perf___profile_8h.html#a3506f976dd0501c40d1605db7811ceed">NN_PERF_SET_GET_CORE_NUMBER_FUNCTION</a>(g3ddemo::GetFixedCoreNumber);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// 現在のスレッド(メインスレッド)を 0 番コアに割り当て</span></div>
<div class="line">    <a name="a143"></a><a class="code" href="namespacenn_1_1os.html#ac50b86561c15ee3e8195c83fddc8e732">nn::os::SetThreadCoreMask</a>(<a name="a144"></a><a class="code" href="namespacenn_1_1os.html#ad106866a5b13bc3d430104333966b479">nn::os::GetCurrentThread</a>(), 0, 1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// リソースの初期化</span></div>
<div class="line">    InitializeResource(pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// コンピュートシェーダーの初期化</span></div>
<div class="line">    InitializeComputeShader(pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// コンピュートシェーダーで使用する GPU バッファーの初期化</span></div>
<div class="line">    InitializeGpuBuffer(pDevice, g_Holder.renderModelObjs[0]-&gt;GetModelObj());</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 座標の計算モード</span></div>
<div class="line">    g_CalcMode = CalcMode_GPU;</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span> uniformBufferIndex = 0;</div>
<div class="line">    pGfxFramework-&gt;SetCalculateCallback(Calculate, &amp;uniformBufferIndex);</div>
<div class="line">    pGfxFramework-&gt;SetMakeCommandCallback(MakeCommand, &amp;uniformBufferIndex);</div>
<div class="line">    pGfxFramework-&gt;ResetFrame();</div>
<div class="line"></div>
<div class="line">    <a name="a145"></a><a class="code" href="structnn_1_1util_1_1_vector2f_type.html#ab3d3802057388c9eae9635b786b71de8">VectorSet</a>(&amp;g_CameraPosition, 0.0f, 0.0f, 80.f);</div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_vector2f_type.html#ab3d3802057388c9eae9635b786b71de8">VectorSet</a>(&amp;g_CameraUp, 0.0f, 1.0f, 0.0f);</div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_vector2f_type.html#ab3d3802057388c9eae9635b786b71de8">VectorSet</a>(&amp;g_CameraTarget, 0.0f, 0.0f, 0.0f);</div>
<div class="line"></div>
<div class="line">    g3ddemo::Pad&amp; pad = g3ddemo::GetPad();</div>
<div class="line">    pad.Reset();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// メインループ</span></div>
<div class="line">    <span class="keywordflow">while</span> (<a name="a146"></a><a class="code" href="nn___macro_8h.html#a71c0f58f6d49fe1392380eed4509ab9a">NN_STATIC_CONDITION</a>(1))</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// タッチ長押しで終了</span></div>
<div class="line">        <span class="keywordflow">if</span> (g3ddemo::isExitDemo())</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!pad.Read() || pad.IsTriggered(g3ddemo::Pad::BUTTON_START))</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        CalcMenu(pad);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// フレーム処理実行</span></div>
<div class="line">        pGfxFramework-&gt;ProcessFrame();</div>
<div class="line"></div>
<div class="line">        uniformBufferIndex ^= 1;</div>
<div class="line">    }</div>
<div class="line">    pGfxFramework-&gt;QueueFinish();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 終了処理</span></div>
<div class="line">    g3ddemo::DestroyAll(pDevice, &amp;g_Holder);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ビュー用ユニフォームブロックの破棄</span></div>
<div class="line">    g_RenderView.<a name="a147"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#ae2461a77f4a4a5f2c954516604f35a9e">Finalize</a>(pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 負荷計測メーターの破棄</span></div>
<div class="line">    pGfxFramework-&gt;FinalizePerf();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// スクリーン情報表示の破棄</span></div>
<div class="line">    g_ScreenInfo.Cleanup(pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// コンピュートシェーダーで使用する GPU バッファーの破棄</span></div>
<div class="line">    FinalizeGpuBuffer(pDevice);</div>
<div class="line"></div>
<div class="line">    pGfxFramework-&gt;SetCalculateCallback(<span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>);</div>
<div class="line">    pGfxFramework-&gt;SetMakeCommandCallback(<span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> EXIT_SUCCESS;</div>
<div class="line">} <span class="comment">// NOLINT</span></div>
</div><!-- fragment --> </div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
</body>
</html>
