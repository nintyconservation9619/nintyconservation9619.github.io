<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>NintendoSDK API Reference: LibcurlSpeedTest.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="openclose.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">NintendoSDK API Reference
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 構築: Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'検索');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>総合概要</span></a></li>
      <li><a href="pages.html"><span>諸情報</span></a></li>
      <li><a href="modules.html"><span>モジュール</span></a></li>
      <li><a href="namespaces.html"><span>名前空間</span></a></li>
      <li><a href="annotated.html"><span>クラス</span></a></li>
      <li><a href="files.html"><span>ファイル</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="検索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">LibcurlSpeedTest.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>ソースコードの説明は、<a class="el" href="_page_sample_libcurl_speed_test.html">libcurl による HTTP(S) 通信</a> および <a class="el" href="_libcurl_speed_test_8cpp.html" title="libcurl による HTTP(S) 通信 ">LibcurlSpeedTest.cpp</a> を参照してください。</p>
<div class="fragment"><div class="line"><span class="comment">/*--------------------------------------------------------------------------------*</span></div>
<div class="line"><span class="comment">  Copyright (C)Nintendo All rights reserved.</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  These coded instructions, statements, and computer programs contain proprietary</span></div>
<div class="line"><span class="comment">  information of Nintendo and/or its licensed developers and are protected by</span></div>
<div class="line"><span class="comment">  national and international copyright laws. They may not be disclosed to third</span></div>
<div class="line"><span class="comment">  parties or copied or duplicated in any form, in whole or in part, without the</span></div>
<div class="line"><span class="comment">  prior written consent of Nintendo.</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  The content herein is highly confidential and should be handled accordingly.</span></div>
<div class="line"><span class="comment"> *--------------------------------------------------------------------------------*/</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;cstdlib&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;nn/os.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="init_8h.html">nn/init.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="nn___log_8h.html">nn/nn_Log.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;nn/nifm.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="socket_8h.html">nn/socket.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;curl/curl.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;../Common/HttpsHelper.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">namespace</span></div>
<div class="line">{</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">float</span> kGigabyte       = 1024.0f * 1024.0f * 1024.0f;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">float</span> kMegabyte       = 1024.0f * 1024.0f;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">float</span> kKilobyte       = 1024.0f;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span>   kMaxUrlLength   = 512;</div>
<div class="line"></div>
<div class="line"><span class="comment">// **** Uncomment if you need to set proxy settings different than what is set</span></div>
<div class="line"><span class="comment">//      in system settings. ****</span></div>
<div class="line"><span class="comment">//#define USE_PROXY</span></div>
<div class="line"><span class="preprocessor">#ifdef USE_PROXY</span></div>
<div class="line"><span class="preprocessor">#define PROXY_SETTINGS(curl)                    \</span></div>
<div class="line"><span class="preprocessor">        curl_easy_setopt(curl,                  \</span></div>
<div class="line"><span class="preprocessor">                       CURLOPT_PROXYAUTOCONFIG, \</span></div>
<div class="line"><span class="preprocessor">                       0L);                     \</span></div>
<div class="line"><span class="preprocessor">        curl_easy_setopt(curl,                  \</span></div>
<div class="line"><span class="preprocessor">                       CURLOPT_PROXY,           \</span></div>
<div class="line"><span class="preprocessor">                       &quot;ProxyServer&quot;);          \</span></div>
<div class="line"><span class="preprocessor">        curl_easy_setopt(curl,                  \</span></div>
<div class="line"><span class="preprocessor">                       CURLOPT_PROXYPORT,       \</span></div>
<div class="line"><span class="preprocessor">                       8080);                   \</span></div>
<div class="line"><span class="preprocessor">        curl_easy_setopt(curl,                  \</span></div>
<div class="line"><span class="preprocessor">                       CURLOPT_PROXYUSERPWD,    \</span></div>
<div class="line"><span class="preprocessor">                       &quot;UserName:Password&quot;);    \</span></div>
<div class="line"><span class="preprocessor">        curl_easy_setopt(curl,                  \</span></div>
<div class="line"><span class="preprocessor">                       CURLOPT_PROXYAUTH,       \</span></div>
<div class="line"><span class="preprocessor">                       CURLAUTH_BASIC);</span></div>
<div class="line"><span class="preprocessor">#endif // USE_PROXY</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>WriteData {</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>  *pReadPos;</div>
<div class="line">    <span class="keywordtype">size_t</span>      sizeLeft;</div>
<div class="line">} WriteData;</div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>EasyData</div>
<div class="line">{</div>
<div class="line">    CURL* easyHandle;</div>
<div class="line">    <span class="keywordtype">char</span> pErrorBuffer[CURL_ERROR_SIZE];</div>
<div class="line">} EasyData;</div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>Options</div>
<div class="line">{</div>
<div class="line">    uint32_t    numConnections;</div>
<div class="line">    uint32_t    timesToDownload;</div>
<div class="line">    <span class="keywordtype">int</span>         sndBufSize;</div>
<div class="line">    <span class="keywordtype">int</span>         rcvBufSize;</div>
<div class="line">    <span class="keywordtype">int</span>         disableTcpNagle;</div>
<div class="line">    <span class="keywordtype">int</span>         uploadSize;</div>
<div class="line">    <span class="keywordtype">char</span>        url[kMaxUrlLength + 1];</div>
<div class="line">} Options;</div>
<div class="line"></div>
<div class="line"><span class="comment">// Socket memory</span></div>
<div class="line"><a name="a0"></a><a class="code" href="nn___macro_8h.html#a6ce9d4b07ab8bec971ac8875873615b5">NN_ALIGNAS</a>(4096) uint8_t    g_SocketMemoryPoolBuffer[<a name="a1"></a><a class="code" href="namespacenn_1_1socket.html#a150d80cacbb08735b665a1e061367ee1">nn::socket::DefaultSocketMemoryPoolSize</a>] = { 0 };</div>
<div class="line">HttpsHelperForCtxImport     g_HttpsHelper   = HttpsHelperForCtxImport();</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">size_t</span> CurlSetSockOpts(<span class="keywordtype">void</span> *pData, curl_socket_t curlfd, curlsocktype purpose)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span>         rval        = 0;</div>
<div class="line">    Options *   pOptions    = <span class="keyword">static_cast&lt;</span>Options *<span class="keyword">&gt;</span>(pData);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( <span class="keyword">nullptr</span> != pOptions )</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>( -1 != pOptions-&gt;sndBufSize )</div>
<div class="line">        {</div>
<div class="line">            rval = <a name="a2"></a><a class="code" href="namespacenn_1_1socket.html#afaa7ccade3133a9884ab0b8e44ac18fc">nn::socket::SetSockOpt</a>(curlfd, <a name="a3"></a><a class="code" href="namespacenn_1_1socket.html#a8f9b7859b60d1ee546e472a7e2a9beaaa4418133767fb2aecc740f56abdda0a07">nn::socket::Level::Sol_Socket</a>, <a name="a4"></a><a class="code" href="namespacenn_1_1socket.html#a9706518d71ec37371e9aa3ae9a2fa92ca4078c1b605c4c29f21a0bf25944c0cd4">nn::socket::Option::So_SndBuf</a>, &amp;pOptions-&gt;sndBufSize, <span class="keyword">sizeof</span>(pOptions-&gt;sndBufSize));</div>
<div class="line">            <span class="keywordflow">if</span>( rval != 0 )</div>
<div class="line">            {</div>
<div class="line">                <a name="a5"></a><a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot; * nn::socket::SetSockOpt on SO_SNDBUF failed with error: %d\n\n&quot;</span>, <a name="a6"></a><a class="code" href="namespacenn_1_1socket.html#a6db6951cb084f74f4c17d655ce798890">nn::socket::GetLastError</a>());</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">return</span> CURL_SOCKOPT_ERROR;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot; * nn::socket::SetSockOpt SO_SNDBUF set to: %d\n&quot;</span>, pOptions-&gt;sndBufSize);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>( -1 != pOptions-&gt;rcvBufSize )</div>
<div class="line">        {</div>
<div class="line">            rval = <a class="code" href="namespacenn_1_1socket.html#afaa7ccade3133a9884ab0b8e44ac18fc">nn::socket::SetSockOpt</a>(curlfd, <a class="code" href="namespacenn_1_1socket.html#a8f9b7859b60d1ee546e472a7e2a9beaaa4418133767fb2aecc740f56abdda0a07">nn::socket::Level::Sol_Socket</a>, <a name="a7"></a><a class="code" href="namespacenn_1_1socket.html#a9706518d71ec37371e9aa3ae9a2fa92ca1600030ecdfa4988343a0182c2716781">nn::socket::Option::So_RcvBuf</a>, &amp;pOptions-&gt;rcvBufSize, <span class="keyword">sizeof</span>(pOptions-&gt;rcvBufSize));</div>
<div class="line">            <span class="keywordflow">if</span>( rval != 0 )</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot; * nn::socket::SetSockOpt on SO_RCVBUF failed with error: %d\n\n&quot;</span>, <a class="code" href="namespacenn_1_1socket.html#a6db6951cb084f74f4c17d655ce798890">nn::socket::GetLastError</a>());</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">return</span> CURL_SOCKOPT_ERROR;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot; * nn::socket::SetSockOpt SO_RCVBUF set to: %d\n&quot;</span>, pOptions-&gt;rcvBufSize);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        rval = <a class="code" href="namespacenn_1_1socket.html#afaa7ccade3133a9884ab0b8e44ac18fc">nn::socket::SetSockOpt</a>(curlfd, <a name="a8"></a><a class="code" href="namespacenn_1_1socket.html#a8f9b7859b60d1ee546e472a7e2a9beaaa07877ef6eba5cd50e7fd156ab490e25e">nn::socket::Level::Sol_Tcp</a>, <a name="a9"></a><a class="code" href="namespacenn_1_1socket.html#a9706518d71ec37371e9aa3ae9a2fa92ca2d22a30cb3647dfc45e9cf81c9d7c92e">nn::socket::Option::Tcp_NoDelay</a>, &amp;pOptions-&gt;disableTcpNagle, <span class="keyword">sizeof</span>(pOptions-&gt;disableTcpNagle));</div>
<div class="line">        <span class="keywordflow">if</span>( rval != 0 )</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot; * nn::socket::SetSockOpt on nn::socket::Option::Tcp_NoDelay failed with error: %d\n\n&quot;</span>, <a class="code" href="namespacenn_1_1socket.html#a6db6951cb084f74f4c17d655ce798890">nn::socket::GetLastError</a>());</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">return</span> CURL_SOCKOPT_ERROR;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> CURL_SOCKOPT_OK;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">size_t</span> CurlWriteFunction(<span class="keywordtype">char</span> *data, <span class="keywordtype">size_t</span> blobsize, <span class="keywordtype">size_t</span> blobcount, <span class="keywordtype">void</span> *userdata)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">size_t</span> count = blobsize*blobcount;</div>
<div class="line">    <span class="keywordflow">return</span> count;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> <a name="a10"></a><a class="code" href="namespacenn_1_1fs.html#aba29e01d386e809349d60eccdb15ff21">GetFileSize</a>(<span class="keyword">const</span> Options &amp;options, uint32_t* pSize)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">bool</span>    bRet    = <span class="keyword">false</span>;</div>
<div class="line">    CURL*   curl    = curl_easy_init();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( <span class="keyword">nullptr</span> != curl )</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">char</span> pErrorBuffer[CURL_ERROR_SIZE] = { 0 };</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef USE_PROXY</span></div>
<div class="line">        PROXY_SETTINGS(curl)</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"></div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;url: %s\n&quot;</span>, options.url);</div>
<div class="line">        curl_easy_setopt(curl, CURLOPT_URL, options.url);</div>
<div class="line">        curl_easy_setopt(curl, CURLOPT_FOLLOWLOCATION, 1);</div>
<div class="line">        curl_easy_setopt(curl, CURLOPT_VERBOSE, 1);</div>
<div class="line">        curl_easy_setopt(curl, CURLOPT_ERRORBUFFER, pErrorBuffer);</div>
<div class="line">        curl_easy_setopt(curl, CURLOPT_SOCKOPTFUNCTION, CurlSetSockOpts);</div>
<div class="line">        curl_easy_setopt(curl, CURLOPT_SOCKOPTDATA, &amp;options);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>( HttpsHelperBase::IsUrlHttps(options.url) == <span class="keyword">true</span> )</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">/* Import the SSL context into libcurl. Because there&#39;s only one SSL context</span></div>
<div class="line"><span class="comment">            maintained in httpsHelper, same SSL context will be shared between CURL</span></div>
<div class="line"><span class="comment">            handles.</span></div>
<div class="line"><span class="comment">            */</span></div>
<div class="line">            <span class="keywordflow">if</span> ( g_HttpsHelper.ImportSslContext(curl) &lt; 0 )</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;[ERROR] Failed to import the SSL context.\n&quot;</span>);</div>
<div class="line">                <span class="keywordflow">goto</span> cleanup;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// This is the KEY option that tells the server not to send to body(the actual content).</span></div>
<div class="line">        curl_easy_setopt(curl, CURLOPT_NOBODY, 1);</div>
<div class="line"></div>
<div class="line">        CURLcode rval = curl_easy_perform(curl);</div>
<div class="line">        <span class="keywordflow">if</span>( rval == CURLE_OK )</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">double</span> dSize = 0.0;</div>
<div class="line">            <span class="keywordflow">if</span>( curl_easy_getinfo(curl, CURLINFO_CONTENT_LENGTH_DOWNLOAD, &amp;dSize) == CURLE_OK)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span>( dSize &lt; 0 )</div>
<div class="line">                {</div>
<div class="line">                    <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot; * Unknown content length!\n&quot;</span>);</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                    *pSize = <span class="keyword">static_cast&lt;</span>uint32_t<span class="keyword">&gt;</span>(dSize);</div>
<div class="line">                    <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;\n*******Got File size! %u\n\n&quot;</span>, *pSize);</div>
<div class="line">                    bRet = <span class="keyword">true</span>;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;Failed to get content length\n&quot;</span>);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;ERROR: Error fetching URL: %s. Error: %d\n&quot;</span>, options.url, rval);</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;Details: %s\n&quot;</span>, pErrorBuffer);</div>
<div class="line">            <span class="keywordflow">if</span>( HttpsHelperBase::IsUrlHttps(options.url) == <span class="keyword">true</span> )</div>
<div class="line">            {</div>
<div class="line">                g_HttpsHelper.PrintErrorMessage(curl, rval);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot; * Failed to create curl handle!\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">cleanup:</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( <span class="keyword">true</span> == bRet )</div>
<div class="line">    {</div>
<div class="line">        curl_easy_cleanup(curl);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> bRet;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifndef USE_PROXY</span></div>
<div class="line"><span class="keywordtype">bool</span> EstimateServerRTT(int64_t* pServerRTT, <span class="keyword">const</span> <span class="keywordtype">char</span>* pUrl)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>              strHttp[]               = <span class="stringliteral">&quot;http://&quot;</span>;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>              strHttps[]              = <span class="stringliteral">&quot;https://&quot;</span>;</div>
<div class="line">    <a name="_a11"></a><a class="code" href="structnn_1_1socket_1_1_host_ent.html">nn::socket::HostEnt</a>*    pHost                   = <span class="keyword">nullptr</span>;</div>
<div class="line">    <a name="_a12"></a><a class="code" href="structnn_1_1socket_1_1_sock_addr_in.html">nn::socket::SockAddrIn</a>  addr                    = <a class="code" href="structnn_1_1socket_1_1_sock_addr_in.html">nn::socket::SockAddrIn</a>();</div>
<div class="line">    <span class="keywordtype">char</span>                    strHostName[255 + 1]    = { <span class="charliteral">&#39;\0&#39;</span> };</div>
<div class="line">    <a name="_a13"></a><a class="code" href="classnn_1_1os_1_1_tick.html">nn::os::Tick</a>            tickPrev                = <a class="code" href="classnn_1_1os_1_1_tick.html">nn::os::Tick</a>();</div>
<div class="line">    <a class="code" href="classnn_1_1os_1_1_tick.html">nn::os::Tick</a>            tickNow                 = <a class="code" href="classnn_1_1os_1_1_tick.html">nn::os::Tick</a>();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( strncmp(pUrl, strHttp, strlen(strHttp)) == 0 )</div>
<div class="line">    {</div>
<div class="line">        strncpy(strHostName, &amp;pUrl[strlen(strHttp)], <span class="keyword">sizeof</span>(strHostName) / <span class="keyword">sizeof</span>(strHostName[0]) - 1);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( strncmp(pUrl, strHttps, strlen(strHttps)) == 0 )</div>
<div class="line">    {</div>
<div class="line">        strncpy(strHostName, &amp;pUrl[strlen(strHttps)], <span class="keyword">sizeof</span>(strHostName) / <span class="keyword">sizeof</span>(strHostName[0]) - 1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">char</span>* pIter = strHostName;</div>
<div class="line">    <span class="keywordflow">while</span>( *pIter != <span class="charliteral">&#39;\0&#39;</span> )</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>( *pIter == <span class="charliteral">&#39;/&#39;</span> )</div>
<div class="line">        {</div>
<div class="line">            *pIter = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        ++pIter;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot; HostName: %s\n&quot;</span>, strHostName);</div>
<div class="line">    pHost = <a name="a14"></a><a class="code" href="namespacenn_1_1socket.html#a358030926e9e63c2e322de2bd3d26719">nn::socket::GetHostEntByName</a>(strHostName);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( <span class="keyword">nullptr</span> == pHost || <span class="keyword">nullptr</span> == pHost-&gt;<a name="a15"></a><a class="code" href="structnn_1_1socket_1_1_host_ent.html#a1d26bb1a8b570fc8e1aa0a498ed5934d">h_addr_list</a>[0] )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;No host found!\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;IP: %s\n&quot;</span>, <a name="a16"></a><a class="code" href="namespacenn_1_1socket.html#af90b8239ae0f5fbd70f12f9980fdac76">nn::socket::InetNtoa</a>(*reinterpret_cast&lt;nn::socket::InAddr*&gt;(pHost-&gt;<a class="code" href="structnn_1_1socket_1_1_host_ent.html#a1d26bb1a8b570fc8e1aa0a498ed5934d">h_addr_list</a>[0])));</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span> nSocket = <a name="a17"></a><a class="code" href="namespacenn_1_1socket.html#a9afeb564bac1d0c04af2fec1f00c739f">nn::socket::Socket</a>(<a name="a18"></a><a class="code" href="namespacenn_1_1socket.html#a057d985148e23267303e6d00d7ed205daa4d833d8c15a76105639ddd11bcb614e">nn::socket::Family::Af_Inet</a>, <a name="a19"></a><a class="code" href="namespacenn_1_1socket.html#a1db675083dcccec6500d1435c5dfeaeaae703319723c99d2d3a7ba1ad0dc8f572">nn::socket::Type::Sock_Stream</a>, <a name="a20"></a><a class="code" href="namespacenn_1_1socket.html#a46347de69614965469ac8f3c8056468eaf07a075529789e7d91eefbce84c55d90">nn::socket::Protocol::IpProto_Tcp</a>);</div>
<div class="line">    <span class="keywordflow">if</span>( nSocket == nn::socket::SocketError )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;Failed to create socket. Err: %d\n&quot;</span>, <a class="code" href="namespacenn_1_1socket.html#a6db6951cb084f74f4c17d655ce798890">nn::socket::GetLastError</a>());</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    addr.<a name="a21"></a><a class="code" href="structnn_1_1socket_1_1_sock_addr_in.html#ac8e09f776d8331345ee1870f3aed4535">sin_family</a> = <a class="code" href="namespacenn_1_1socket.html#a057d985148e23267303e6d00d7ed205daa4d833d8c15a76105639ddd11bcb614e">nn::socket::Family::Af_Inet</a>;</div>
<div class="line">    addr.<a name="a22"></a><a class="code" href="structnn_1_1socket_1_1_sock_addr_in.html#a7fe5afa2fe039b8bbf5a23fae30fe755">sin_addr</a> = *(<span class="keyword">reinterpret_cast&lt;</span>struct <a name="_a23"></a><a class="code" href="structnn_1_1socket_1_1_in_addr.html">nn::socket::InAddr</a>*<span class="keyword">&gt;</span>(pHost-&gt;<a class="code" href="structnn_1_1socket_1_1_host_ent.html#a1d26bb1a8b570fc8e1aa0a498ed5934d">h_addr_list</a>[0]));</div>
<div class="line">    addr.<a name="a24"></a><a class="code" href="structnn_1_1socket_1_1_sock_addr_in.html#ae37d378c458d394a0646d7bfcf72bc4d">sin_port</a> = <a name="a25"></a><a class="code" href="namespacenn_1_1socket.html#a1b6e15ce629648357cf10cc8ada6b8d1">nn::socket::InetHtons</a>(80);</div>
<div class="line"></div>
<div class="line">    tickPrev = <a name="a26"></a><a class="code" href="namespacenn_1_1os.html#a79e29821bfb2b0c3a5c222488e90cc89">nn::os::GetSystemTick</a>();</div>
<div class="line">    <span class="keywordflow">if</span>( <a name="a27"></a><a class="code" href="namespacenn_1_1socket.html#a3aded7f0c8c072c7beb68a670d03d36f">nn::socket::Connect</a>(nSocket, reinterpret_cast&lt;nn::socket::SockAddr*&gt;(&amp;addr), <span class="keyword">sizeof</span>(addr)) == nn::socket::SocketError )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;Could not connect! Error: %d\n&quot;</span>, <a class="code" href="namespacenn_1_1socket.html#a6db6951cb084f74f4c17d655ce798890">nn::socket::GetLastError</a>());</div>
<div class="line">        <a name="a28"></a><a class="code" href="namespacenn_1_1socket.html#ae01110d228e2148d830b1ecfb9aaa425">nn::socket::Close</a>(nSocket);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">    tickNow = <a class="code" href="namespacenn_1_1os.html#a79e29821bfb2b0c3a5c222488e90cc89">nn::os::GetSystemTick</a>();</div>
<div class="line"></div>
<div class="line">    <a class="code" href="namespacenn_1_1socket.html#ae01110d228e2148d830b1ecfb9aaa425">nn::socket::Close</a>(nSocket);</div>
<div class="line"></div>
<div class="line">    *pServerRTT = <a name="a29"></a><a class="code" href="namespacenn_1_1os.html#a53032bee4cfe0f01916e8149c393adad">nn::os::ConvertToTimeSpan</a>( tickNow - tickPrev ).<a name="a30"></a><a class="code" href="classnn_1_1_time_span.html#a5c2c7f5af7b80454e0a2f8bc11eae473">GetMilliSeconds</a>();</div>
<div class="line">    <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;RTT: %lld ms\n&quot;</span>, *pServerRTT);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">float</span> DownloadFile(uint32_t index, <span class="keyword">const</span> Options &amp;options, uint32_t fileSize)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">float</span>           fThroughput     = 0.0f;</div>
<div class="line">    <a class="code" href="classnn_1_1os_1_1_tick.html">nn::os::Tick</a>    tickPrev        = <a class="code" href="classnn_1_1os_1_1_tick.html">nn::os::Tick</a>(),</div>
<div class="line">                    tickNow         = <a class="code" href="classnn_1_1os_1_1_tick.html">nn::os::Tick</a>();</div>
<div class="line">    uint32_t        downloadSize    = 0;</div>
<div class="line">    uint32_t        chunk           = 0;</div>
<div class="line">    uint32_t        remainder       = 0;</div>
<div class="line">    uint32_t        previous        = 0;</div>
<div class="line">    <span class="keywordtype">float</span>           fSeconds        = 0.0f;</div>
<div class="line"></div>
<div class="line">    uint32_t        curlEasyHandleCount = 0;</div>
<div class="line">    CURLM*          curlMultiHandle = NULL;</div>
<div class="line"></div>
<div class="line">    CURLMcode       status          = CURLM_OK;</div>
<div class="line">    <span class="keywordtype">int</span>             stillRunning    = 0;</div>
<div class="line"></div>
<div class="line">    chunk = fileSize / options.numConnections;</div>
<div class="line">    remainder = fileSize % options.numConnections;</div>
<div class="line"></div>
<div class="line">    EasyData *curlEasyHandles = <span class="keyword">static_cast&lt;</span>EasyData *<span class="keyword">&gt;</span>(std::calloc(options.numConnections, <span class="keyword">sizeof</span>(EasyData)));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( <span class="keyword">nullptr</span> == curlEasyHandles )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;[ERROR] Failed to allocate %d curl easy handles.\n&quot;</span>, options.numConnections);</div>
<div class="line">        <span class="keywordflow">return</span> 0.0f;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (curlEasyHandleCount = 0;</div>
<div class="line">        curlEasyHandleCount &lt; options.numConnections;</div>
<div class="line">        curlEasyHandleCount++)</div>
<div class="line">    {</div>
<div class="line">        CURL *curlEasyHandle = curl_easy_init();</div>
<div class="line">        <span class="keywordflow">if</span> (<span class="keyword">nullptr</span> == curlEasyHandle)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;ERROR: Could not create curl easy handle for url:%s&quot;</span>, options.url);</div>
<div class="line">            <span class="keywordflow">goto</span> cleanup;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        curlEasyHandles[curlEasyHandleCount].easyHandle = curlEasyHandle;</div>
<div class="line">        memset(curlEasyHandles[curlEasyHandleCount].pErrorBuffer, 0, CURL_ERROR_SIZE);</div>
<div class="line"></div>
<div class="line">        curl_easy_setopt(curlEasyHandle, CURLOPT_URL, options.url);</div>
<div class="line">        curl_easy_setopt(curlEasyHandle, CURLOPT_VERBOSE, 1);</div>
<div class="line">        curl_easy_setopt(curlEasyHandle, CURLOPT_FOLLOWLOCATION, 1);</div>
<div class="line">        curl_easy_setopt(curlEasyHandle, CURLOPT_ERRORBUFFER, curlEasyHandles[curlEasyHandleCount].pErrorBuffer);</div>
<div class="line">        curl_easy_setopt(curlEasyHandle, CURLOPT_WRITEFUNCTION, CurlWriteFunction);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>( HttpsHelperBase::IsUrlHttps(options.url) == <span class="keyword">true</span> )</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">/* Import the SSL context into libcurl. Because there&#39;s only one SSL context</span></div>
<div class="line"><span class="comment">            maintained in g_HttpsHelper, same SSL context will be shared between CURL</span></div>
<div class="line"><span class="comment">            handles.</span></div>
<div class="line"><span class="comment">            */</span></div>
<div class="line">            <span class="keywordflow">if</span> ( g_HttpsHelper.ImportSslContext(curlEasyHandle) &lt; 0 )</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;[ERROR] Failed to import the SSL context.\n&quot;</span>);</div>
<div class="line">                <span class="keywordflow">goto</span> cleanup;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        curl_easy_setopt(curlEasyHandle, CURLOPT_SOCKOPTFUNCTION, CurlSetSockOpts);</div>
<div class="line">        curl_easy_setopt(curlEasyHandle, CURLOPT_SOCKOPTDATA, &amp;options);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>( options.numConnections &gt; 1 )</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">char</span>        pBuffer[64 + 1] = { <span class="charliteral">&#39;\0&#39;</span> };</div>
<div class="line">            uint32_t    increment       = 0;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span>( remainder &gt; 0 )</div>
<div class="line">            {</div>
<div class="line">                increment = chunk + 1;</div>
<div class="line">                --remainder;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                increment = chunk;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// snprintf() isn&#39;t supported in Visual Studio 2013 so we can &quot;safely&quot; use sprintf() since we</span></div>
<div class="line">            <span class="comment">// know the maximum length string that would ever be put into pBuffer using 32-bit values is 22</span></div>
<div class="line">            sprintf(pBuffer, <span class="stringliteral">&quot;%u-%u&quot;</span>, previous, previous + increment - 1);</div>
<div class="line">            curl_easy_setopt(curlEasyHandle, CURLOPT_RANGE, pBuffer);</div>
<div class="line"></div>
<div class="line">            previous += increment;</div>
<div class="line"></div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;Chunk: %u  %s\n&quot;</span>, chunk, pBuffer);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef USE_PROXY</span></div>
<div class="line">        PROXY_SETTINGS(curlEasyHandle)</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// init a multi stack</span></div>
<div class="line">    curlMultiHandle = curl_multi_init();</div>
<div class="line">    <span class="keywordflow">if</span> (<span class="keyword">nullptr</span> == curlMultiHandle)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;ERROR: Could not create libcurl multi handle.&quot;</span>);</div>
<div class="line">        <span class="keywordflow">goto</span> cleanup;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// add the individual transfers</span></div>
<div class="line">    <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; curlEasyHandleCount; i++)</div>
<div class="line">    {</div>
<div class="line">        curl_multi_add_handle(curlMultiHandle, curlEasyHandles[i].easyHandle);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    tickPrev = <a class="code" href="namespacenn_1_1os.html#a79e29821bfb2b0c3a5c222488e90cc89">nn::os::GetSystemTick</a>();</div>
<div class="line">    <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;Downloading...\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">do</span></div>
<div class="line">    {</div>
<div class="line">        status = curl_multi_perform(curlMultiHandle, &amp;stillRunning);</div>
<div class="line">    } <span class="keywordflow">while</span>(status == CURLM_CALL_MULTI_PERFORM);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;Status: %u\n&quot;</span>, status);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span>(stillRunning)</div>
<div class="line">    {</div>
<div class="line">        <a name="_a31"></a><a class="code" href="structnn_1_1socket_1_1_time_val.html">nn::socket::TimeVal</a> timeout = { 0, 0 };</div>
<div class="line"></div>
<div class="line">        <a name="_a32"></a><a class="code" href="structnn_1_1socket_1_1_fd_set.html">nn::socket::FdSet</a>   fdread      = <a class="code" href="structnn_1_1socket_1_1_fd_set.html">nn::socket::FdSet</a>();</div>
<div class="line">        <a class="code" href="structnn_1_1socket_1_1_fd_set.html">nn::socket::FdSet</a>   fdwrite     = <a class="code" href="structnn_1_1socket_1_1_fd_set.html">nn::socket::FdSet</a>();</div>
<div class="line">        <a class="code" href="structnn_1_1socket_1_1_fd_set.html">nn::socket::FdSet</a>   fdexcep     = <a class="code" href="structnn_1_1socket_1_1_fd_set.html">nn::socket::FdSet</a>();</div>
<div class="line">        <span class="keywordtype">int</span>                 maxfd       = -1;</div>
<div class="line">        <span class="keywordtype">long</span>                curl_timeo  = -1;</div>
<div class="line"></div>
<div class="line">        <a name="a33"></a><a class="code" href="namespacenn_1_1socket.html#aa62380fb58406f3d7e83ea25c6deab35">nn::socket::FdSetZero</a>(&amp;fdread);</div>
<div class="line">        <a class="code" href="namespacenn_1_1socket.html#aa62380fb58406f3d7e83ea25c6deab35">nn::socket::FdSetZero</a>(&amp;fdwrite);</div>
<div class="line">        <a class="code" href="namespacenn_1_1socket.html#aa62380fb58406f3d7e83ea25c6deab35">nn::socket::FdSetZero</a>(&amp;fdexcep);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// set a suitable timeout to play around with</span></div>
<div class="line">        timeout.<a name="a34"></a><a class="code" href="structnn_1_1socket_1_1_time_val.html#ac07cd524371c2ecc7ab157ceed3fb46c">tv_sec</a> = 1;</div>
<div class="line">        timeout.<a name="a35"></a><a class="code" href="structnn_1_1socket_1_1_time_val.html#a6193c235e4ad720e065e138ddfdb69f6">tv_usec</a> = 0;</div>
<div class="line"></div>
<div class="line">        curl_multi_timeout(curlMultiHandle, &amp;curl_timeo);</div>
<div class="line">        <span class="keywordflow">if</span>(curl_timeo &gt;= 0)</div>
<div class="line">        {</div>
<div class="line">            timeout.<a class="code" href="structnn_1_1socket_1_1_time_val.html#ac07cd524371c2ecc7ab157ceed3fb46c">tv_sec</a> = curl_timeo / 1000;</div>
<div class="line">            <span class="keywordflow">if</span>( timeout.<a class="code" href="structnn_1_1socket_1_1_time_val.html#ac07cd524371c2ecc7ab157ceed3fb46c">tv_sec</a> &gt; 1 )</div>
<div class="line">            {</div>
<div class="line">                timeout.<a class="code" href="structnn_1_1socket_1_1_time_val.html#ac07cd524371c2ecc7ab157ceed3fb46c">tv_sec</a> = 1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                timeout.<a class="code" href="structnn_1_1socket_1_1_time_val.html#a6193c235e4ad720e065e138ddfdb69f6">tv_usec</a> = (curl_timeo % 1000) * 1000;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">//Get file descriptors from the transfers</span></div>
<div class="line">        curl_multi_fdset(curlMultiHandle, &amp;fdread, &amp;fdwrite, &amp;fdexcep, &amp;maxfd);</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">int</span> rc = <a name="a36"></a><a class="code" href="namespacenn_1_1socket.html#aa523b16a6004b8748cc0116f9ed65dd2">nn::socket::Select</a>(maxfd + 1, &amp;fdread, &amp;fdwrite, &amp;fdexcep, &amp;timeout);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">switch</span>(rc)</div>
<div class="line">        {</div>
<div class="line">        <span class="keywordflow">case</span> nn::socket::SocketError:</div>
<div class="line">            <span class="comment">// select error</span></div>
<div class="line">            stillRunning = 0;</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;ERROR: select() returned error %d\n&quot;</span>, <a class="code" href="namespacenn_1_1socket.html#a6db6951cb084f74f4c17d655ce798890">nn::socket::GetLastError</a>());</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 0:</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <span class="comment">// timeout or readable/writable sockets</span></div>
<div class="line">            <span class="keywordflow">do</span></div>
<div class="line">            {</div>
<div class="line">                status = curl_multi_perform(curlMultiHandle, &amp;stillRunning);</div>
<div class="line">            } <span class="keywordflow">while</span>(status == CURLM_CALL_MULTI_PERFORM);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    tickNow = <a class="code" href="namespacenn_1_1os.html#a79e29821bfb2b0c3a5c222488e90cc89">nn::os::GetSystemTick</a>();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span>(uint32_t iEasyHandle = 0; iEasyHandle &lt; options.numConnections; ++ iEasyHandle)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">long</span>    responseCode = 0;</div>
<div class="line">        <span class="keywordtype">double</span>  val          = 0.0f;</div>
<div class="line"></div>
<div class="line">        CURLcode ret = curl_easy_getinfo(curlEasyHandles[iEasyHandle].easyHandle, CURLINFO_RESPONSE_CODE, &amp;responseCode);</div>
<div class="line">        <span class="keywordflow">if</span>( ret != CURLE_OK )</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;curl_easy_getinfo failed: %d\n&quot;</span>, ret);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;CURLINFO_RESPONSE_CODE: %d\n&quot;</span>, responseCode);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        ret = curl_easy_getinfo(curlEasyHandles[iEasyHandle].easyHandle, CURLINFO_HTTP_CONNECTCODE, &amp;responseCode);</div>
<div class="line">        <span class="keywordflow">if</span>( ret != CURLE_OK)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;curl_easy_getinfo failed: %d\n&quot;</span>, ret);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;CURLINFO_HTTP_CONNECTCODE: %d\n&quot;</span>, responseCode);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        ret = curl_easy_getinfo(curlEasyHandles[iEasyHandle].easyHandle, CURLINFO_SIZE_DOWNLOAD, &amp;val);</div>
<div class="line">        <span class="keywordflow">if</span>( ret != CURLE_OK )</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;curl_easy_getinfo failed: %d\n&quot;</span>, ret);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            uint32_t numBytes = <span class="keyword">static_cast&lt;</span>uint32_t<span class="keyword">&gt;</span>(val);</div>
<div class="line">            downloadSize += numBytes;</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;CURLINFO_SIZE_DOWNLOAD: %u\n&quot;</span>, numBytes);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* check for total download time */</span></div>
<div class="line">        ret = curl_easy_getinfo(curlEasyHandles[iEasyHandle].easyHandle, CURLINFO_TOTAL_TIME, &amp;val);</div>
<div class="line">        <span class="keywordflow">if</span>( (CURLE_OK == ret) &amp;&amp; (val &gt; 0) )</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;CURLINFO_TOTAL_TIME: %0.3f sec.\n&quot;</span>, val);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* check for average download speed */</span></div>
<div class="line">        ret = curl_easy_getinfo(curlEasyHandles[iEasyHandle].easyHandle, CURLINFO_SPEED_DOWNLOAD, &amp;val);</div>
<div class="line">        <span class="keywordflow">if</span>( (CURLE_OK == ret) &amp;&amp; (val &gt; 0) )</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;CURLINFO_SPEED_DOWNLOAD: %0.3f kbyte/sec.\n&quot;</span>, val / 1024);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* check for name resolution time */</span></div>
<div class="line">        ret = curl_easy_getinfo(curlEasyHandles[iEasyHandle].easyHandle, CURLINFO_NAMELOOKUP_TIME, &amp;val);</div>
<div class="line">        <span class="keywordflow">if</span>( (CURLE_OK == ret) &amp;&amp; (val &gt; 0) )</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;CURLINFO_NAMELOOKUP_TIME: %0.3f sec.\n&quot;</span>, val);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* check for connect time */</span></div>
<div class="line">        ret = curl_easy_getinfo(curlEasyHandles[iEasyHandle].easyHandle, CURLINFO_CONNECT_TIME, &amp;val);</div>
<div class="line">        <span class="keywordflow">if</span>( (CURLE_OK == ret) &amp;&amp; (val &gt; 0) )</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;CURLINFO_CONNECT_TIME: %0.3f sec.\n&quot;</span>, val);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;Error Details %d: %s\n&quot;</span>, iEasyHandle, curlEasyHandles[iEasyHandle].pErrorBuffer);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    fSeconds = <a class="code" href="namespacenn_1_1os.html#a53032bee4cfe0f01916e8149c393adad">nn::os::ConvertToTimeSpan</a>( tickNow - tickPrev ).<a class="code" href="classnn_1_1_time_span.html#a5c2c7f5af7b80454e0a2f8bc11eae473">GetMilliSeconds</a>() / 1000.0f;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;\n ** Finished download %u with Status: %d\n&quot;</span>, index, status);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot; ** Duration: %.3f sec\n&quot;</span>, fSeconds);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( downloadSize / kGigabyte &gt;= 1.0f )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot; ** Downloaded: %.3f GB\n&quot;</span>, downloadSize / kGigabyte);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( downloadSize / kMegabyte &gt;= 1.0f )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot; ** Downloaded: %.3f MB\n&quot;</span>, downloadSize / kMegabyte);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>( downloadSize / kKilobyte &gt;= 1.0f )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot; ** Downloaded: %.3f KB\n&quot;</span>, downloadSize / kKilobyte);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot; ** Downloaded: %u Bytes\n&quot;</span>, downloadSize);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* bytes/ms -&gt; Mb/s */</span></div>
<div class="line">    fThroughput = downloadSize * 8.0f / fSeconds / kMegabyte;</div>
<div class="line">    <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot; ** Speed: %.3f Mbits/sec\n\n&quot;</span>, fThroughput);</div>
<div class="line"></div>
<div class="line">cleanup:</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; curlEasyHandleCount; i++)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (curlMultiHandle)</div>
<div class="line">        {</div>
<div class="line">            curl_multi_remove_handle(curlMultiHandle, curlEasyHandles[i].easyHandle);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        curl_easy_cleanup(curlEasyHandles[i].easyHandle);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (curlMultiHandle)</div>
<div class="line">    {</div>
<div class="line">        curl_multi_cleanup(curlMultiHandle);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    free(curlEasyHandles);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> fThroughput;</div>
<div class="line">} <span class="comment">// NOLINT(impl/function_size)</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">size_t</span> CurlReadFunction(<span class="keywordtype">void</span> *ptr, <span class="keywordtype">size_t</span> size, <span class="keywordtype">size_t</span> nmemb, <span class="keywordtype">void</span> *userp)</div>
<div class="line">{</div>
<div class="line">    WriteData   *pData = <span class="keyword">static_cast&lt;</span>WriteData *<span class="keyword">&gt;</span>(userp);</div>
<div class="line">    <span class="keywordtype">size_t</span>      count = size * nmemb;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (count &lt; 1)</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (pData-&gt;sizeLeft &gt; 0)</div>
<div class="line">    {</div>
<div class="line">        memcpy(ptr, pData-&gt;pReadPos, count);</div>
<div class="line">        pData-&gt;pReadPos += count;</div>
<div class="line">        pData-&gt;sizeLeft -= count;</div>
<div class="line">        <span class="keywordflow">return</span> count;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 0;                          <span class="comment">/* no more data left to deliver */</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">float</span> UploadFile(<span class="keyword">const</span> Options &amp;options)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">float</span>           fThroughput = 0.0f;</div>
<div class="line">    <a class="code" href="classnn_1_1os_1_1_tick.html">nn::os::Tick</a>    tickPrev = <a class="code" href="classnn_1_1os_1_1_tick.html">nn::os::Tick</a>(),</div>
<div class="line">                    tickNow = <a class="code" href="classnn_1_1os_1_1_tick.html">nn::os::Tick</a>();</div>
<div class="line">    <span class="keywordtype">char</span>            *pBuf = <span class="keyword">static_cast&lt;</span><span class="keywordtype">char</span> *<span class="keyword">&gt;</span>(std::calloc(options.uploadSize, 1));</div>
<div class="line">    WriteData       writeData = { 0 };</div>
<div class="line">    CURLcode        res = CURLE_OK;</div>
<div class="line">    <span class="keywordtype">float</span>           fSeconds = 0.0f;</div>
<div class="line"></div>
<div class="line">    writeData.pReadPos = pBuf;</div>
<div class="line">    writeData.sizeLeft = options.uploadSize;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<span class="keyword">nullptr</span> == pBuf)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;[ERROR] Failed to allocate %d bytes for upload.\n&quot;</span>, options.uploadSize);</div>
<div class="line">        <span class="keywordflow">return</span> 0.0f;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// fill buffer with randomish bytes</span></div>
<div class="line">    memset(pBuf, rand(), options.uploadSize);</div>
<div class="line"></div>
<div class="line">    CURL *curlEasyHandle = curl_easy_init();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (<span class="keyword">nullptr</span> != curlEasyHandle)</div>
<div class="line">    {</div>
<div class="line">        curl_easy_setopt(curlEasyHandle, CURLOPT_URL, options.url);</div>
<div class="line">        curl_easy_setopt(curlEasyHandle, CURLOPT_VERBOSE, 1);</div>
<div class="line">        curl_easy_setopt(curlEasyHandle, CURLOPT_HTTP_VERSION, CURL_HTTP_VERSION_1_0);</div>
<div class="line">        curl_easy_setopt(curlEasyHandle, CURLOPT_POST, 1L);</div>
<div class="line">        curl_easy_setopt(curlEasyHandle, CURLOPT_READFUNCTION, CurlReadFunction);</div>
<div class="line">        curl_easy_setopt(curlEasyHandle, CURLOPT_READDATA, &amp;writeData);</div>
<div class="line">        curl_easy_setopt(curlEasyHandle, CURLOPT_POSTFIELDSIZE, options.uploadSize);</div>
<div class="line"></div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;Uploading %d bytes to %s\n&quot;</span>, options.uploadSize, options.url);</div>
<div class="line">        tickPrev = <a class="code" href="namespacenn_1_1os.html#a79e29821bfb2b0c3a5c222488e90cc89">nn::os::GetSystemTick</a>();</div>
<div class="line"></div>
<div class="line">        res = curl_easy_perform(curlEasyHandle);</div>
<div class="line">        <span class="keywordflow">if</span> (CURLE_OK == res)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">long</span>    responseCode = 0;</div>
<div class="line">            <span class="keywordtype">double</span>  val = 0.0f;</div>
<div class="line"></div>
<div class="line">            tickNow = <a class="code" href="namespacenn_1_1os.html#a79e29821bfb2b0c3a5c222488e90cc89">nn::os::GetSystemTick</a>();</div>
<div class="line"></div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;curl_easy_perform() succeeded!\n&quot;</span>, res);</div>
<div class="line"></div>
<div class="line">            CURLcode ret = curl_easy_getinfo(curlEasyHandle, CURLINFO_RESPONSE_CODE, &amp;responseCode);</div>
<div class="line">            <span class="keywordflow">if</span> (ret != CURLE_OK)</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;curl_easy_getinfo failed: %d\n&quot;</span>, ret);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;CURLINFO_RESPONSE_CODE: %d\n&quot;</span>, responseCode);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            ret = curl_easy_getinfo(curlEasyHandle, CURLINFO_HTTP_CONNECTCODE, &amp;responseCode);</div>
<div class="line">            <span class="keywordflow">if</span> (ret != CURLE_OK)</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;curl_easy_getinfo failed: %d\n&quot;</span>, ret);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;CURLINFO_HTTP_CONNECTCODE: %d\n&quot;</span>, responseCode);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* check for total download time */</span></div>
<div class="line">            ret = curl_easy_getinfo(curlEasyHandle, CURLINFO_TOTAL_TIME, &amp;val);</div>
<div class="line">            <span class="keywordflow">if</span> ((CURLE_OK == ret) &amp;&amp; (val &gt; 0))</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;CURLINFO_TOTAL_TIME: %0.3f sec.\n&quot;</span>, val);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* check for average download speed */</span></div>
<div class="line">            ret = curl_easy_getinfo(curlEasyHandle, CURLINFO_SPEED_UPLOAD, &amp;val);</div>
<div class="line">            <span class="keywordflow">if</span> ((CURLE_OK == ret) &amp;&amp; (val &gt; 0))</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;CURLINFO_SPEED_UPLOAD: %0.3f kbyte/sec.\n&quot;</span>, val / 1024);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* check for name resolution time */</span></div>
<div class="line">            ret = curl_easy_getinfo(curlEasyHandle, CURLINFO_NAMELOOKUP_TIME, &amp;val);</div>
<div class="line">            <span class="keywordflow">if</span> ((CURLE_OK == ret) &amp;&amp; (val &gt; 0))</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;CURLINFO_NAMELOOKUP_TIME: %0.3f sec.\n&quot;</span>, val);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* check for connect time */</span></div>
<div class="line">            ret = curl_easy_getinfo(curlEasyHandle, CURLINFO_CONNECT_TIME, &amp;val);</div>
<div class="line">            <span class="keywordflow">if</span> ((CURLE_OK == ret) &amp;&amp; (val &gt; 0))</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;CURLINFO_CONNECT_TIME: %0.3f sec.\n&quot;</span>, val);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            fSeconds = <a class="code" href="namespacenn_1_1os.html#a53032bee4cfe0f01916e8149c393adad">nn::os::ConvertToTimeSpan</a>(tickNow - tickPrev).<a class="code" href="classnn_1_1_time_span.html#a5c2c7f5af7b80454e0a2f8bc11eae473">GetMilliSeconds</a>() / 1000.0f;</div>
<div class="line"></div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;\n ** Finished upload\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot; ** Duration: %.3f sec\n&quot;</span>, fSeconds);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">if</span> (options.uploadSize / kGigabyte &gt;= 1.0f)</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot; ** Uploaded: %.3f GB\n&quot;</span>, options.uploadSize / kGigabyte);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (options.uploadSize / kMegabyte &gt;= 1.0f)</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot; ** Uploaded: %.3f MB\n&quot;</span>, options.uploadSize / kMegabyte);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (options.uploadSize / kKilobyte &gt;= 1.0f)</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot; ** Uploaded: %.3f KB\n&quot;</span>, options.uploadSize / kKilobyte);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot; ** Uploaded: %u Bytes\n&quot;</span>, options.uploadSize);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">/* bytes/ms -&gt; Mb/s */</span></div>
<div class="line">            fThroughput = options.uploadSize * 8.0f / fSeconds / kMegabyte;</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot; ** Speed: %.3f Mbits/sec\n\n&quot;</span>, fThroughput);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;[ERROR] curl_easy_perform() failed! curl error: %d\n&quot;</span>, res);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        curl_easy_cleanup(curlEasyHandle);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    free(pBuf);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> fThroughput;</div>
<div class="line">} <span class="comment">// NOLINT(impl/function_size)</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">char</span>* GetCmdOption(<span class="keywordtype">char</span> **pBegin, <span class="keywordtype">char</span> **pEnd, <span class="keyword">const</span> std::string &amp;option)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> **pItr = std::find(pBegin, pEnd, option);</div>
<div class="line">    <span class="keywordflow">if</span> (pItr != pEnd &amp;&amp; ++pItr != pEnd)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> *pItr;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> CmdOptionExists(<span class="keywordtype">char</span> **pBegin, <span class="keywordtype">char</span> **pEnd, <span class="keyword">const</span> std::string&amp; option)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> std::find(pBegin, pEnd, option) != pEnd;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> ParseCmdOptions(Options *pOptions)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span>   argc                    = <a name="a37"></a><a class="code" href="namespacenn_1_1os.html#acf2fa6b7b7074a51d0b2de1664cc7bb5">nn::os::GetHostArgc</a>();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( argc &gt; 2 )</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">char</span> *option    = <span class="keyword">nullptr</span>;</div>
<div class="line"></div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;Command: LibcurlSpeedTest&quot;</span>);</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt; argc; i++)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot; %s&quot;</span>, <a name="a38"></a><a class="code" href="namespacenn_1_1os.html#abd77e6bf19be140867869cc759fa492c">nn::os::GetHostArgv</a>()[i]);</div>
<div class="line">        }</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>( CmdOptionExists(<a class="code" href="namespacenn_1_1os.html#abd77e6bf19be140867869cc759fa492c">nn::os::GetHostArgv</a>(), <a class="code" href="namespacenn_1_1os.html#abd77e6bf19be140867869cc759fa492c">nn::os::GetHostArgv</a>() + argc, <span class="stringliteral">&quot;-h&quot;</span>) )</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;LibcurlSpeedTest.nca: Run speed test using libcurl.\n&quot;</span>);</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;\nUsage: RunOnTarget.exe LibcurlSpeedTest.nca [-u &lt;arg&gt;] [-s &lt;arg&gt;] [-r &lt;arg&gt;]&quot;</span> \</div>
<div class="line">                   <span class="stringliteral">&quot;                                                [-p &lt;arg&gt;] [-t &lt;arg&gt;] [-n &lt;arg&gt;]&quot;</span> \</div>
<div class="line">                   <span class="stringliteral">&quot;                                                [-up &lt;arg&gt;]\n&quot;</span>);</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;\nExamples:\n&quot;</span> \</div>
<div class="line">                   <span class="stringliteral">&quot;  # Run with default parameters.\n&quot;</span> \</div>
<div class="line">                   <span class="stringliteral">&quot;  RunOnTarget.exe LibcurlSpeedTest.nca\n\n&quot;</span> \</div>
<div class="line">                   <span class="stringliteral">&quot;  # Download default url with four simultaneous connections.\n&quot;</span> \</div>
<div class="line">                   <span class="stringliteral">&quot;  RunOnTarget.exe LibcurlSpeedTest.nca -n 4\n\n&quot;</span> \</div>
<div class="line">                   <span class="stringliteral">&quot;  # Download specific url three times.\n&quot;</span> \</div>
<div class="line">                   <span class="stringliteral">&quot;  RunOnTarget.exe LibcurlSpeedTest.nca -u http://www.example.com -t 3\n\n&quot;</span> \</div>
<div class="line">                   <span class="stringliteral">&quot;  # Download default url with custom sized socket send and receive buffers.\n&quot;</span> \</div>
<div class="line">                   <span class="stringliteral">&quot;  RunOnTarget.exe LibcurlSpeedTest.nca -r 131072 -s 65536\n&quot;</span> \</div>
<div class="line">                   <span class="stringliteral">&quot;  # Download default url with the TCP Nagle algorithm disabled.\n&quot;</span> \</div>
<div class="line">                   <span class="stringliteral">&quot;  RunOnTarget.exe LibcurlSpeedTest.nca -n off\n\n&quot;</span>);</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;\nAcceptable Arguments:\n&quot;</span> \</div>
<div class="line">                   <span class="stringliteral">&quot;  -h         Display this help.\n&quot;</span> \</div>
<div class="line">                   <span class="stringliteral">&quot;  -n &lt;arg&gt;   on [default] - Enable TCP Nagle algorithm.\n&quot;</span> \</div>
<div class="line">                   <span class="stringliteral">&quot;             off - Disable TCP Nagle algorithm.\n&quot;</span> \</div>
<div class="line">                   <span class="stringliteral">&quot;  -p &lt;arg&gt;   Number of simultaneous parallel connections to make to the server.\n&quot;</span> \</div>
<div class="line">                   <span class="stringliteral">&quot;  -r &lt;arg&gt;   Value to set SO_RCVBUF socket option to.\n&quot;</span> \</div>
<div class="line">                   <span class="stringliteral">&quot;  -s &lt;arg&gt;   Value to set SO_SNDBUF socket option to.\n&quot;</span> \</div>
<div class="line">                   <span class="stringliteral">&quot;  -t &lt;arg&gt;   Number of times to download or upload to the url.\n&quot;</span> \</div>
<div class="line">                   <span class="stringliteral">&quot;  -u &lt;arg&gt;   The url to connect to.\n&quot;</span> \</div>
<div class="line">                   <span class="stringliteral">&quot;  -up &lt;arg&gt;  Number of random bytes to upload.\n&quot;</span> \</div>
<div class="line">                   <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        option = GetCmdOption(<a class="code" href="namespacenn_1_1os.html#abd77e6bf19be140867869cc759fa492c">nn::os::GetHostArgv</a>(), <a class="code" href="namespacenn_1_1os.html#abd77e6bf19be140867869cc759fa492c">nn::os::GetHostArgv</a>() + argc, <span class="stringliteral">&quot;-u&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span>( <span class="keyword">nullptr</span> != option )</div>
<div class="line">        {</div>
<div class="line">            strncpy(pOptions-&gt;url, option, kMaxUrlLength);</div>
<div class="line">            pOptions-&gt;url[kMaxUrlLength] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;setting url to %s\n&quot;</span>, pOptions-&gt;url);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        option = GetCmdOption(<a class="code" href="namespacenn_1_1os.html#abd77e6bf19be140867869cc759fa492c">nn::os::GetHostArgv</a>(), <a class="code" href="namespacenn_1_1os.html#abd77e6bf19be140867869cc759fa492c">nn::os::GetHostArgv</a>() + argc, <span class="stringliteral">&quot;-s&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span>( <span class="keyword">nullptr</span> != option )</div>
<div class="line">        {</div>
<div class="line">            pOptions-&gt;sndBufSize = atoi(option);</div>
<div class="line">            <span class="comment">// if rcvBufSize is 0, it could be due to the parameter being passed in incorrectly</span></div>
<div class="line">            <span class="keywordflow">if</span>( 0 == pOptions-&gt;sndBufSize )</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;[WARNING] The send buffer size is set to 0. Was that intentional?\n&quot;</span>);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        option = GetCmdOption(<a class="code" href="namespacenn_1_1os.html#abd77e6bf19be140867869cc759fa492c">nn::os::GetHostArgv</a>(), <a class="code" href="namespacenn_1_1os.html#abd77e6bf19be140867869cc759fa492c">nn::os::GetHostArgv</a>() + argc, <span class="stringliteral">&quot;-r&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span>( <span class="keyword">nullptr</span> != option )</div>
<div class="line">        {</div>
<div class="line">            pOptions-&gt;rcvBufSize = atoi(option);</div>
<div class="line">            <span class="comment">// if rcvBufSize is 0, it could be due to the parameter being passed in incorrectly</span></div>
<div class="line">            <span class="keywordflow">if</span>( 0 == pOptions-&gt;rcvBufSize )</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;[WARNING] The receive buffer size is set to 0. Was that intentional?\n&quot;</span>);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        option = GetCmdOption(<a class="code" href="namespacenn_1_1os.html#abd77e6bf19be140867869cc759fa492c">nn::os::GetHostArgv</a>(), <a class="code" href="namespacenn_1_1os.html#abd77e6bf19be140867869cc759fa492c">nn::os::GetHostArgv</a>() + argc, <span class="stringliteral">&quot;-p&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span>( <span class="keyword">nullptr</span> != option )</div>
<div class="line">        {</div>
<div class="line">            pOptions-&gt;numConnections = atoi(option);</div>
<div class="line">            <span class="comment">// if numConnections is 0, it could be due to the parameter being passed in incorrectly</span></div>
<div class="line">            <span class="keywordflow">if</span>( 0 == pOptions-&gt;numConnections )</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;[WARNING] The number of parallel connetions is set to 0. Was that intentional?\n&quot;</span>);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        option = GetCmdOption(<a class="code" href="namespacenn_1_1os.html#abd77e6bf19be140867869cc759fa492c">nn::os::GetHostArgv</a>(), <a class="code" href="namespacenn_1_1os.html#abd77e6bf19be140867869cc759fa492c">nn::os::GetHostArgv</a>() + argc, <span class="stringliteral">&quot;-t&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span>( <span class="keyword">nullptr</span> != option )</div>
<div class="line">        {</div>
<div class="line">            pOptions-&gt;timesToDownload = atoi(option);</div>
<div class="line">            <span class="comment">// if timesToDownload is 0, it could be due to the parameter being passed in incorrectly</span></div>
<div class="line">            <span class="keywordflow">if</span>( 0 == pOptions-&gt;timesToDownload )</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;[WARNING] The number of times to download is set to 0. Was that intentional?\n&quot;</span>);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        option = GetCmdOption(<a class="code" href="namespacenn_1_1os.html#abd77e6bf19be140867869cc759fa492c">nn::os::GetHostArgv</a>(), <a class="code" href="namespacenn_1_1os.html#abd77e6bf19be140867869cc759fa492c">nn::os::GetHostArgv</a>() + argc, <span class="stringliteral">&quot;-n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span>( <span class="keyword">nullptr</span> != option )</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span>( std::string(<span class="stringliteral">&quot;off&quot;</span>) == option )</div>
<div class="line">            {</div>
<div class="line">                pOptions-&gt;disableTcpNagle = 1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span>( std::string(<span class="stringliteral">&quot;on&quot;</span>) == option )</div>
<div class="line">            {</div>
<div class="line">                pOptions-&gt;disableTcpNagle = 0;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;[WARNING] Unknown argument, %s, used for -n option. Use \&quot;off\&quot; or \&quot;on\&quot; (default).\n&quot;</span>, option);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        option = GetCmdOption(<a class="code" href="namespacenn_1_1os.html#abd77e6bf19be140867869cc759fa492c">nn::os::GetHostArgv</a>(), <a class="code" href="namespacenn_1_1os.html#abd77e6bf19be140867869cc759fa492c">nn::os::GetHostArgv</a>() + argc, <span class="stringliteral">&quot;-up&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span> (<span class="keyword">nullptr</span> != option)</div>
<div class="line">        {</div>
<div class="line">            pOptions-&gt;uploadSize = atoi(option);</div>
<div class="line">            <span class="comment">// if uploadSize is 0, it could be due to the parameter being passed in incorrectly</span></div>
<div class="line">            <span class="keywordflow">if</span> (0 == pOptions-&gt;uploadSize)</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;[WARNING] The number of upload bytes is set to 0. Was that intentional?\n&quot;</span>);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">} <span class="comment">// NOLINT(impl/function_size)</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> <span class="keywordtype">void</span> <a name="a39"></a><a class="code" href="_socket_resolver_8cpp.html#ae79180f8ae90e05743b47a872f305a52">nnMain</a>()</div>
<div class="line">{</div>
<div class="line">    <a name="_a40"></a><a class="code" href="classnn_1_1_result.html">nn::Result</a>  ret                     = <a class="code" href="classnn_1_1_result.html">nn::Result</a>();</div>
<div class="line">    CURLcode    res                     = CURLE_OK;</div>
<div class="line">    uint32_t    fileSize                = 0;</div>
<div class="line">    int64_t     serverRTT               = -1;</div>
<div class="line">    <span class="keywordtype">float</span>       fAverageThroughput      = 0.0f;</div>
<div class="line">    Options     options                 = { 1,      <span class="comment">// numConnections</span></div>
<div class="line">                                            1,      <span class="comment">// timesToDownload</span></div>
<div class="line">                                            -1,     <span class="comment">// sndBufSize</span></div>
<div class="line">                                            -1,     <span class="comment">// rcvBufSize</span></div>
<div class="line">                                            0,      <span class="comment">// disableTcpNagle</span></div>
<div class="line">                                            0,      <span class="comment">// uploadSize</span></div>
<div class="line">                                            <span class="stringliteral">&quot;http://speedtest.tele2.net/100MB.zip&quot;</span> };    <span class="comment">// url}</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// if this returns false, then the user only wanted to view the help</span></div>
<div class="line">    <span class="keywordflow">if</span>( ParseCmdOptions(&amp;options) == <span class="keyword">false</span> )</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;Started...\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* since the following will utilize the system network interface, we must initialize</span></div>
<div class="line"><span class="comment">    network interface manager (NIFM) */</span></div>
<div class="line">    <a name="a41"></a><a class="code" href="namespacenn_1_1nifm.html#a0e3aaf3209696149ec22613e1d3d6705">nn::nifm::Initialize</a>();</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* this application is now requesting to use network interface */</span></div>
<div class="line">    <a name="a42"></a><a class="code" href="namespacenn_1_1nifm.html#a96f83210fc74e61335caf9308a357fff">nn::nifm::SubmitNetworkRequest</a>();</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* wait for network interface availability, while providing status */</span></div>
<div class="line">    <span class="keywordflow">while</span>( <a name="a43"></a><a class="code" href="namespacenn_1_1nifm.html#abe80d921b69bef9c0919c5bb544576f3">nn::nifm::IsNetworkRequestOnHold</a>() )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;Waiting for network interface availability...\n&quot;</span>);</div>
<div class="line">        <a name="a44"></a><a class="code" href="namespacenn_1_1os.html#a96b335e87af44c60a0d6dca75f11c9d2">nn::os::SleepThread</a>(<a name="a45"></a><a class="code" href="classnn_1_1_time_span.html#adc879772bbd4cd05381326fe0dd58b97">nn::TimeSpan::FromSeconds</a>(1));</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( !<a name="a46"></a><a class="code" href="namespacenn_1_1nifm.html#a933a28d229a56e800703d95d4830fc6a">nn::nifm::IsNetworkAvailable</a>() )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;\n[ERROR] network is not available.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">goto</span> CLEANUP_NIFM;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* initialize the socket library, providing application use case specific amount of memory */</span></div>
<div class="line">    ret = <a name="a47"></a><a class="code" href="namespacenn_1_1socket.html#adacc3405184e8f28fb630745b9f43db0">nn::socket::Initialize</a>(g_SocketMemoryPoolBuffer,</div>
<div class="line">        <a class="code" href="namespacenn_1_1socket.html#a150d80cacbb08735b665a1e061367ee1">nn::socket::DefaultSocketMemoryPoolSize</a>,</div>
<div class="line">        <a name="a48"></a><a class="code" href="namespacenn_1_1socket.html#adfeb3704c8d57239f730a25ab70ef147">nn::socket::MinSocketAllocatorSize</a>,</div>
<div class="line">        nn::socket::DefaultConcurrencyLimit);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( ret.<a name="a49"></a><a class="code" href="classnn_1_1_result.html#a5d119d9cb4918fc3cd09215437b91c13">IsFailure</a>() )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;\n[ERROR] nn::socket::Initialize() failed. Err Desc: %d\n\n&quot;</span>, ret.<a name="a50"></a><a class="code" href="classnn_1_1_result.html#a800c5bb9b58c3f2b76223ea43904120b">GetDescription</a>());</div>
<div class="line">        <span class="keywordflow">goto</span> CLEANUP_NIFM;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* initialize using system malloc for libcurl for testing */</span></div>
<div class="line">    res = curl_global_init(CURL_GLOBAL_DEFAULT);</div>
<div class="line">    <span class="keywordflow">if</span>( res != CURLE_OK )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;\n[ERROR] curl_global_init failed. Err: %d\n\n&quot;</span>, res);</div>
<div class="line">        <span class="keywordflow">goto</span> CLEANUP_SOCKET_AND_NIFM;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;Network ready\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Setup for HTTPS. The SSL context will be allocated inside g_HttpsHelper.</span></div>
<div class="line"><span class="comment">    The allocated SSL context will be imported into libcurl by g_HttpsHelper.ImportSslContext</span></div>
<div class="line"><span class="comment">    below after CURL handle is created, and when URL contains https.</span></div>
<div class="line"><span class="comment">    The allocated SSL context will be freed in g_HttpsHelper.Finalize after all curl handles</span></div>
<div class="line"><span class="comment">    which imported this context are closed at the bottom.</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line">    <span class="keywordflow">if</span> ( g_HttpsHelper.Initialize() &lt; 0 )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;[ERROR] Failed to initialize HTTPS helper util.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">goto</span> CLEANUP_CURL_AND_SOCKET_AND_NIFM;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Can only calc RTT with no proxy</span></div>
<div class="line"><span class="preprocessor">#ifndef USE_PROXY</span></div>
<div class="line">    <span class="keywordflow">if</span>( !EstimateServerRTT(&amp;serverRTT, options.url) )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;Failed to get server RTT!\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( options.uploadSize == 0 )</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>( !<a class="code" href="namespacenn_1_1fs.html#aba29e01d386e809349d60eccdb15ff21">GetFileSize</a>(options, &amp;fileSize) )</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;Failed to get file size!\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">goto</span> CLEANUP_CURL_AND_SOCKET_AND_NIFM;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span>( uint32_t iDownload = 1; iDownload &lt;= options.timesToDownload; ++iDownload )</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot; * Starting download number: %d\n&quot;</span>, iDownload);</div>
<div class="line">            fAverageThroughput += DownloadFile(iDownload, options, fileSize);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;times to download: %d\n&quot;</span>, options.timesToDownload);</div>
<div class="line">        fAverageThroughput /= options.timesToDownload;</div>
<div class="line"></div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;\n******* Results *******\n&quot;</span>);</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;******* URL: %s\n&quot;</span>, options.url);</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;******* Average Throughput: %.3f Mbits/sec\n&quot;</span>, fAverageThroughput);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span>( fileSize / kGigabyte &gt;= 1.0f )</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;******* File Size: %.3f GB\n&quot;</span>, fileSize / kGigabyte);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( fileSize / kMegabyte &gt;= 1.0f )</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;******* File Size: %.3f MB\n&quot;</span>, fileSize / kMegabyte);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( fileSize / kKilobyte &gt;= 1.0f )</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;******* File Size: %.3f KB\n&quot;</span>, fileSize / kKilobyte);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;******* File Size: %u Bytes\n&quot;</span>, fileSize);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;******* Number of Downloads: %u\n&quot;</span>, options.timesToDownload);</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;******* Number of Connections: %u\n&quot;</span>, options.numConnections);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        UploadFile(options);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( serverRTT &gt;= 0 )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;******* Server RTT: %lld ms\n\n&quot;</span>, serverRTT);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;******* Server RTT: Unknown\n\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">CLEANUP_CURL_AND_SOCKET_AND_NIFM:</div>
<div class="line">    <span class="comment">/* cleanup libcurl library */</span></div>
<div class="line">    curl_global_cleanup();</div>
<div class="line"></div>
<div class="line">CLEANUP_SOCKET_AND_NIFM:</div>
<div class="line">    <span class="comment">/* cleanup socket library */</span></div>
<div class="line">    <a name="a51"></a><a class="code" href="namespacenn_1_1socket.html#a28a801f086aadf0b731a721567f3e4b2">nn::socket::Finalize</a>();</div>
<div class="line"></div>
<div class="line">CLEANUP_NIFM:</div>
<div class="line">    <span class="comment">/* this application no longer requires use of network interface */</span></div>
<div class="line">    <a name="a52"></a><a class="code" href="namespacenn_1_1nifm.html#a7704800c5ddaa16c5f0f89f6fa42174b">nn::nifm::CancelNetworkRequest</a>();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">} <span class="comment">// NOLINT(impl/function_size)</span></div>
<div class="line"></div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
</body>
</html>
