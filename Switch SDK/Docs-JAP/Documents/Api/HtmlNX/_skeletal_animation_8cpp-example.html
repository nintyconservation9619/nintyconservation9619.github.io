<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>NintendoSDK API Reference: SkeletalAnimation.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="openclose.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">NintendoSDK API Reference
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 構築: Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'検索');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>総合概要</span></a></li>
      <li><a href="pages.html"><span>諸情報</span></a></li>
      <li><a href="modules.html"><span>モジュール</span></a></li>
      <li><a href="namespaces.html"><span>名前空間</span></a></li>
      <li><a href="annotated.html"><span>クラス</span></a></li>
      <li><a href="files.html"><span>ファイル</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="検索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">SkeletalAnimation.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>ソースコードの説明は、<a class="el" href="_page_sample_g3d_skeletal_animation.html">G3dDemo SkeletalAnimation</a> および <a class="el" href="_skeletal_animation_8cpp.html" title="スケルタルアニメーション機能を使用するサンプルプログラム ">SkeletalAnimation.cpp</a> を参照してください。</p>
<div class="fragment"><div class="line"><span class="comment">/*--------------------------------------------------------------------------------*</span></div>
<div class="line"><span class="comment">  Copyright (C)Nintendo All rights reserved.</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  These coded instructions, statements, and computer programs contain proprietary</span></div>
<div class="line"><span class="comment">  information of Nintendo and/or its licensed developers and are protected by</span></div>
<div class="line"><span class="comment">  national and international copyright laws. They may not be disclosed to third</span></div>
<div class="line"><span class="comment">  parties or copied or duplicated in any form, in whole or in part, without the</span></div>
<div class="line"><span class="comment">  prior written consent of Nintendo.</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  The content herein is highly confidential and should be handled accordingly.</span></div>
<div class="line"><span class="comment"> *--------------------------------------------------------------------------------*/</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;SkeletalAnimation.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;g3ddemo_GfxUtility.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;g3ddemo_ModelUtility.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespacenn_1_1g3d_1_1demo.html">g3ddemo</a> = <a class="code" href="namespacenn_1_1g3d_1_1demo.html">nn::g3d::demo</a>;</div>
<div class="line"></div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespacenn.html">nn</a> { <span class="keyword">namespace </span>g3d { <span class="keyword">namespace </span>demo { <span class="keyword">namespace </span>skeletalanim {</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define RESOURCE_PATH &quot;Resource:/&quot;</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* g_BfshaPath = RESOURCE_PATH <span class="stringliteral">&quot;shader/demo.bfsha&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* g_EnvBfresPath = RESOURCE_PATH <span class="stringliteral">&quot;env.bfres&quot;</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* g_ModelBfresPath = RESOURCE_PATH <span class="stringliteral">&quot;SkeletalAnimDemo.bfres&quot;</span>;</div>
<div class="line"></div>
<div class="line"><a name="_a0"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>*    g_pRenderModelObj[ModelCount];</div>
<div class="line"><a name="_a1"></a><a class="code" href="structnn_1_1util_1_1_matrix_row_major4x3f_type.html">nn::util::Matrix4x3fType</a>     g_BaseMtx[ModelCount];</div>
<div class="line"><a name="_a2"></a><a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_obj.html">nn::g3d::SkeletalAnimObj</a>*    g_pSkeletalAnimObjArray[ModelCount][AnimIndexCount];</div>
<div class="line"><a name="_a3"></a><a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_blender.html">nn::g3d::SkeletalAnimBlender</a> g_SkeletalAnimBlender[ModelCount];</div>
<div class="line"><a name="_a4"></a><a class="code" href="classnn_1_1util_1_1_color4u8.html">nn::util::Color4u8</a>           g_MeterColor[ModelCount];</div>
<div class="line"></div>
<div class="line"><a name="_a5"></a><a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> g_CameraPosition;</div>
<div class="line"><a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> g_CameraUp;</div>
<div class="line"><a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> g_CameraTarget;</div>
<div class="line"></div>
<div class="line"><a name="_a6"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html">nns::g3d::RenderView</a>    g_RenderView;</div>
<div class="line">g3ddemo::ResourceHolder g_Holder;</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> g_BufferingCount = 2;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> g_InvalidIndex = -1;</div>
<div class="line"></div>
<div class="line"><span class="comment">// アニメーションをベイクするかどうかのフラグ</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">bool</span> g_BakeAnimEnabled = <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> ResetAnim()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> animIndex = 0; animIndex &lt; AnimIndexCount; ++animIndex)</div>
<div class="line">    {</div>
<div class="line">        <a name="_a7"></a><a class="code" href="classnn_1_1g3d_1_1_res_skeletal_anim.html">nn::g3d::ResSkeletalAnim</a>* pNewResAnim = NULL;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> holderAnimIndex = 0; holderAnimIndex &lt; g_Holder.modelAnims.GetCount(); holderAnimIndex++)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="classnn_1_1g3d_1_1_res_skeletal_anim.html">nn::g3d::ResSkeletalAnim</a>* pTmpAnim = <span class="keyword">reinterpret_cast&lt;</span><a class="code" href="classnn_1_1g3d_1_1_res_skeletal_anim.html">nn::g3d::ResSkeletalAnim</a>*<span class="keyword">&gt;</span>(g_Holder.modelAnims[holderAnimIndex]);</div>
<div class="line">            <span class="keywordflow">if</span> (strcmp(GetSelectedAnimationPreset()-&gt;name[animIndex], pTmpAnim-&gt;<a name="a8"></a><a class="code" href="classnn_1_1g3d_1_1_res_skeletal_anim.html#ae877f741fd5fe24b8dfa4893c0e88885">GetName</a>()) == 0)</div>
<div class="line">            {</div>
<div class="line">                pNewResAnim = pTmpAnim;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (pNewResAnim)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> modelIndex = 0; modelIndex &lt; ModelCount; ++modelIndex)</div>
<div class="line">            {</div>
<div class="line">                <span class="comment">// アニメーションを再生するモデルのスケルトンリソースをバインド</span></div>
<div class="line">                <a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_obj.html">nn::g3d::SkeletalAnimObj</a>* pSkeletalAnimObj = g_pSkeletalAnimObjArray[modelIndex][animIndex];</div>
<div class="line">                pSkeletalAnimObj-&gt;<a name="a9"></a><a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_obj.html#a30929e05d9aa083b436c2eb31c042a8e">SetResource</a>(pNewResAnim);</div>
<div class="line">                nn::g3d::SkeletalAnimObj::BindArgument bindArg;</div>
<div class="line">                bindArg.SetResource(g_pRenderModelObj[modelIndex]-&gt;GetRenderModel()-&gt;GetResModel()-&gt;GetSkeleton());</div>
<div class="line">                <span class="keywordflow">switch</span> (modelIndex)</div>
<div class="line">                {</div>
<div class="line">                <span class="keywordflow">case</span> Model_Pierrot:</div>
<div class="line">                    {</div>
<div class="line">                        <span class="comment">// Pierrot モデルは PreBind しているので高速な BindFast が可能</span></div>
<div class="line">                        pSkeletalAnimObj-&gt;<a name="a10"></a><a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_obj.html#afccb5b5714bed901fa8e9cb3d0d8e81b">BindFast</a>(bindArg);</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> Model_Robot:</div>
<div class="line">                    {</div>
<div class="line">                        <span class="keywordflow">if</span> (IsRetargetingEnabled())</div>
<div class="line">                        {</div>
<div class="line">                            <span class="comment">// リターゲティング有効の場合は host に Pierrot リソースを指定する</span></div>
<div class="line">                            bindArg.SetHostResource(g_pRenderModelObj[Model_Pierrot]-&gt;GetRenderModel()-&gt;GetResModel()-&gt;GetSkeleton());</div>
<div class="line">                            bindArg.SetRetargetingEnabled();</div>
<div class="line">                        }</div>
<div class="line">                        pSkeletalAnimObj-&gt;<a name="a11"></a><a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_obj.html#a4b977f30de1ee941d20c02822f6aefdc">Bind</a>(bindArg);</div>
<div class="line">                    }</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">default</span>:</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                }</div>
<div class="line">                pSkeletalAnimObj-&gt;<a name="a12"></a><a class="code" href="classnn_1_1g3d_1_1_anim_obj.html#ac2f590c6bdb160d6e7b7e640826b4362">GetFrameCtrl</a>().<a name="a13"></a><a class="code" href="classnn_1_1g3d_1_1_anim_frame_ctrl.html#acc8290c7f3020efa545336804fbb7ea0">SetStep</a>(GetAnimStep());</div>
<div class="line">                pSkeletalAnimObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_anim_obj.html#ac2f590c6bdb160d6e7b7e640826b4362">GetFrameCtrl</a>().<a name="a14"></a><a class="code" href="classnn_1_1g3d_1_1_anim_frame_ctrl.html#af7022b2827d078b2f8972664c9f28fdc">SetFrame</a>(0.f);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> modelIndex = 0; modelIndex &lt; ModelCount; ++modelIndex)</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_obj.html">nn::g3d::SkeletalAnimObj</a>* pSkeletalAnimObj = g_pSkeletalAnimObjArray[modelIndex][animIndex];</div>
<div class="line">                g_pRenderModelObj[modelIndex]-&gt;<a name="a15"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#aa0a852cc2943033071f80f6660185518">GetModelObj</a>()-&gt;<a name="a16"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#af8c5bbd80c73ab37280e7505ea4a0292">GetSkeleton</a>()-&gt;<a name="a17"></a><a class="code" href="classnn_1_1g3d_1_1_skeleton_obj.html#af51584c59f1b48f4b3cfe9a203edfa7f">ClearLocalMtx</a>();</div>
<div class="line">                pSkeletalAnimObj-&gt;<a name="a18"></a><a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_obj.html#a263858de97acb3167a430e806b4a7c87">ResetResource</a>();</div>
<div class="line">                pSkeletalAnimObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_anim_obj.html#ac2f590c6bdb160d6e7b7e640826b4362">GetFrameCtrl</a>().<a class="code" href="classnn_1_1g3d_1_1_anim_frame_ctrl.html#af7022b2827d078b2f8972664c9f28fdc">SetFrame</a>(0.f);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> CalculateAnim(<span class="keywordtype">int</span> modelIndex)</div>
<div class="line">{</div>
<div class="line">    <a name="_a19"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html">nn::g3d::ModelObj</a>* pModelObj = g_pRenderModelObj[modelIndex]-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#aa0a852cc2943033071f80f6660185518">GetModelObj</a>();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// アニメーション更新</span></div>
<div class="line">    <span class="keywordtype">int</span> singleAnimIndex = g_InvalidIndex;</div>
<div class="line">    <span class="keywordtype">int</span> skeletalAnimCount = 0;</div>
<div class="line">    <span class="keywordtype">float</span> weightSum = 0.0f;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 有効アニメーション数と weight 値の計算</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> animIndex = 0; animIndex &lt; AnimIndexCount; ++animIndex)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (g_pSkeletalAnimObjArray[modelIndex][animIndex]-&gt;IsTargetBound())</div>
<div class="line">        {</div>
<div class="line">            ++skeletalAnimCount;</div>
<div class="line">            weightSum += GetSelectedAnimationPreset()-&gt;weight[animIndex];</div>
<div class="line">            singleAnimIndex = animIndex;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (skeletalAnimCount == 1)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// 単一スロットのアニメーションが有効な場合は単独再生</span></div>
<div class="line">        <a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_obj.html">nn::g3d::SkeletalAnimObj</a>* pSkeletalAnimObj = g_pSkeletalAnimObjArray[modelIndex][singleAnimIndex];</div>
<div class="line">        pSkeletalAnimObj-&gt;<a name="a20"></a><a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_obj.html#acc065d1a4d967a187d6fad7449a238b8">Calculate</a>();</div>
<div class="line">        pSkeletalAnimObj-&gt;<a name="a21"></a><a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_obj.html#ae6fcca63c801268f0c9350b4053ff150">ApplyTo</a>(pModelObj);</div>
<div class="line">        pSkeletalAnimObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_anim_obj.html#ac2f590c6bdb160d6e7b7e640826b4362">GetFrameCtrl</a>().<a name="a22"></a><a class="code" href="classnn_1_1g3d_1_1_anim_frame_ctrl.html#a1ebbe648949363e3f96d7c2c040bd9eb">UpdateFrame</a>();</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (skeletalAnimCount &gt; 1)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// 複数スロットのアニメーションが有効な場合はブレンド再生を行う</span></div>
<div class="line">        <span class="comment">// 合計 weight 値が 1 になっていない場合 nn::g3d::SkeletalAnimBlender::ApplyTo() 内で正規化されるが</span></div>
<div class="line">        <span class="comment">// 正規化の処理コストが高くつくため、アプリ側で weight 値の合計を 1 にしておく</span></div>
<div class="line">        <a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_blender.html">nn::g3d::SkeletalAnimBlender</a>&amp; blender = g_SkeletalAnimBlender[modelIndex];</div>
<div class="line">        <span class="keywordtype">float</span> invWeightSum = <a name="a23"></a><a class="code" href="namespacenn_1_1util.html#aee333695e4a66942a628f67d238c5fb3">nn::util::Rcp</a>(weightSum);</div>
<div class="line">        blender.<a name="a24"></a><a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_blender.html#a8a41ecdf8f6890437a1122869f5477e0">ClearResult</a>();</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> animIndex = 0; animIndex &lt; AnimIndexCount; ++animIndex)</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_obj.html">nn::g3d::SkeletalAnimObj</a>* pSkeletalAnimObj = g_pSkeletalAnimObjArray[modelIndex][animIndex];</div>
<div class="line">            <span class="keywordflow">if</span> (pSkeletalAnimObj-&gt;<a name="a25"></a><a class="code" href="classnn_1_1g3d_1_1_model_anim_obj.html#a08ce09f133737cb0bfd81b8657d4332e">IsTargetBound</a>())</div>
<div class="line">            {</div>
<div class="line">                blender.<a name="a26"></a><a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_blender.html#a62c4d496d0b47d42f6c4a8c956ae5fe8">Blend</a>(pSkeletalAnimObj, GetSelectedAnimationPreset()-&gt;weight[animIndex] * invWeightSum);</div>
<div class="line">                pSkeletalAnimObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_anim_obj.html#ac2f590c6bdb160d6e7b7e640826b4362">GetFrameCtrl</a>().<a class="code" href="classnn_1_1g3d_1_1_anim_frame_ctrl.html#a1ebbe648949363e3f96d7c2c040bd9eb">UpdateFrame</a>();</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        blender.<a name="a27"></a><a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_blender.html#a9294646df1ae71b3c2bf24ca93202217">ApplyTo</a>(pModelObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_model_obj.html#af8c5bbd80c73ab37280e7505ea4a0292">GetSkeleton</a>());</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> Calculate(<a name="_a28"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html">nns::gfx::GraphicsFramework</a>* pGfxFramework, <span class="keywordtype">void</span>* pUserData)</div>
<div class="line">{</div>
<div class="line">    <a name="a29"></a><a class="code" href="nn___macro_8h.html#af2d1673769927c5eae977d8dde3ce106">NN_UNUSED</a>(pGfxFramework);</div>
<div class="line">    <span class="keywordtype">int</span> uniformBufferIndex = *<span class="keyword">reinterpret_cast&lt;</span><span class="keywordtype">int</span>*<span class="keyword">&gt;</span>(pUserData);</div>
<div class="line">    g3ddemo::Pad&amp; pad = g3ddemo::GetPad();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// メニューの更新 &amp; メニューで選択されたアニメーションの切り替え</span></div>
<div class="line">    <span class="keywordflow">switch</span> (CalculateMenu(pad))</div>
<div class="line">    {</div>
<div class="line">    <span class="keywordflow">case</span> MenuResult_ChangeSelectedAnim:</div>
<div class="line">        {</div>
<div class="line">            ResetAnim();</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> MenuResult_ChangeAnimStep:</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> modelIndex = 0; modelIndex &lt; ModelCount; ++modelIndex)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> animIndex = 0; animIndex &lt; AnimIndexCount; ++animIndex)</div>
<div class="line">                {</div>
<div class="line">                    g_pSkeletalAnimObjArray[modelIndex][animIndex]-&gt;<a class="code" href="classnn_1_1g3d_1_1_anim_obj.html#ac2f590c6bdb160d6e7b7e640826b4362">GetFrameCtrl</a>().<a class="code" href="classnn_1_1g3d_1_1_anim_frame_ctrl.html#acc8290c7f3020efa545336804fbb7ea0">SetStep</a>(GetAnimStep());</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// カメラコントロール</span></div>
<div class="line">    ControlCamera(&amp;g_CameraPosition, &amp;g_CameraUp, &amp;g_CameraTarget, &amp;g_RenderView.<a name="a30"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#aff24f2ebd999e9d9f423945fa9d4e8e0">GetViewMtx</a>(0), &amp;pad);</div>
<div class="line">    <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x3f_type.html">nn::util::Matrix4x3fType</a> viewMatrix;</div>
<div class="line">    MatrixLookAtRightHanded(&amp;viewMatrix,</div>
<div class="line">        g_CameraPosition,</div>
<div class="line">        g_CameraTarget,</div>
<div class="line">        g_CameraUp);</div>
<div class="line">    g_RenderView.<a name="a31"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#a5b633742724f63bffdb11389a06b974b">SetViewMtx</a>(0, viewMatrix);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 投影行列</span></div>
<div class="line">    <a name="_a32"></a><a class="code" href="structnn_1_1util_1_1_matrix_row_major4x4f_type.html">nn::util::Matrix4x4fType</a> projectionMatrix;</div>
<div class="line">    MatrixPerspectiveFieldOfViewRightHanded(&amp;projectionMatrix, <a name="a33"></a><a class="code" href="namespacenn_1_1util.html#a342713848fbb4ce6750da90d297bc824">nn::util::DegreeToRadian</a>(45.0f), 16.0f / 9.0f, 10.0f, 40000.0f);</div>
<div class="line">    g_RenderView.<a name="a34"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#ab2d9de5f49ec96d7672389badb1acf46">SetProjectionMtx</a>(0, projectionMatrix);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ビューの更新処理</span></div>
<div class="line">    g_RenderView.<a name="a35"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#aea54457661666de292743fe0cb6c75a0">Calculate</a>(uniformBufferIndex);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// モデルの更新処理</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> modelIndex = 0; modelIndex &lt; ModelCount; ++modelIndex)</div>
<div class="line">    {</div>
<div class="line">        <a name="a36"></a><a class="code" href="perf___profile_8h.html#ac0cbbec62451185954e3e6a11cac2fa8">NN_PERF_SET_COLOR</a>(g_MeterColor[modelIndex]);</div>
<div class="line">        <a name="a37"></a><a class="code" href="perf___profile_8h.html#a39fa663adaf42d4eb3d3aadd33f9957d">NN_PERF_AUTO_MEASURE</a>();</div>
<div class="line">        <a class="code" href="classnn_1_1g3d_1_1_model_obj.html">nn::g3d::ModelObj</a>* pModelObj = g_pRenderModelObj[modelIndex]-&gt;<a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#aa0a852cc2943033071f80f6660185518">GetModelObj</a>();</div>
<div class="line"></div>
<div class="line">        <span class="comment">// アニメーション更新</span></div>
<div class="line">        CalculateAnim(modelIndex);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// ワールド座標更新</span></div>
<div class="line">        pModelObj-&gt;<a name="a38"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#ab774452bb7729bd5b964056476dec55d">CalculateWorld</a>(g_BaseMtx[modelIndex]);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// ユニフォームブロック更新</span></div>
<div class="line">        pModelObj-&gt;<a name="a39"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a8be53fd1232ac0ee1ed4041f8aabd7d2">CalculateView</a>(0, g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#aff24f2ebd999e9d9f423945fa9d4e8e0">GetViewMtx</a>(0), uniformBufferIndex);</div>
<div class="line">        pModelObj-&gt;<a name="a40"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a674b6b3417778ae519cf3bc6d6f5ff65">CalculateMaterial</a>(uniformBufferIndex);</div>
<div class="line">        pModelObj-&gt;<a name="a41"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#adef78f87e8b217936ccb27f0b4e1a46c">CalculateSkeleton</a>(uniformBufferIndex);</div>
<div class="line">        pModelObj-&gt;<a name="a42"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a79b51e82adb59599c0ec443bd1041d55">CalculateShape</a>(uniformBufferIndex);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> MakeCommand(<a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html">nns::gfx::GraphicsFramework</a>* pGfxFramework, <span class="keywordtype">int</span> bufferIndex, <span class="keywordtype">void</span>* pUserData)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> uniformBufferIndex = *<span class="keyword">reinterpret_cast&lt;</span><span class="keywordtype">int</span>*<span class="keyword">&gt;</span>(pUserData);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// コマンド生成</span></div>
<div class="line">    pGfxFramework-&gt;<a name="a43"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a1682d81714db542ef9bb6aae8908b19f">BeginFrame</a>(bufferIndex);</div>
<div class="line">    {</div>
<div class="line">        <a name="_a44"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html">nn::gfx::CommandBuffer</a>* pCommandBuffer = pGfxFramework-&gt;<a name="a45"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a80b4defad13752d673db840e439d1a7f">GetRootCommandBuffer</a>(bufferIndex);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// カラーターゲットをクリア</span></div>
<div class="line">        <a name="_a46"></a><a class="code" href="classnn_1_1gfx_1_1_t_color_target_view.html">nn::gfx::ColorTargetView</a>* pColor = pGfxFramework-&gt;<a name="a47"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#ab825acf6f1e23e4946e8915d087a94a1">GetColorTargetView</a>();</div>
<div class="line">        pCommandBuffer-&gt;<a name="a48"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#a3da2d3c95fe888adb5a3f84dcc013d45">ClearColor</a>(pColor, 0.3f, 0.3f, 0.3f, 1.0f, <span class="keyword">nullptr</span>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// 深度ステンシルをクリア</span></div>
<div class="line">        <a name="_a49"></a><a class="code" href="classnn_1_1gfx_1_1_t_depth_stencil_view.html">nn::gfx::DepthStencilView</a>* pDepth = pGfxFramework-&gt;<a name="a50"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#ae375791c8ef66431a6910dafd0156bb2">GetDepthStencilView</a>();</div>
<div class="line">        pCommandBuffer-&gt;<a name="a51"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#ae51f685157847b92ffb0c05362a4a6ef">ClearDepthStencil</a>(pDepth, 1.0f, 0, <a name="a52"></a><a class="code" href="namespacenn_1_1gfx.html#a733cd65018ead22dd2cd0a62a8bd2ec9a93c09969027b90e4794060197dedb5fb">nn::gfx::DepthStencilClearMode_DepthStencil</a>, <span class="keyword">nullptr</span>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// レンダーターゲットをセット</span></div>
<div class="line">        pCommandBuffer-&gt;<a name="a53"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#a3698a1cbd3b59b649c048f709ddd766c">SetRenderTargets</a>(1, &amp;pColor, pDepth);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// ビューポートシザーステートをセット</span></div>
<div class="line">        pCommandBuffer-&gt;<a name="a54"></a><a class="code" href="classnn_1_1gfx_1_1_t_command_buffer.html#ab1c541475f015777b8ce4bdfffe7c1c3">SetViewportScissorState</a>(pGfxFramework-&gt;<a name="a55"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#ae13f7a4f898b54ab4d566ee2d1aec56e">GetViewportScissorState</a>());</div>
<div class="line"></div>
<div class="line">        <span class="comment">// モデル表示 コマンド生成</span></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> modelIndex = 0; modelIndex &lt; g_Holder.renderModelObjs.GetCount(); ++modelIndex)</div>
<div class="line">        {</div>
<div class="line">            <a name="a56"></a><a class="code" href="perf___profile_8h.html#af2d54f7bfca84e3d33b2009f6334f169">NN_PERF_SET_COLOR_GPU</a>(g_MeterColor[modelIndex]);</div>
<div class="line">            <a name="a57"></a><a class="code" href="perf___profile_8h.html#a1401127601eef2f70a9916b2fbbf5b4a">NN_PERF_BEGIN_MEASURE_GPU</a>(pCommandBuffer);</div>
<div class="line">            g_Holder.renderModelObjs[modelIndex]-&gt;Draw(pCommandBuffer, 0, uniformBufferIndex);</div>
<div class="line">            <a name="a58"></a><a class="code" href="perf___profile_8h.html#a5289e91681166ba39ce97d6eb116c59d">NN_PERF_END_MEASURE_GPU</a>(pCommandBuffer);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// スケルトンデバッグ描画</span></div>
<div class="line">        <span class="keywordflow">if</span> (IsViewSkeletonEnabled())</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> index = 0; index &lt; g_Holder.renderModelObjs.GetCount(); ++index)</div>
<div class="line">            {</div>
<div class="line">                <a name="_a59"></a><a class="code" href="classnn_1_1g3d_1_1_skeleton_obj.html">nn::g3d::SkeletonObj</a>* skeletonObj = g_Holder.renderModelObjs[index]-&gt;GetModelObj()-&gt;GetSkeleton();</div>
<div class="line">                DrawSkeleton(pCommandBuffer, skeletonObj);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// テキスト表示 コマンド生成</span></div>
<div class="line">        DrawMenu(pCommandBuffer);</div>
<div class="line">    }</div>
<div class="line">    pGfxFramework-&gt;<a name="a60"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#ae8a95943cd296bb2ad8ab6e6532b7b0e">EndFrame</a>(bufferIndex);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* CreateRenderModelObj(<a name="_a61"></a><a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice, <a name="_a62"></a><a class="code" href="classnn_1_1g3d_1_1_res_model.html">nn::g3d::ResModel</a>* pResModel, <a name="_a63"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_archive.html">nn::g3d::ResShaderArchive</a>* pDemoShaderArchive)</div>
<div class="line">{</div>
<div class="line">    <a name="_a64"></a><a class="code" href="classnns_1_1g3d_1_1_render_model.html">nns::g3d::RenderModel</a>* pRenderModel = <a name="a65"></a><a class="code" href="namespacenns_1_1g3d.html#aa1c714afc7a0cf4a993dcbc6774f1643">nns::g3d::CreateRenderModel</a>(pDevice, pResModel);</div>
<div class="line">    pRenderModel-&gt;<a name="a66"></a><a class="code" href="classnns_1_1g3d_1_1_render_model.html#aa157d2168a767b3333c62aa5cc120973">CreateDrawPass</a>(pDevice, pDemoShaderArchive);</div>
<div class="line">    g_Holder.renderModels.PushBack(pRenderModel);</div>
<div class="line"></div>
<div class="line">    <a name="_a67"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj_1_1_builder.html">nn::g3d::ModelObj::Builder</a> builder(pResModel);</div>
<div class="line">    builder.<a name="a68"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj_1_1_initialize_argument.html#acd583ad430a0d87edc34259daedb7cff">ShapeBufferingCount</a>(g_BufferingCount);</div>
<div class="line">    builder.<a name="a69"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj_1_1_initialize_argument.html#ae2d93db7573a8afa3a576d94651f9e80">SkeletonBufferingCount</a>(g_BufferingCount);</div>
<div class="line">    builder.<a name="a70"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj_1_1_initialize_argument.html#a4487cd834e5a84490ab47745b420169a">MaterialBufferingCount</a>(g_BufferingCount);</div>
<div class="line">    <a class="code" href="classnn_1_1g3d_1_1_model_obj.html">nn::g3d::ModelObj</a>* pModelObj = <a name="a71"></a><a class="code" href="namespacenns_1_1g3d.html#ae7cfdc41c478154e34bc8350851099ac">nns::g3d::CreateModelObj</a>(pDevice, builder);</div>
<div class="line">    g_Holder.modelObjs.PushBack(pModelObj);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html">nns::g3d::RenderModelObj</a>* pRenderModelObj = <a name="a72"></a><a class="code" href="namespacenns_1_1g3d.html#a4d8d828fb260a742ceca742312144c68">nns::g3d::CreateRenderModelObj</a>(pModelObj, pRenderModel);</div>
<div class="line">    g_Holder.renderModelObjs.PushBack(pRenderModelObj);</div>
<div class="line">    g3ddemo::WriteSkinningOption(pRenderModelObj);</div>
<div class="line">    pRenderModelObj-&gt;<a name="a73"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a2abf914afb4d7489f87c6ea7a3fe5ac1">UpdateShader</a>(pDevice);</div>
<div class="line">    <span class="keywordflow">return</span> pRenderModelObj;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// モデル * スロット数分の SkeletalAnimObj 、モデル数分の SkeletalAnimBlender を作成する。</span></div>
<div class="line"><span class="comment">// 本サンプルでは、SkeletalAnimObj の初期化時に、再生し得るアニメーションリソースを再生できるメモリを確保しておき</span></div>
<div class="line"><span class="comment">// 描画ループ内で skeletalAnimObj が再生するアニメーションを切り替える方法を取る</span></div>
<div class="line"><span class="keywordtype">void</span> InitializeSkeletalAnimObj(<a name="_a74"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html">nn::g3d::ResFile</a>* pResFile)</div>
<div class="line">{</div>
<div class="line">    <a name="_a75"></a><a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_obj_1_1_builder.html">nn::g3d::SkeletalAnimObj::Builder</a> builderBase;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> animIndex = 0; animIndex &lt; pResFile-&gt;<a name="a76"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html#ab9cbf0edd85d1823c1f298ba4e29e109">GetSkeletalAnimCount</a>(); ++animIndex)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnn_1_1g3d_1_1_res_skeletal_anim.html">nn::g3d::ResSkeletalAnim</a>* pAnim = pResFile-&gt;<a name="a77"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html#ae13da380c5e44f3395e5b9054d4ce928">GetSkeletalAnim</a>(animIndex);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// アニメーションのベイク</span></div>
<div class="line">        <span class="keywordflow">if</span> (g_BakeAnimEnabled)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">size_t</span> bakeSize = pAnim-&gt;<a name="a78"></a><a class="code" href="classnn_1_1g3d_1_1_res_skeletal_anim.html#a2c92dee5c22f0794c6ca9a9359737b9f">GetBakedSize</a>();</div>
<div class="line">            <span class="keywordtype">void</span>* pBakeBuffer = <a name="a79"></a><a class="code" href="namespacenns_1_1g3d.html#a1a215a2fdfabe9aa8b6b70c639e9fd56">nns::g3d::Allocate</a>(bakeSize);</div>
<div class="line">            <span class="keywordtype">bool</span> isSucceed = pAnim-&gt;<a name="a80"></a><a class="code" href="classnn_1_1g3d_1_1_res_skeletal_anim.html#a76307ed132c51970498d6f08851534a0">BakeCurve</a>(pBakeBuffer, bakeSize);</div>
<div class="line">            <a name="a81"></a><a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(isSucceed);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// 全てのアニメーションリソースをあらかじめ SkeletalAnimObj の builer に Reserve しておく</span></div>
<div class="line">        <span class="comment">// そうすることで SkeletalAnimObj を作り直すことなく、SkeletalAnimObj::SetResource() で再生するアニメーションリソースの切り替えが可能</span></div>
<div class="line">        builderBase.<a name="a82"></a><a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_obj_1_1_initialize_argument.html#a0edde22a9eb68a26b6d9f979ef303478">Reserve</a>(pAnim);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// 高速 Bind のためアニメーションリソースに Pierrot モデルを PreBind しておく</span></div>
<div class="line">        pAnim-&gt;<a name="a83"></a><a class="code" href="classnn_1_1g3d_1_1_res_skeletal_anim.html#a51341e31cf67f0332596d16efc74c742">PreBind</a>(g_pRenderModelObj[Model_Pierrot]-&gt;GetRenderModel()-&gt;GetResModel()-&gt;GetSkeleton());</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// モデル * スロット数分の SkeletalAnimObj を作成</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> modelIndex = 0; modelIndex &lt; ModelCount; ++modelIndex)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnn_1_1g3d_1_1_res_model.html">nn::g3d::ResModel</a>* pResModel = g_pRenderModelObj[modelIndex]-&gt;<a name="a84"></a><a class="code" href="classnns_1_1g3d_1_1_render_model_obj.html#a17b469fd1d5951075d68febca8f45294">GetRenderModel</a>()-&gt;<a name="a85"></a><a class="code" href="classnns_1_1g3d_1_1_render_model.html#a8a79574afbd1af521b7dedbc75b5e376">GetResModel</a>();</div>
<div class="line">        <a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_obj_1_1_builder.html">nn::g3d::SkeletalAnimObj::Builder</a> builder = builderBase;</div>
<div class="line">        builder.<a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_obj_1_1_initialize_argument.html#a0edde22a9eb68a26b6d9f979ef303478">Reserve</a>(pResModel);</div>
<div class="line">        <span class="comment">// Robot はリターゲティングを行う設定にしておく</span></div>
<div class="line">        <span class="keywordflow">if</span> (modelIndex == Model_Robot)</div>
<div class="line">        {</div>
<div class="line">            builder.<a name="a86"></a><a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_obj_1_1_initialize_argument.html#a218b507af0560c97b68f827e7d14b3a4">SetRetargetingEnabled</a>();</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> animIndex = 0; animIndex &lt; AnimIndexCount; ++animIndex)</div>
<div class="line">        {</div>
<div class="line">            g_pSkeletalAnimObjArray[modelIndex][animIndex] = nns::g3d::CreateAnimObj&lt;nn::g3d::SkeletalAnimObj&gt;(builder);</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">// SkeletalAnimBlender の設定</span></div>
<div class="line">        <a name="_a87"></a><a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_blender_1_1_builder.html">nn::g3d::SkeletalAnimBlender::Builder</a> skeletalAnimBlenderBuilder;</div>
<div class="line">        skeletalAnimBlenderBuilder.<a name="a88"></a><a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_blender_1_1_initialize_argument.html#a2a078c8a63d913e13ff86531b4665569">Reserve</a>(pResModel);</div>
<div class="line">        skeletalAnimBlenderBuilder.<a name="a89"></a><a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_blender_1_1_initialize_argument.html#af44baa319697fc82dca449dc804d1f55">CalculateMemorySize</a>();</div>
<div class="line">        <span class="keywordtype">size_t</span> bufferSize = skeletalAnimBlenderBuilder.<a name="a90"></a><a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_blender_1_1_initialize_argument.html#aa3e1d6c7c6614c02e41f757aaeef154e">GetWorkMemorySize</a>();</div>
<div class="line">        <span class="keywordtype">void</span>* pBlendBuffer = <a class="code" href="namespacenns_1_1g3d.html#a1a215a2fdfabe9aa8b6b70c639e9fd56">nns::g3d::Allocate</a>(bufferSize, <a name="a91"></a><a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_blender.html#adaf68873bc087049b95ef9dab866c92aa743ac14b086b047dd87bc6fcd07c877c">nn::g3d::SkeletalAnimBlender::Alignment_Buffer</a>);</div>
<div class="line">        skeletalAnimBlenderBuilder.<a name="a92"></a><a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_blender_1_1_builder.html#af9a2d5c5d209af5637fb6a3f1c58f17b">Build</a>(&amp;g_SkeletalAnimBlender[modelIndex], pBlendBuffer, bufferSize);</div>
<div class="line">        g_SkeletalAnimBlender[modelIndex].<a name="a93"></a><a class="code" href="classnn_1_1g3d_1_1_skeletal_anim_blender.html#ae12ed39be0d2fec652578726b62c4e2f">SetBoneCount</a>(pResModel-&gt;<a name="a94"></a><a class="code" href="classnn_1_1g3d_1_1_res_model.html#a100e334fb903c3678b678b5cea008c94">GetSkeleton</a>()-&gt;<a name="a95"></a><a class="code" href="classnn_1_1g3d_1_1_res_skeleton.html#a0b888ffca985de6bbdd0ebff9fd0db75">GetBoneCount</a>());</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="namespacenn_1_1htcs.html#a7eab72b8843a2a9ff763f52b78da680e">Initialize</a>()</div>
<div class="line">{</div>
<div class="line">    nns::gfx::DebugGraphicsFramework* pGfxFramework = g3ddemo::GetGfxFramework();</div>
<div class="line">    pGfxFramework-&gt;SetFrameworkMode(<a name="a96"></a><a class="code" href="classnns_1_1gfx_1_1_graphics_framework.html#a4987555fae0e257658ffef4beb51a674a6d2e6861717e82c71ea532bf89e5b1f0">nns::gfx::GraphicsFramework::FrameworkMode_DeferredSubmission</a>);</div>
<div class="line">    <a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice = pGfxFramework-&gt;GetDevice();</div>
<div class="line">    pGfxFramework-&gt;InitializePerf();</div>
<div class="line"><span class="preprocessor">#if defined( NN_BUILD_CONFIG_OS_WIN )</span></div>
<div class="line">    <a name="a97"></a><a class="code" href="perf___profile_8h.html#a3506f976dd0501c40d1605db7811ceed">NN_PERF_SET_GET_CORE_NUMBER_FUNCTION</a>(g3ddemo::GetFixedCoreNumber);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    <a name="a98"></a><a class="code" href="namespacenn_1_1os.html#ac50b86561c15ee3e8195c83fddc8e732">nn::os::SetThreadCoreMask</a>(<a name="a99"></a><a class="code" href="namespacenn_1_1os.html#ad106866a5b13bc3d430104333966b479">nn::os::GetCurrentThread</a>(), 0, 1);</div>
<div class="line"></div>
<div class="line">    g_Holder.Initialize();</div>
<div class="line">    InitializeMenu(pDevice);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// シェーダーアーカイブの初期化</span></div>
<div class="line">    <a class="code" href="classnn_1_1g3d_1_1_res_shader_archive.html">nn::g3d::ResShaderArchive</a>* pDemoShaderArchive;</div>
<div class="line">    {</div>
<div class="line">        <a name="_a100"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_file.html">nn::g3d::ResShaderFile</a>* pFile = g3ddemo::LoadResource&lt;nn::g3d::ResShaderFile&gt;(g_BfshaPath);</div>
<div class="line">        pFile-&gt;<a name="a101"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_file.html#a6ca625333d1fb3f4b903d0ee4533666c">Setup</a>(pDevice);</div>
<div class="line">        g_Holder.shaderFiles.PushBack(pFile);</div>
<div class="line">        pDemoShaderArchive = pFile-&gt;<a name="a102"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_file.html#ab2a9392d9a139efe97b011ac5aec96c4">GetResShaderArchive</a>();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 環境モデルリソースの初期化</span></div>
<div class="line">    <a class="code" href="classnn_1_1g3d_1_1_res_file.html">nn::g3d::ResFile</a>* pEnvModelFile;</div>
<div class="line">    {</div>
<div class="line">        pEnvModelFile = g3ddemo::LoadResource&lt;nn::g3d::ResFile&gt;(g_EnvBfresPath);</div>
<div class="line">        pEnvModelFile-&gt;<a name="a103"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html#afeaf3b666d229f4e30fe374ee5707909">Setup</a>(pDevice);</div>
<div class="line">        g_Holder.files.PushBack(pEnvModelFile);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// モデルリソースの初期化</span></div>
<div class="line">    <a class="code" href="classnn_1_1g3d_1_1_res_file.html">nn::g3d::ResFile</a>* pPierrotModelFile;</div>
<div class="line">    {</div>
<div class="line">        pPierrotModelFile = g3ddemo::LoadResource&lt;nn::g3d::ResFile&gt;(g_ModelBfresPath);</div>
<div class="line">        pPierrotModelFile-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_file.html#afeaf3b666d229f4e30fe374ee5707909">Setup</a>(pDevice);</div>
<div class="line">        g3ddemo::SetupTexture(pDevice, pPierrotModelFile, g3ddemo::TextureBindCallback);</div>
<div class="line">        g3ddemo::RegisterSamplerToDescriptorPool(pPierrotModelFile);</div>
<div class="line">        g_Holder.files.PushBack(pPierrotModelFile);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// モデルの初期化</span></div>
<div class="line">    g_pRenderModelObj[Model_Pierrot] = CreateRenderModelObj(pDevice, pPierrotModelFile-&gt;<a name="a104"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html#aea207d962515bd832f33b3efd734ccbc">FindModel</a>(<span class="stringliteral">&quot;Pierrot&quot;</span>), pDemoShaderArchive);</div>
<div class="line">    g_pRenderModelObj[Model_Robot] = CreateRenderModelObj(pDevice, pPierrotModelFile-&gt;<a class="code" href="classnn_1_1g3d_1_1_res_file.html#aea207d962515bd832f33b3efd734ccbc">FindModel</a>(<span class="stringliteral">&quot;Robot&quot;</span>), pDemoShaderArchive);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// SkeletalAnimObj の初期化</span></div>
<div class="line">    InitializeSkeletalAnimObj(pPierrotModelFile);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// アニメーションリソースの登録</span></div>
<div class="line">    g3ddemo::RegistAnim(&amp;g_Holder);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// アニメーションの初期化</span></div>
<div class="line">    ResetAnim();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Env モデルの初期化</span></div>
<div class="line">    <a class="code" href="classnn_1_1g3d_1_1_model_obj.html">nn::g3d::ModelObj</a>* pEnvModelObj;</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnn_1_1g3d_1_1_res_model.html">nn::g3d::ResModel</a>* pResModel = pEnvModelFile-&gt;<a name="a105"></a><a class="code" href="classnn_1_1g3d_1_1_res_file.html#ab776cb75749d955956b5b2d4522da962">GetModel</a>(0);</div>
<div class="line">        <a name="a106"></a><a class="code" href="classnn_1_1g3d_1_1_shader_utility.html#a26b394ba1043958e5f64a6d6f25efe9b">nn::g3d::ShaderUtility::BindShaderParam</a>(pResModel-&gt;<a name="a107"></a><a class="code" href="classnn_1_1g3d_1_1_res_model.html#af57b0b32fc406e4c07a02133b0df1009">GetMaterial</a>(0), pDemoShaderArchive-&gt;<a name="a108"></a><a class="code" href="classnn_1_1g3d_1_1_res_shader_archive.html#a17c81d3fe346cbcc531ad38138b7117b">FindShadingModel</a>(<span class="stringliteral">&quot;env&quot;</span>));</div>
<div class="line">        <a class="code" href="classnn_1_1g3d_1_1_model_obj_1_1_builder.html">nn::g3d::ModelObj::Builder</a> builder(pResModel);</div>
<div class="line">        builder.MaterialBufferingCount(g_BufferingCount);</div>
<div class="line">        pEnvModelObj = <a class="code" href="namespacenns_1_1g3d.html#ae7cfdc41c478154e34bc8350851099ac">nns::g3d::CreateModelObj</a>(pDevice, builder);</div>
<div class="line">        pEnvModelObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a674b6b3417778ae519cf3bc6d6f5ff65">CalculateMaterial</a>(0);</div>
<div class="line">        pEnvModelObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a674b6b3417778ae519cf3bc6d6f5ff65">CalculateMaterial</a>(1);</div>
<div class="line">        g_Holder.modelObjs.PushBack(pEnvModelObj);</div>
<div class="line">        <span class="keyword">const</span> <a name="_a109"></a><a class="code" href="classnn_1_1gfx_1_1_t_buffer.html">nn::gfx::Buffer</a>* buffers[g_BufferingCount];</div>
<div class="line">        buffers[0] = pEnvModelObj-&gt;<a name="a110"></a><a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a225cda4a0e7881df5dc4ebb15ac6c6f6">GetMaterial</a>(0)-&gt;<a name="a111"></a><a class="code" href="classnn_1_1g3d_1_1_material_obj.html#aef15d5bfda74edf022aa6337f13d52ed">GetMaterialBlock</a>(0);</div>
<div class="line">        buffers[1] = pEnvModelObj-&gt;<a class="code" href="classnn_1_1g3d_1_1_model_obj.html#a225cda4a0e7881df5dc4ebb15ac6c6f6">GetMaterial</a>(0)-&gt;<a class="code" href="classnn_1_1g3d_1_1_material_obj.html#aef15d5bfda74edf022aa6337f13d52ed">GetMaterialBlock</a>(1);</div>
<div class="line">        g_pRenderModelObj[Model_Pierrot]-&gt;BindUniformBlock(<span class="stringliteral">&quot;env&quot;</span>, buffers, g_BufferingCount);</div>
<div class="line">        g_pRenderModelObj[Model_Robot]-&gt;BindUniformBlock(<span class="stringliteral">&quot;env&quot;</span>, buffers, g_BufferingCount);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ビュー用のユニフォームブロックを設定</span></div>
<div class="line">    g_RenderView.<a name="a112"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#a6520169e698d615f7cc77553e32ca88c">Initialize</a>(pDevice, 1, g_BufferingCount);</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="classnn_1_1gfx_1_1_t_buffer.html">nn::gfx::Buffer</a>* buffers[g_BufferingCount];</div>
<div class="line">        buffers[0] = g_RenderView.<a name="a113"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#ac12827c0d0788017a196ef5b80304304">GetViewUniformBlock</a>(0, 0);</div>
<div class="line">        buffers[1] = g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#ac12827c0d0788017a196ef5b80304304">GetViewUniformBlock</a>(0, 1);</div>
<div class="line">        g_pRenderModelObj[Model_Pierrot]-&gt;BindUniformBlock(<span class="stringliteral">&quot;view&quot;</span>, buffers, g_BufferingCount);</div>
<div class="line">        g_pRenderModelObj[Model_Robot]-&gt;BindUniformBlock(<span class="stringliteral">&quot;view&quot;</span>, buffers, g_BufferingCount);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// カメラ初期化</span></div>
<div class="line">    {</div>
<div class="line">        VectorSet(&amp;g_CameraPosition, 0, 110.f, 350.0f);</div>
<div class="line">        VectorSet(&amp;g_CameraUp, 0.0f, 1.0f, 0.0f);</div>
<div class="line">        VectorSet(&amp;g_CameraTarget, 0.0f, 110.f, 0.0f);</div>
<div class="line"></div>
<div class="line">        <a class="code" href="structnn_1_1util_1_1_matrix_row_major4x3f_type.html">nn::util::Matrix4x3fType</a> matrix;</div>
<div class="line">        MatrixLookAtRightHanded(&amp;matrix,</div>
<div class="line">            g_CameraPosition,</div>
<div class="line">            g_CameraTarget,</div>
<div class="line">            g_CameraUp);</div>
<div class="line">        g_RenderView.<a class="code" href="classnns_1_1g3d_1_1_render_view.html#a5b633742724f63bffdb11389a06b974b">SetViewMtx</a>(0, matrix);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// モデルの位置を設定</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> modelIndex = 0; modelIndex &lt; ModelCount; ++modelIndex)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="structnn_1_1util_1_1_vector3f_type.html">nn::util::Vector3fType</a> translate;</div>
<div class="line">        VectorSet(&amp;translate, -80.f + (modelIndex * 160.f), 0, 0.0f);</div>
<div class="line">        MatrixIdentity(&amp;g_BaseMtx[modelIndex]);</div>
<div class="line">        nn::util::MatrixSetTranslate(&amp;g_BaseMtx[modelIndex], translate);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// モデルのパフォーマンスメーターの色を設定</span></div>
<div class="line">    g_MeterColor[Model_Pierrot] = <a name="a114"></a><a class="code" href="classnn_1_1util_1_1_color4u8.html#a74cab22bd85f0940aec269c535ee5b54">nn::util::Color4u8::Red</a>();</div>
<div class="line">    g_MeterColor[Model_Robot] = <a name="a115"></a><a class="code" href="classnn_1_1util_1_1_color4u8.html#a5ad1502b37a61d84307433906727813c">nn::util::Color4u8::Blue</a>();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// シェーダーに必要なスクラッチメモリーを設定</span></div>
<div class="line">    g3ddemo::SetShaderScratchMemory(g_Holder.shaderFiles);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// メインループ</span></div>
<div class="line"><span class="keywordtype">void</span> MainLoop()</div>
<div class="line">{</div>
<div class="line">    nns::gfx::DebugGraphicsFramework* pGfxFramework = g3ddemo::GetGfxFramework();</div>
<div class="line">    <span class="keywordtype">int</span> uniformBufferIndex = 0;</div>
<div class="line">    pGfxFramework-&gt;SetCalculateCallback(Calculate, &amp;uniformBufferIndex);</div>
<div class="line">    pGfxFramework-&gt;SetMakeCommandCallback(MakeCommand, &amp;uniformBufferIndex);</div>
<div class="line">    pGfxFramework-&gt;ResetFrame();</div>
<div class="line"></div>
<div class="line">    g3ddemo::Pad&amp; pad = g3ddemo::GetPad();</div>
<div class="line">    pad.Reset();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (<a name="a116"></a><a class="code" href="nn___macro_8h.html#a71c0f58f6d49fe1392380eed4509ab9a">NN_STATIC_CONDITION</a>(1))</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// タッチ長押しで終了</span></div>
<div class="line">        <span class="keywordflow">if</span> (g3ddemo::isExitDemo())</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (!pad.Read() || pad.IsTriggered(g3ddemo::Pad::BUTTON_START))</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// フレーム処理実行</span></div>
<div class="line">        pGfxFramework-&gt;ProcessFrame();</div>
<div class="line"></div>
<div class="line">        uniformBufferIndex ^= 1;</div>
<div class="line">    }</div>
<div class="line">    pGfxFramework-&gt;QueueFinish();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="namespacenn_1_1htcs.html#abf5eb36f3563222450920fad56fdaf61">Finalize</a>()</div>
<div class="line">{</div>
<div class="line">    nns::gfx::DebugGraphicsFramework* pGfxFramework = g3ddemo::GetGfxFramework();</div>
<div class="line">    <a class="code" href="classnn_1_1gfx_1_1_t_device.html">nn::gfx::Device</a>* pDevice = pGfxFramework-&gt;GetDevice();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// ベイクしたバッファーの破棄</span></div>
<div class="line">    <span class="keywordflow">if</span> (g_BakeAnimEnabled)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> animIndex = 0; animIndex &lt; g_Holder.modelAnims.GetCount(); animIndex++)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">void</span>* ptr = g_Holder.modelAnims[animIndex];</div>
<div class="line">            <a class="code" href="classnn_1_1g3d_1_1_res_skeletal_anim.html">nn::g3d::ResSkeletalAnim</a>* pAnim = <span class="keyword">reinterpret_cast&lt;</span><a class="code" href="classnn_1_1g3d_1_1_res_skeletal_anim.html">nn::g3d::ResSkeletalAnim</a>*<span class="keyword">&gt;</span>(ptr);</div>
<div class="line">            <span class="keywordtype">void</span>* pBakeBuffer = pAnim-&gt;<a name="a117"></a><a class="code" href="classnn_1_1g3d_1_1_res_skeletal_anim.html#a1b2b5be2ced815bb51ae87beb0028798">ResetCurve</a>();</div>
<div class="line">            <a name="a118"></a><a class="code" href="namespacenns_1_1g3d.html#ac23ca3ba1949451319eb3bbaec93a93d">nns::g3d::Free</a>(pBakeBuffer);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 終了処理</span></div>
<div class="line">    g3ddemo::DestroyAll(pDevice, &amp;g_Holder);</div>
<div class="line">    g_RenderView.<a name="a119"></a><a class="code" href="classnns_1_1g3d_1_1_render_view.html#ae2461a77f4a4a5f2c954516604f35a9e">Finalize</a>(pDevice);</div>
<div class="line">    FinalizeMenu(pDevice);</div>
<div class="line">    pGfxFramework-&gt;FinalizePerf();</div>
<div class="line">    pGfxFramework-&gt;SetCalculateCallback(<span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>);</div>
<div class="line">    pGfxFramework-&gt;SetMakeCommandCallback(<span class="keyword">nullptr</span>, <span class="keyword">nullptr</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">}}}} <span class="comment">// namespace nn::g3d::demo::skeletalanim</span></div>
<div class="line"></div>
<div class="line"><span class="comment">//--------------------------------------------------------------------------------------------------</span></div>
<div class="line"><span class="keywordtype">int</span> SkeletalAnimationMain()</div>
<div class="line">{</div>
<div class="line">    g3ddemo::skeletalanim::Initialize();</div>
<div class="line">    g3ddemo::skeletalanim::MainLoop();</div>
<div class="line">    g3ddemo::skeletalanim::Finalize();</div>
<div class="line">    <span class="keywordflow">return</span> EXIT_SUCCESS;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
</body>
</html>
