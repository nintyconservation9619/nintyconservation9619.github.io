<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>NintendoSDK API Reference: FontllSaveToJpeg.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="openclose.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">NintendoSDK API Reference
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 構築: Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'検索');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>総合概要</span></a></li>
      <li><a href="pages.html"><span>諸情報</span></a></li>
      <li><a href="modules.html"><span>モジュール</span></a></li>
      <li><a href="namespaces.html"><span>名前空間</span></a></li>
      <li><a href="annotated.html"><span>クラス</span></a></li>
      <li><a href="files.html"><span>ファイル</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="検索" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">FontllSaveToJpeg.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>ソースコードの説明は、<a class="el" href="_page_sample_fontll_save_to_jpeg.html">FontllSaveToJpeg</a> および <a class="el" href="_fontll_save_to_jpeg_8cpp.html" title="Fontll ライブラリを用いてグリフ画像を生成するサンプルプログラム ">FontllSaveToJpeg.cpp</a> を参照してください。</p>
<div class="fragment"><div class="line"><span class="comment">/*--------------------------------------------------------------------------------*</span></div>
<div class="line"><span class="comment">  Copyright (C)Nintendo All rights reserved.</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  These coded instructions, statements, and computer programs contain proprietary</span></div>
<div class="line"><span class="comment">  information of Nintendo and/or its licensed developers and are protected by</span></div>
<div class="line"><span class="comment">  national and international copyright laws. They may not be disclosed to third</span></div>
<div class="line"><span class="comment">  parties or copied or duplicated in any form, in whole or in part, without the</span></div>
<div class="line"><span class="comment">  prior written consent of Nintendo.</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  The content herein is highly confidential and should be handled accordingly.</span></div>
<div class="line"><span class="comment"> *--------------------------------------------------------------------------------*/</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;malloc.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cstring&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;memory&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;algorithm&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="nn___log_8h.html">nn/nn_Log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="nn___abort_8h.html">nn/nn_Abort.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="nn___assert_8h.html">nn/nn_Assert.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="nn___macro_8h.html">nn/nn_Macro.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="fs_8h.html">nn/fs.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;nn/os.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;nn/fontll/fontll_ScalableFontEngine.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="image___jpeg_encoder_8h.html">nn/image/image_JpegEncoder.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;HostExecutableFilepath.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">namespace </span>{</div>
<div class="line"></div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> TextureHeight = 256;</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> TextureWidth  = 256;</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> TextureSize   = TextureHeight * TextureWidth;</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> FontSize      = 192;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> uint8_t BackgroundColor = 128;</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> uint8_t BaselingColor = 255;</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> uint8_t ToplineColor = 255;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// スケーラブルフォントエンジンに読み込む、ttf ファイル</span></div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">bool</span>       IsInputFontTTF    = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>*<span class="keyword">const</span> InputFontFileName = <span class="stringliteral">&quot;nintendo_NTLG-DB_002.bfttf&quot;</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">float</span> g_AscentRatio = 1.0f;</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">char</span>  g_MyFontNameBuffer[<a name="a0"></a><a class="code" href="namespacenn_1_1fontll.html#ad0330b5997e39ede5d75ad925a58cf3d">nn::fontll::FontNameLengthMax</a>];</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// グリフ画像を作成します</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> CreateGlyphImage(uint8_t* pDstBuff, <span class="keywordtype">size_t</span> dstBuffSize, <a name="_a1"></a><a class="code" href="classnn_1_1fontll_1_1_scalable_font_engine.html">nn::fontll::ScalableFontEngine</a>* pFontEngine, uint32_t charCode)</div>
<div class="line">{</div>
<div class="line">    <a name="a2"></a><a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(dstBuffSize &gt;= TextureSize);</div>
<div class="line">    <a name="a3"></a><a class="code" href="nn___macro_8h.html#af2d1673769927c5eae977d8dde3ce106">NN_UNUSED</a>(dstBuffSize);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// グリフビットマップを取得します。</span></div>
<div class="line">    <span class="comment">// エンジン内部ワークにビットマップを生成しています。</span></div>
<div class="line">    <span class="comment">// FormatGrayMap8 だけが指定可能です。</span></div>
<div class="line">    <a name="_a4"></a><a class="code" href="structnn_1_1fontll_1_1_glyph_map.html">nn::fontll::GlyphMap</a>* pMap = pFontEngine-&gt;<a name="a5"></a><a class="code" href="classnn_1_1fontll_1_1_scalable_font_engine.html#a4cbee09d481af1d14527f4748c66cb48">AcquireGlyphmap</a>(charCode, <a name="a6"></a><a class="code" href="namespacenn_1_1fontll.html#a1ad2dd32ec3cab2778cba958c00e7e38">nn::fontll::FormatGrayMap8</a>);</div>
<div class="line">    <a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(pMap != NULL);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 表示確認用に グリフビットマップ を テクスチャ にコピーします。</span></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// 全体をクリア</span></div>
<div class="line">        memset(pDstBuff, BackgroundColor, TextureSize);</div>
<div class="line"></div>
<div class="line">        <span class="comment">//const uint32_t cache_flush_size = pMap-&gt;width + 32;</span></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">int</span> font_ascent     = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(g_AscentRatio * FontSize + 0.5f);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">int</span> offsetFromTop   = std::max(font_ascent - pMap-&gt;<a name="a7"></a><a class="code" href="structnn_1_1fontll_1_1_glyph_map.html#aaac69c6ea55322aadcd71120195c3902">hiY</a>, 0);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">int</span> render_origin_y = offsetFromTop;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">int</span> render_origin_x = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>((TextureWidth - pMap-&gt;<a name="a8"></a><a class="code" href="structnn_1_1fontll_1_1_glyph_map.html#a5a115b3e3f30789d50a2c013d19909b8">width</a>) * 0.5 + pMap-&gt;<a name="a9"></a><a class="code" href="structnn_1_1fontll_1_1_glyph_map.html#a426dc7b2428972c1597f88d9c87d2d2e">loX</a>);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// ベースラインと、文字のトップにラインを描画する</span></div>
<div class="line">        memset(&amp;pDstBuff[(render_origin_y) * TextureWidth], BaselingColor, TextureWidth);</div>
<div class="line">        memset(&amp;pDstBuff[(font_ascent)     * TextureWidth], ToplineColor,  TextureWidth);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// エンジンが生成したグリフビットマップをテクスチャにコピーする</span></div>
<div class="line">        <span class="keywordflow">for</span> (int32_t l = 0; l &lt; pMap-&gt;<a name="a10"></a><a class="code" href="structnn_1_1fontll_1_1_glyph_map.html#a306f8a7da9c15e3029cd852200e2b41f">height</a>; l++)</div>
<div class="line">        {</div>
<div class="line">            uint8_t* line_start = &amp;pDstBuff[(l + render_origin_y) * TextureWidth + render_origin_x];</div>
<div class="line">            memcpy(line_start, &amp;pMap-&gt;<a name="a11"></a><a class="code" href="structnn_1_1fontll_1_1_glyph_map.html#ad204f91672151db29a391e51e83dff85">bits</a>[l * pMap-&gt;<a class="code" href="structnn_1_1fontll_1_1_glyph_map.html#a5a115b3e3f30789d50a2c013d19909b8">width</a>], pMap-&gt;<a class="code" href="structnn_1_1fontll_1_1_glyph_map.html#a5a115b3e3f30789d50a2c013d19909b8">width</a>);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// エンジンのグリフ情報を破棄します。</span></div>
<div class="line">    pFontEngine-&gt;<a name="a12"></a><a class="code" href="classnn_1_1fontll_1_1_scalable_font_engine.html#aa030c945f76110faa0acd74db4dd03b3">ReleasesGlyph</a>(pMap);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// Jpeg ファイルを保存します</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> SaveAsJpeg(<span class="keyword">const</span> <span class="keywordtype">char</span>* pFilePath, <span class="keywordtype">int</span> cx, <span class="keywordtype">int</span> cy, <span class="keywordtype">void</span>* pImage, <span class="keywordtype">size_t</span> imageSize)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="nn___macro_8h.html#af2d1673769927c5eae977d8dde3ce106">NN_UNUSED</a>(imageSize);</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">size_t</span> JpegBufSize = 1024 * 1024;</div>
<div class="line">    <span class="keywordtype">void</span>* jpegBuf = malloc(JpegBufSize);</div>
<div class="line">    <span class="keywordtype">size_t</span> jpegSize = 0;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Jpeg エンコードして jpegBuf に格納</span></div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="namespacenn_1_1image.html#a8c78190141f5d2997ea6dfdaac0730e3">nn::image::JpegStatus</a> result;</div>
<div class="line">        <a name="_a13"></a><a class="code" href="classnn_1_1image_1_1_jpeg_encoder.html">nn::image::JpegEncoder</a> encoder;</div>
<div class="line">        <a name="_a14"></a><a class="code" href="structnn_1_1image_1_1_dimension.html">nn::image::Dimension</a> dimension;</div>
<div class="line">        dimension.<a name="a15"></a><a class="code" href="structnn_1_1image_1_1_dimension.html#a22d3774aefe021c9b1712995e911cb6b">width</a>  = cx;</div>
<div class="line">        dimension.<a name="a16"></a><a class="code" href="structnn_1_1image_1_1_dimension.html#a66ca932bdd1a155f05b51572c0d88f75">height</a> = cy;</div>
<div class="line"></div>
<div class="line">        encoder.<a name="a17"></a><a class="code" href="classnn_1_1image_1_1_jpeg_encoder.html#a47c9917a740d4569ddd647d6e4ae64cf">SetPixelData</a>(pImage, dimension, cx);</div>
<div class="line">        encoder.<a name="a18"></a><a class="code" href="classnn_1_1image_1_1_jpeg_encoder.html#a384908d45afc2cc7a3a31eb91cacc8af">SetQuality</a>(100);</div>
<div class="line">        encoder.<a name="a19"></a><a class="code" href="classnn_1_1image_1_1_jpeg_encoder.html#ac8266ce81652ed78005e63e68f1b066a">SetSamplingRatio</a>(<a name="a20"></a><a class="code" href="namespacenn_1_1image.html#ac9106d5a0df8b9453f48ec618cf0850ea5ff0e6b73867b9eb10cdbdf083374664">nn::image::JpegSamplingRatio_444</a>);</div>
<div class="line"></div>
<div class="line">        result = encoder.<a name="a21"></a><a class="code" href="classnn_1_1image_1_1_jpeg_encoder.html#abc556ad99a578459ea3c9f4822eb5497">Analyze</a>();</div>
<div class="line">        <a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(result == <a name="a22"></a><a class="code" href="namespacenn_1_1image.html#a8c78190141f5d2997ea6dfdaac0730e3a2f99a50104618a54e9d4e3bfa4e35ffc">nn::image::JpegStatus_Ok</a>);</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">size_t</span> workSize = encoder.<a name="a23"></a><a class="code" href="classnn_1_1image_1_1_jpeg_encoder.html#a1c6ef1ee7483972b30cf4bb17d104121">GetAnalyzedWorkBufferSize</a>();</div>
<div class="line">        <span class="keywordtype">void</span>* workBuf = malloc(workSize);</div>
<div class="line"></div>
<div class="line">        result = encoder.<a name="a24"></a><a class="code" href="classnn_1_1image_1_1_jpeg_encoder.html#ada59b19635ad8dd92a7acd969449d677">Encode</a>(&amp;jpegSize, jpegBuf, JpegBufSize, workBuf, workSize);</div>
<div class="line">        <a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(result == <a class="code" href="namespacenn_1_1image.html#a8c78190141f5d2997ea6dfdaac0730e3a2f99a50104618a54e9d4e3bfa4e35ffc">nn::image::JpegStatus_Ok</a>);</div>
<div class="line"></div>
<div class="line">        free(workBuf);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Jpeg エンコードしたものをファイルに書き込む</span></div>
<div class="line">    {</div>
<div class="line">        <a name="_a25"></a><a class="code" href="classnn_1_1_result.html">nn::Result</a> result;</div>
<div class="line">        <a name="_a26"></a><a class="code" href="structnn_1_1fs_1_1_file_handle.html">nn::fs::FileHandle</a> file;</div>
<div class="line"></div>
<div class="line">        result = <a name="a27"></a><a class="code" href="namespacenn_1_1fs.html#a812ac4964fb5564467c5475c1b9fb16b">nn::fs::DeleteFile</a>(pFilePath);</div>
<div class="line">        <a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(result.<a name="a28"></a><a class="code" href="classnn_1_1_result.html#a80792d8ec8b6b9e9b34025100baa67ec">IsSuccess</a>() || nn::fs::ResultPathNotFound::Includes(result));</div>
<div class="line"></div>
<div class="line">        result = <a name="a29"></a><a class="code" href="namespacenn_1_1fs.html#a3e89c4d57cc8379265894ff7f3e98b2c">nn::fs::CreateFile</a>(pFilePath, static_cast&lt;int64_t&gt;(jpegSize));</div>
<div class="line">        <a name="a30"></a><a class="code" href="nn___abort_8h.html#a1e657a678a588533a020c2e947df7772">NN_ABORT_UNLESS_RESULT_SUCCESS</a>(result);</div>
<div class="line"></div>
<div class="line">        result = <a name="a31"></a><a class="code" href="namespacenn_1_1fs.html#a0f2b5b30657b1ffaf1dec49bfb36462b">nn::fs::OpenFile</a>(&amp;file, pFilePath, <a name="a32"></a><a class="code" href="namespacenn_1_1fs.html#a4c97b79cce78a95c2333dbc9053b9393a0ee257dbba840301b0e656f6d1345c03">nn::fs::OpenMode::OpenMode_Write</a>);</div>
<div class="line">        <a class="code" href="nn___abort_8h.html#a1e657a678a588533a020c2e947df7772">NN_ABORT_UNLESS_RESULT_SUCCESS</a>(result);</div>
<div class="line"></div>
<div class="line">        result = <a name="a33"></a><a class="code" href="namespacenn_1_1fs.html#ab4351ff3a319e9a63093324a669492ab">nn::fs::WriteFile</a>(file, 0, jpegBuf, jpegSize, <a name="a34"></a><a class="code" href="structnn_1_1fs_1_1_write_option.html#ae7e600e7ade2fdde6fab0559dfb4bd1e">nn::fs::WriteOption::MakeValue</a>(<a name="a35"></a><a class="code" href="namespacenn_1_1fs.html#afb4fdd50e0892400c07232f714caa14da2956e16dac576b2b7eff3142e18ac2c0">nn::fs::WriteOptionFlag_Flush</a>));</div>
<div class="line">        <a class="code" href="nn___abort_8h.html#a1e657a678a588533a020c2e947df7772">NN_ABORT_UNLESS_RESULT_SUCCESS</a>(result);</div>
<div class="line"></div>
<div class="line">        <a name="a36"></a><a class="code" href="namespacenn_1_1fs.html#ac8bd9e828751bd4f953acfa765278f84">nn::fs::CloseFile</a>(file);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    free(jpegBuf);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// グリフ画像をJpegファイルとして保存します。</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> SaveGlyphImageAsJpeg(uint8_t* pGlyphBuff, <span class="keyword">const</span> <span class="keywordtype">char</span>* pFilePath)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// レンダリング結果をビットマップにファイル出力します。</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">size_t</span> sizeBuff = TextureWidth * TextureHeight * <span class="keyword">sizeof</span>(uint32_t);</div>
<div class="line">    uint32_t* pBmpBuff = <span class="keyword">static_cast&lt;</span>uint32_t*<span class="keyword">&gt;</span>(malloc(sizeBuff));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y &lt; TextureHeight; y++)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x &lt; TextureWidth; x++)</div>
<div class="line">        {</div>
<div class="line">            uint8_t c = pGlyphBuff[y * TextureWidth + x];</div>
<div class="line">            uint32_t color = c &lt;&lt; 24 | c &lt;&lt; 16 | c &lt;&lt; 8 | c;</div>
<div class="line">            pBmpBuff[y * TextureWidth + x] = color;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    SaveAsJpeg(pFilePath, TextureWidth, TextureHeight, pBmpBuff, sizeBuff);</div>
<div class="line"></div>
<div class="line">    free(pBmpBuff);</div>
<div class="line">}</div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span>* Allocate(<span class="keywordtype">size_t</span> size)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> malloc(size);</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="namespacenns_1_1g3d.html#ac23ca3ba1949451319eb3bbaec93a93d">Free</a>(<span class="keywordtype">void</span>* ptr, <span class="keywordtype">size_t</span> size)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="nn___macro_8h.html#af2d1673769927c5eae977d8dde3ce106">NN_UNUSED</a>(size);</div>
<div class="line">    free(ptr);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> <span class="keywordtype">void</span> <a name="a37"></a><a class="code" href="_socket_resolver_8cpp.html#ae79180f8ae90e05743b47a872f305a52">nnMain</a>()</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">size_t</span> MaxPathLength = 512;</div>
<div class="line">    <span class="comment">// ファイルシステムを初期化</span></div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="classnn_1_1_result.html">nn::Result</a> result;</div>
<div class="line">        <a name="a38"></a><a class="code" href="namespacenn_1_1fs.html#ac021c163ba94a44a2b53cb848c462930">nn::fs::SetAllocator</a>(Allocate, Free);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// 注意：正式なファイルアクセス方法が整備されるまでのワークアラウンドです。</span></div>
<div class="line">        <span class="comment">// 第一引数から、実行ファイルの host 上での位置を取得します。</span></div>
<div class="line">        <span class="keywordtype">char</span> contentPath[260];</div>
<div class="line">        <span class="keywordtype">char</span>* pExeFilePath = <a name="a39"></a><a class="code" href="namespacenn_1_1os.html#abd77e6bf19be140867869cc759fa492c">nn::os::GetHostArgv</a>()[ 0 ];</div>
<div class="line">        <span class="keywordtype">char</span>* pEnd = strrchr( pExeFilePath, <span class="charliteral">&#39;\\&#39;</span> );</div>
<div class="line">        <a name="a40"></a><a class="code" href="nn___assert_8h.html#a0473ebccccc250efd6100a9bbfec406b">NN_ASSERT_NOT_NULL</a>( pEnd );</div>
<div class="line"></div>
<div class="line">        <span class="comment">// 実行ファイルからの相対パスで、リソースフォルダを定義します。</span></div>
<div class="line">        <span class="keywordtype">size_t</span> length = pEnd - pExeFilePath + 1;</div>
<div class="line">        strncpy( contentPath, pExeFilePath, length );</div>
<div class="line">        *(contentPath + length) = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line">        result = <a name="a41"></a><a class="code" href="namespacenn_1_1fs.html#a1b85bf3f3cf038cb67a991a3e3304751">nn::fs::MountHost</a>(<span class="stringliteral">&quot;out&quot;</span>, contentPath);</div>
<div class="line">        <a class="code" href="nn___abort_8h.html#a1e657a678a588533a020c2e947df7772">NN_ABORT_UNLESS_RESULT_SUCCESS</a>(result);</div>
<div class="line">        <a class="code" href="nn___macro_8h.html#af2d1673769927c5eae977d8dde3ce106">NN_UNUSED</a>(result);</div>
<div class="line"></div>
<div class="line">        strcpy( contentPath + length, <span class="stringliteral">&quot;..\\Contents&quot;</span> );</div>
<div class="line">        result = <a class="code" href="namespacenn_1_1fs.html#a1b85bf3f3cf038cb67a991a3e3304751">nn::fs::MountHost</a>(<span class="stringliteral">&quot;contents&quot;</span>, contentPath);</div>
<div class="line">        <a class="code" href="nn___abort_8h.html#a1e657a678a588533a020c2e947df7772">NN_ABORT_UNLESS_RESULT_SUCCESS</a>(result);</div>
<div class="line">        <a class="code" href="nn___macro_8h.html#af2d1673769927c5eae977d8dde3ce106">NN_UNUSED</a>(result);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classnn_1_1fontll_1_1_scalable_font_engine.html">nn::fontll::ScalableFontEngine</a> fontEngine;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// エンジンにワークメモリを指定して初期化します。</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">size_t</span> workSize = 10 * 1024 * 1024;</div>
<div class="line">    <span class="keywordtype">void</span>* pWorkBuf = malloc(workSize);</div>
<div class="line">    fontEngine.<a name="a42"></a><a class="code" href="classnn_1_1fontll_1_1_scalable_font_engine.html#ad3f97c44293e83c4c3e069231494ad7c">Initialize</a>(pWorkBuf, workSize);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// フォントを読み込んでエンジンに設定します。</span></div>
<div class="line">    <span class="keywordtype">void</span>* pFontData = NULL;</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordtype">char</span> fontFilepath[MaxPathLength] = {};</div>
<div class="line">        strcat(fontFilepath, <span class="stringliteral">&quot;contents:/&quot;</span>);</div>
<div class="line">        strcat(fontFilepath, InputFontFileName);</div>
<div class="line"></div>
<div class="line">        <a class="code" href="structnn_1_1fs_1_1_file_handle.html">nn::fs::FileHandle</a> file;</div>
<div class="line">        <a class="code" href="classnn_1_1_result.html">nn::Result</a> openResult = <a class="code" href="namespacenn_1_1fs.html#a0f2b5b30657b1ffaf1dec49bfb36462b">nn::fs::OpenFile</a>(&amp;file, fontFilepath, <a name="a43"></a><a class="code" href="namespacenn_1_1fs.html#a4c97b79cce78a95c2333dbc9053b9393afde4472d2b455879cad02aade386ac0d">nn::fs::OpenMode::OpenMode_Read</a>);</div>
<div class="line">        <a class="code" href="nn___abort_8h.html#a1e657a678a588533a020c2e947df7772">NN_ABORT_UNLESS_RESULT_SUCCESS</a>(openResult);</div>
<div class="line"></div>
<div class="line">        int64_t fileSize = 0;</div>
<div class="line">        <a class="code" href="classnn_1_1_result.html">nn::Result</a> sizeResult = <a name="a44"></a><a class="code" href="namespacenn_1_1fs.html#aba29e01d386e809349d60eccdb15ff21">nn::fs::GetFileSize</a>(&amp;fileSize, file);</div>
<div class="line">        <a class="code" href="nn___abort_8h.html#a1e657a678a588533a020c2e947df7772">NN_ABORT_UNLESS_RESULT_SUCCESS</a>(sizeResult);</div>
<div class="line"></div>
<div class="line">        pFontData = malloc(static_cast&lt;size_t&gt;(fileSize));</div>
<div class="line">        <a class="code" href="nn___assert_8h.html#ade59d1d911907a16c0241f8fe3b31542">NN_ASSERT</a>(pFontData != NULL);</div>
<div class="line"></div>
<div class="line">        <a class="code" href="classnn_1_1_result.html">nn::Result</a> readResult = <a name="a45"></a><a class="code" href="namespacenn_1_1fs.html#a81801a404563984f8c6cc1483cc6d730">nn::fs::ReadFile</a>(file, 0, pFontData, static_cast&lt;size_t&gt;(fileSize));</div>
<div class="line">        <a class="code" href="nn___abort_8h.html#a1e657a678a588533a020c2e947df7772">NN_ABORT_UNLESS_RESULT_SUCCESS</a>(readResult);</div>
<div class="line"></div>
<div class="line">        <a class="code" href="namespacenn_1_1fs.html#ac8bd9e828751bd4f953acfa765278f84">nn::fs::CloseFile</a>(file);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// ttf形式ではない場合( bfttf形式 の場合)は、デコード処理を行います。</span></div>
<div class="line">        <span class="keywordtype">void</span>* pTTFFontData = (!IsInputFontTTF) ? <a name="a46"></a><a class="code" href="classnn_1_1fontll_1_1_scalable_font_engine_helper.html#aec10ff3677f0074f9ef25f25396f1f89">nn::fontll::ScalableFontEngineHelper::Decode</a>(pFontData, static_cast&lt;uint32_t&gt;(fileSize)) : pFontData;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// エンジンにフォントを指定します。</span></div>
<div class="line">        <span class="comment">// LoadFontに渡したデータはエンジンから参照し続けられるので、使用中は解放してはいけません。</span></div>
<div class="line">        fontEngine.<a name="a47"></a><a class="code" href="classnn_1_1fontll_1_1_scalable_font_engine.html#a878f803710ec78fa29ced7ba97960c67">LoadFont</a>(g_MyFontNameBuffer, pTTFFontData, 0, <a class="code" href="namespacenn_1_1fontll.html#ad0330b5997e39ede5d75ad925a58cf3d">nn::fontll::FontNameLengthMax</a>);</div>
<div class="line">        fontEngine.<a name="a48"></a><a class="code" href="classnn_1_1fontll_1_1_scalable_font_engine.html#a70725f64b5665f9aff0ecfb419759b83">SetFont</a>(g_MyFontNameBuffer);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// フォントサイズを設定します。</span></div>
<div class="line">    fontEngine.<a name="a49"></a><a class="code" href="classnn_1_1fontll_1_1_scalable_font_engine.html#a50675f52acbcb508514eff0ce6f3ed97">SetScale</a>(FontSize &lt;&lt; 16, 0, 0, FontSize &lt;&lt; 16);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// 縁取り設定(縁取り描画を行わない場合はコメントアウトします)</span></div>
<div class="line">    fontEngine.<a name="a50"></a><a class="code" href="classnn_1_1fontll_1_1_scalable_font_engine.html#a6c67687d6d536a8be82ec4aa0fac9098">SetOutlineWidth</a>(5);</div>
<div class="line">    fontEngine.<a name="a51"></a><a class="code" href="classnn_1_1fontll_1_1_scalable_font_engine.html#ab071f41ac9e2b624deea3a02a4b7a359">SetFlags</a>(<a name="a52"></a><a class="code" href="classnn_1_1fontll_1_1_scalable_font_engine.html#a2b1ca6803a88958ba86794911e76cf53a0b499ca8b71ea8879d28871a0fec5ce8">nn::fontll::ScalableFontEngine::Flags_OutlinedUnFilled</a>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// グリフの配置用にフォント情報を取得して必要な情報を記憶しておきます。</span></div>
<div class="line">    {</div>
<div class="line">        <a name="_a53"></a><a class="code" href="structnn_1_1fontll_1_1_metrics.html">nn::fontll::Metrics</a> metrics;</div>
<div class="line">        fontEngine.<a name="a54"></a><a class="code" href="classnn_1_1fontll_1_1_scalable_font_engine.html#aca1bba3cfa2e8f8751c5b5c45a0f181d">GetFontMetrics</a>(&amp;metrics);</div>
<div class="line"></div>
<div class="line">        g_AscentRatio = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(metrics.<a name="a55"></a><a class="code" href="structnn_1_1fontll_1_1_metrics.html#a69386a7334f2c56eda2f20aba197e1ba">os2WinAscent</a>) / metrics.<a name="a56"></a><a class="code" href="structnn_1_1fontll_1_1_metrics.html#abf0cfcd3b2d801271cc77e44902603ab">metricsResolution</a>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// グリフ画像を生成し、ビットマップファイルに保存します。</span></div>
<div class="line">    <span class="keywordflow">for</span>(uint32_t charIdx = 0; charIdx &lt;= <span class="charliteral">&#39;z&#39;</span> - <span class="charliteral">&#39;a&#39;</span>; charIdx++)</div>
<div class="line">    {</div>
<div class="line">        uint8_t* pRenderingResultBuff = <span class="keyword">static_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(malloc(TextureSize));</div>
<div class="line">        uint32_t charCode = <span class="charliteral">&#39;a&#39;</span> + charIdx;</div>
<div class="line">        <span class="keywordtype">char</span> charName[] = <span class="stringliteral">&quot;a&quot;</span>;</div>
<div class="line">        charName[0] += <span class="keyword">static_cast&lt;</span><span class="keywordtype">char</span><span class="keyword">&gt;</span>(charIdx);</div>
<div class="line">        <a name="a57"></a><a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;Printing &#39;%s&#39;\n&quot;</span>, charName);</div>
<div class="line"></div>
<div class="line">        CreateGlyphImage(pRenderingResultBuff, TextureSize, &amp;fontEngine, charCode);</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">char</span> resultBmpPath[MaxPathLength] = {};</div>
<div class="line">        strcat(resultBmpPath, <span class="stringliteral">&quot;out:/rendering_result_lower_&quot;</span>);</div>
<div class="line">        strcat(resultBmpPath, charName);</div>
<div class="line">        strcat(resultBmpPath, <span class="stringliteral">&quot;.jpg&quot;</span>);</div>
<div class="line">        SaveGlyphImageAsJpeg(pRenderingResultBuff, resultBmpPath);</div>
<div class="line"></div>
<div class="line">        free(pRenderingResultBuff);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span>(uint32_t charIdx = 0; charIdx &lt;= <span class="charliteral">&#39;Z&#39;</span> - <span class="charliteral">&#39;A&#39;</span>; charIdx++)</div>
<div class="line">    {</div>
<div class="line">        uint8_t* pRenderingResultBuff = <span class="keyword">static_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(malloc(TextureSize));</div>
<div class="line">        uint32_t charCode = <span class="charliteral">&#39;A&#39;</span> + charIdx;</div>
<div class="line">        <span class="keywordtype">char</span> charName[] = <span class="stringliteral">&quot;A&quot;</span>;</div>
<div class="line">        charName[0] += <span class="keyword">static_cast&lt;</span><span class="keywordtype">char</span><span class="keyword">&gt;</span>(charIdx);</div>
<div class="line">        <a class="code" href="nn___log_8h.html#aa8c0b58247a2078e37f2fe0974b98a61">NN_LOG</a>(<span class="stringliteral">&quot;Printing &#39;%s&#39;\n&quot;</span>, charName);</div>
<div class="line"></div>
<div class="line">        CreateGlyphImage(pRenderingResultBuff, TextureSize, &amp;fontEngine, charCode);</div>
<div class="line"></div>
<div class="line">        <span class="keywordtype">char</span> resultBmpPath[MaxPathLength] = {};</div>
<div class="line">        strcat(resultBmpPath, <span class="stringliteral">&quot;out:/rendering_result_upper_&quot;</span>);</div>
<div class="line">        strcat(resultBmpPath, charName);</div>
<div class="line">        strcat(resultBmpPath, <span class="stringliteral">&quot;.jpg&quot;</span>);</div>
<div class="line">        SaveGlyphImageAsJpeg(pRenderingResultBuff, resultBmpPath);</div>
<div class="line"></div>
<div class="line">        free(pRenderingResultBuff);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    free(pFontData);</div>
<div class="line">    free(pWorkBuf);</div>
<div class="line"></div>
<div class="line">    <a name="a58"></a><a class="code" href="namespacenn_1_1fs.html#ac8a95249afd4a87a55d319dfecb0466c">nn::fs::Unmount</a>(<span class="stringliteral">&quot;out&quot;</span>);</div>
<div class="line">    <a class="code" href="namespacenn_1_1fs.html#ac8a95249afd4a87a55d319dfecb0466c">nn::fs::Unmount</a>(<span class="stringliteral">&quot;contents&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
</div><!-- fragment --> </div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
</body>
</html>
